{"version":3,"file":"MatrixActionCreators.js","names":["createSyncAction","matrixClient","state","prevState","action","createAccountDataAction","accountDataEvent","event","event_type","getType","event_content","getContent","createRoomAccountDataAction","room","createRoomAction","createRoomTagsAction","roomTagsEvent","createRoomReceiptAction","createRoomTimelineAction","timelineEvent","toStartOfTimeline","removed","data","isLiveEvent","liveEvent","isLiveUnfilteredRoomTimelineEvent","timeline","getTimelineSet","getUnfilteredTimelineSet","createRoomStateEventsAction","lastStateEvent","createSelfMembershipAction","membership","oldMembership","createEventDecryptedAction","matrixClientListenersStop","addMatrixClientListener","eventName","actionCreator","listener","args","payload","dis","dispatch","on","push","removeListener","start","ClientEvent","Sync","AccountData","RoomEvent","Room","Tags","Receipt","Timeline","MyMembership","MatrixEventEvent","Decrypted","RoomStateEvent","Events","stop","forEach","stopListener"],"sources":["../../src/actions/MatrixActionCreators.ts"],"sourcesContent":["/*\nCopyright 2017, 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { ClientEvent, MatrixClient } from \"matrix-js-sdk/src/client\";\nimport { MatrixEvent, MatrixEventEvent } from \"matrix-js-sdk/src/models/event\";\nimport { Room, RoomEvent } from \"matrix-js-sdk/src/models/room\";\nimport { IRoomTimelineData } from \"matrix-js-sdk/src/models/event-timeline-set\";\nimport { RoomState, RoomStateEvent } from \"matrix-js-sdk/src/models/room-state\";\n\nimport dis from \"../dispatcher/dispatcher\";\nimport { ActionPayload } from \"../dispatcher/payloads\";\n\n/**\n * Create a MatrixActions.sync action that represents a MatrixClient `sync` event,\n * each parameter mapping to a key-value in the action.\n *\n * @param {MatrixClient} matrixClient the matrix client\n * @param {string} state the current sync state.\n * @param {string} prevState the previous sync state.\n * @returns {Object} an action of type MatrixActions.sync.\n */\nfunction createSyncAction(matrixClient: MatrixClient, state: string, prevState: string): ActionPayload {\n    return {\n        action: 'MatrixActions.sync',\n        state,\n        prevState,\n        matrixClient,\n    };\n}\n\n/**\n * @typedef AccountDataAction\n * @type {Object}\n * @property {string} action 'MatrixActions.accountData'.\n * @property {MatrixEvent} event the MatrixEvent that triggered the dispatch.\n * @property {string} event_type the type of the MatrixEvent, e.g. \"m.direct\".\n * @property {Object} event_content the content of the MatrixEvent.\n */\n\n/**\n * Create a MatrixActions.accountData action that represents a MatrixClient `accountData`\n * matrix event.\n *\n * @param {MatrixClient} matrixClient the matrix client.\n * @param {MatrixEvent} accountDataEvent the account data event.\n * @returns {AccountDataAction} an action of type MatrixActions.accountData.\n */\nfunction createAccountDataAction(matrixClient: MatrixClient, accountDataEvent: MatrixEvent): ActionPayload {\n    return {\n        action: 'MatrixActions.accountData',\n        event: accountDataEvent,\n        event_type: accountDataEvent.getType(),\n        event_content: accountDataEvent.getContent(),\n    };\n}\n\n/**\n * @typedef RoomAccountDataAction\n * @type {Object}\n * @property {string} action 'MatrixActions.Room.accountData'.\n * @property {MatrixEvent} event the MatrixEvent that triggered the dispatch.\n * @property {string} event_type the type of the MatrixEvent, e.g. \"m.direct\".\n * @property {Object} event_content the content of the MatrixEvent.\n * @property {Room} room the room where the account data was changed.\n */\n\n/**\n * Create a MatrixActions.Room.accountData action that represents a MatrixClient `Room.accountData`\n * matrix event.\n *\n * @param {MatrixClient} matrixClient the matrix client.\n * @param {MatrixEvent} accountDataEvent the account data event.\n * @param {Room} room the room where account data was changed\n * @returns {RoomAccountDataAction} an action of type MatrixActions.Room.accountData.\n */\nfunction createRoomAccountDataAction(\n    matrixClient: MatrixClient,\n    accountDataEvent: MatrixEvent,\n    room: Room,\n): ActionPayload {\n    return {\n        action: 'MatrixActions.Room.accountData',\n        event: accountDataEvent,\n        event_type: accountDataEvent.getType(),\n        event_content: accountDataEvent.getContent(),\n        room: room,\n    };\n}\n\n/**\n * @typedef RoomAction\n * @type {Object}\n * @property {string} action 'MatrixActions.Room'.\n * @property {Room} room the Room that was stored.\n */\n\n/**\n * Create a MatrixActions.Room action that represents a MatrixClient `Room`\n * matrix event, emitted when a Room is stored in the client.\n *\n * @param {MatrixClient} matrixClient the matrix client.\n * @param {Room} room the Room that was stored.\n * @returns {RoomAction} an action of type `MatrixActions.Room`.\n */\nfunction createRoomAction(matrixClient: MatrixClient, room: Room): ActionPayload {\n    return { action: 'MatrixActions.Room', room };\n}\n\n/**\n * @typedef RoomTagsAction\n * @type {Object}\n * @property {string} action 'MatrixActions.Room.tags'.\n * @property {Room} room the Room whose tags changed.\n */\n\n/**\n * Create a MatrixActions.Room.tags action that represents a MatrixClient\n * `Room.tags` matrix event, emitted when the m.tag room account data\n * event is updated.\n *\n * @param {MatrixClient} matrixClient the matrix client.\n * @param {MatrixEvent} roomTagsEvent the m.tag event.\n * @param {Room} room the Room whose tags were changed.\n * @returns {RoomTagsAction} an action of type `MatrixActions.Room.tags`.\n */\nfunction createRoomTagsAction(matrixClient: MatrixClient, roomTagsEvent: MatrixEvent, room: Room): ActionPayload {\n    return { action: 'MatrixActions.Room.tags', room };\n}\n\n/**\n * Create a MatrixActions.Room.receipt action that represents a MatrixClient\n * `Room.receipt` event, each parameter mapping to a key-value in the action.\n *\n * @param {MatrixClient} matrixClient the matrix client\n * @param {MatrixEvent} event the receipt event.\n * @param {Room} room the room the receipt happened in.\n * @returns {Object} an action of type MatrixActions.Room.receipt.\n */\nfunction createRoomReceiptAction(matrixClient: MatrixClient, event: MatrixEvent, room: Room): ActionPayload {\n    return {\n        action: 'MatrixActions.Room.receipt',\n        event,\n        room,\n        matrixClient,\n    };\n}\n\n/**\n * @typedef IRoomTimelineActionPayload\n * @type {Object}\n * @property {string} action 'MatrixActions.Room.timeline'.\n * @property {boolean} isLiveEvent whether the event was attached to a\n * live timeline.\n * @property {boolean} isLiveUnfilteredRoomTimelineEvent whether the\n * event was attached to a timeline in the set of unfiltered timelines.\n * @property {Room} room the Room whose tags changed.\n */\nexport interface IRoomTimelineActionPayload extends Pick<ActionPayload, \"action\"> {\n    action: 'MatrixActions.Room.timeline';\n    event: MatrixEvent;\n    room: Room | null;\n    isLiveEvent?: boolean;\n    isLiveUnfilteredRoomTimelineEvent: boolean;\n}\n\n/**\n * @typedef IRoomStateEventsActionPayload\n * @type {Object}\n * @property {string} action 'MatrixActions.RoomState.events'.\n * @property {MatrixEvent} event the state event received\n * @property {RoomState} state the room state into which the event was applied\n * @property {MatrixEvent | null} lastStateEvent the previous value for this (event-type, state-key) tuple in room state\n */\nexport interface IRoomStateEventsActionPayload extends Pick<ActionPayload, \"action\"> {\n    action: 'MatrixActions.RoomState.events';\n    event: MatrixEvent;\n    state: RoomState;\n    lastStateEvent: MatrixEvent | null;\n}\n\n/**\n * Create a MatrixActions.Room.timeline action that represents a\n * MatrixClient `Room.timeline` matrix event, emitted when an event\n * is added to or removed from a timeline of a room.\n *\n * @param {MatrixClient} matrixClient the matrix client.\n * @param {MatrixEvent} timelineEvent the event that was added/removed.\n * @param {?Room} room the Room that was stored.\n * @param {boolean} toStartOfTimeline whether the event is being added\n * to the start (and not the end) of the timeline.\n * @param {boolean} removed whether the event was removed from the\n * timeline.\n * @param {Object} data\n * @param {boolean} data.liveEvent whether the event is a live event,\n * belonging to a live timeline.\n * @param {EventTimeline} data.timeline the timeline being altered.\n * @returns {IRoomTimelineActionPayload} an action of type `MatrixActions.Room.timeline`.\n */\nfunction createRoomTimelineAction(\n    matrixClient: MatrixClient,\n    timelineEvent: MatrixEvent,\n    room: Room | null,\n    toStartOfTimeline: boolean,\n    removed: boolean,\n    data: IRoomTimelineData,\n): IRoomTimelineActionPayload {\n    return {\n        action: 'MatrixActions.Room.timeline',\n        event: timelineEvent,\n        isLiveEvent: data.liveEvent,\n        isLiveUnfilteredRoomTimelineEvent: room && data.timeline.getTimelineSet() === room.getUnfilteredTimelineSet(),\n        room,\n    };\n}\n\n/**\n * Create a MatrixActions.Room.timeline action that represents a\n * MatrixClient `Room.timeline` matrix event, emitted when an event\n * is added to or removed from a timeline of a room.\n *\n * @param {MatrixClient} matrixClient the matrix client.\n * @param {MatrixEvent} event the state event received\n * @param {RoomState} state the room state into which the event was applied\n * @param {MatrixEvent | null} lastStateEvent the previous value for this (event-type, state-key) tuple in room state\n * @returns {IRoomStateEventsActionPayload} an action of type `MatrixActions.RoomState.events`.\n */\nfunction createRoomStateEventsAction(\n    matrixClient: MatrixClient,\n    event: MatrixEvent,\n    state: RoomState,\n    lastStateEvent: MatrixEvent | null,\n): IRoomStateEventsActionPayload {\n    return {\n        action: 'MatrixActions.RoomState.events',\n        event,\n        state,\n        lastStateEvent,\n    };\n}\n\n/**\n * @typedef RoomMembershipAction\n * @type {Object}\n * @property {string} action 'MatrixActions.Room.myMembership'.\n * @property {Room} room to room for which the self-membership changed.\n * @property {string} membership the new membership\n * @property {string} oldMembership the previous membership, can be null.\n */\n\n/**\n * Create a MatrixActions.Room.myMembership action that represents\n * a MatrixClient `Room.myMembership` event for the syncing user,\n * emitted when the syncing user's membership is updated for a room.\n *\n * @param {MatrixClient} matrixClient the matrix client.\n * @param {Room} room to room for which the self-membership changed.\n * @param {string} membership the new membership\n * @param {string} oldMembership the previous membership, can be null.\n * @returns {RoomMembershipAction} an action of type `MatrixActions.Room.myMembership`.\n */\nfunction createSelfMembershipAction(\n    matrixClient: MatrixClient,\n    room: Room,\n    membership: string,\n    oldMembership: string,\n): ActionPayload {\n    return { action: 'MatrixActions.Room.myMembership', room, membership, oldMembership };\n}\n\n/**\n * @typedef EventDecryptedAction\n * @type {Object}\n * @property {string} action 'MatrixActions.Event.decrypted'.\n * @property {MatrixEvent} event the matrix event that was decrypted.\n */\n\n/**\n * Create a MatrixActions.Event.decrypted action that represents\n * a MatrixClient `Event.decrypted` matrix event, emitted when a\n * matrix event is decrypted.\n *\n * @param {MatrixClient} matrixClient the matrix client.\n * @param {MatrixEvent} event the matrix event that was decrypted.\n * @returns {EventDecryptedAction} an action of type `MatrixActions.Event.decrypted`.\n */\nfunction createEventDecryptedAction(matrixClient: MatrixClient, event: MatrixEvent): ActionPayload {\n    return { action: 'MatrixActions.Event.decrypted', event };\n}\n\ntype Listener = () => void;\ntype ActionCreator = (matrixClient: MatrixClient, ...args: any) => ActionPayload;\n\n// A list of callbacks to call to unregister all listeners added\nlet matrixClientListenersStop: Listener[] = [];\n\n/**\n * Start listening to events of type eventName on matrixClient and when they are emitted,\n * dispatch an action created by the actionCreator function.\n * @param {MatrixClient} matrixClient a MatrixClient to register a listener with.\n * @param {string} eventName the event to listen to on MatrixClient.\n * @param {function} actionCreator a function that should return an action to dispatch\n *                                 when given the MatrixClient as an argument as well as\n *                                 arguments emitted in the MatrixClient event.\n */\nfunction addMatrixClientListener(\n    matrixClient: MatrixClient,\n    eventName: Parameters<MatrixClient[\"emit\"]>[0],\n    actionCreator: ActionCreator,\n): void {\n    const listener: Listener = (...args) => {\n        const payload = actionCreator(matrixClient, ...args);\n        if (payload) {\n            // Consumers shouldn't have to worry about calling js-sdk methods mid-dispatch, so make this dispatch async\n            dis.dispatch(payload, false);\n        }\n    };\n    matrixClient.on(eventName, listener);\n    matrixClientListenersStop.push(() => {\n        matrixClient.removeListener(eventName, listener);\n    });\n}\n\n/**\n * This object is responsible for dispatching actions when certain events are emitted by\n * the given MatrixClient.\n */\nexport default {\n    /**\n     * Start listening to certain events from the MatrixClient and dispatch actions when\n     * they are emitted.\n     * @param {MatrixClient} matrixClient the MatrixClient to listen to events from\n     */\n    start(matrixClient: MatrixClient) {\n        addMatrixClientListener(matrixClient, ClientEvent.Sync, createSyncAction);\n        addMatrixClientListener(matrixClient, ClientEvent.AccountData, createAccountDataAction);\n        addMatrixClientListener(matrixClient, RoomEvent.AccountData, createRoomAccountDataAction);\n        addMatrixClientListener(matrixClient, ClientEvent.Room, createRoomAction);\n        addMatrixClientListener(matrixClient, RoomEvent.Tags, createRoomTagsAction);\n        addMatrixClientListener(matrixClient, RoomEvent.Receipt, createRoomReceiptAction);\n        addMatrixClientListener(matrixClient, RoomEvent.Timeline, createRoomTimelineAction);\n        addMatrixClientListener(matrixClient, RoomEvent.MyMembership, createSelfMembershipAction);\n        addMatrixClientListener(matrixClient, MatrixEventEvent.Decrypted, createEventDecryptedAction);\n        addMatrixClientListener(matrixClient, RoomStateEvent.Events, createRoomStateEventsAction);\n    },\n\n    /**\n     * Stop listening to events.\n     */\n    stop() {\n        matrixClientListenersStop.forEach((stopListener) => stopListener());\n        matrixClientListenersStop = [];\n    },\n};\n"],"mappings":"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"}