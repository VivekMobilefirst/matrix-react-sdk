{"version":3,"file":"EventIndexPeg.js","names":["INDEX_VERSION","EventIndexPeg","init","indexManager","PlatformPeg","get","getEventIndexingManager","logger","log","_supportIsInstalled","supportsEventIndexing","supportIsInstalled","SettingsStore","getValueAt","SettingLevel","DEVICE","initEventIndex","index","EventIndex","client","MatrixClientPeg","userId","getUserId","deviceId","getDeviceId","userVersion","getUserVersion","eventIndexIsEmpty","isEventIndexEmpty","setUserVersion","closeEventIndex","deleteEventIndex","e","error","platformHasSupport","start","startCrawler","stop","stopCrawler","unset","close","window","mxEventIndexPeg"],"sources":["../../src/indexing/EventIndexPeg.ts"],"sourcesContent":["/*\nCopyright 2019-2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n/*\n * Object holding the global EventIndex object. Can only be initialized if the\n * platform supports event indexing.\n */\n\nimport { logger } from \"matrix-js-sdk/src/logger\";\n\nimport PlatformPeg from \"../PlatformPeg\";\nimport EventIndex from \"../indexing/EventIndex\";\nimport { MatrixClientPeg } from \"../MatrixClientPeg\";\nimport SettingsStore from '../settings/SettingsStore';\nimport { SettingLevel } from \"../settings/SettingLevel\";\n\nconst INDEX_VERSION = 1;\n\n/**\n * Holds the current instance of the `EventIndex` to use across the codebase.\n * Looking for an `EventIndex`? Just look for the `EventIndexPeg` on the peg\n * board. \"Peg\" is the literal meaning of something you hang something on. So\n * you'll find a `EventIndex` hanging on the `EventIndexPeg`.\n */\nexport class EventIndexPeg {\n    public index: EventIndex = null;\n    public error: Error = null;\n\n    private _supportIsInstalled = false;\n\n    /**\n     * Initialize the EventIndexPeg and if event indexing is enabled initialize\n     * the event index.\n     *\n     * @return {Promise<boolean>} A promise that will resolve to true if an\n     * EventIndex was successfully initialized, false otherwise.\n     */\n    async init() {\n        const indexManager = PlatformPeg.get().getEventIndexingManager();\n        if (!indexManager) {\n            logger.log(\"EventIndex: Platform doesn't support event indexing, not initializing.\");\n            return false;\n        }\n\n        this._supportIsInstalled = await indexManager.supportsEventIndexing();\n\n        if (!this.supportIsInstalled()) {\n            logger.log(\"EventIndex: Event indexing isn't installed for the platform, not initializing.\");\n            return false;\n        }\n\n        if (!SettingsStore.getValueAt(SettingLevel.DEVICE, 'enableEventIndexing')) {\n            logger.log(\"EventIndex: Event indexing is disabled, not initializing\");\n            return false;\n        }\n\n        return this.initEventIndex();\n    }\n\n    /**\n     * Initialize the event index.\n     *\n     * @returns {boolean} True if the event index was successfully initialized,\n     * false otherwise.\n     */\n    async initEventIndex() {\n        const index = new EventIndex();\n        const indexManager = PlatformPeg.get().getEventIndexingManager();\n        const client = MatrixClientPeg.get();\n\n        const userId = client.getUserId();\n        const deviceId = client.getDeviceId();\n\n        try {\n            await indexManager.initEventIndex(userId, deviceId);\n\n            const userVersion = await indexManager.getUserVersion();\n            const eventIndexIsEmpty = await indexManager.isEventIndexEmpty();\n\n            if (eventIndexIsEmpty) {\n                await indexManager.setUserVersion(INDEX_VERSION);\n            } else if (userVersion === 0 && !eventIndexIsEmpty) {\n                await indexManager.closeEventIndex();\n                await this.deleteEventIndex();\n\n                await indexManager.initEventIndex(userId, deviceId);\n                await indexManager.setUserVersion(INDEX_VERSION);\n            }\n\n            logger.log(\"EventIndex: Successfully initialized the event index\");\n            await index.init();\n        } catch (e) {\n            logger.log(\"EventIndex: Error initializing the event index\", e);\n            this.error = e;\n            return false;\n        }\n\n        this.index = index;\n\n        return true;\n    }\n\n    /**\n     * Check if the current platform has support for event indexing.\n     *\n     * @return {boolean} True if it has support, false otherwise. Note that this\n     * does not mean that support is installed.\n     */\n    platformHasSupport(): boolean {\n        return PlatformPeg.get().getEventIndexingManager() !== null;\n    }\n\n    /**\n     * Check if event indexing support is installed for the platform.\n     *\n     * Event indexing might require additional optional modules to be installed,\n     * this tells us if those are installed. Note that this should only be\n     * called after the init() method was called.\n     *\n     * @return {boolean} True if support is installed, false otherwise.\n     */\n    supportIsInstalled(): boolean {\n        return this._supportIsInstalled;\n    }\n\n    /**\n     * Get the current event index.\n     *\n     * @return {EventIndex} The current event index.\n     */\n    get() {\n        return this.index;\n    }\n\n    start() {\n        if (this.index === null) return;\n        this.index.startCrawler();\n    }\n\n    stop() {\n        if (this.index === null) return;\n        this.index.stopCrawler();\n    }\n\n    /**\n     * Unset our event store\n     *\n     * After a call to this the init() method will need to be called again.\n     *\n     * @return {Promise} A promise that will resolve once the event index is\n     * closed.\n     */\n    async unset() {\n        if (this.index === null) return;\n        await this.index.close();\n        this.index = null;\n    }\n\n    /**\n     * Delete our event indexer.\n     *\n     * After a call to this the init() method will need to be called again.\n     *\n     * @return {Promise} A promise that will resolve once the event index is\n     * deleted.\n     */\n    async deleteEventIndex() {\n        const indexManager = PlatformPeg.get().getEventIndexingManager();\n\n        if (indexManager !== null) {\n            await this.unset();\n            logger.log(\"EventIndex: Deleting event index.\");\n            await indexManager.deleteEventIndex();\n        }\n    }\n}\n\nif (!window.mxEventIndexPeg) {\n    window.mxEventIndexPeg = new EventIndexPeg();\n}\nexport default window.mxEventIndexPeg;\n"],"mappings":"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"}