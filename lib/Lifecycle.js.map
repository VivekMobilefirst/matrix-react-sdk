{"version":3,"file":"Lifecycle.js","names":["HOMESERVER_URL_KEY","ID_SERVER_URL_KEY","dis","register","payload","action","Action","TriggerLogout","onLoggedOut","OverwriteLogin","typed","doSetLoggedIn","credentials","loadSession","opts","enableGuest","guestHsUrl","guestIsUrl","fragmentQueryParams","defaultDeviceDisplayName","logger","warn","guest_user_id","guest_access_token","log","userId","accessToken","homeserverUrl","identityServerUrl","guest","then","success","restoreFromLocalStorage","ignoreGuest","Boolean","registerAsGuest","e","AbortLoginAndRebuildStorage","handleLoadSessionFailure","getStoredSessionOwner","hsUrl","hasAccessToken","isGuest","getStoredSessionVars","attemptTokenLogin","queryParams","fragmentAfterLogin","loginToken","Promise","resolve","homeserver","localStorage","getItem","SSO_HOMESERVER_URL_KEY","identityServer","SSO_ID_SERVER_URL_KEY","Modal","createDialog","ErrorDialog","title","_t","description","button","sendLoginRequest","token","initial_device_display_name","creds","clearStorage","persistCredentials","sessionStorage","setItem","String","catch","err","name","onFinished","tryAgain","cli","createClient","baseUrl","idBaseUrl","idpId","SSO_IDP_ID_KEY","undefined","PlatformPeg","get","startSingleSignOn","error","handleInvalidStoreError","reason","InvalidStoreError","TOGGLED_LAZY_LOADING","lazyLoadEnabled","value","LazyLoadingResyncDialog","LazyLoadingDisabledDialog","host","window","location","MatrixClientPeg","store","deleteAllData","reload","isUrl","client","registerGuest","body","user_id","deviceId","device_id","access_token","StorageManager","idbLoad","idbSave","removeItem","pickleKeyToAesKey","pickleKey","pickleKeyBuffer","Uint8Array","length","i","charCodeAt","hkdfKey","crypto","subtle","importKey","fill","deriveBits","hash","salt","info","abortLogin","signOut","showStorageEvictedDialog","decryptedAccessToken","getPickleKey","encrKey","decryptAES","freshLogin","modal","SessionRestoreErrorDialog","finished","setLoggedIn","stopMatrixClient","createPickleKey","Object","assign","hydrateSession","oldUserId","getUserId","oldDeviceId","getDeviceId","_isLoggingOut","overwrite","clearStorageEnabled","softLogout","isSoftLogout","dispatch","results","checkConsistency","dataInLocalStorage","cryptoInited","dataInCryptoStore","replaceUsingCreds","setSentryUser","PosthogAnalytics","instance","isEnabled","startListeningToSettingsChanges","SettingsStore","getValue","newDeviceId","rehydrateDevice","fire","OnLoggedIn","startMatrixClient","StorageEvictedDialog","Error","JSON","stringify","deleteItem","encryptedAccessToken","encryptAES","SecurityCustomisations","logout","setImmediate","destroyPickleKey","isLoggingOut","startSyncing","TypingStore","sharedInstance","reset","ToastStore","DialogOpener","prepare","Notifier","start","UserActivity","DMRoomMap","makeShared","IntegrationManagers","startWatching","ActiveWidgetStore","CallHandler","Mjolnir","EventIndexPeg","init","runMigrations","DeviceListener","Presence","Jitsi","getInstance","VideoChannelStore","roomId","fixStuckDevices","getRoom","OnLoggedOut","deleteEverything","LifecycleCustomisations","onLoggedOutAndStorageCleared","SdkConfig","logout_redirect_url","setTimeout","href","pendingInvites","ThreepidInviteStore","getWireInvites","registrationTime","clear","AbstractLocalStorageSettingsHandler","idbDelete","forEach","storeInvite","createMatrixClient","deleteEventIndex","clearStores","unsetClient","stop","stopWatching","shared","stopClient","removeAllListeners","unset","mxLoginWithAccessToken","tempClient","whoami"],"sources":["../src/Lifecycle.ts"],"sourcesContent":["/*\nCopyright 2015, 2016 OpenMarket Ltd\nCopyright 2017 Vector Creations Ltd\nCopyright 2018 New Vector Ltd\nCopyright 2019, 2020 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { createClient } from 'matrix-js-sdk/src/matrix';\nimport { InvalidStoreError } from \"matrix-js-sdk/src/errors\";\nimport { MatrixClient } from \"matrix-js-sdk/src/client\";\nimport { decryptAES, encryptAES, IEncryptedPayload } from \"matrix-js-sdk/src/crypto/aes\";\nimport { QueryDict } from 'matrix-js-sdk/src/utils';\nimport { logger } from \"matrix-js-sdk/src/logger\";\n\nimport { IMatrixClientCreds, MatrixClientPeg } from './MatrixClientPeg';\nimport SecurityCustomisations from \"./customisations/Security\";\nimport EventIndexPeg from './indexing/EventIndexPeg';\nimport createMatrixClient from './utils/createMatrixClient';\nimport Notifier from './Notifier';\nimport UserActivity from './UserActivity';\nimport Presence from './Presence';\nimport dis from './dispatcher/dispatcher';\nimport DMRoomMap from './utils/DMRoomMap';\nimport Modal from './Modal';\nimport ActiveWidgetStore from './stores/ActiveWidgetStore';\nimport PlatformPeg from \"./PlatformPeg\";\nimport { sendLoginRequest } from \"./Login\";\nimport * as StorageManager from './utils/StorageManager';\nimport SettingsStore from \"./settings/SettingsStore\";\nimport TypingStore from \"./stores/TypingStore\";\nimport ToastStore from \"./stores/ToastStore\";\nimport { IntegrationManagers } from \"./integrations/IntegrationManagers\";\nimport { Mjolnir } from \"./mjolnir/Mjolnir\";\nimport DeviceListener from \"./DeviceListener\";\nimport { Jitsi } from \"./widgets/Jitsi\";\nimport { SSO_HOMESERVER_URL_KEY, SSO_ID_SERVER_URL_KEY, SSO_IDP_ID_KEY } from \"./BasePlatform\";\nimport ThreepidInviteStore from \"./stores/ThreepidInviteStore\";\nimport { PosthogAnalytics } from \"./PosthogAnalytics\";\nimport CallHandler from './CallHandler';\nimport LifecycleCustomisations from \"./customisations/Lifecycle\";\nimport ErrorDialog from \"./components/views/dialogs/ErrorDialog\";\nimport { _t } from \"./languageHandler\";\nimport LazyLoadingResyncDialog from \"./components/views/dialogs/LazyLoadingResyncDialog\";\nimport LazyLoadingDisabledDialog from \"./components/views/dialogs/LazyLoadingDisabledDialog\";\nimport SessionRestoreErrorDialog from \"./components/views/dialogs/SessionRestoreErrorDialog\";\nimport StorageEvictedDialog from \"./components/views/dialogs/StorageEvictedDialog\";\nimport { setSentryUser } from \"./sentry\";\nimport SdkConfig from \"./SdkConfig\";\nimport { DialogOpener } from \"./utils/DialogOpener\";\nimport VideoChannelStore from \"./stores/VideoChannelStore\";\nimport { fixStuckDevices } from \"./utils/VideoChannelUtils\";\nimport { Action } from \"./dispatcher/actions\";\nimport AbstractLocalStorageSettingsHandler from \"./settings/handlers/AbstractLocalStorageSettingsHandler\";\nimport { OverwriteLoginPayload } from \"./dispatcher/payloads/OverwriteLoginPayload\";\n\nconst HOMESERVER_URL_KEY = \"mx_hs_url\";\nconst ID_SERVER_URL_KEY = \"mx_is_url\";\n\ndis.register((payload) => {\n    if (payload.action === Action.TriggerLogout) {\n        // noinspection JSIgnoredPromiseFromCall - we don't care if it fails\n        onLoggedOut();\n    } else if (payload.action === Action.OverwriteLogin) {\n        const typed = <OverwriteLoginPayload>payload;\n        // noinspection JSIgnoredPromiseFromCall - we don't care if it fails\n        doSetLoggedIn(typed.credentials, true);\n    }\n});\n\ninterface ILoadSessionOpts {\n    enableGuest?: boolean;\n    guestHsUrl?: string;\n    guestIsUrl?: string;\n    ignoreGuest?: boolean;\n    defaultDeviceDisplayName?: string;\n    fragmentQueryParams?: QueryDict;\n}\n\n/**\n * Called at startup, to attempt to build a logged-in Matrix session. It tries\n * a number of things:\n *\n * 1. if we have a guest access token in the fragment query params, it uses\n *    that.\n * 2. if an access token is stored in local storage (from a previous session),\n *    it uses that.\n * 3. it attempts to auto-register as a guest user.\n *\n * If any of steps 1-4 are successful, it will call {_doSetLoggedIn}, which in\n * turn will raise on_logged_in and will_start_client events.\n *\n * @param {object} [opts]\n * @param {object} [opts.fragmentQueryParams]: string->string map of the\n *     query-parameters extracted from the #-fragment of the starting URI.\n * @param {boolean} [opts.enableGuest]: set to true to enable guest access\n *     tokens and auto-guest registrations.\n * @param {string} [opts.guestHsUrl]: homeserver URL. Only used if enableGuest\n *     is true; defines the HS to register against.\n * @param {string} [opts.guestIsUrl]: homeserver URL. Only used if enableGuest\n *     is true; defines the IS to use.\n * @param {bool} [opts.ignoreGuest]: If the stored session is a guest account,\n *     ignore it and don't load it.\n * @param {string} [opts.defaultDeviceDisplayName]: Default display name to use\n *     when registering as a guest.\n * @returns {Promise} a promise which resolves when the above process completes.\n *     Resolves to `true` if we ended up starting a session, or `false` if we\n *     failed.\n */\nexport async function loadSession(opts: ILoadSessionOpts = {}): Promise<boolean> {\n    try {\n        let enableGuest = opts.enableGuest || false;\n        const guestHsUrl = opts.guestHsUrl;\n        const guestIsUrl = opts.guestIsUrl;\n        const fragmentQueryParams = opts.fragmentQueryParams || {};\n        const defaultDeviceDisplayName = opts.defaultDeviceDisplayName;\n\n        if (enableGuest && !guestHsUrl) {\n            logger.warn(\"Cannot enable guest access: can't determine HS URL to use\");\n            enableGuest = false;\n        }\n\n        if (\n            enableGuest &&\n            fragmentQueryParams.guest_user_id &&\n            fragmentQueryParams.guest_access_token\n        ) {\n            logger.log(\"Using guest access credentials\");\n            return doSetLoggedIn({\n                userId: fragmentQueryParams.guest_user_id as string,\n                accessToken: fragmentQueryParams.guest_access_token as string,\n                homeserverUrl: guestHsUrl,\n                identityServerUrl: guestIsUrl,\n                guest: true,\n            }, true).then(() => true);\n        }\n        const success = await restoreFromLocalStorage({\n            ignoreGuest: Boolean(opts.ignoreGuest),\n        });\n        if (success) {\n            return true;\n        }\n\n        if (enableGuest) {\n            return registerAsGuest(guestHsUrl, guestIsUrl, defaultDeviceDisplayName);\n        }\n\n        // fall back to welcome screen\n        return false;\n    } catch (e) {\n        if (e instanceof AbortLoginAndRebuildStorage) {\n            // If we're aborting login because of a storage inconsistency, we don't\n            // need to show the general failure dialog. Instead, just go back to welcome.\n            return false;\n        }\n        return handleLoadSessionFailure(e);\n    }\n}\n\n/**\n * Gets the user ID of the persisted session, if one exists. This does not validate\n * that the user's credentials still work, just that they exist and that a user ID\n * is associated with them. The session is not loaded.\n * @returns {[string, boolean]} The persisted session's owner and whether the stored\n *     session is for a guest user, if an owner exists. If there is no stored session,\n *     return [null, null].\n */\nexport async function getStoredSessionOwner(): Promise<[string, boolean]> {\n    const { hsUrl, userId, hasAccessToken, isGuest } = await getStoredSessionVars();\n    return hsUrl && userId && hasAccessToken ? [userId, isGuest] : [null, null];\n}\n\n/**\n * @param {Object} queryParams    string->string map of the\n *     query-parameters extracted from the real query-string of the starting\n *     URI.\n *\n * @param {string} defaultDeviceDisplayName\n * @param {string} fragmentAfterLogin path to go to after a successful login, only used for \"Try again\"\n *\n * @returns {Promise} promise which resolves to true if we completed the token\n *    login, else false\n */\nexport function attemptTokenLogin(\n    queryParams: QueryDict,\n    defaultDeviceDisplayName?: string,\n    fragmentAfterLogin?: string,\n): Promise<boolean> {\n    if (!queryParams.loginToken) {\n        return Promise.resolve(false);\n    }\n\n    const homeserver = localStorage.getItem(SSO_HOMESERVER_URL_KEY);\n    const identityServer = localStorage.getItem(SSO_ID_SERVER_URL_KEY);\n    if (!homeserver) {\n        logger.warn(\"Cannot log in with token: can't determine HS URL to use\");\n        Modal.createDialog(ErrorDialog, {\n            title: _t(\"We couldn't log you in\"),\n            description: _t(\"We asked the browser to remember which homeserver you use to let you sign in, \" +\n                \"but unfortunately your browser has forgotten it. Go to the sign in page and try again.\"),\n            button: _t(\"Try again\"),\n        });\n        return Promise.resolve(false);\n    }\n\n    return sendLoginRequest(\n        homeserver,\n        identityServer,\n        \"m.login.token\", {\n            token: queryParams.loginToken as string,\n            initial_device_display_name: defaultDeviceDisplayName,\n        },\n    ).then(function(creds) {\n        logger.log(\"Logged in with token\");\n        return clearStorage().then(async () => {\n            await persistCredentials(creds);\n            // remember that we just logged in\n            sessionStorage.setItem(\"mx_fresh_login\", String(true));\n            return true;\n        });\n    }).catch((err) => {\n        Modal.createDialog(ErrorDialog, {\n            title: _t(\"We couldn't log you in\"),\n            description: err.name === \"ConnectionError\"\n                ? _t(\"Your homeserver was unreachable and was not able to log you in. Please try again. \" +\n                    \"If this continues, please contact your homeserver administrator.\")\n                : _t(\"Your homeserver rejected your log in attempt. \" +\n                    \"This could be due to things just taking too long. Please try again. \" +\n                    \"If this continues, please contact your homeserver administrator.\"),\n            button: _t(\"Try again\"),\n            onFinished: tryAgain => {\n                if (tryAgain) {\n                    const cli = createClient({\n                        baseUrl: homeserver,\n                        idBaseUrl: identityServer,\n                    });\n                    const idpId = localStorage.getItem(SSO_IDP_ID_KEY) || undefined;\n                    PlatformPeg.get().startSingleSignOn(cli, \"sso\", fragmentAfterLogin, idpId);\n                }\n            },\n        });\n        logger.error(\"Failed to log in with login token:\");\n        logger.error(err);\n        return false;\n    });\n}\n\nexport function handleInvalidStoreError(e: InvalidStoreError): Promise<void> {\n    if (e.reason === InvalidStoreError.TOGGLED_LAZY_LOADING) {\n        return Promise.resolve().then(() => {\n            const lazyLoadEnabled = e.value;\n            if (lazyLoadEnabled) {\n                return new Promise((resolve) => {\n                    Modal.createDialog(LazyLoadingResyncDialog, {\n                        onFinished: resolve,\n                    });\n                });\n            } else {\n                // show warning about simultaneous use\n                // between LL/non-LL version on same host.\n                // as disabling LL when previously enabled\n                // is a strong indicator of this (/develop & /app)\n                return new Promise((resolve) => {\n                    Modal.createDialog(LazyLoadingDisabledDialog, {\n                        onFinished: resolve,\n                        host: window.location.host,\n                    });\n                });\n            }\n        }).then(() => {\n            return MatrixClientPeg.get().store.deleteAllData();\n        }).then(() => {\n            PlatformPeg.get().reload();\n        });\n    }\n}\n\nfunction registerAsGuest(\n    hsUrl: string,\n    isUrl: string,\n    defaultDeviceDisplayName: string,\n): Promise<boolean> {\n    logger.log(`Doing guest login on ${hsUrl}`);\n\n    // create a temporary MatrixClient to do the login\n    const client = createClient({\n        baseUrl: hsUrl,\n    });\n\n    return client.registerGuest({\n        body: {\n            initial_device_display_name: defaultDeviceDisplayName,\n        },\n    }).then((creds) => {\n        logger.log(`Registered as guest: ${creds.user_id}`);\n        return doSetLoggedIn({\n            userId: creds.user_id,\n            deviceId: creds.device_id,\n            accessToken: creds.access_token,\n            homeserverUrl: hsUrl,\n            identityServerUrl: isUrl,\n            guest: true,\n        }, true).then(() => true);\n    }, (err) => {\n        logger.error(\"Failed to register as guest\", err);\n        return false;\n    });\n}\n\nexport interface IStoredSession {\n    hsUrl: string;\n    isUrl: string;\n    hasAccessToken: boolean;\n    accessToken: string | IEncryptedPayload;\n    userId: string;\n    deviceId: string;\n    isGuest: boolean;\n}\n\n/**\n * Retrieves information about the stored session from the browser's storage. The session\n * may not be valid, as it is not tested for consistency here.\n * @returns {Object} Information about the session - see implementation for variables.\n */\nexport async function getStoredSessionVars(): Promise<IStoredSession> {\n    const hsUrl = localStorage.getItem(HOMESERVER_URL_KEY);\n    const isUrl = localStorage.getItem(ID_SERVER_URL_KEY);\n    let accessToken;\n    try {\n        accessToken = await StorageManager.idbLoad(\"account\", \"mx_access_token\");\n    } catch (e) {\n        logger.error(\"StorageManager.idbLoad failed for account:mx_access_token\", e);\n    }\n    if (!accessToken) {\n        accessToken = localStorage.getItem(\"mx_access_token\");\n        if (accessToken) {\n            try {\n                // try to migrate access token to IndexedDB if we can\n                await StorageManager.idbSave(\"account\", \"mx_access_token\", accessToken);\n                localStorage.removeItem(\"mx_access_token\");\n            } catch (e) {\n                logger.error(\"migration of access token to IndexedDB failed\", e);\n            }\n        }\n    }\n    // if we pre-date storing \"mx_has_access_token\", but we retrieved an access\n    // token, then we should say we have an access token\n    const hasAccessToken =\n        (localStorage.getItem(\"mx_has_access_token\") === \"true\") || !!accessToken;\n    const userId = localStorage.getItem(\"mx_user_id\");\n    const deviceId = localStorage.getItem(\"mx_device_id\");\n\n    let isGuest;\n    if (localStorage.getItem(\"mx_is_guest\") !== null) {\n        isGuest = localStorage.getItem(\"mx_is_guest\") === \"true\";\n    } else {\n        // legacy key name\n        isGuest = localStorage.getItem(\"matrix-is-guest\") === \"true\";\n    }\n\n    return { hsUrl, isUrl, hasAccessToken, accessToken, userId, deviceId, isGuest };\n}\n\n// The pickle key is a string of unspecified length and format.  For AES, we\n// need a 256-bit Uint8Array. So we HKDF the pickle key to generate the AES\n// key.  The AES key should be zeroed after it is used.\nasync function pickleKeyToAesKey(pickleKey: string): Promise<Uint8Array> {\n    const pickleKeyBuffer = new Uint8Array(pickleKey.length);\n    for (let i = 0; i < pickleKey.length; i++) {\n        pickleKeyBuffer[i] = pickleKey.charCodeAt(i);\n    }\n    const hkdfKey = await window.crypto.subtle.importKey(\n        \"raw\", pickleKeyBuffer, \"HKDF\", false, [\"deriveBits\"],\n    );\n    pickleKeyBuffer.fill(0);\n    return new Uint8Array(await window.crypto.subtle.deriveBits(\n        {\n            name: \"HKDF\", hash: \"SHA-256\",\n            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n            // @ts-ignore: https://github.com/microsoft/TypeScript-DOM-lib-generator/pull/879\n            salt: new Uint8Array(32), info: new Uint8Array(0),\n        },\n        hkdfKey,\n        256,\n    ));\n}\n\nasync function abortLogin() {\n    const signOut = await showStorageEvictedDialog();\n    if (signOut) {\n        await clearStorage();\n        // This error feels a bit clunky, but we want to make sure we don't go any\n        // further and instead head back to sign in.\n        throw new AbortLoginAndRebuildStorage(\n            \"Aborting login in progress because of storage inconsistency\",\n        );\n    }\n}\n\n// returns a promise which resolves to true if a session is found in\n// localstorage\n//\n// N.B. Lifecycle.js should not maintain any further localStorage state, we\n//      are moving towards using SessionStore to keep track of state related\n//      to the current session (which is typically backed by localStorage).\n//\n//      The plan is to gradually move the localStorage access done here into\n//      SessionStore to avoid bugs where the view becomes out-of-sync with\n//      localStorage (e.g. isGuest etc.)\nexport async function restoreFromLocalStorage(opts?: { ignoreGuest?: boolean }): Promise<boolean> {\n    const ignoreGuest = opts?.ignoreGuest;\n\n    if (!localStorage) {\n        return false;\n    }\n\n    const { hsUrl, isUrl, hasAccessToken, accessToken, userId, deviceId, isGuest } = await getStoredSessionVars();\n\n    if (hasAccessToken && !accessToken) {\n        abortLogin();\n    }\n\n    if (accessToken && userId && hsUrl) {\n        if (ignoreGuest && isGuest) {\n            logger.log(\"Ignoring stored guest account: \" + userId);\n            return false;\n        }\n\n        let decryptedAccessToken = accessToken;\n        const pickleKey = await PlatformPeg.get().getPickleKey(userId, deviceId);\n        if (pickleKey) {\n            logger.log(\"Got pickle key\");\n            if (typeof accessToken !== \"string\") {\n                const encrKey = await pickleKeyToAesKey(pickleKey);\n                decryptedAccessToken = await decryptAES(accessToken, encrKey, \"access_token\");\n                encrKey.fill(0);\n            }\n        } else {\n            logger.log(\"No pickle key available\");\n        }\n\n        const freshLogin = sessionStorage.getItem(\"mx_fresh_login\") === \"true\";\n        sessionStorage.removeItem(\"mx_fresh_login\");\n\n        logger.log(`Restoring session for ${userId}`);\n        await doSetLoggedIn({\n            userId: userId,\n            deviceId: deviceId,\n            accessToken: decryptedAccessToken as string,\n            homeserverUrl: hsUrl,\n            identityServerUrl: isUrl,\n            guest: isGuest,\n            pickleKey: pickleKey,\n            freshLogin: freshLogin,\n        }, false);\n        return true;\n    } else {\n        logger.log(\"No previous session found.\");\n        return false;\n    }\n}\n\nasync function handleLoadSessionFailure(e: Error): Promise<boolean> {\n    logger.error(\"Unable to load session\", e);\n\n    const modal = Modal.createDialog(SessionRestoreErrorDialog, {\n        error: e,\n    });\n\n    const [success] = await modal.finished;\n    if (success) {\n        // user clicked continue.\n        await clearStorage();\n        return false;\n    }\n\n    // try, try again\n    return loadSession();\n}\n\n/**\n * Transitions to a logged-in state using the given credentials.\n *\n * Starts the matrix client and all other react-sdk services that\n * listen for events while a session is logged in.\n *\n * Also stops the old MatrixClient and clears old credentials/etc out of\n * storage before starting the new client.\n *\n * @param {IMatrixClientCreds} credentials The credentials to use\n *\n * @returns {Promise} promise which resolves to the new MatrixClient once it has been started\n */\nexport async function setLoggedIn(credentials: IMatrixClientCreds): Promise<MatrixClient> {\n    credentials.freshLogin = true;\n    stopMatrixClient();\n    const pickleKey = credentials.userId && credentials.deviceId\n        ? await PlatformPeg.get().createPickleKey(credentials.userId, credentials.deviceId)\n        : null;\n\n    if (pickleKey) {\n        logger.log(\"Created pickle key\");\n    } else {\n        logger.log(\"Pickle key not created\");\n    }\n\n    return doSetLoggedIn(Object.assign({}, credentials, { pickleKey }), true);\n}\n\n/**\n * Hydrates an existing session by using the credentials provided. This will\n * not clear any local storage, unlike setLoggedIn().\n *\n * Stops the existing Matrix client (without clearing its data) and starts a\n * new one in its place. This additionally starts all other react-sdk services\n * which use the new Matrix client.\n *\n * If the credentials belong to a different user from the session already stored,\n * the old session will be cleared automatically.\n *\n * @param {IMatrixClientCreds} credentials The credentials to use\n *\n * @returns {Promise} promise which resolves to the new MatrixClient once it has been started\n */\nexport async function hydrateSession(credentials: IMatrixClientCreds): Promise<MatrixClient> {\n    const oldUserId = MatrixClientPeg.get().getUserId();\n    const oldDeviceId = MatrixClientPeg.get().getDeviceId();\n\n    stopMatrixClient(); // unsets MatrixClientPeg.get()\n    localStorage.removeItem(\"mx_soft_logout\");\n    _isLoggingOut = false;\n\n    const overwrite = credentials.userId !== oldUserId || credentials.deviceId !== oldDeviceId;\n    if (overwrite) {\n        logger.warn(\"Clearing all data: Old session belongs to a different user/session\");\n    }\n\n    if (!credentials.pickleKey) {\n        logger.info(\"Lifecycle#hydrateSession: Pickle key not provided - trying to get one\");\n        credentials.pickleKey = await PlatformPeg.get().getPickleKey(credentials.userId, credentials.deviceId);\n    }\n\n    return doSetLoggedIn(credentials, overwrite);\n}\n\n/**\n * fires on_logging_in, optionally clears localstorage, persists new credentials\n * to localstorage, starts the new client.\n *\n * @param {IMatrixClientCreds} credentials\n * @param {Boolean} clearStorageEnabled\n *\n * @returns {Promise} promise which resolves to the new MatrixClient once it has been started\n */\nasync function doSetLoggedIn(\n    credentials: IMatrixClientCreds,\n    clearStorageEnabled: boolean,\n): Promise<MatrixClient> {\n    credentials.guest = Boolean(credentials.guest);\n\n    const softLogout = isSoftLogout();\n\n    logger.log(\n        \"setLoggedIn: mxid: \" + credentials.userId +\n        \" deviceId: \" + credentials.deviceId +\n        \" guest: \" + credentials.guest +\n        \" hs: \" + credentials.homeserverUrl +\n        \" softLogout: \" + softLogout,\n        \" freshLogin: \" + credentials.freshLogin,\n    );\n\n    // This is dispatched to indicate that the user is still in the process of logging in\n    // because async code may take some time to resolve, breaking the assumption that\n    // `setLoggedIn` takes an \"instant\" to complete, and dispatch `on_logged_in` a few ms\n    // later than MatrixChat might assume.\n    //\n    // we fire it *synchronously* to make sure it fires before on_logged_in.\n    // (dis.dispatch uses `setTimeout`, which does not guarantee ordering.)\n    dis.dispatch({ action: 'on_logging_in' }, true);\n\n    if (clearStorageEnabled) {\n        await clearStorage();\n    }\n\n    const results = await StorageManager.checkConsistency();\n    // If there's an inconsistency between account data in local storage and the\n    // crypto store, we'll be generally confused when handling encrypted data.\n    // Show a modal recommending a full reset of storage.\n    if (results.dataInLocalStorage && results.cryptoInited && !results.dataInCryptoStore) {\n        await abortLogin();\n    }\n\n    MatrixClientPeg.replaceUsingCreds(credentials);\n\n    setSentryUser(credentials.userId);\n\n    if (PosthogAnalytics.instance.isEnabled()) {\n        PosthogAnalytics.instance.startListeningToSettingsChanges();\n    }\n\n    const client = MatrixClientPeg.get();\n    if (credentials.freshLogin && SettingsStore.getValue(\"feature_dehydration\")) {\n        // If we just logged in, try to rehydrate a device instead of using a\n        // new device.  If it succeeds, we'll get a new device ID, so make sure\n        // we persist that ID to localStorage\n        const newDeviceId = await client.rehydrateDevice();\n        if (newDeviceId) {\n            credentials.deviceId = newDeviceId;\n        }\n\n        delete credentials.freshLogin;\n    }\n\n    if (localStorage) {\n        try {\n            await persistCredentials(credentials);\n            // make sure we don't think that it's a fresh login any more\n            sessionStorage.removeItem(\"mx_fresh_login\");\n        } catch (e) {\n            logger.warn(\"Error using local storage: can't persist session!\", e);\n        }\n    } else {\n        logger.warn(\"No local storage available: can't persist session!\");\n    }\n\n    dis.fire(Action.OnLoggedIn);\n    await startMatrixClient(/*startSyncing=*/!softLogout);\n\n    return client;\n}\n\nfunction showStorageEvictedDialog(): Promise<boolean> {\n    return new Promise(resolve => {\n        Modal.createDialog(StorageEvictedDialog, {\n            onFinished: resolve,\n        });\n    });\n}\n\n// Note: Babel 6 requires the `transform-builtin-extend` plugin for this to satisfy\n// `instanceof`. Babel 7 supports this natively in their class handling.\nclass AbortLoginAndRebuildStorage extends Error { }\n\nasync function persistCredentials(credentials: IMatrixClientCreds): Promise<void> {\n    localStorage.setItem(HOMESERVER_URL_KEY, credentials.homeserverUrl);\n    if (credentials.identityServerUrl) {\n        localStorage.setItem(ID_SERVER_URL_KEY, credentials.identityServerUrl);\n    }\n    localStorage.setItem(\"mx_user_id\", credentials.userId);\n    localStorage.setItem(\"mx_is_guest\", JSON.stringify(credentials.guest));\n\n    // store whether we expect to find an access token, to detect the case\n    // where IndexedDB is blown away\n    if (credentials.accessToken) {\n        localStorage.setItem(\"mx_has_access_token\", \"true\");\n    } else {\n        localStorage.deleteItem(\"mx_has_access_token\");\n    }\n\n    if (credentials.pickleKey) {\n        let encryptedAccessToken: IEncryptedPayload;\n        try {\n            // try to encrypt the access token using the pickle key\n            const encrKey = await pickleKeyToAesKey(credentials.pickleKey);\n            encryptedAccessToken = await encryptAES(credentials.accessToken, encrKey, \"access_token\");\n            encrKey.fill(0);\n        } catch (e) {\n            logger.warn(\"Could not encrypt access token\", e);\n        }\n        try {\n            // save either the encrypted access token, or the plain access\n            // token if we were unable to encrypt (e.g. if the browser doesn't\n            // have WebCrypto).\n            await StorageManager.idbSave(\n                \"account\", \"mx_access_token\",\n                encryptedAccessToken || credentials.accessToken,\n            );\n        } catch (e) {\n            // if we couldn't save to indexedDB, fall back to localStorage.  We\n            // store the access token unencrypted since localStorage only saves\n            // strings.\n            localStorage.setItem(\"mx_access_token\", credentials.accessToken);\n        }\n        localStorage.setItem(\"mx_has_pickle_key\", String(true));\n    } else {\n        try {\n            await StorageManager.idbSave(\n                \"account\", \"mx_access_token\", credentials.accessToken,\n            );\n        } catch (e) {\n            localStorage.setItem(\"mx_access_token\", credentials.accessToken);\n        }\n        if (localStorage.getItem(\"mx_has_pickle_key\")) {\n            logger.error(\"Expected a pickle key, but none provided.  Encryption may not work.\");\n        }\n    }\n\n    // if we didn't get a deviceId from the login, leave mx_device_id unset,\n    // rather than setting it to \"undefined\".\n    //\n    // (in this case MatrixClient doesn't bother with the crypto stuff\n    // - that's fine for us).\n    if (credentials.deviceId) {\n        localStorage.setItem(\"mx_device_id\", credentials.deviceId);\n    }\n\n    SecurityCustomisations.persistCredentials?.(credentials);\n\n    logger.log(`Session persisted for ${credentials.userId}`);\n}\n\nlet _isLoggingOut = false;\n\n/**\n * Logs the current session out and transitions to the logged-out state\n */\nexport function logout(): void {\n    if (!MatrixClientPeg.get()) return;\n\n    PosthogAnalytics.instance.logout();\n\n    if (MatrixClientPeg.get().isGuest()) {\n        // logout doesn't work for guest sessions\n        // Also we sometimes want to re-log in a guest session if we abort the login.\n        // defer until next tick because it calls a synchronous dispatch, and we are likely here from a dispatch.\n        setImmediate(() => onLoggedOut());\n        return;\n    }\n\n    _isLoggingOut = true;\n    const client = MatrixClientPeg.get();\n    PlatformPeg.get().destroyPickleKey(client.getUserId(), client.getDeviceId());\n    client.logout(undefined, true).then(onLoggedOut, (err) => {\n        // Just throwing an error here is going to be very unhelpful\n        // if you're trying to log out because your server's down and\n        // you want to log into a different server, so just forget the\n        // access token. It's annoying that this will leave the access\n        // token still valid, but we should fix this by having access\n        // tokens expire (and if you really think you've been compromised,\n        // change your password).\n        logger.warn(\"Failed to call logout API: token will not be invalidated\", err);\n        onLoggedOut();\n    });\n}\n\nexport function softLogout(): void {\n    if (!MatrixClientPeg.get()) return;\n\n    // Track that we've detected and trapped a soft logout. This helps prevent other\n    // parts of the app from starting if there's no point (ie: don't sync if we've\n    // been soft logged out, despite having credentials and data for a MatrixClient).\n    localStorage.setItem(\"mx_soft_logout\", \"true\");\n\n    // Dev note: please keep this log line around. It can be useful for track down\n    // random clients stopping in the middle of the logs.\n    logger.log(\"Soft logout initiated\");\n    _isLoggingOut = true; // to avoid repeated flags\n    // Ensure that we dispatch a view change **before** stopping the client so\n    // so that React components unmount first. This avoids React soft crashes\n    // that can occur when components try to use a null client.\n    dis.dispatch({ action: 'on_client_not_viable' }); // generic version of on_logged_out\n    stopMatrixClient(/*unsetClient=*/false);\n\n    // DO NOT CALL LOGOUT. A soft logout preserves data, logout does not.\n}\n\nexport function isSoftLogout(): boolean {\n    return localStorage.getItem(\"mx_soft_logout\") === \"true\";\n}\n\nexport function isLoggingOut(): boolean {\n    return _isLoggingOut;\n}\n\n/**\n * Starts the matrix client and all other react-sdk services that\n * listen for events while a session is logged in.\n * @param {boolean} startSyncing True (default) to actually start\n * syncing the client.\n */\nasync function startMatrixClient(startSyncing = true): Promise<void> {\n    logger.log(`Lifecycle: Starting MatrixClient`);\n\n    // dispatch this before starting the matrix client: it's used\n    // to add listeners for the 'sync' event so otherwise we'd have\n    // a race condition (and we need to dispatch synchronously for this\n    // to work).\n    dis.dispatch({ action: 'will_start_client' }, true);\n\n    // reset things first just in case\n    TypingStore.sharedInstance().reset();\n    ToastStore.sharedInstance().reset();\n\n    DialogOpener.instance.prepare();\n    Notifier.start();\n    UserActivity.sharedInstance().start();\n    DMRoomMap.makeShared().start();\n    IntegrationManagers.sharedInstance().startWatching();\n    ActiveWidgetStore.instance.start();\n    CallHandler.instance.start();\n\n    // Start Mjolnir even though we haven't checked the feature flag yet. Starting\n    // the thing just wastes CPU cycles, but should result in no actual functionality\n    // being exposed to the user.\n    Mjolnir.sharedInstance().start();\n\n    if (startSyncing) {\n        // The client might want to populate some views with events from the\n        // index (e.g. the FilePanel), therefore initialize the event index\n        // before the client.\n        await EventIndexPeg.init();\n        await MatrixClientPeg.start();\n    } else {\n        logger.warn(\"Caller requested only auxiliary services be started\");\n        await MatrixClientPeg.assign();\n    }\n\n    // Run the migrations after the MatrixClientPeg has been assigned\n    SettingsStore.runMigrations();\n\n    // This needs to be started after crypto is set up\n    DeviceListener.sharedInstance().start();\n    // Similarly, don't start sending presence updates until we've started\n    // the client\n    if (!SettingsStore.getValue(\"lowBandwidth\")) {\n        Presence.start();\n    }\n\n    // Now that we have a MatrixClientPeg, update the Jitsi info\n    Jitsi.getInstance().start();\n\n    // In case we disconnected uncleanly from a video room, clean up the stuck device\n    if (VideoChannelStore.instance.roomId) {\n        fixStuckDevices(MatrixClientPeg.get().getRoom(VideoChannelStore.instance.roomId), false);\n    }\n\n    // dispatch that we finished starting up to wire up any other bits\n    // of the matrix client that cannot be set prior to starting up.\n    dis.dispatch({ action: 'client_started' });\n\n    if (isSoftLogout()) {\n        softLogout();\n    }\n}\n\n/*\n * Stops a running client and all related services, and clears persistent\n * storage. Used after a session has been logged out.\n */\nexport async function onLoggedOut(): Promise<void> {\n    // Ensure that we dispatch a view change **before** stopping the client,\n    // that React components unmount first. This avoids React soft crashes\n    // that can occur when components try to use a null client.\n    dis.fire(Action.OnLoggedOut, true);\n    stopMatrixClient();\n    await clearStorage({ deleteEverything: true });\n    LifecycleCustomisations.onLoggedOutAndStorageCleared?.();\n\n    // Do this last, so we can make sure all storage has been cleared and all\n    // customisations got the memo.\n    if (SdkConfig.get().logout_redirect_url) {\n        logger.log(\"Redirecting to external provider to finish logout\");\n        // XXX: Defer this so that it doesn't race with MatrixChat unmounting the world by going to /#/login\n        setTimeout(() => {\n            window.location.href = SdkConfig.get().logout_redirect_url;\n        }, 100);\n    }\n    // Do this last to prevent racing `stopMatrixClient` and `on_logged_out` with MatrixChat handling Session.logged_out\n    _isLoggingOut = false;\n}\n\n/**\n * @param {object} opts Options for how to clear storage.\n * @returns {Promise} promise which resolves once the stores have been cleared\n */\nasync function clearStorage(opts?: { deleteEverything?: boolean }): Promise<void> {\n    if (window.localStorage) {\n        // try to save any 3pid invites from being obliterated and registration time\n        const pendingInvites = ThreepidInviteStore.instance.getWireInvites();\n        const registrationTime = window.localStorage.getItem(\"mx_registration_time\");\n\n        window.localStorage.clear();\n        AbstractLocalStorageSettingsHandler.clear();\n\n        try {\n            await StorageManager.idbDelete(\"account\", \"mx_access_token\");\n        } catch (e) {\n            logger.error(\"idbDelete failed for account:mx_access_token\", e);\n        }\n\n        // now restore those invites and registration time\n        if (!opts?.deleteEverything) {\n            pendingInvites.forEach(i => {\n                const roomId = i.roomId;\n                delete i.roomId; // delete to avoid confusing the store\n                ThreepidInviteStore.instance.storeInvite(roomId, i);\n            });\n\n            if (registrationTime) {\n                window.localStorage.setItem(\"mx_registration_time\", registrationTime);\n            }\n        }\n    }\n\n    window.sessionStorage?.clear();\n\n    // create a temporary client to clear out the persistent stores.\n    const cli = createMatrixClient({\n        // we'll never make any requests, so can pass a bogus HS URL\n        baseUrl: \"\",\n    });\n\n    await EventIndexPeg.deleteEventIndex();\n    await cli.clearStores();\n}\n\n/**\n * Stop all the background processes related to the current client.\n * @param {boolean} unsetClient True (default) to abandon the client\n * on MatrixClientPeg after stopping.\n */\nexport function stopMatrixClient(unsetClient = true): void {\n    Notifier.stop();\n    CallHandler.instance.stop();\n    UserActivity.sharedInstance().stop();\n    TypingStore.sharedInstance().reset();\n    Presence.stop();\n    ActiveWidgetStore.instance.stop();\n    IntegrationManagers.sharedInstance().stopWatching();\n    Mjolnir.sharedInstance().stop();\n    DeviceListener.sharedInstance().stop();\n    DMRoomMap.shared()?.stop();\n    EventIndexPeg.stop();\n    const cli = MatrixClientPeg.get();\n    if (cli) {\n        cli.stopClient();\n        cli.removeAllListeners();\n\n        if (unsetClient) {\n            MatrixClientPeg.unset();\n            EventIndexPeg.unset();\n        }\n    }\n}\n\n// Utility method to perform a login with an existing access_token\nwindow.mxLoginWithAccessToken = async (hsUrl: string, accessToken: string): Promise<void> => {\n    const tempClient = createClient({\n        baseUrl: hsUrl,\n        accessToken,\n    });\n    const { user_id: userId } = await tempClient.whoami();\n    await doSetLoggedIn({\n        homeserverUrl: hsUrl,\n        accessToken,\n        userId,\n    }, true);\n};\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAmBA;;AACA;;AAEA;;AAEA;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;;;AAhEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAkDA,MAAMA,kBAAkB,GAAG,WAA3B;AACA,MAAMC,iBAAiB,GAAG,WAA1B;;AAEAC,mBAAA,CAAIC,QAAJ,CAAcC,OAAD,IAAa;EACtB,IAAIA,OAAO,CAACC,MAAR,KAAmBC,eAAA,CAAOC,aAA9B,EAA6C;IACzC;IACAC,WAAW;EACd,CAHD,MAGO,IAAIJ,OAAO,CAACC,MAAR,KAAmBC,eAAA,CAAOG,cAA9B,EAA8C;IACjD,MAAMC,KAAK,GAA0BN,OAArC,CADiD,CAEjD;;IACAO,aAAa,CAACD,KAAK,CAACE,WAAP,EAAoB,IAApB,CAAb;EACH;AACJ,CATD;;AAoBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,eAAeC,WAAf,GAA0E;EAAA,IAA/CC,IAA+C,uEAAtB,EAAsB;;EAC7E,IAAI;IACA,IAAIC,WAAW,GAAGD,IAAI,CAACC,WAAL,IAAoB,KAAtC;IACA,MAAMC,UAAU,GAAGF,IAAI,CAACE,UAAxB;IACA,MAAMC,UAAU,GAAGH,IAAI,CAACG,UAAxB;IACA,MAAMC,mBAAmB,GAAGJ,IAAI,CAACI,mBAAL,IAA4B,EAAxD;IACA,MAAMC,wBAAwB,GAAGL,IAAI,CAACK,wBAAtC;;IAEA,IAAIJ,WAAW,IAAI,CAACC,UAApB,EAAgC;MAC5BI,cAAA,CAAOC,IAAP,CAAY,2DAAZ;;MACAN,WAAW,GAAG,KAAd;IACH;;IAED,IACIA,WAAW,IACXG,mBAAmB,CAACI,aADpB,IAEAJ,mBAAmB,CAACK,kBAHxB,EAIE;MACEH,cAAA,CAAOI,GAAP,CAAW,gCAAX;;MACA,OAAOb,aAAa,CAAC;QACjBc,MAAM,EAAEP,mBAAmB,CAACI,aADX;QAEjBI,WAAW,EAAER,mBAAmB,CAACK,kBAFhB;QAGjBI,aAAa,EAAEX,UAHE;QAIjBY,iBAAiB,EAAEX,UAJF;QAKjBY,KAAK,EAAE;MALU,CAAD,EAMjB,IANiB,CAAb,CAMEC,IANF,CAMO,MAAM,IANb,CAAP;IAOH;;IACD,MAAMC,OAAO,GAAG,MAAMC,uBAAuB,CAAC;MAC1CC,WAAW,EAAEC,OAAO,CAACpB,IAAI,CAACmB,WAAN;IADsB,CAAD,CAA7C;;IAGA,IAAIF,OAAJ,EAAa;MACT,OAAO,IAAP;IACH;;IAED,IAAIhB,WAAJ,EAAiB;MACb,OAAOoB,eAAe,CAACnB,UAAD,EAAaC,UAAb,EAAyBE,wBAAzB,CAAtB;IACH,CAnCD,CAqCA;;;IACA,OAAO,KAAP;EACH,CAvCD,CAuCE,OAAOiB,CAAP,EAAU;IACR,IAAIA,CAAC,YAAYC,2BAAjB,EAA8C;MAC1C;MACA;MACA,OAAO,KAAP;IACH;;IACD,OAAOC,wBAAwB,CAACF,CAAD,CAA/B;EACH;AACJ;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACO,eAAeG,qBAAf,GAAmE;EACtE,MAAM;IAAEC,KAAF;IAASf,MAAT;IAAiBgB,cAAjB;IAAiCC;EAAjC,IAA6C,MAAMC,oBAAoB,EAA7E;EACA,OAAOH,KAAK,IAAIf,MAAT,IAAmBgB,cAAnB,GAAoC,CAAChB,MAAD,EAASiB,OAAT,CAApC,GAAwD,CAAC,IAAD,EAAO,IAAP,CAA/D;AACH;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACO,SAASE,iBAAT,CACHC,WADG,EAEH1B,wBAFG,EAGH2B,kBAHG,EAIa;EAChB,IAAI,CAACD,WAAW,CAACE,UAAjB,EAA6B;IACzB,OAAOC,OAAO,CAACC,OAAR,CAAgB,KAAhB,CAAP;EACH;;EAED,MAAMC,UAAU,GAAGC,YAAY,CAACC,OAAb,CAAqBC,oCAArB,CAAnB;EACA,MAAMC,cAAc,GAAGH,YAAY,CAACC,OAAb,CAAqBG,mCAArB,CAAvB;;EACA,IAAI,CAACL,UAAL,EAAiB;IACb9B,cAAA,CAAOC,IAAP,CAAY,yDAAZ;;IACAmC,cAAA,CAAMC,YAAN,CAAmBC,oBAAnB,EAAgC;MAC5BC,KAAK,EAAE,IAAAC,mBAAA,EAAG,wBAAH,CADqB;MAE5BC,WAAW,EAAE,IAAAD,mBAAA,EAAG,mFACZ,wFADS,CAFe;MAI5BE,MAAM,EAAE,IAAAF,mBAAA,EAAG,WAAH;IAJoB,CAAhC;;IAMA,OAAOZ,OAAO,CAACC,OAAR,CAAgB,KAAhB,CAAP;EACH;;EAED,OAAO,IAAAc,uBAAA,EACHb,UADG,EAEHI,cAFG,EAGH,eAHG,EAGc;IACbU,KAAK,EAAEnB,WAAW,CAACE,UADN;IAEbkB,2BAA2B,EAAE9C;EAFhB,CAHd,EAOLW,IAPK,CAOA,UAASoC,KAAT,EAAgB;IACnB9C,cAAA,CAAOI,GAAP,CAAW,sBAAX;;IACA,OAAO2C,YAAY,GAAGrC,IAAf,CAAoB,YAAY;MACnC,MAAMsC,kBAAkB,CAACF,KAAD,CAAxB,CADmC,CAEnC;;MACAG,cAAc,CAACC,OAAf,CAAuB,gBAAvB,EAAyCC,MAAM,CAAC,IAAD,CAA/C;MACA,OAAO,IAAP;IACH,CALM,CAAP;EAMH,CAfM,EAeJC,KAfI,CAeGC,GAAD,IAAS;IACdjB,cAAA,CAAMC,YAAN,CAAmBC,oBAAnB,EAAgC;MAC5BC,KAAK,EAAE,IAAAC,mBAAA,EAAG,wBAAH,CADqB;MAE5BC,WAAW,EAAEY,GAAG,CAACC,IAAJ,KAAa,iBAAb,GACP,IAAAd,mBAAA,EAAG,uFACD,kEADF,CADO,GAGP,IAAAA,mBAAA,EAAG,mDACD,sEADC,GAED,kEAFF,CALsB;MAQ5BE,MAAM,EAAE,IAAAF,mBAAA,EAAG,WAAH,CARoB;MAS5Be,UAAU,EAAEC,QAAQ,IAAI;QACpB,IAAIA,QAAJ,EAAc;UACV,MAAMC,GAAG,GAAG,IAAAC,oBAAA,EAAa;YACrBC,OAAO,EAAE7B,UADY;YAErB8B,SAAS,EAAE1B;UAFU,CAAb,CAAZ;UAIA,MAAM2B,KAAK,GAAG9B,YAAY,CAACC,OAAb,CAAqB8B,4BAArB,KAAwCC,SAAtD;;UACAC,oBAAA,CAAYC,GAAZ,GAAkBC,iBAAlB,CAAoCT,GAApC,EAAyC,KAAzC,EAAgD/B,kBAAhD,EAAoEmC,KAApE;QACH;MACJ;IAlB2B,CAAhC;;IAoBA7D,cAAA,CAAOmE,KAAP,CAAa,oCAAb;;IACAnE,cAAA,CAAOmE,KAAP,CAAad,GAAb;;IACA,OAAO,KAAP;EACH,CAvCM,CAAP;AAwCH;;AAEM,SAASe,uBAAT,CAAiCpD,CAAjC,EAAsE;EACzE,IAAIA,CAAC,CAACqD,MAAF,KAAaC,yBAAA,CAAkBC,oBAAnC,EAAyD;IACrD,OAAO3C,OAAO,CAACC,OAAR,GAAkBnB,IAAlB,CAAuB,MAAM;MAChC,MAAM8D,eAAe,GAAGxD,CAAC,CAACyD,KAA1B;;MACA,IAAID,eAAJ,EAAqB;QACjB,OAAO,IAAI5C,OAAJ,CAAaC,OAAD,IAAa;UAC5BO,cAAA,CAAMC,YAAN,CAAmBqC,gCAAnB,EAA4C;YACxCnB,UAAU,EAAE1B;UAD4B,CAA5C;QAGH,CAJM,CAAP;MAKH,CAND,MAMO;QACH;QACA;QACA;QACA;QACA,OAAO,IAAID,OAAJ,CAAaC,OAAD,IAAa;UAC5BO,cAAA,CAAMC,YAAN,CAAmBsC,kCAAnB,EAA8C;YAC1CpB,UAAU,EAAE1B,OAD8B;YAE1C+C,IAAI,EAAEC,MAAM,CAACC,QAAP,CAAgBF;UAFoB,CAA9C;QAIH,CALM,CAAP;MAMH;IACJ,CApBM,EAoBJlE,IApBI,CAoBC,MAAM;MACV,OAAOqE,gCAAA,CAAgBd,GAAhB,GAAsBe,KAAtB,CAA4BC,aAA5B,EAAP;IACH,CAtBM,EAsBJvE,IAtBI,CAsBC,MAAM;MACVsD,oBAAA,CAAYC,GAAZ,GAAkBiB,MAAlB;IACH,CAxBM,CAAP;EAyBH;AACJ;;AAED,SAASnE,eAAT,CACIK,KADJ,EAEI+D,KAFJ,EAGIpF,wBAHJ,EAIoB;EAChBC,cAAA,CAAOI,GAAP,CAAY,wBAAuBgB,KAAM,EAAzC,EADgB,CAGhB;;;EACA,MAAMgE,MAAM,GAAG,IAAA1B,oBAAA,EAAa;IACxBC,OAAO,EAAEvC;EADe,CAAb,CAAf;EAIA,OAAOgE,MAAM,CAACC,aAAP,CAAqB;IACxBC,IAAI,EAAE;MACFzC,2BAA2B,EAAE9C;IAD3B;EADkB,CAArB,EAIJW,IAJI,CAIEoC,KAAD,IAAW;IACf9C,cAAA,CAAOI,GAAP,CAAY,wBAAuB0C,KAAK,CAACyC,OAAQ,EAAjD;;IACA,OAAOhG,aAAa,CAAC;MACjBc,MAAM,EAAEyC,KAAK,CAACyC,OADG;MAEjBC,QAAQ,EAAE1C,KAAK,CAAC2C,SAFC;MAGjBnF,WAAW,EAAEwC,KAAK,CAAC4C,YAHF;MAIjBnF,aAAa,EAAEa,KAJE;MAKjBZ,iBAAiB,EAAE2E,KALF;MAMjB1E,KAAK,EAAE;IANU,CAAD,EAOjB,IAPiB,CAAb,CAOEC,IAPF,CAOO,MAAM,IAPb,CAAP;EAQH,CAdM,EAcH2C,GAAD,IAAS;IACRrD,cAAA,CAAOmE,KAAP,CAAa,6BAAb,EAA4Cd,GAA5C;;IACA,OAAO,KAAP;EACH,CAjBM,CAAP;AAkBH;;AAYD;AACA;AACA;AACA;AACA;AACO,eAAe9B,oBAAf,GAA+D;EAClE,MAAMH,KAAK,GAAGW,YAAY,CAACC,OAAb,CAAqBpD,kBAArB,CAAd;EACA,MAAMuG,KAAK,GAAGpD,YAAY,CAACC,OAAb,CAAqBnD,iBAArB,CAAd;EACA,IAAIyB,WAAJ;;EACA,IAAI;IACAA,WAAW,GAAG,MAAMqF,cAAc,CAACC,OAAf,CAAuB,SAAvB,EAAkC,iBAAlC,CAApB;EACH,CAFD,CAEE,OAAO5E,CAAP,EAAU;IACRhB,cAAA,CAAOmE,KAAP,CAAa,2DAAb,EAA0EnD,CAA1E;EACH;;EACD,IAAI,CAACV,WAAL,EAAkB;IACdA,WAAW,GAAGyB,YAAY,CAACC,OAAb,CAAqB,iBAArB,CAAd;;IACA,IAAI1B,WAAJ,EAAiB;MACb,IAAI;QACA;QACA,MAAMqF,cAAc,CAACE,OAAf,CAAuB,SAAvB,EAAkC,iBAAlC,EAAqDvF,WAArD,CAAN;QACAyB,YAAY,CAAC+D,UAAb,CAAwB,iBAAxB;MACH,CAJD,CAIE,OAAO9E,CAAP,EAAU;QACRhB,cAAA,CAAOmE,KAAP,CAAa,+CAAb,EAA8DnD,CAA9D;MACH;IACJ;EACJ,CApBiE,CAqBlE;EACA;;;EACA,MAAMK,cAAc,GACfU,YAAY,CAACC,OAAb,CAAqB,qBAArB,MAAgD,MAAjD,IAA4D,CAAC,CAAC1B,WADlE;EAEA,MAAMD,MAAM,GAAG0B,YAAY,CAACC,OAAb,CAAqB,YAArB,CAAf;EACA,MAAMwD,QAAQ,GAAGzD,YAAY,CAACC,OAAb,CAAqB,cAArB,CAAjB;EAEA,IAAIV,OAAJ;;EACA,IAAIS,YAAY,CAACC,OAAb,CAAqB,aAArB,MAAwC,IAA5C,EAAkD;IAC9CV,OAAO,GAAGS,YAAY,CAACC,OAAb,CAAqB,aAArB,MAAwC,MAAlD;EACH,CAFD,MAEO;IACH;IACAV,OAAO,GAAGS,YAAY,CAACC,OAAb,CAAqB,iBAArB,MAA4C,MAAtD;EACH;;EAED,OAAO;IAAEZ,KAAF;IAAS+D,KAAT;IAAgB9D,cAAhB;IAAgCf,WAAhC;IAA6CD,MAA7C;IAAqDmF,QAArD;IAA+DlE;EAA/D,CAAP;AACH,C,CAED;AACA;AACA;;;AACA,eAAeyE,iBAAf,CAAiCC,SAAjC,EAAyE;EACrE,MAAMC,eAAe,GAAG,IAAIC,UAAJ,CAAeF,SAAS,CAACG,MAAzB,CAAxB;;EACA,KAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,SAAS,CAACG,MAA9B,EAAsCC,CAAC,EAAvC,EAA2C;IACvCH,eAAe,CAACG,CAAD,CAAf,GAAqBJ,SAAS,CAACK,UAAV,CAAqBD,CAArB,CAArB;EACH;;EACD,MAAME,OAAO,GAAG,MAAMzB,MAAM,CAAC0B,MAAP,CAAcC,MAAd,CAAqBC,SAArB,CAClB,KADkB,EACXR,eADW,EACM,MADN,EACc,KADd,EACqB,CAAC,YAAD,CADrB,CAAtB;EAGAA,eAAe,CAACS,IAAhB,CAAqB,CAArB;EACA,OAAO,IAAIR,UAAJ,CAAe,MAAMrB,MAAM,CAAC0B,MAAP,CAAcC,MAAd,CAAqBG,UAArB,CACxB;IACIrD,IAAI,EAAE,MADV;IACkBsD,IAAI,EAAE,SADxB;IAEI;IACA;IACAC,IAAI,EAAE,IAAIX,UAAJ,CAAe,EAAf,CAJV;IAI8BY,IAAI,EAAE,IAAIZ,UAAJ,CAAe,CAAf;EAJpC,CADwB,EAOxBI,OAPwB,EAQxB,GARwB,CAArB,CAAP;AAUH;;AAED,eAAeS,UAAf,GAA4B;EACxB,MAAMC,OAAO,GAAG,MAAMC,wBAAwB,EAA9C;;EACA,IAAID,OAAJ,EAAa;IACT,MAAMjE,YAAY,EAAlB,CADS,CAET;IACA;;IACA,MAAM,IAAI9B,2BAAJ,CACF,6DADE,CAAN;EAGH;AACJ,C,CAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACO,eAAeL,uBAAf,CAAuClB,IAAvC,EAA2F;EAC9F,MAAMmB,WAAW,GAAGnB,IAAI,EAAEmB,WAA1B;;EAEA,IAAI,CAACkB,YAAL,EAAmB;IACf,OAAO,KAAP;EACH;;EAED,MAAM;IAAEX,KAAF;IAAS+D,KAAT;IAAgB9D,cAAhB;IAAgCf,WAAhC;IAA6CD,MAA7C;IAAqDmF,QAArD;IAA+DlE;EAA/D,IAA2E,MAAMC,oBAAoB,EAA3G;;EAEA,IAAIF,cAAc,IAAI,CAACf,WAAvB,EAAoC;IAChCyG,UAAU;EACb;;EAED,IAAIzG,WAAW,IAAID,MAAf,IAAyBe,KAA7B,EAAoC;IAChC,IAAIP,WAAW,IAAIS,OAAnB,EAA4B;MACxBtB,cAAA,CAAOI,GAAP,CAAW,oCAAoCC,MAA/C;;MACA,OAAO,KAAP;IACH;;IAED,IAAI6G,oBAAoB,GAAG5G,WAA3B;IACA,MAAM0F,SAAS,GAAG,MAAMhC,oBAAA,CAAYC,GAAZ,GAAkBkD,YAAlB,CAA+B9G,MAA/B,EAAuCmF,QAAvC,CAAxB;;IACA,IAAIQ,SAAJ,EAAe;MACXhG,cAAA,CAAOI,GAAP,CAAW,gBAAX;;MACA,IAAI,OAAOE,WAAP,KAAuB,QAA3B,EAAqC;QACjC,MAAM8G,OAAO,GAAG,MAAMrB,iBAAiB,CAACC,SAAD,CAAvC;QACAkB,oBAAoB,GAAG,MAAM,IAAAG,eAAA,EAAW/G,WAAX,EAAwB8G,OAAxB,EAAiC,cAAjC,CAA7B;QACAA,OAAO,CAACV,IAAR,CAAa,CAAb;MACH;IACJ,CAPD,MAOO;MACH1G,cAAA,CAAOI,GAAP,CAAW,yBAAX;IACH;;IAED,MAAMkH,UAAU,GAAGrE,cAAc,CAACjB,OAAf,CAAuB,gBAAvB,MAA6C,MAAhE;IACAiB,cAAc,CAAC6C,UAAf,CAA0B,gBAA1B;;IAEA9F,cAAA,CAAOI,GAAP,CAAY,yBAAwBC,MAAO,EAA3C;;IACA,MAAMd,aAAa,CAAC;MAChBc,MAAM,EAAEA,MADQ;MAEhBmF,QAAQ,EAAEA,QAFM;MAGhBlF,WAAW,EAAE4G,oBAHG;MAIhB3G,aAAa,EAAEa,KAJC;MAKhBZ,iBAAiB,EAAE2E,KALH;MAMhB1E,KAAK,EAAEa,OANS;MAOhB0E,SAAS,EAAEA,SAPK;MAQhBsB,UAAU,EAAEA;IARI,CAAD,EAShB,KATgB,CAAnB;IAUA,OAAO,IAAP;EACH,CAlCD,MAkCO;IACHtH,cAAA,CAAOI,GAAP,CAAW,4BAAX;;IACA,OAAO,KAAP;EACH;AACJ;;AAED,eAAec,wBAAf,CAAwCF,CAAxC,EAAoE;EAChEhB,cAAA,CAAOmE,KAAP,CAAa,wBAAb,EAAuCnD,CAAvC;;EAEA,MAAMuG,KAAK,GAAGnF,cAAA,CAAMC,YAAN,CAAmBmF,kCAAnB,EAA8C;IACxDrD,KAAK,EAAEnD;EADiD,CAA9C,CAAd;;EAIA,MAAM,CAACL,OAAD,IAAY,MAAM4G,KAAK,CAACE,QAA9B;;EACA,IAAI9G,OAAJ,EAAa;IACT;IACA,MAAMoC,YAAY,EAAlB;IACA,OAAO,KAAP;EACH,CAZ+D,CAchE;;;EACA,OAAOtD,WAAW,EAAlB;AACH;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACO,eAAeiI,WAAf,CAA2BlI,WAA3B,EAAmF;EACtFA,WAAW,CAAC8H,UAAZ,GAAyB,IAAzB;EACAK,gBAAgB;EAChB,MAAM3B,SAAS,GAAGxG,WAAW,CAACa,MAAZ,IAAsBb,WAAW,CAACgG,QAAlC,GACZ,MAAMxB,oBAAA,CAAYC,GAAZ,GAAkB2D,eAAlB,CAAkCpI,WAAW,CAACa,MAA9C,EAAsDb,WAAW,CAACgG,QAAlE,CADM,GAEZ,IAFN;;EAIA,IAAIQ,SAAJ,EAAe;IACXhG,cAAA,CAAOI,GAAP,CAAW,oBAAX;EACH,CAFD,MAEO;IACHJ,cAAA,CAAOI,GAAP,CAAW,wBAAX;EACH;;EAED,OAAOb,aAAa,CAACsI,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkBtI,WAAlB,EAA+B;IAAEwG;EAAF,CAA/B,CAAD,EAAgD,IAAhD,CAApB;AACH;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACO,eAAe+B,cAAf,CAA8BvI,WAA9B,EAAsF;EACzF,MAAMwI,SAAS,GAAGjD,gCAAA,CAAgBd,GAAhB,GAAsBgE,SAAtB,EAAlB;;EACA,MAAMC,WAAW,GAAGnD,gCAAA,CAAgBd,GAAhB,GAAsBkE,WAAtB,EAApB;;EAEAR,gBAAgB,GAJyE,CAIrE;;EACpB5F,YAAY,CAAC+D,UAAb,CAAwB,gBAAxB;EACAsC,aAAa,GAAG,KAAhB;EAEA,MAAMC,SAAS,GAAG7I,WAAW,CAACa,MAAZ,KAAuB2H,SAAvB,IAAoCxI,WAAW,CAACgG,QAAZ,KAAyB0C,WAA/E;;EACA,IAAIG,SAAJ,EAAe;IACXrI,cAAA,CAAOC,IAAP,CAAY,oEAAZ;EACH;;EAED,IAAI,CAACT,WAAW,CAACwG,SAAjB,EAA4B;IACxBhG,cAAA,CAAO8G,IAAP,CAAY,uEAAZ;;IACAtH,WAAW,CAACwG,SAAZ,GAAwB,MAAMhC,oBAAA,CAAYC,GAAZ,GAAkBkD,YAAlB,CAA+B3H,WAAW,CAACa,MAA3C,EAAmDb,WAAW,CAACgG,QAA/D,CAA9B;EACH;;EAED,OAAOjG,aAAa,CAACC,WAAD,EAAc6I,SAAd,CAApB;AACH;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,eAAe9I,aAAf,CACIC,WADJ,EAEI8I,mBAFJ,EAGyB;EACrB9I,WAAW,CAACiB,KAAZ,GAAoBK,OAAO,CAACtB,WAAW,CAACiB,KAAb,CAA3B;EAEA,MAAM8H,UAAU,GAAGC,YAAY,EAA/B;;EAEAxI,cAAA,CAAOI,GAAP,CACI,wBAAwBZ,WAAW,CAACa,MAApC,GACA,aADA,GACgBb,WAAW,CAACgG,QAD5B,GAEA,UAFA,GAEahG,WAAW,CAACiB,KAFzB,GAGA,OAHA,GAGUjB,WAAW,CAACe,aAHtB,GAIA,eAJA,GAIkBgI,UALtB,EAMI,kBAAkB/I,WAAW,CAAC8H,UANlC,EALqB,CAcrB;EACA;EACA;EACA;EACA;EACA;EACA;;;EACAxI,mBAAA,CAAI2J,QAAJ,CAAa;IAAExJ,MAAM,EAAE;EAAV,CAAb,EAA0C,IAA1C;;EAEA,IAAIqJ,mBAAJ,EAAyB;IACrB,MAAMvF,YAAY,EAAlB;EACH;;EAED,MAAM2F,OAAO,GAAG,MAAM/C,cAAc,CAACgD,gBAAf,EAAtB,CA3BqB,CA4BrB;EACA;EACA;;EACA,IAAID,OAAO,CAACE,kBAAR,IAA8BF,OAAO,CAACG,YAAtC,IAAsD,CAACH,OAAO,CAACI,iBAAnE,EAAsF;IAClF,MAAM/B,UAAU,EAAhB;EACH;;EAEDhC,gCAAA,CAAgBgE,iBAAhB,CAAkCvJ,WAAlC;;EAEA,IAAAwJ,qBAAA,EAAcxJ,WAAW,CAACa,MAA1B;;EAEA,IAAI4I,kCAAA,CAAiBC,QAAjB,CAA0BC,SAA1B,EAAJ,EAA2C;IACvCF,kCAAA,CAAiBC,QAAjB,CAA0BE,+BAA1B;EACH;;EAED,MAAMhE,MAAM,GAAGL,gCAAA,CAAgBd,GAAhB,EAAf;;EACA,IAAIzE,WAAW,CAAC8H,UAAZ,IAA0B+B,sBAAA,CAAcC,QAAd,CAAuB,qBAAvB,CAA9B,EAA6E;IACzE;IACA;IACA;IACA,MAAMC,WAAW,GAAG,MAAMnE,MAAM,CAACoE,eAAP,EAA1B;;IACA,IAAID,WAAJ,EAAiB;MACb/J,WAAW,CAACgG,QAAZ,GAAuB+D,WAAvB;IACH;;IAED,OAAO/J,WAAW,CAAC8H,UAAnB;EACH;;EAED,IAAIvF,YAAJ,EAAkB;IACd,IAAI;MACA,MAAMiB,kBAAkB,CAACxD,WAAD,CAAxB,CADA,CAEA;;MACAyD,cAAc,CAAC6C,UAAf,CAA0B,gBAA1B;IACH,CAJD,CAIE,OAAO9E,CAAP,EAAU;MACRhB,cAAA,CAAOC,IAAP,CAAY,mDAAZ,EAAiEe,CAAjE;IACH;EACJ,CARD,MAQO;IACHhB,cAAA,CAAOC,IAAP,CAAY,oDAAZ;EACH;;EAEDnB,mBAAA,CAAI2K,IAAJ,CAASvK,eAAA,CAAOwK,UAAhB;;EACA,MAAMC,iBAAiB;EAAC;EAAiB,CAACpB,UAAnB,CAAvB;EAEA,OAAOnD,MAAP;AACH;;AAED,SAAS6B,wBAAT,GAAsD;EAClD,OAAO,IAAIrF,OAAJ,CAAYC,OAAO,IAAI;IAC1BO,cAAA,CAAMC,YAAN,CAAmBuH,6BAAnB,EAAyC;MACrCrG,UAAU,EAAE1B;IADyB,CAAzC;EAGH,CAJM,CAAP;AAKH,C,CAED;AACA;;;AACA,MAAMZ,2BAAN,SAA0C4I,KAA1C,CAAgD;;AAEhD,eAAe7G,kBAAf,CAAkCxD,WAAlC,EAAkF;EAC9EuC,YAAY,CAACmB,OAAb,CAAqBtE,kBAArB,EAAyCY,WAAW,CAACe,aAArD;;EACA,IAAIf,WAAW,CAACgB,iBAAhB,EAAmC;IAC/BuB,YAAY,CAACmB,OAAb,CAAqBrE,iBAArB,EAAwCW,WAAW,CAACgB,iBAApD;EACH;;EACDuB,YAAY,CAACmB,OAAb,CAAqB,YAArB,EAAmC1D,WAAW,CAACa,MAA/C;EACA0B,YAAY,CAACmB,OAAb,CAAqB,aAArB,EAAoC4G,IAAI,CAACC,SAAL,CAAevK,WAAW,CAACiB,KAA3B,CAApC,EAN8E,CAQ9E;EACA;;EACA,IAAIjB,WAAW,CAACc,WAAhB,EAA6B;IACzByB,YAAY,CAACmB,OAAb,CAAqB,qBAArB,EAA4C,MAA5C;EACH,CAFD,MAEO;IACHnB,YAAY,CAACiI,UAAb,CAAwB,qBAAxB;EACH;;EAED,IAAIxK,WAAW,CAACwG,SAAhB,EAA2B;IACvB,IAAIiE,oBAAJ;;IACA,IAAI;MACA;MACA,MAAM7C,OAAO,GAAG,MAAMrB,iBAAiB,CAACvG,WAAW,CAACwG,SAAb,CAAvC;MACAiE,oBAAoB,GAAG,MAAM,IAAAC,eAAA,EAAW1K,WAAW,CAACc,WAAvB,EAAoC8G,OAApC,EAA6C,cAA7C,CAA7B;MACAA,OAAO,CAACV,IAAR,CAAa,CAAb;IACH,CALD,CAKE,OAAO1F,CAAP,EAAU;MACRhB,cAAA,CAAOC,IAAP,CAAY,gCAAZ,EAA8Ce,CAA9C;IACH;;IACD,IAAI;MACA;MACA;MACA;MACA,MAAM2E,cAAc,CAACE,OAAf,CACF,SADE,EACS,iBADT,EAEFoE,oBAAoB,IAAIzK,WAAW,CAACc,WAFlC,CAAN;IAIH,CARD,CAQE,OAAOU,CAAP,EAAU;MACR;MACA;MACA;MACAe,YAAY,CAACmB,OAAb,CAAqB,iBAArB,EAAwC1D,WAAW,CAACc,WAApD;IACH;;IACDyB,YAAY,CAACmB,OAAb,CAAqB,mBAArB,EAA0CC,MAAM,CAAC,IAAD,CAAhD;EACH,CAzBD,MAyBO;IACH,IAAI;MACA,MAAMwC,cAAc,CAACE,OAAf,CACF,SADE,EACS,iBADT,EAC4BrG,WAAW,CAACc,WADxC,CAAN;IAGH,CAJD,CAIE,OAAOU,CAAP,EAAU;MACRe,YAAY,CAACmB,OAAb,CAAqB,iBAArB,EAAwC1D,WAAW,CAACc,WAApD;IACH;;IACD,IAAIyB,YAAY,CAACC,OAAb,CAAqB,mBAArB,CAAJ,EAA+C;MAC3ChC,cAAA,CAAOmE,KAAP,CAAa,qEAAb;IACH;EACJ,CApD6E,CAsD9E;EACA;EACA;EACA;EACA;;;EACA,IAAI3E,WAAW,CAACgG,QAAhB,EAA0B;IACtBzD,YAAY,CAACmB,OAAb,CAAqB,cAArB,EAAqC1D,WAAW,CAACgG,QAAjD;EACH;;EAED2E,iBAAA,CAAuBnH,kBAAvB,GAA4CxD,WAA5C;;EAEAQ,cAAA,CAAOI,GAAP,CAAY,yBAAwBZ,WAAW,CAACa,MAAO,EAAvD;AACH;;AAED,IAAI+H,aAAa,GAAG,KAApB;AAEA;AACA;AACA;;AACO,SAASgC,MAAT,GAAwB;EAC3B,IAAI,CAACrF,gCAAA,CAAgBd,GAAhB,EAAL,EAA4B;;EAE5BgF,kCAAA,CAAiBC,QAAjB,CAA0BkB,MAA1B;;EAEA,IAAIrF,gCAAA,CAAgBd,GAAhB,GAAsB3C,OAAtB,EAAJ,EAAqC;IACjC;IACA;IACA;IACA+I,YAAY,CAAC,MAAMjL,WAAW,EAAlB,CAAZ;IACA;EACH;;EAEDgJ,aAAa,GAAG,IAAhB;;EACA,MAAMhD,MAAM,GAAGL,gCAAA,CAAgBd,GAAhB,EAAf;;EACAD,oBAAA,CAAYC,GAAZ,GAAkBqG,gBAAlB,CAAmClF,MAAM,CAAC6C,SAAP,EAAnC,EAAuD7C,MAAM,CAAC+C,WAAP,EAAvD;;EACA/C,MAAM,CAACgF,MAAP,CAAcrG,SAAd,EAAyB,IAAzB,EAA+BrD,IAA/B,CAAoCtB,WAApC,EAAkDiE,GAAD,IAAS;IACtD;IACA;IACA;IACA;IACA;IACA;IACA;IACArD,cAAA,CAAOC,IAAP,CAAY,0DAAZ,EAAwEoD,GAAxE;;IACAjE,WAAW;EACd,CAVD;AAWH;;AAEM,SAASmJ,UAAT,GAA4B;EAC/B,IAAI,CAACxD,gCAAA,CAAgBd,GAAhB,EAAL,EAA4B,OADG,CAG/B;EACA;EACA;;EACAlC,YAAY,CAACmB,OAAb,CAAqB,gBAArB,EAAuC,MAAvC,EAN+B,CAQ/B;EACA;;EACAlD,cAAA,CAAOI,GAAP,CAAW,uBAAX;;EACAgI,aAAa,GAAG,IAAhB,CAX+B,CAWT;EACtB;EACA;EACA;;EACAtJ,mBAAA,CAAI2J,QAAJ,CAAa;IAAExJ,MAAM,EAAE;EAAV,CAAb,EAf+B,CAemB;;;EAClD0I,gBAAgB;EAAC;EAAgB,KAAjB,CAAhB,CAhB+B,CAkB/B;AACH;;AAEM,SAASa,YAAT,GAAiC;EACpC,OAAOzG,YAAY,CAACC,OAAb,CAAqB,gBAArB,MAA2C,MAAlD;AACH;;AAEM,SAASuI,YAAT,GAAiC;EACpC,OAAOnC,aAAP;AACH;AAED;AACA;AACA;AACA;AACA;AACA;;;AACA,eAAeuB,iBAAf,GAAqE;EAAA,IAApCa,YAAoC,uEAArB,IAAqB;;EACjExK,cAAA,CAAOI,GAAP,CAAY,kCAAZ,EADiE,CAGjE;EACA;EACA;EACA;;;EACAtB,mBAAA,CAAI2J,QAAJ,CAAa;IAAExJ,MAAM,EAAE;EAAV,CAAb,EAA8C,IAA9C,EAPiE,CASjE;;;EACAwL,oBAAA,CAAYC,cAAZ,GAA6BC,KAA7B;;EACAC,mBAAA,CAAWF,cAAX,GAA4BC,KAA5B;;EAEAE,0BAAA,CAAa3B,QAAb,CAAsB4B,OAAtB;;EACAC,iBAAA,CAASC,KAAT;;EACAC,qBAAA,CAAaP,cAAb,GAA8BM,KAA9B;;EACAE,kBAAA,CAAUC,UAAV,GAAuBH,KAAvB;;EACAI,wCAAA,CAAoBV,cAApB,GAAqCW,aAArC;;EACAC,0BAAA,CAAkBpC,QAAlB,CAA2B8B,KAA3B;;EACAO,oBAAA,CAAYrC,QAAZ,CAAqB8B,KAArB,GAnBiE,CAqBjE;EACA;EACA;;;EACAQ,gBAAA,CAAQd,cAAR,GAAyBM,KAAzB;;EAEA,IAAIR,YAAJ,EAAkB;IACd;IACA;IACA;IACA,MAAMiB,sBAAA,CAAcC,IAAd,EAAN;IACA,MAAM3G,gCAAA,CAAgBiG,KAAhB,EAAN;EACH,CAND,MAMO;IACHhL,cAAA,CAAOC,IAAP,CAAY,qDAAZ;;IACA,MAAM8E,gCAAA,CAAgB+C,MAAhB,EAAN;EACH,CAnCgE,CAqCjE;;;EACAuB,sBAAA,CAAcsC,aAAd,GAtCiE,CAwCjE;;;EACAC,uBAAA,CAAelB,cAAf,GAAgCM,KAAhC,GAzCiE,CA0CjE;EACA;;;EACA,IAAI,CAAC3B,sBAAA,CAAcC,QAAd,CAAuB,cAAvB,CAAL,EAA6C;IACzCuC,iBAAA,CAASb,KAAT;EACH,CA9CgE,CAgDjE;;;EACAc,YAAA,CAAMC,WAAN,GAAoBf,KAApB,GAjDiE,CAmDjE;;;EACA,IAAIgB,0BAAA,CAAkB9C,QAAlB,CAA2B+C,MAA/B,EAAuC;IACnC,IAAAC,kCAAA,EAAgBnH,gCAAA,CAAgBd,GAAhB,GAAsBkI,OAAtB,CAA8BH,0BAAA,CAAkB9C,QAAlB,CAA2B+C,MAAzD,CAAhB,EAAkF,KAAlF;EACH,CAtDgE,CAwDjE;EACA;;;EACAnN,mBAAA,CAAI2J,QAAJ,CAAa;IAAExJ,MAAM,EAAE;EAAV,CAAb;;EAEA,IAAIuJ,YAAY,EAAhB,EAAoB;IAChBD,UAAU;EACb;AACJ;AAED;AACA;AACA;AACA;;;AACO,eAAenJ,WAAf,GAA4C;EAC/C;EACA;EACA;EACAN,mBAAA,CAAI2K,IAAJ,CAASvK,eAAA,CAAOkN,WAAhB,EAA6B,IAA7B;;EACAzE,gBAAgB;EAChB,MAAM5E,YAAY,CAAC;IAAEsJ,gBAAgB,EAAE;EAApB,CAAD,CAAlB;EACAC,kBAAA,CAAwBC,4BAAxB,KAP+C,CAS/C;EACA;;EACA,IAAIC,kBAAA,CAAUvI,GAAV,GAAgBwI,mBAApB,EAAyC;IACrCzM,cAAA,CAAOI,GAAP,CAAW,mDAAX,EADqC,CAErC;;;IACAsM,UAAU,CAAC,MAAM;MACb7H,MAAM,CAACC,QAAP,CAAgB6H,IAAhB,GAAuBH,kBAAA,CAAUvI,GAAV,GAAgBwI,mBAAvC;IACH,CAFS,EAEP,GAFO,CAAV;EAGH,CAjB8C,CAkB/C;;;EACArE,aAAa,GAAG,KAAhB;AACH;AAED;AACA;AACA;AACA;;;AACA,eAAerF,YAAf,CAA4BrD,IAA5B,EAAkF;EAC9E,IAAImF,MAAM,CAAC9C,YAAX,EAAyB;IACrB;IACA,MAAM6K,cAAc,GAAGC,4BAAA,CAAoB3D,QAApB,CAA6B4D,cAA7B,EAAvB;;IACA,MAAMC,gBAAgB,GAAGlI,MAAM,CAAC9C,YAAP,CAAoBC,OAApB,CAA4B,sBAA5B,CAAzB;IAEA6C,MAAM,CAAC9C,YAAP,CAAoBiL,KAApB;;IACAC,4CAAA,CAAoCD,KAApC;;IAEA,IAAI;MACA,MAAMrH,cAAc,CAACuH,SAAf,CAAyB,SAAzB,EAAoC,iBAApC,CAAN;IACH,CAFD,CAEE,OAAOlM,CAAP,EAAU;MACRhB,cAAA,CAAOmE,KAAP,CAAa,8CAAb,EAA6DnD,CAA7D;IACH,CAZoB,CAcrB;;;IACA,IAAI,CAACtB,IAAI,EAAE2M,gBAAX,EAA6B;MACzBO,cAAc,CAACO,OAAf,CAAuB/G,CAAC,IAAI;QACxB,MAAM6F,MAAM,GAAG7F,CAAC,CAAC6F,MAAjB;QACA,OAAO7F,CAAC,CAAC6F,MAAT,CAFwB,CAEP;;QACjBY,4BAAA,CAAoB3D,QAApB,CAA6BkE,WAA7B,CAAyCnB,MAAzC,EAAiD7F,CAAjD;MACH,CAJD;;MAMA,IAAI2G,gBAAJ,EAAsB;QAClBlI,MAAM,CAAC9C,YAAP,CAAoBmB,OAApB,CAA4B,sBAA5B,EAAoD6J,gBAApD;MACH;IACJ;EACJ;;EAEDlI,MAAM,CAAC5B,cAAP,EAAuB+J,KAAvB,GA7B8E,CA+B9E;;EACA,MAAMvJ,GAAG,GAAG,IAAA4J,2BAAA,EAAmB;IAC3B;IACA1J,OAAO,EAAE;EAFkB,CAAnB,CAAZ;EAKA,MAAM8H,sBAAA,CAAc6B,gBAAd,EAAN;EACA,MAAM7J,GAAG,CAAC8J,WAAJ,EAAN;AACH;AAED;AACA;AACA;AACA;AACA;;;AACO,SAAS5F,gBAAT,GAAoD;EAAA,IAA1B6F,WAA0B,uEAAZ,IAAY;;EACvDzC,iBAAA,CAAS0C,IAAT;;EACAlC,oBAAA,CAAYrC,QAAZ,CAAqBuE,IAArB;;EACAxC,qBAAA,CAAaP,cAAb,GAA8B+C,IAA9B;;EACAhD,oBAAA,CAAYC,cAAZ,GAA6BC,KAA7B;;EACAkB,iBAAA,CAAS4B,IAAT;;EACAnC,0BAAA,CAAkBpC,QAAlB,CAA2BuE,IAA3B;;EACArC,wCAAA,CAAoBV,cAApB,GAAqCgD,YAArC;;EACAlC,gBAAA,CAAQd,cAAR,GAAyB+C,IAAzB;;EACA7B,uBAAA,CAAelB,cAAf,GAAgC+C,IAAhC;;EACAvC,kBAAA,CAAUyC,MAAV,IAAoBF,IAApB;;EACAhC,sBAAA,CAAcgC,IAAd;;EACA,MAAMhK,GAAG,GAAGsB,gCAAA,CAAgBd,GAAhB,EAAZ;;EACA,IAAIR,GAAJ,EAAS;IACLA,GAAG,CAACmK,UAAJ;IACAnK,GAAG,CAACoK,kBAAJ;;IAEA,IAAIL,WAAJ,EAAiB;MACbzI,gCAAA,CAAgB+I,KAAhB;;MACArC,sBAAA,CAAcqC,KAAd;IACH;EACJ;AACJ,C,CAED;;;AACAjJ,MAAM,CAACkJ,sBAAP,GAAgC,OAAO3M,KAAP,EAAsBd,WAAtB,KAA6D;EACzF,MAAM0N,UAAU,GAAG,IAAAtK,oBAAA,EAAa;IAC5BC,OAAO,EAAEvC,KADmB;IAE5Bd;EAF4B,CAAb,CAAnB;EAIA,MAAM;IAAEiF,OAAO,EAAElF;EAAX,IAAsB,MAAM2N,UAAU,CAACC,MAAX,EAAlC;EACA,MAAM1O,aAAa,CAAC;IAChBgB,aAAa,EAAEa,KADC;IAEhBd,WAFgB;IAGhBD;EAHgB,CAAD,EAIhB,IAJgB,CAAnB;AAKH,CAXD"}