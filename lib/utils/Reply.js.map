{"version":3,"file":"Reply.js","names":["getParentEventId","ev","isRedacted","replyEventId","stripPlainReply","body","lines","split","length","startsWith","shift","join","stripHTMLReply","html","sanitizeHtml","allowedTags","allowedAttributes","allowedSchemes","PERMITTED_URL_SCHEMES","exclusiveFilter","frame","tag","getNestedReplyText","permalinkCreator","formatted_body","msgtype","getContent","escapeHtml","replace","evLink","forEvent","getId","userLink","makeUserPermalink","getSender","mxid","M_BEACON_INFO","matches","getType","aTheir","isSelfLocation","MsgType","Text","Notice","trim","map","line","Image","Video","Audio","File","Location","Emote","makeReplyMixIn","mixin","threadRootId","SettingsStore","getValue","is_falling_back","relation","getRelation","rel_type","event_id","shouldDisplayReply","event","inReplyTo","getWireContent","THREAD_RELATION_TYPE","name","addReplyToMessageContent","content","replyToEvent","opts","includeLegacyFallback","nestedReply"],"sources":["../../src/utils/Reply.ts"],"sourcesContent":["/*\nCopyright 2021 Å imon Brandner <simon.bra.ag@gmail.com>\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { IContent, IEventRelation, MatrixEvent } from \"matrix-js-sdk/src/models/event\";\nimport sanitizeHtml from \"sanitize-html\";\nimport escapeHtml from \"escape-html\";\nimport { THREAD_RELATION_TYPE } from \"matrix-js-sdk/src/models/thread\";\nimport { MsgType } from \"matrix-js-sdk/src/@types/event\";\nimport { M_BEACON_INFO } from \"matrix-js-sdk/src/@types/beacon\";\n\nimport { PERMITTED_URL_SCHEMES } from \"../HtmlUtils\";\nimport { makeUserPermalink, RoomPermalinkCreator } from \"./permalinks/Permalinks\";\nimport SettingsStore from \"../settings/SettingsStore\";\nimport { isSelfLocation } from \"./location\";\n\nexport function getParentEventId(ev?: MatrixEvent): string | undefined {\n    if (!ev || ev.isRedacted()) return;\n    if (ev.replyEventId) {\n        return ev.replyEventId;\n    }\n}\n\n// Part of Replies fallback support\nexport function stripPlainReply(body: string): string {\n    // Removes lines beginning with `> ` until you reach one that doesn't.\n    const lines = body.split('\\n');\n    while (lines.length && lines[0].startsWith('> ')) lines.shift();\n    // Reply fallback has a blank line after it, so remove it to prevent leading newline\n    if (lines[0] === '') lines.shift();\n    return lines.join('\\n');\n}\n\n// Part of Replies fallback support\nexport function stripHTMLReply(html: string): string {\n    // Sanitize the original HTML for inclusion in <mx-reply>.  We allow\n    // any HTML, since the original sender could use special tags that we\n    // don't recognize, but want to pass along to any recipients who do\n    // recognize them -- recipients should be sanitizing before displaying\n    // anyways.  However, we sanitize to 1) remove any mx-reply, so that we\n    // don't generate a nested mx-reply, and 2) make sure that the HTML is\n    // properly formatted (e.g. tags are closed where necessary)\n    return sanitizeHtml(\n        html,\n        {\n            allowedTags: false, // false means allow everything\n            allowedAttributes: false,\n            // we somehow can't allow all schemes, so we allow all that we\n            // know of and mxc (for img tags)\n            allowedSchemes: [...PERMITTED_URL_SCHEMES, 'mxc'],\n            exclusiveFilter: (frame) => frame.tag === \"mx-reply\",\n        },\n    );\n}\n\n// Part of Replies fallback support\nexport function getNestedReplyText(\n    ev: MatrixEvent,\n    permalinkCreator: RoomPermalinkCreator,\n): { body: string, html: string } | null {\n    if (!ev) return null;\n\n    let { body, formatted_body: html, msgtype } = ev.getContent();\n    if (getParentEventId(ev)) {\n        if (body) body = stripPlainReply(body);\n    }\n\n    if (!body) body = \"\"; // Always ensure we have a body, for reasons.\n\n    if (html) {\n        // sanitize the HTML before we put it in an <mx-reply>\n        html = stripHTMLReply(html);\n    } else {\n        // Escape the body to use as HTML below.\n        // We also run a nl2br over the result to fix the fallback representation. We do this\n        // after converting the text to safe HTML to avoid user-provided BR's from being converted.\n        html = escapeHtml(body).replace(/\\n/g, '<br/>');\n    }\n\n    // dev note: do not rely on `body` being safe for HTML usage below.\n\n    const evLink = permalinkCreator.forEvent(ev.getId());\n    const userLink = makeUserPermalink(ev.getSender());\n    const mxid = ev.getSender();\n\n    if (M_BEACON_INFO.matches(ev.getType())) {\n        const aTheir = isSelfLocation(ev.getContent()) ? \"their\" : \"a\";\n        return {\n            html: `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>`\n            + `<br>shared ${aTheir} live location.</blockquote></mx-reply>`,\n            body: `> <${mxid}> shared ${aTheir} live location.\\n\\n`,\n        };\n    }\n\n    // This fallback contains text that is explicitly EN.\n    switch (msgtype) {\n        case MsgType.Text:\n        case MsgType.Notice: {\n            html = `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>`\n                + `<br>${html}</blockquote></mx-reply>`;\n            const lines = body.trim().split('\\n');\n            if (lines.length > 0) {\n                lines[0] = `<${mxid}> ${lines[0]}`;\n                body = lines.map((line) => `> ${line}`).join('\\n') + '\\n\\n';\n            }\n            break;\n        }\n        case MsgType.Image:\n            html = `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>`\n                + `<br>sent an image.</blockquote></mx-reply>`;\n            body = `> <${mxid}> sent an image.\\n\\n`;\n            break;\n        case MsgType.Video:\n            html = `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>`\n                + `<br>sent a video.</blockquote></mx-reply>`;\n            body = `> <${mxid}> sent a video.\\n\\n`;\n            break;\n        case MsgType.Audio:\n            html = `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>`\n                + `<br>sent an audio file.</blockquote></mx-reply>`;\n            body = `> <${mxid}> sent an audio file.\\n\\n`;\n            break;\n        case MsgType.File:\n            html = `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>`\n                + `<br>sent a file.</blockquote></mx-reply>`;\n            body = `> <${mxid}> sent a file.\\n\\n`;\n            break;\n        case MsgType.Location: {\n            const aTheir = isSelfLocation(ev.getContent()) ? \"their\" : \"a\";\n            html = `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> <a href=\"${userLink}\">${mxid}</a>`\n            + `<br>shared ${aTheir} location.</blockquote></mx-reply>`;\n            body = `> <${mxid}> shared ${aTheir} location.\\n\\n`;\n            break;\n        }\n        case MsgType.Emote: {\n            html = `<mx-reply><blockquote><a href=\"${evLink}\">In reply to</a> * `\n                + `<a href=\"${userLink}\">${mxid}</a><br>${html}</blockquote></mx-reply>`;\n            const lines = body.trim().split('\\n');\n            if (lines.length > 0) {\n                lines[0] = `* <${mxid}> ${lines[0]}`;\n                body = lines.map((line) => `> ${line}`).join('\\n') + '\\n\\n';\n            }\n            break;\n        }\n        default:\n            return null;\n    }\n\n    return { body, html };\n}\n\nexport function makeReplyMixIn(ev?: MatrixEvent): IEventRelation {\n    if (!ev) return {};\n\n    const mixin: IEventRelation = {\n        'm.in_reply_to': {\n            'event_id': ev.getId(),\n        },\n    };\n\n    if (ev.threadRootId) {\n        if (SettingsStore.getValue(\"feature_thread\")) {\n            mixin.is_falling_back = false;\n        } else {\n            // Clients that do not offer a threading UI should behave as follows when replying, for best interaction\n            // with those that do. They should set the m.in_reply_to part as usual, and then add on\n            // \"rel_type\": \"m.thread\" and \"event_id\": \"$thread_root\", copying $thread_root from the replied-to event.\n            const relation = ev.getRelation();\n            mixin.rel_type = relation.rel_type;\n            mixin.event_id = relation.event_id;\n        }\n    }\n\n    return mixin;\n}\n\nexport function shouldDisplayReply(event: MatrixEvent): boolean {\n    if (event.isRedacted()) {\n        return false;\n    }\n\n    const inReplyTo = event.getWireContent()?.[\"m.relates_to\"]?.[\"m.in_reply_to\"];\n    if (!inReplyTo) {\n        return false;\n    }\n\n    const relation = event.getRelation();\n    if (SettingsStore.getValue(\"feature_thread\") &&\n        relation?.rel_type === THREAD_RELATION_TYPE.name &&\n        relation?.is_falling_back\n    ) {\n        return false;\n    }\n\n    return !!inReplyTo.event_id;\n}\n\ninterface IAddReplyOpts {\n    permalinkCreator?: RoomPermalinkCreator;\n    includeLegacyFallback?: boolean;\n}\n\nexport function addReplyToMessageContent(\n    content: IContent,\n    replyToEvent: MatrixEvent,\n    opts: IAddReplyOpts = {\n        includeLegacyFallback: true,\n    },\n): void {\n    content[\"m.relates_to\"] = {\n        ...(content[\"m.relates_to\"] || {}),\n        ...makeReplyMixIn(replyToEvent),\n    };\n\n    if (opts.includeLegacyFallback) {\n        // Part of Replies fallback support - prepend the text we're sending with the text we're replying to\n        const nestedReply = getNestedReplyText(replyToEvent, opts.permalinkCreator);\n        if (nestedReply) {\n            if (content.formatted_body) {\n                content.formatted_body = nestedReply.html + content.formatted_body;\n            }\n            content.body = nestedReply.body + content.body;\n        }\n    }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;AAiBA;;AACA;;AACA;;AACA;;AACA;;AAEA;;AACA;;AACA;;AACA;;;;;;AAEO,SAASA,gBAAT,CAA0BC,EAA1B,EAAgE;EACnE,IAAI,CAACA,EAAD,IAAOA,EAAE,CAACC,UAAH,EAAX,EAA4B;;EAC5B,IAAID,EAAE,CAACE,YAAP,EAAqB;IACjB,OAAOF,EAAE,CAACE,YAAV;EACH;AACJ,C,CAED;;;AACO,SAASC,eAAT,CAAyBC,IAAzB,EAA+C;EAClD;EACA,MAAMC,KAAK,GAAGD,IAAI,CAACE,KAAL,CAAW,IAAX,CAAd;;EACA,OAAOD,KAAK,CAACE,MAAN,IAAgBF,KAAK,CAAC,CAAD,CAAL,CAASG,UAAT,CAAoB,IAApB,CAAvB,EAAkDH,KAAK,CAACI,KAAN,GAHA,CAIlD;;;EACA,IAAIJ,KAAK,CAAC,CAAD,CAAL,KAAa,EAAjB,EAAqBA,KAAK,CAACI,KAAN;EACrB,OAAOJ,KAAK,CAACK,IAAN,CAAW,IAAX,CAAP;AACH,C,CAED;;;AACO,SAASC,cAAT,CAAwBC,IAAxB,EAA8C;EACjD;EACA;EACA;EACA;EACA;EACA;EACA;EACA,OAAO,IAAAC,qBAAA,EACHD,IADG,EAEH;IACIE,WAAW,EAAE,KADjB;IACwB;IACpBC,iBAAiB,EAAE,KAFvB;IAGI;IACA;IACAC,cAAc,EAAE,CAAC,GAAGC,gCAAJ,EAA2B,KAA3B,CALpB;IAMIC,eAAe,EAAGC,KAAD,IAAWA,KAAK,CAACC,GAAN,KAAc;EAN9C,CAFG,CAAP;AAWH,C,CAED;;;AACO,SAASC,kBAAT,CACHrB,EADG,EAEHsB,gBAFG,EAGkC;EACrC,IAAI,CAACtB,EAAL,EAAS,OAAO,IAAP;EAET,IAAI;IAAEI,IAAF;IAAQmB,cAAc,EAAEX,IAAxB;IAA8BY;EAA9B,IAA0CxB,EAAE,CAACyB,UAAH,EAA9C;;EACA,IAAI1B,gBAAgB,CAACC,EAAD,CAApB,EAA0B;IACtB,IAAII,IAAJ,EAAUA,IAAI,GAAGD,eAAe,CAACC,IAAD,CAAtB;EACb;;EAED,IAAI,CAACA,IAAL,EAAWA,IAAI,GAAG,EAAP,CAR0B,CAQf;;EAEtB,IAAIQ,IAAJ,EAAU;IACN;IACAA,IAAI,GAAGD,cAAc,CAACC,IAAD,CAArB;EACH,CAHD,MAGO;IACH;IACA;IACA;IACAA,IAAI,GAAG,IAAAc,mBAAA,EAAWtB,IAAX,EAAiBuB,OAAjB,CAAyB,KAAzB,EAAgC,OAAhC,CAAP;EACH,CAlBoC,CAoBrC;;;EAEA,MAAMC,MAAM,GAAGN,gBAAgB,CAACO,QAAjB,CAA0B7B,EAAE,CAAC8B,KAAH,EAA1B,CAAf;EACA,MAAMC,QAAQ,GAAG,IAAAC,6BAAA,EAAkBhC,EAAE,CAACiC,SAAH,EAAlB,CAAjB;EACA,MAAMC,IAAI,GAAGlC,EAAE,CAACiC,SAAH,EAAb;;EAEA,IAAIE,qBAAA,CAAcC,OAAd,CAAsBpC,EAAE,CAACqC,OAAH,EAAtB,CAAJ,EAAyC;IACrC,MAAMC,MAAM,GAAG,IAAAC,wBAAA,EAAevC,EAAE,CAACyB,UAAH,EAAf,IAAkC,OAAlC,GAA4C,GAA3D;IACA,OAAO;MACHb,IAAI,EAAG,kCAAiCgB,MAAO,8BAA6BG,QAAS,KAAIG,IAAK,MAAxF,GACH,cAAaI,MAAO,yCAFpB;MAGHlC,IAAI,EAAG,MAAK8B,IAAK,YAAWI,MAAO;IAHhC,CAAP;EAKH,CAjCoC,CAmCrC;;;EACA,QAAQd,OAAR;IACI,KAAKgB,cAAA,CAAQC,IAAb;IACA,KAAKD,cAAA,CAAQE,MAAb;MAAqB;QACjB9B,IAAI,GAAI,kCAAiCgB,MAAO,8BAA6BG,QAAS,KAAIG,IAAK,MAAxF,GACA,OAAMtB,IAAK,0BADlB;QAEA,MAAMP,KAAK,GAAGD,IAAI,CAACuC,IAAL,GAAYrC,KAAZ,CAAkB,IAAlB,CAAd;;QACA,IAAID,KAAK,CAACE,MAAN,GAAe,CAAnB,EAAsB;UAClBF,KAAK,CAAC,CAAD,CAAL,GAAY,IAAG6B,IAAK,KAAI7B,KAAK,CAAC,CAAD,CAAI,EAAjC;UACAD,IAAI,GAAGC,KAAK,CAACuC,GAAN,CAAWC,IAAD,IAAW,KAAIA,IAAK,EAA9B,EAAiCnC,IAAjC,CAAsC,IAAtC,IAA8C,MAArD;QACH;;QACD;MACH;;IACD,KAAK8B,cAAA,CAAQM,KAAb;MACIlC,IAAI,GAAI,kCAAiCgB,MAAO,8BAA6BG,QAAS,KAAIG,IAAK,MAAxF,GACA,4CADP;MAEA9B,IAAI,GAAI,MAAK8B,IAAK,sBAAlB;MACA;;IACJ,KAAKM,cAAA,CAAQO,KAAb;MACInC,IAAI,GAAI,kCAAiCgB,MAAO,8BAA6BG,QAAS,KAAIG,IAAK,MAAxF,GACA,2CADP;MAEA9B,IAAI,GAAI,MAAK8B,IAAK,qBAAlB;MACA;;IACJ,KAAKM,cAAA,CAAQQ,KAAb;MACIpC,IAAI,GAAI,kCAAiCgB,MAAO,8BAA6BG,QAAS,KAAIG,IAAK,MAAxF,GACA,iDADP;MAEA9B,IAAI,GAAI,MAAK8B,IAAK,2BAAlB;MACA;;IACJ,KAAKM,cAAA,CAAQS,IAAb;MACIrC,IAAI,GAAI,kCAAiCgB,MAAO,8BAA6BG,QAAS,KAAIG,IAAK,MAAxF,GACA,0CADP;MAEA9B,IAAI,GAAI,MAAK8B,IAAK,oBAAlB;MACA;;IACJ,KAAKM,cAAA,CAAQU,QAAb;MAAuB;QACnB,MAAMZ,MAAM,GAAG,IAAAC,wBAAA,EAAevC,EAAE,CAACyB,UAAH,EAAf,IAAkC,OAAlC,GAA4C,GAA3D;QACAb,IAAI,GAAI,kCAAiCgB,MAAO,8BAA6BG,QAAS,KAAIG,IAAK,MAAxF,GACJ,cAAaI,MAAO,oCADvB;QAEAlC,IAAI,GAAI,MAAK8B,IAAK,YAAWI,MAAO,gBAApC;QACA;MACH;;IACD,KAAKE,cAAA,CAAQW,KAAb;MAAoB;QAChBvC,IAAI,GAAI,kCAAiCgB,MAAO,sBAAzC,GACA,YAAWG,QAAS,KAAIG,IAAK,WAAUtB,IAAK,0BADnD;QAEA,MAAMP,KAAK,GAAGD,IAAI,CAACuC,IAAL,GAAYrC,KAAZ,CAAkB,IAAlB,CAAd;;QACA,IAAID,KAAK,CAACE,MAAN,GAAe,CAAnB,EAAsB;UAClBF,KAAK,CAAC,CAAD,CAAL,GAAY,MAAK6B,IAAK,KAAI7B,KAAK,CAAC,CAAD,CAAI,EAAnC;UACAD,IAAI,GAAGC,KAAK,CAACuC,GAAN,CAAWC,IAAD,IAAW,KAAIA,IAAK,EAA9B,EAAiCnC,IAAjC,CAAsC,IAAtC,IAA8C,MAArD;QACH;;QACD;MACH;;IACD;MACI,OAAO,IAAP;EAlDR;;EAqDA,OAAO;IAAEN,IAAF;IAAQQ;EAAR,CAAP;AACH;;AAEM,SAASwC,cAAT,CAAwBpD,EAAxB,EAA0D;EAC7D,IAAI,CAACA,EAAL,EAAS,OAAO,EAAP;EAET,MAAMqD,KAAqB,GAAG;IAC1B,iBAAiB;MACb,YAAYrD,EAAE,CAAC8B,KAAH;IADC;EADS,CAA9B;;EAMA,IAAI9B,EAAE,CAACsD,YAAP,EAAqB;IACjB,IAAIC,sBAAA,CAAcC,QAAd,CAAuB,gBAAvB,CAAJ,EAA8C;MAC1CH,KAAK,CAACI,eAAN,GAAwB,KAAxB;IACH,CAFD,MAEO;MACH;MACA;MACA;MACA,MAAMC,QAAQ,GAAG1D,EAAE,CAAC2D,WAAH,EAAjB;MACAN,KAAK,CAACO,QAAN,GAAiBF,QAAQ,CAACE,QAA1B;MACAP,KAAK,CAACQ,QAAN,GAAiBH,QAAQ,CAACG,QAA1B;IACH;EACJ;;EAED,OAAOR,KAAP;AACH;;AAEM,SAASS,kBAAT,CAA4BC,KAA5B,EAAyD;EAC5D,IAAIA,KAAK,CAAC9D,UAAN,EAAJ,EAAwB;IACpB,OAAO,KAAP;EACH;;EAED,MAAM+D,SAAS,GAAGD,KAAK,CAACE,cAAN,KAAyB,cAAzB,IAA2C,eAA3C,CAAlB;;EACA,IAAI,CAACD,SAAL,EAAgB;IACZ,OAAO,KAAP;EACH;;EAED,MAAMN,QAAQ,GAAGK,KAAK,CAACJ,WAAN,EAAjB;;EACA,IAAIJ,sBAAA,CAAcC,QAAd,CAAuB,gBAAvB,KACAE,QAAQ,EAAEE,QAAV,KAAuBM,4BAAA,CAAqBC,IAD5C,IAEAT,QAAQ,EAAED,eAFd,EAGE;IACE,OAAO,KAAP;EACH;;EAED,OAAO,CAAC,CAACO,SAAS,CAACH,QAAnB;AACH;;AAOM,SAASO,wBAAT,CACHC,OADG,EAEHC,YAFG,EAMC;EAAA,IAHJC,IAGI,uEAHkB;IAClBC,qBAAqB,EAAE;EADL,CAGlB;EACJH,OAAO,CAAC,cAAD,CAAP,mCACQA,OAAO,CAAC,cAAD,CAAP,IAA2B,EADnC,GAEOjB,cAAc,CAACkB,YAAD,CAFrB;;EAKA,IAAIC,IAAI,CAACC,qBAAT,EAAgC;IAC5B;IACA,MAAMC,WAAW,GAAGpD,kBAAkB,CAACiD,YAAD,EAAeC,IAAI,CAACjD,gBAApB,CAAtC;;IACA,IAAImD,WAAJ,EAAiB;MACb,IAAIJ,OAAO,CAAC9C,cAAZ,EAA4B;QACxB8C,OAAO,CAAC9C,cAAR,GAAyBkD,WAAW,CAAC7D,IAAZ,GAAmByD,OAAO,CAAC9C,cAApD;MACH;;MACD8C,OAAO,CAACjE,IAAR,GAAeqE,WAAW,CAACrE,IAAZ,GAAmBiE,OAAO,CAACjE,IAA1C;IACH;EACJ;AACJ"}