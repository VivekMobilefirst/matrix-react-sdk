{"version":3,"file":"MultiInviter.js","names":["InviteState","UNKNOWN_PROFILE_ERRORS","USER_ALREADY_JOINED","USER_ALREADY_INVITED","MultiInviter","constructor","roomId","progressCallback","matrixClient","MatrixClientPeg","get","fatal","_fatal","invite","addresses","reason","sendSharedHistoryKeys","length","Error","push","addr","getAddressType","completionStates","errors","errcode","errorText","_t","deferred","defer","inviteMore","isRoomEncrypted","promise","room","getRoom","visibilityEvent","currentState","getStateEvents","EventType","RoomHistoryVisibility","visibility","getContent","history_visibility","HistoryVisibility","WorldReadable","Shared","then","states","invitedUsers","state","Object","entries","Invited","AddressType","MatrixUserId","logger","log","cancel","busy","canceled","reject","getCompletionState","getErrorText","inviteToRoom","ignoreProfile","addrType","Email","inviteByEmail","member","getMember","membership","MatrixError","error","SettingsStore","getValue","getProfileInfo","err","undefined","doInvite","address","Promise","resolve","catch","isSpace","isSpaceRoom","setTimeout","warn","nextIndex","keys","unknownProfileUsers","filter","a","includes","inviteUnknowns","promises","map","u","all","Modal","createDialog","AskInviteAnywayDialog","userId","onInviteAnyways","onGiveUp"],"sources":["../../src/utils/MultiInviter.ts"],"sourcesContent":["/*\nCopyright 2016 - 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { MatrixError } from \"matrix-js-sdk/src/http-api\";\nimport { defer, IDeferred } from \"matrix-js-sdk/src/utils\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\nimport { MatrixClient } from \"matrix-js-sdk/src/client\";\nimport { EventType } from \"matrix-js-sdk/src/@types/event\";\nimport { HistoryVisibility } from \"matrix-js-sdk/src/@types/partials\";\n\nimport { MatrixClientPeg } from '../MatrixClientPeg';\nimport { AddressType, getAddressType } from '../UserAddress';\nimport { _t } from \"../languageHandler\";\nimport Modal from \"../Modal\";\nimport SettingsStore from \"../settings/SettingsStore\";\nimport AskInviteAnywayDialog from \"../components/views/dialogs/AskInviteAnywayDialog\";\n\nexport enum InviteState {\n    Invited = \"invited\",\n    Error = \"error\",\n}\n\ninterface IError {\n    errorText: string;\n    errcode: string;\n}\n\nconst UNKNOWN_PROFILE_ERRORS = ['M_NOT_FOUND', 'M_USER_NOT_FOUND', 'M_PROFILE_UNDISCLOSED', 'M_PROFILE_NOT_FOUND'];\n\nexport type CompletionStates = Record<string, InviteState>;\n\nconst USER_ALREADY_JOINED = \"IO.ELEMENT.ALREADY_JOINED\";\nconst USER_ALREADY_INVITED = \"IO.ELEMENT.ALREADY_INVITED\";\n\n/**\n * Invites multiple addresses to a room, handling rate limiting from the server\n */\nexport default class MultiInviter {\n    private readonly matrixClient: MatrixClient;\n\n    private canceled = false;\n    private addresses: string[] = [];\n    private busy = false;\n    private _fatal = false;\n    private completionStates: CompletionStates = {}; // State of each address (invited or error)\n    private errors: Record<string, IError> = {}; // { address: {errorText, errcode} }\n    private deferred: IDeferred<CompletionStates> = null;\n    private reason: string = null;\n\n    /**\n     * @param {string} roomId The ID of the room to invite to\n     * @param {function} progressCallback optional callback, fired after each invite.\n     */\n    constructor(private roomId: string, private readonly progressCallback?: () => void) {\n        this.matrixClient = MatrixClientPeg.get();\n    }\n\n    public get fatal() {\n        return this._fatal;\n    }\n\n    /**\n     * Invite users to this room. This may only be called once per\n     * instance of the class.\n     *\n     * @param {array} addresses Array of addresses to invite\n     * @param {string} reason Reason for inviting (optional)\n     * @param {boolean} sendSharedHistoryKeys whether to share e2ee keys with the invitees if applicable.\n     * @returns {Promise} Resolved when all invitations in the queue are complete\n     */\n    public invite(addresses, reason?: string, sendSharedHistoryKeys = false): Promise<CompletionStates> {\n        if (this.addresses.length > 0) {\n            throw new Error(\"Already inviting/invited\");\n        }\n        this.addresses.push(...addresses);\n        this.reason = reason;\n\n        for (const addr of this.addresses) {\n            if (getAddressType(addr) === null) {\n                this.completionStates[addr] = InviteState.Error;\n                this.errors[addr] = {\n                    errcode: 'M_INVALID',\n                    errorText: _t('Unrecognised address'),\n                };\n            }\n        }\n        this.deferred = defer<CompletionStates>();\n        this.inviteMore(0);\n\n        if (!sendSharedHistoryKeys || !this.roomId || !this.matrixClient.isRoomEncrypted(this.roomId)) {\n            return this.deferred.promise;\n        }\n\n        const room = this.matrixClient.getRoom(this.roomId);\n        const visibilityEvent = room?.currentState.getStateEvents(EventType.RoomHistoryVisibility, \"\");\n        const visibility = visibilityEvent?.getContent().history_visibility;\n\n        if (visibility !== HistoryVisibility.WorldReadable && visibility !== HistoryVisibility.Shared) {\n            return this.deferred.promise;\n        }\n\n        return this.deferred.promise.then(async states => {\n            const invitedUsers = [];\n            for (const [addr, state] of Object.entries(states)) {\n                if (state === InviteState.Invited && getAddressType(addr) === AddressType.MatrixUserId) {\n                    invitedUsers.push(addr);\n                }\n            }\n\n            logger.log(\"Sharing history with\", invitedUsers);\n            this.matrixClient.sendSharedHistoryKeys(this.roomId, invitedUsers); // do this in the background\n\n            return states;\n        });\n    }\n\n    /**\n     * Stops inviting. Causes promises returned by invite() to be rejected.\n     */\n    public cancel(): void {\n        if (!this.busy) return;\n\n        this.canceled = true;\n        this.deferred.reject(new Error('canceled'));\n    }\n\n    public getCompletionState(addr: string): InviteState {\n        return this.completionStates[addr];\n    }\n\n    public getErrorText(addr: string): string {\n        return this.errors[addr] ? this.errors[addr].errorText : null;\n    }\n\n    private async inviteToRoom(roomId: string, addr: string, ignoreProfile = false): Promise<{}> {\n        const addrType = getAddressType(addr);\n\n        if (addrType === AddressType.Email) {\n            return this.matrixClient.inviteByEmail(roomId, addr);\n        } else if (addrType === AddressType.MatrixUserId) {\n            const room = this.matrixClient.getRoom(roomId);\n            if (!room) throw new Error(\"Room not found\");\n\n            const member = room.getMember(addr);\n            if (member?.membership === \"join\") {\n                throw new MatrixError({\n                    errcode: USER_ALREADY_JOINED,\n                    error: \"Member already joined\",\n                });\n            } else if (member?.membership === \"invite\") {\n                throw new MatrixError({\n                    errcode: USER_ALREADY_INVITED,\n                    error: \"Member already invited\",\n                });\n            }\n\n            if (!ignoreProfile && SettingsStore.getValue(\"promptBeforeInviteUnknownUsers\", this.roomId)) {\n                try {\n                    await this.matrixClient.getProfileInfo(addr);\n                } catch (err) {\n                    // The error handling during the invitation process covers any API.\n                    // Some errors must to me mapped from profile API errors to more specific ones to avoid collisions.\n                    switch (err.errcode) {\n                        case 'M_FORBIDDEN':\n                            throw new MatrixError({ errcode: 'M_PROFILE_UNDISCLOSED' });\n                        case 'M_NOT_FOUND':\n                            throw new MatrixError({ errcode: 'M_USER_NOT_FOUND' });\n                        default:\n                            throw err;\n                    }\n                }\n            }\n\n            return this.matrixClient.invite(roomId, addr, undefined, this.reason);\n        } else {\n            throw new Error('Unsupported address');\n        }\n    }\n\n    private doInvite(address: string, ignoreProfile = false): Promise<void> {\n        return new Promise<void>((resolve, reject) => {\n            logger.log(`Inviting ${address}`);\n\n            const doInvite = this.inviteToRoom(this.roomId, address, ignoreProfile);\n            doInvite.then(() => {\n                if (this.canceled) {\n                    return;\n                }\n\n                this.completionStates[address] = InviteState.Invited;\n                delete this.errors[address];\n\n                resolve();\n                this.progressCallback?.();\n            }).catch((err) => {\n                if (this.canceled) {\n                    return;\n                }\n\n                logger.error(err);\n\n                const isSpace = this.roomId && this.matrixClient.getRoom(this.roomId)?.isSpaceRoom();\n\n                let errorText: string;\n                let fatal = false;\n                switch (err.errcode) {\n                    case \"M_FORBIDDEN\":\n                        if (isSpace) {\n                            errorText = _t('You do not have permission to invite people to this space.');\n                        } else {\n                            errorText = _t('You do not have permission to invite people to this room.');\n                        }\n                        fatal = true;\n                        break;\n                    case USER_ALREADY_INVITED:\n                        if (isSpace) {\n                            errorText = _t(\"User is already invited to the space\");\n                        } else {\n                            errorText = _t(\"User is already invited to the room\");\n                        }\n                        break;\n                    case USER_ALREADY_JOINED:\n                        if (isSpace) {\n                            errorText = _t(\"User is already in the space\");\n                        } else {\n                            errorText = _t(\"User is already in the room\");\n                        }\n                        break;\n                    case \"M_LIMIT_EXCEEDED\":\n                        // we're being throttled so wait a bit & try again\n                        setTimeout(() => {\n                            this.doInvite(address, ignoreProfile).then(resolve, reject);\n                        }, 5000);\n                        return;\n                    case \"M_NOT_FOUND\":\n                    case \"M_USER_NOT_FOUND\":\n                        errorText = _t(\"User does not exist\");\n                        break;\n                    case \"M_PROFILE_UNDISCLOSED\":\n                        errorText = _t(\"User may or may not exist\");\n                        break;\n                    case \"M_PROFILE_NOT_FOUND\":\n                        if (!ignoreProfile) {\n                            // Invite without the profile check\n                            logger.warn(`User ${address} does not have a profile - inviting anyways automatically`);\n                            this.doInvite(address, true).then(resolve, reject);\n                            return;\n                        }\n                        break;\n                    case \"M_BAD_STATE\":\n                        errorText = _t(\"The user must be unbanned before they can be invited.\");\n                        break;\n                    case \"M_UNSUPPORTED_ROOM_VERSION\":\n                        if (isSpace) {\n                            errorText = _t(\"The user's homeserver does not support the version of the space.\");\n                        } else {\n                            errorText = _t(\"The user's homeserver does not support the version of the room.\");\n                        }\n                        break;\n                }\n\n                if (!errorText) {\n                    errorText = _t('Unknown server error');\n                }\n\n                this.completionStates[address] = InviteState.Error;\n                this.errors[address] = { errorText, errcode: err.errcode };\n\n                this.busy = !fatal;\n                this._fatal = fatal;\n\n                if (fatal) {\n                    reject(err);\n                } else {\n                    resolve();\n                }\n            });\n        });\n    }\n\n    private inviteMore(nextIndex: number, ignoreProfile = false): void {\n        if (this.canceled) {\n            return;\n        }\n\n        if (nextIndex === this.addresses.length) {\n            this.busy = false;\n            if (Object.keys(this.errors).length > 0) {\n                // There were problems inviting some people - see if we can invite them\n                // without caring if they exist or not.\n                const unknownProfileUsers = Object.keys(this.errors)\n                    .filter(a => UNKNOWN_PROFILE_ERRORS.includes(this.errors[a].errcode));\n\n                if (unknownProfileUsers.length > 0) {\n                    const inviteUnknowns = () => {\n                        const promises = unknownProfileUsers.map(u => this.doInvite(u, true));\n                        Promise.all(promises).then(() => this.deferred.resolve(this.completionStates));\n                    };\n\n                    if (!SettingsStore.getValue(\"promptBeforeInviteUnknownUsers\", this.roomId)) {\n                        inviteUnknowns();\n                        return;\n                    }\n\n                    logger.log(\"Showing failed to invite dialog...\");\n                    Modal.createDialog(AskInviteAnywayDialog, {\n                        unknownProfileUsers: unknownProfileUsers.map(u => ({\n                            userId: u,\n                            errorText: this.errors[u].errorText,\n                        })),\n                        onInviteAnyways: () => inviteUnknowns(),\n                        onGiveUp: () => {\n                            // Fake all the completion states because we already warned the user\n                            for (const addr of unknownProfileUsers) {\n                                this.completionStates[addr] = InviteState.Invited;\n                            }\n                            this.deferred.resolve(this.completionStates);\n                        },\n                    });\n                    return;\n                }\n            }\n            this.deferred.resolve(this.completionStates);\n            return;\n        }\n\n        const addr = this.addresses[nextIndex];\n\n        // don't try to invite it if it's an invalid address\n        // (it will already be marked as an error though,\n        // so no need to do so again)\n        if (getAddressType(addr) === null) {\n            this.inviteMore(nextIndex + 1);\n            return;\n        }\n\n        // don't re-invite (there's no way in the UI to do this, but\n        // for sanity's sake)\n        if (this.completionStates[addr] === InviteState.Invited) {\n            this.inviteMore(nextIndex + 1);\n            return;\n        }\n\n        this.doInvite(addr, ignoreProfile).then(() => {\n            this.inviteMore(nextIndex + 1, ignoreProfile);\n        }).catch(() => this.deferred.resolve(this.completionStates));\n    }\n}\n"],"mappings":"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"}