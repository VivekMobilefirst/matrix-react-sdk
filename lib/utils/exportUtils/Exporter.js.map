{"version":3,"file":"Exporter.js","names":["Exporter","constructor","room","exportType","exportOptions","setProgressText","maxSize","numberOfMessages","Error","client","MatrixClientPeg","get","window","addEventListener","onBeforeUnload","e","preventDefault","returnValue","_t","updateProgress","progress","log","show","logger","addFile","filePath","blob","file","name","files","push","downloadZIP","brand","SdkConfig","filenameWithoutExt","formatFullDateNoDay","Date","filename","default","JSZip","zip","cancelled","cleanUp","content","generateAsync","type","saveAs","removeEventListener","cancelExport","downloadPlainText","fileName","text","Blob","setEventMetadata","event","roomState","getRoom","roomId","currentState","sender","getSentinelMember","getSender","getType","target","getStateKey","getLimit","limit","ExportType","LastNMessages","Timeline","getRequiredEvents","eventMapper","getEventMapper","prevToken","events","eventsPerCrawl","Math","min","res","createMessagesRequest","Direction","Backward","chunk","length","matrixEvents","map","mxEv","count","total","end","i","floor","decryptionPromises","filter","isEncrypted","decryptEventIfNeeded","isRetry","emit","Promise","all","getMediaBlob","getContent","shouldDecrypt","hasOwnProperty","decryptFile","media","mediaFromContent","image","fetch","srcHttp","err","splitFileName","lastDot","lastIndexOf","slice","ext","getFilePath","mediaType","msgtype","fileDirectory","fileDate","getTs","fileExt","body","isVoiceMessage","isReply","relatesTo","isAttachment","attachmentTypes","includes"],"sources":["../../../src/utils/exportUtils/Exporter.ts"],"sourcesContent":["/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\nimport { Room } from \"matrix-js-sdk/src/models/room\";\nimport { MatrixClient } from \"matrix-js-sdk/src/client\";\nimport { Direction } from \"matrix-js-sdk/src/models/event-timeline\";\nimport { saveAs } from \"file-saver\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\n\nimport { MatrixClientPeg } from \"../../MatrixClientPeg\";\nimport { ExportType, IExportOptions } from \"./exportUtils\";\nimport { decryptFile } from \"../DecryptFile\";\nimport { mediaFromContent } from \"../../customisations/Media\";\nimport { formatFullDateNoDay } from \"../../DateUtils\";\nimport { isVoiceMessage } from \"../EventUtils\";\nimport { IMediaEventContent } from \"../../customisations/models/IMediaEventContent\";\nimport { _t } from \"../../languageHandler\";\nimport SdkConfig from \"../../SdkConfig\";\n\ntype BlobFile = {\n    name: string;\n    blob: Blob;\n};\n\nexport default abstract class Exporter {\n    protected files: BlobFile[] = [];\n    protected client: MatrixClient;\n    protected cancelled = false;\n\n    protected constructor(\n        protected room: Room,\n        protected exportType: ExportType,\n        protected exportOptions: IExportOptions,\n        protected setProgressText: React.Dispatch<React.SetStateAction<string>>,\n    ) {\n        if (exportOptions.maxSize < 1 * 1024 * 1024|| // Less than 1 MB\n            exportOptions.maxSize > 8000 * 1024 * 1024 || // More than 8 GB\n            exportOptions.numberOfMessages > 10**8\n        ) {\n            throw new Error(\"Invalid export options\");\n        }\n        this.client = MatrixClientPeg.get();\n        window.addEventListener(\"beforeunload\", this.onBeforeUnload);\n    }\n\n    protected onBeforeUnload(e: BeforeUnloadEvent): string {\n        e.preventDefault();\n        return e.returnValue = _t(\"Are you sure you want to exit during this export?\");\n    }\n\n    protected updateProgress(progress: string, log = true, show = true): void {\n        if (log) logger.log(progress);\n        if (show) this.setProgressText(progress);\n    }\n\n    protected addFile(filePath: string, blob: Blob): void {\n        const file = {\n            name: filePath,\n            blob,\n        };\n        this.files.push(file);\n    }\n\n    protected async downloadZIP(): Promise<string | void> {\n        const brand = SdkConfig.get().brand;\n        const filenameWithoutExt = `${brand} - Chat Export - ${formatFullDateNoDay(new Date())}`;\n        const filename = `${filenameWithoutExt}.zip`;\n        const { default: JSZip } = await import('jszip');\n\n        const zip = new JSZip();\n        // Create a writable stream to the directory\n        if (!this.cancelled) this.updateProgress(_t(\"Generating a ZIP\"));\n        else return this.cleanUp();\n\n        for (const file of this.files) zip.file(filenameWithoutExt + \"/\" + file.name, file.blob);\n\n        const content = await zip.generateAsync({ type: \"blob\" });\n\n        saveAs(content, filename);\n    }\n\n    protected cleanUp(): string {\n        logger.log(\"Cleaning up...\");\n        window.removeEventListener(\"beforeunload\", this.onBeforeUnload);\n        return \"\";\n    }\n\n    public async cancelExport(): Promise<void> {\n        logger.log(\"Cancelling export...\");\n        this.cancelled = true;\n    }\n\n    protected downloadPlainText(fileName: string, text: string) {\n        const content = new Blob([text], { type: \"text\" });\n        saveAs(content, fileName);\n    }\n\n    protected setEventMetadata(event: MatrixEvent): MatrixEvent {\n        const roomState = this.client.getRoom(this.room.roomId).currentState;\n        event.sender = roomState.getSentinelMember(\n            event.getSender(),\n        );\n        if (event.getType() === \"m.room.member\") {\n            event.target = roomState.getSentinelMember(\n                event.getStateKey(),\n            );\n        }\n        return event;\n    }\n\n    public getLimit(): number {\n        let limit: number;\n        switch (this.exportType) {\n            case ExportType.LastNMessages:\n                limit = this.exportOptions.numberOfMessages;\n                break;\n            case ExportType.Timeline:\n                limit = 40;\n                break;\n            default:\n                limit = 10**8;\n        }\n        return limit;\n    }\n\n    protected async getRequiredEvents(): Promise<MatrixEvent[]> {\n        const eventMapper = this.client.getEventMapper();\n\n        let prevToken: string|null = null;\n        let limit = this.getLimit();\n        const events: MatrixEvent[] = [];\n\n        while (limit) {\n            const eventsPerCrawl = Math.min(limit, 1000);\n            const res = await this.client.createMessagesRequest(\n                this.room.roomId,\n                prevToken,\n                eventsPerCrawl,\n                Direction.Backward,\n            );\n\n            if (this.cancelled) {\n                this.cleanUp();\n                return [];\n            }\n\n            if (res.chunk.length === 0) break;\n\n            limit -= res.chunk.length;\n\n            const matrixEvents: MatrixEvent[] = res.chunk.map(eventMapper);\n\n            for (const mxEv of matrixEvents) {\n                // if (this.exportOptions.startDate && mxEv.getTs() < this.exportOptions.startDate) {\n                //     // Once the last message received is older than the start date, we break out of both the loops\n                //     limit = 0;\n                //     break;\n                // }\n                events.push(mxEv);\n            }\n\n            if (this.exportType === ExportType.LastNMessages) {\n                this.updateProgress(_t(\"Fetched %(count)s events out of %(total)s\", {\n                    count: events.length,\n                    total: this.exportOptions.numberOfMessages,\n                }));\n            } else {\n                this.updateProgress(_t(\"Fetched %(count)s events so far\", {\n                    count: events.length,\n                }));\n            }\n\n            prevToken = res.end;\n        }\n        // Reverse the events so that we preserve the order\n        for (let i = 0; i < Math.floor(events.length/2); i++) {\n            [events[i], events[events.length - i - 1]] = [events[events.length - i - 1], events[i]];\n        }\n\n        const decryptionPromises = events\n            .filter(event => event.isEncrypted())\n            .map(event => {\n                return this.client.decryptEventIfNeeded(event, {\n                    isRetry: true,\n                    emit: false,\n                });\n            });\n\n        // Wait for all the events to get decrypted.\n        await Promise.all(decryptionPromises);\n\n        for (let i = 0; i < events.length; i++) this.setEventMetadata(events[i]);\n\n        return events;\n    }\n\n    protected async getMediaBlob(event: MatrixEvent): Promise<Blob> {\n        let blob: Blob;\n        try {\n            const isEncrypted = event.isEncrypted();\n            const content: IMediaEventContent = event.getContent();\n            const shouldDecrypt = isEncrypted && content.hasOwnProperty(\"file\") && event.getType() !== \"m.sticker\";\n            if (shouldDecrypt) {\n                blob = await decryptFile(content.file);\n            } else {\n                const media = mediaFromContent(content);\n                const image = await fetch(media.srcHttp);\n                blob = await image.blob();\n            }\n        } catch (err) {\n            logger.log(\"Error decrypting media\");\n        }\n        return blob;\n    }\n\n    public splitFileName(file: string): string[] {\n        const lastDot = file.lastIndexOf('.');\n        if (lastDot === -1) return [file, \"\"];\n        const fileName = file.slice(0, lastDot);\n        const ext = file.slice(lastDot + 1);\n        return [fileName, '.' + ext];\n    }\n\n    public getFilePath(event: MatrixEvent): string {\n        const mediaType = event.getContent().msgtype;\n        let fileDirectory: string;\n        switch (mediaType) {\n            case \"m.image\":\n                fileDirectory = \"images\";\n                break;\n            case \"m.video\":\n                fileDirectory = \"videos\";\n                break;\n            case \"m.audio\":\n                fileDirectory = \"audio\";\n                break;\n            default:\n                fileDirectory = event.getType() === \"m.sticker\" ? \"stickers\" : \"files\";\n        }\n        const fileDate = formatFullDateNoDay(new Date(event.getTs()));\n        let [fileName, fileExt] = this.splitFileName(event.getContent().body);\n\n        if (event.getType() === \"m.sticker\") fileExt = \".png\";\n        if (isVoiceMessage(event)) fileExt = \".ogg\";\n\n        return fileDirectory + \"/\" + fileName + '-' + fileDate + fileExt;\n    }\n\n    protected isReply(event: MatrixEvent): boolean {\n        const isEncrypted = event.isEncrypted();\n        // If encrypted, in_reply_to lies in event.event.content\n        const content = isEncrypted ? event.event.content : event.getContent();\n        const relatesTo = content[\"m.relates_to\"];\n        return !!(relatesTo && relatesTo[\"m.in_reply_to\"]);\n    }\n\n    protected isAttachment(mxEv: MatrixEvent): boolean {\n        const attachmentTypes = [\"m.sticker\", \"m.image\", \"m.file\", \"m.video\", \"m.audio\"];\n        return mxEv.getType() === attachmentTypes[0] || attachmentTypes.includes(mxEv.getContent().msgtype);\n    }\n\n    abstract export(): Promise<void>;\n}\n"],"mappings":"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"}