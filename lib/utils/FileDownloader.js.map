{"version":3,"file":"FileDownloader.js","names":["DEFAULT_STYLES","imgSrc","imgStyle","style","textContent","managedIframe","onLoadPromise","getManagedIframe","iframe","document","createElement","body","appendChild","display","sandbox","Promise","resolve","onload","src","FileDownloader","constructor","iframeFn","managed","download","blob","name","autoDownload","opts","contentWindow","postMessage","auto"],"sources":["../../src/utils/FileDownloader.ts"],"sourcesContent":["/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nexport type getIframeFn = () => HTMLIFrameElement; // eslint-disable-line @typescript-eslint/naming-convention\n\nexport const DEFAULT_STYLES = {\n    imgSrc: \"\",\n    imgStyle: null, // css props\n    style: \"\",\n    textContent: \"\",\n};\n\ntype DownloadOptions = {\n    blob: Blob;\n    name: string;\n    autoDownload?: boolean;\n    opts?: typeof DEFAULT_STYLES;\n};\n\n// set up the iframe as a singleton so we don't have to figure out destruction of it down the line.\nlet managedIframe: HTMLIFrameElement;\nlet onLoadPromise: Promise<void>;\nfunction getManagedIframe(): { iframe: HTMLIFrameElement, onLoadPromise: Promise<void> } {\n    if (managedIframe) return { iframe: managedIframe, onLoadPromise };\n\n    managedIframe = document.createElement(\"iframe\");\n\n    // Need to append the iframe in order for the browser to load it.\n    document.body.appendChild(managedIframe);\n\n    // Dev note: the reassignment warnings are entirely incorrect here.\n\n    managedIframe.style.display = \"none\";\n\n    // @ts-ignore\n    // noinspection JSConstantReassignment\n    managedIframe.sandbox = \"allow-scripts allow-downloads allow-downloads-without-user-activation\";\n\n    onLoadPromise = new Promise(resolve => {\n        managedIframe.onload = () => {\n            resolve();\n        };\n        managedIframe.src = \"usercontent/\"; // XXX: Should come from the skin\n    });\n\n    return { iframe: managedIframe, onLoadPromise };\n}\n\n// TODO: If we decide to keep the download link behaviour, we should bring the style management into here.\n\n/**\n * Helper to handle safe file downloads. This operates off an iframe for reasons described\n * by the blob helpers. By default, this will use a hidden iframe to manage the download\n * through a user content wrapper, but can be given an iframe reference if the caller needs\n * additional control over the styling/position of the iframe itself.\n */\nexport class FileDownloader {\n    private onLoadPromise: Promise<void>;\n\n    /**\n     * Creates a new file downloader\n     * @param iframeFn Function to get a pre-configured iframe. Set to null to have the downloader\n     * use a generic, hidden, iframe.\n     */\n    constructor(private iframeFn: getIframeFn = null) {\n    }\n\n    private get iframe(): HTMLIFrameElement {\n        const iframe = this.iframeFn?.();\n        if (!iframe) {\n            const managed = getManagedIframe();\n            this.onLoadPromise = managed.onLoadPromise;\n            return managed.iframe;\n        }\n        this.onLoadPromise = null;\n        return iframe;\n    }\n\n    public async download({ blob, name, autoDownload = true, opts = DEFAULT_STYLES }: DownloadOptions) {\n        const iframe = this.iframe; // get the iframe first just in case we need to await onload\n        if (this.onLoadPromise) await this.onLoadPromise;\n        iframe.contentWindow.postMessage({\n            ...opts,\n            blob: blob,\n            download: name,\n            auto: autoDownload,\n        }, '*');\n    }\n}\n"],"mappings":";;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEmD;AAE5C,MAAMA,cAAc,GAAG;EAC1BC,MAAM,EAAE,EADkB;EAE1BC,QAAQ,EAAE,IAFgB;EAEV;EAChBC,KAAK,EAAE,EAHmB;EAI1BC,WAAW,EAAE;AAJa,CAAvB;;AAcP;AACA,IAAIC,aAAJ;AACA,IAAIC,aAAJ;;AACA,SAASC,gBAAT,GAAyF;EACrF,IAAIF,aAAJ,EAAmB,OAAO;IAAEG,MAAM,EAAEH,aAAV;IAAyBC;EAAzB,CAAP;EAEnBD,aAAa,GAAGI,QAAQ,CAACC,aAAT,CAAuB,QAAvB,CAAhB,CAHqF,CAKrF;;EACAD,QAAQ,CAACE,IAAT,CAAcC,WAAd,CAA0BP,aAA1B,EANqF,CAQrF;;EAEAA,aAAa,CAACF,KAAd,CAAoBU,OAApB,GAA8B,MAA9B,CAVqF,CAYrF;EACA;;EACAR,aAAa,CAACS,OAAd,GAAwB,uEAAxB;EAEAR,aAAa,GAAG,IAAIS,OAAJ,CAAYC,OAAO,IAAI;IACnCX,aAAa,CAACY,MAAd,GAAuB,MAAM;MACzBD,OAAO;IACV,CAFD;;IAGAX,aAAa,CAACa,GAAd,GAAoB,cAApB,CAJmC,CAIC;EACvC,CALe,CAAhB;EAOA,OAAO;IAAEV,MAAM,EAAEH,aAAV;IAAyBC;EAAzB,CAAP;AACH,C,CAED;;AAEA;AACA;AACA;AACA;AACA;AACA;;;AACO,MAAMa,cAAN,CAAqB;EAGxB;AACJ;AACA;AACA;AACA;EACIC,WAAW,GAAuC;IAAA,IAA9BC,QAA8B,uEAAN,IAAM;IAAA,KAA9BA,QAA8B,GAA9BA,QAA8B;IAAA;EACjD;;EAEiB,IAANb,MAAM,GAAsB;IACpC,MAAMA,MAAM,GAAG,KAAKa,QAAL,IAAf;;IACA,IAAI,CAACb,MAAL,EAAa;MACT,MAAMc,OAAO,GAAGf,gBAAgB,EAAhC;MACA,KAAKD,aAAL,GAAqBgB,OAAO,CAAChB,aAA7B;MACA,OAAOgB,OAAO,CAACd,MAAf;IACH;;IACD,KAAKF,aAAL,GAAqB,IAArB;IACA,OAAOE,MAAP;EACH;;EAEoB,MAARe,QAAQ,OAA8E;IAAA,IAA7E;MAAEC,IAAF;MAAQC,IAAR;MAAcC,YAAY,GAAG,IAA7B;MAAmCC,IAAI,GAAG3B;IAA1C,CAA6E;IAC/F,MAAMQ,MAAM,GAAG,KAAKA,MAApB,CAD+F,CACnE;;IAC5B,IAAI,KAAKF,aAAT,EAAwB,MAAM,KAAKA,aAAX;IACxBE,MAAM,CAACoB,aAAP,CAAqBC,WAArB,iCACOF,IADP;MAEIH,IAAI,EAAEA,IAFV;MAGID,QAAQ,EAAEE,IAHd;MAIIK,IAAI,EAAEJ;IAJV,IAKG,GALH;EAMH;;AA/BuB"}