{"version":3,"file":"WidgetUtils.js","names":["WIDGET_WAIT_TIME","WidgetUtils","canUserModifyWidgets","roomId","logger","warn","client","MatrixClientPeg","get","room","getRoom","me","credentials","userId","getMyMembership","currentState","maySendStateEvent","isScalarUrl","testUrlString","error","testUrl","url","parse","scalarUrls","SdkConfig","integrations_widgets_urls","length","defaultManager","IntegrationManagers","sharedInstance","getPrimaryManager","apiUrl","i","scalarUrl","protocol","host","pathname","startsWith","waitForUserWidget","widgetId","add","Promise","resolve","reject","eventInIntendedState","ev","getContent","undefined","startingAccountDataEvent","getAccountData","onAccountData","currentAccountDataEvent","removeListener","ClientEvent","AccountData","clearTimeout","timerId","setTimeout","Error","on","waitForRoomWidget","eventsInIntendedState","evList","widgetPresent","some","startingWidgetEvents","getStateEvents","onRoomStateEvents","getRoomId","getType","currentWidgetEvents","RoomStateEvent","Events","setUserWidget","widgetType","widgetUrl","widgetName","widgetData","content","type","preferred","name","data","userWidgets","objectClone","getUserWidgets","e","addingWidget","Boolean","sender","getUserId","state_key","id","setAccountData","then","dis","dispatch","action","setRoomWidget","widgetAvatarUrl","legacy","avatar_url","setRoomWidgetContent","WidgetEchoStore","setRoomWidgetEcho","sendStateEvent","finally","removeRoomWidgetEcho","getRoomWidgets","appsStateEvents","filter","getUserWidgetsArray","Object","values","getStickerpickerWidgets","widgets","widget","getIntegrationManagerWidgets","w","getRoomWidgetsOfType","matches","removeIntegrationManagerWidgets","entries","forEach","key","addIntegrationManagerWidget","uiUrl","Date","getTime","WidgetType","INTEGRATION_MANAGER","removeStickerpickerWidgets","addJitsiWidget","isVideoChannel","oobRoomName","domain","Jitsi","getInstance","preferredDomain","auth","getJitsiAuth","randomString","confId","base32","stringify","Buffer","from","pad","randomUppercaseString","randomLowercaseString","URL","getLocalJitsiWrapperUrl","search","searchParams","set","JITSI","toString","conferenceId","roomName","isAudioOnly","CallType","Voice","makeAppConfig","appId","app","senderUserId","eventId","creatorUserId","opts","queryStringParts","PlatformPeg","supportsJitsiScreensharing","push","queryString","join","baseUrl","window","location","href","forLocalRender","getWidgetName","trim","_t","getWidgetDataTitle","title","getWidgetUid","calcWidgetUid","editWidget","open","isManagedByManager","managers","hasManager"],"sources":["../../src/utils/WidgetUtils.ts"],"sourcesContent":["/*\nCopyright 2019 Travis Ralston\nCopyright 2017 - 2020 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport * as url from \"url\";\nimport { base32 } from \"rfc4648\";\nimport { IWidget, IWidgetData } from \"matrix-widget-api\";\nimport { Room } from \"matrix-js-sdk/src/models/room\";\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\nimport { ClientEvent, RoomStateEvent } from \"matrix-js-sdk/src/matrix\";\nimport { CallType } from \"matrix-js-sdk/src/webrtc/call\";\nimport { randomString, randomLowercaseString, randomUppercaseString } from \"matrix-js-sdk/src/randomstring\";\n\nimport { MatrixClientPeg } from '../MatrixClientPeg';\nimport PlatformPeg from '../PlatformPeg';\nimport SdkConfig from \"../SdkConfig\";\nimport dis from '../dispatcher/dispatcher';\nimport WidgetEchoStore from '../stores/WidgetEchoStore';\nimport { IntegrationManagers } from \"../integrations/IntegrationManagers\";\nimport { WidgetType } from \"../widgets/WidgetType\";\nimport { Jitsi } from \"../widgets/Jitsi\";\nimport { objectClone } from \"./objects\";\nimport { _t } from \"../languageHandler\";\nimport { IApp } from \"../stores/WidgetStore\";\n\n// How long we wait for the state event echo to come back from the server\n// before waitFor[Room/User]Widget rejects its promise\nconst WIDGET_WAIT_TIME = 20000;\n\nexport interface IWidgetEvent {\n    id: string;\n    type: string;\n    sender: string;\n    // eslint-disable-next-line camelcase\n    state_key: string;\n    content: Partial<IApp>;\n}\n\nexport default class WidgetUtils {\n    /* Returns true if user is able to send state events to modify widgets in this room\n     * (Does not apply to non-room-based / user widgets)\n     * @param roomId -- The ID of the room to check\n     * @return Boolean -- true if the user can modify widgets in this room\n     * @throws Error -- specifies the error reason\n     */\n    static canUserModifyWidgets(roomId: string): boolean {\n        if (!roomId) {\n            logger.warn('No room ID specified');\n            return false;\n        }\n\n        const client = MatrixClientPeg.get();\n        if (!client) {\n            logger.warn('User must be be logged in');\n            return false;\n        }\n\n        const room = client.getRoom(roomId);\n        if (!room) {\n            logger.warn(`Room ID ${roomId} is not recognised`);\n            return false;\n        }\n\n        const me = client.credentials.userId;\n        if (!me) {\n            logger.warn('Failed to get user ID');\n            return false;\n        }\n\n        if (room.getMyMembership() !== \"join\") {\n            logger.warn(`User ${me} is not in room ${roomId}`);\n            return false;\n        }\n\n        // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\n        return room.currentState.maySendStateEvent('im.vector.modular.widgets', me);\n    }\n\n    // TODO: Generify the name of this function. It's not just scalar.\n    /**\n     * Returns true if specified url is a scalar URL, typically https://scalar.vector.im/api\n     * @param  {[type]}  testUrlString URL to check\n     * @return {Boolean} True if specified URL is a scalar URL\n     */\n    static isScalarUrl(testUrlString: string): boolean {\n        if (!testUrlString) {\n            logger.error('Scalar URL check failed. No URL specified');\n            return false;\n        }\n\n        const testUrl = url.parse(testUrlString);\n        let scalarUrls = SdkConfig.get().integrations_widgets_urls;\n        if (!scalarUrls || scalarUrls.length === 0) {\n            const defaultManager = IntegrationManagers.sharedInstance().getPrimaryManager();\n            if (defaultManager) {\n                scalarUrls = [defaultManager.apiUrl];\n            } else {\n                scalarUrls = [];\n            }\n        }\n\n        for (let i = 0; i < scalarUrls.length; i++) {\n            const scalarUrl = url.parse(scalarUrls[i]);\n            if (testUrl && scalarUrl) {\n                if (\n                    testUrl.protocol === scalarUrl.protocol &&\n                    testUrl.host === scalarUrl.host &&\n                    testUrl.pathname.startsWith(scalarUrl.pathname)\n                ) {\n                    return true;\n                }\n            }\n        }\n        return false;\n    }\n\n    /**\n     * Returns a promise that resolves when a widget with the given\n     * ID has been added as a user widget (ie. the accountData event\n     * arrives) or rejects after a timeout\n     *\n     * @param {string} widgetId The ID of the widget to wait for\n     * @param {boolean} add True to wait for the widget to be added,\n     *     false to wait for it to be deleted.\n     * @returns {Promise} that resolves when the widget is in the\n     *     requested state according to the `add` param\n     */\n    static waitForUserWidget(widgetId: string, add: boolean): Promise<void> {\n        return new Promise((resolve, reject) => {\n            // Tests an account data event, returning true if it's in the state\n            // we're waiting for it to be in\n            function eventInIntendedState(ev) {\n                if (!ev || !ev.getContent()) return false;\n                if (add) {\n                    return ev.getContent()[widgetId] !== undefined;\n                } else {\n                    return ev.getContent()[widgetId] === undefined;\n                }\n            }\n\n            const startingAccountDataEvent = MatrixClientPeg.get().getAccountData('m.widgets');\n            if (eventInIntendedState(startingAccountDataEvent)) {\n                resolve();\n                return;\n            }\n\n            function onAccountData(ev) {\n                const currentAccountDataEvent = MatrixClientPeg.get().getAccountData('m.widgets');\n                if (eventInIntendedState(currentAccountDataEvent)) {\n                    MatrixClientPeg.get().removeListener(ClientEvent.AccountData, onAccountData);\n                    clearTimeout(timerId);\n                    resolve();\n                }\n            }\n            const timerId = setTimeout(() => {\n                MatrixClientPeg.get().removeListener(ClientEvent.AccountData, onAccountData);\n                reject(new Error(\"Timed out waiting for widget ID \" + widgetId + \" to appear\"));\n            }, WIDGET_WAIT_TIME);\n            MatrixClientPeg.get().on(ClientEvent.AccountData, onAccountData);\n        });\n    }\n\n    /**\n     * Returns a promise that resolves when a widget with the given\n     * ID has been added as a room widget in the given room (ie. the\n     * room state event arrives) or rejects after a timeout\n     *\n     * @param {string} widgetId The ID of the widget to wait for\n     * @param {string} roomId The ID of the room to wait for the widget in\n     * @param {boolean} add True to wait for the widget to be added,\n     *     false to wait for it to be deleted.\n     * @returns {Promise} that resolves when the widget is in the\n     *     requested state according to the `add` param\n     */\n    static waitForRoomWidget(widgetId: string, roomId: string, add: boolean): Promise<void> {\n        return new Promise((resolve, reject) => {\n            // Tests a list of state events, returning true if it's in the state\n            // we're waiting for it to be in\n            function eventsInIntendedState(evList) {\n                const widgetPresent = evList.some((ev) => {\n                    return ev.getContent() && ev.getContent()['id'] === widgetId;\n                });\n                if (add) {\n                    return widgetPresent;\n                } else {\n                    return !widgetPresent;\n                }\n            }\n\n            const room = MatrixClientPeg.get().getRoom(roomId);\n            // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\n            const startingWidgetEvents = room.currentState.getStateEvents('im.vector.modular.widgets');\n            if (eventsInIntendedState(startingWidgetEvents)) {\n                resolve();\n                return;\n            }\n\n            function onRoomStateEvents(ev: MatrixEvent) {\n                if (ev.getRoomId() !== roomId || ev.getType() !== \"im.vector.modular.widgets\") return;\n\n                // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\n                const currentWidgetEvents = room.currentState.getStateEvents('im.vector.modular.widgets');\n\n                if (eventsInIntendedState(currentWidgetEvents)) {\n                    MatrixClientPeg.get().removeListener(RoomStateEvent.Events, onRoomStateEvents);\n                    clearTimeout(timerId);\n                    resolve();\n                }\n            }\n            const timerId = setTimeout(() => {\n                MatrixClientPeg.get().removeListener(RoomStateEvent.Events, onRoomStateEvents);\n                reject(new Error(\"Timed out waiting for widget ID \" + widgetId + \" to appear\"));\n            }, WIDGET_WAIT_TIME);\n            MatrixClientPeg.get().on(RoomStateEvent.Events, onRoomStateEvents);\n        });\n    }\n\n    static setUserWidget(\n        widgetId: string,\n        widgetType: WidgetType,\n        widgetUrl: string,\n        widgetName: string,\n        widgetData: IWidgetData,\n    ) {\n        const content = {\n            type: widgetType.preferred,\n            url: widgetUrl,\n            name: widgetName,\n            data: widgetData,\n        };\n\n        const client = MatrixClientPeg.get();\n        // Get the current widgets and clone them before we modify them, otherwise\n        // we'll modify the content of the old event.\n        const userWidgets = objectClone(WidgetUtils.getUserWidgets());\n\n        // Delete existing widget with ID\n        try {\n            delete userWidgets[widgetId];\n        } catch (e) {\n            logger.error(`$widgetId is non-configurable`);\n        }\n\n        const addingWidget = Boolean(widgetUrl);\n\n        // Add new widget / update\n        if (addingWidget) {\n            userWidgets[widgetId] = {\n                content: content,\n                sender: client.getUserId(),\n                state_key: widgetId,\n                type: 'm.widget',\n                id: widgetId,\n            };\n        }\n\n        // This starts listening for when the echo comes back from the server\n        // since the widget won't appear added until this happens. If we don't\n        // wait for this, the action will complete but if the user is fast enough,\n        // the widget still won't actually be there.\n        return client.setAccountData('m.widgets', userWidgets).then(() => {\n            return WidgetUtils.waitForUserWidget(widgetId, addingWidget);\n        }).then(() => {\n            dis.dispatch({ action: \"user_widget_updated\" });\n        });\n    }\n\n    static setRoomWidget(\n        roomId: string,\n        widgetId: string,\n        widgetType?: WidgetType,\n        widgetUrl?: string,\n        widgetName?: string,\n        widgetData?: object,\n        widgetAvatarUrl?: string,\n    ) {\n        let content;\n\n        const addingWidget = Boolean(widgetUrl);\n\n        if (addingWidget) {\n            content = {\n                // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\n                // For now we'll send the legacy event type for compatibility with older apps/elements\n                type: widgetType.legacy,\n                url: widgetUrl,\n                name: widgetName,\n                data: widgetData,\n                avatar_url: widgetAvatarUrl,\n            };\n        } else {\n            content = {};\n        }\n\n        return WidgetUtils.setRoomWidgetContent(roomId, widgetId, content);\n    }\n\n    static setRoomWidgetContent(\n        roomId: string,\n        widgetId: string,\n        content: IWidget,\n    ) {\n        const addingWidget = !!content.url;\n\n        WidgetEchoStore.setRoomWidgetEcho(roomId, widgetId, content);\n\n        const client = MatrixClientPeg.get();\n        // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\n        return client.sendStateEvent(roomId, \"im.vector.modular.widgets\", content, widgetId).then(() => {\n            return WidgetUtils.waitForRoomWidget(widgetId, roomId, addingWidget);\n        }).finally(() => {\n            WidgetEchoStore.removeRoomWidgetEcho(roomId, widgetId);\n        });\n    }\n\n    /**\n     * Get room specific widgets\n     * @param  {Room} room The room to get widgets force\n     * @return {[object]} Array containing current / active room widgets\n     */\n    static getRoomWidgets(room: Room) {\n        // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\n        const appsStateEvents = room.currentState.getStateEvents('im.vector.modular.widgets');\n        if (!appsStateEvents) {\n            return [];\n        }\n\n        return appsStateEvents.filter((ev) => {\n            return ev.getContent().type && ev.getContent().url;\n        });\n    }\n\n    /**\n     * Get user specific widgets (not linked to a specific room)\n     * @return {object} Event content object containing current / active user widgets\n     */\n    static getUserWidgets(): Record<string, IWidgetEvent> {\n        const client = MatrixClientPeg.get();\n        if (!client) {\n            throw new Error('User not logged in');\n        }\n        const userWidgets = client.getAccountData('m.widgets');\n        if (userWidgets && userWidgets.getContent()) {\n            return userWidgets.getContent();\n        }\n        return {};\n    }\n\n    /**\n     * Get user specific widgets (not linked to a specific room) as an array\n     * @return {[object]} Array containing current / active user widgets\n     */\n    static getUserWidgetsArray(): IWidgetEvent[] {\n        return Object.values(WidgetUtils.getUserWidgets());\n    }\n\n    /**\n     * Get active stickerpicker widgets (stickerpickers are user widgets by nature)\n     * @return {[object]} Array containing current / active stickerpicker widgets\n     */\n    static getStickerpickerWidgets(): IWidgetEvent[] {\n        const widgets = WidgetUtils.getUserWidgetsArray();\n        return widgets.filter((widget) => widget.content && widget.content.type === \"m.stickerpicker\");\n    }\n\n    /**\n     * Get all integration manager widgets for this user.\n     * @returns {Object[]} An array of integration manager user widgets.\n     */\n    static getIntegrationManagerWidgets(): IWidgetEvent[] {\n        const widgets = WidgetUtils.getUserWidgetsArray();\n        return widgets.filter(w => w.content && w.content.type === \"m.integration_manager\");\n    }\n\n    static getRoomWidgetsOfType(room: Room, type: WidgetType): MatrixEvent[] {\n        const widgets = WidgetUtils.getRoomWidgets(room) || [];\n        return widgets.filter(w => {\n            const content = w.getContent();\n            return content.url && type.matches(content.type);\n        });\n    }\n\n    static async removeIntegrationManagerWidgets(): Promise<void> {\n        const client = MatrixClientPeg.get();\n        if (!client) {\n            throw new Error('User not logged in');\n        }\n        const widgets = client.getAccountData('m.widgets');\n        if (!widgets) return;\n        const userWidgets: Record<string, IWidgetEvent> = widgets.getContent() || {};\n        Object.entries(userWidgets).forEach(([key, widget]) => {\n            if (widget.content && widget.content.type === \"m.integration_manager\") {\n                delete userWidgets[key];\n            }\n        });\n        await client.setAccountData('m.widgets', userWidgets);\n    }\n\n    static addIntegrationManagerWidget(name: string, uiUrl: string, apiUrl: string): Promise<void> {\n        return WidgetUtils.setUserWidget(\n            \"integration_manager_\" + (new Date().getTime()),\n            WidgetType.INTEGRATION_MANAGER,\n            uiUrl,\n            \"Integration manager: \" + name,\n            { \"api_url\": apiUrl },\n        );\n    }\n\n    /**\n     * Remove all stickerpicker widgets (stickerpickers are user widgets by nature)\n     * @return {Promise} Resolves on account data updated\n     */\n    static async removeStickerpickerWidgets(): Promise<void> {\n        const client = MatrixClientPeg.get();\n        if (!client) {\n            throw new Error('User not logged in');\n        }\n        const widgets = client.getAccountData('m.widgets');\n        if (!widgets) return;\n        const userWidgets: Record<string, IWidgetEvent> = widgets.getContent() || {};\n        Object.entries(userWidgets).forEach(([key, widget]) => {\n            if (widget.content && widget.content.type === 'm.stickerpicker') {\n                delete userWidgets[key];\n            }\n        });\n        await client.setAccountData('m.widgets', userWidgets);\n    }\n\n    static async addJitsiWidget(\n        roomId: string,\n        type: CallType,\n        name: string,\n        isVideoChannel: boolean,\n        oobRoomName?: string,\n    ): Promise<void> {\n        const domain = Jitsi.getInstance().preferredDomain;\n        const auth = await Jitsi.getInstance().getJitsiAuth();\n        const widgetId = randomString(24); // Must be globally unique\n\n        let confId;\n        if (auth === 'openidtoken-jwt') {\n            // Create conference ID from room ID\n            // For compatibility with Jitsi, use base32 without padding.\n            // More details here:\n            // https://github.com/matrix-org/prosody-mod-auth-matrix-user-verification\n            confId = base32.stringify(Buffer.from(roomId), { pad: false });\n        } else {\n            // Create a random conference ID\n            confId = `Jitsi${randomUppercaseString(1)}${randomLowercaseString(23)}`;\n        }\n\n        // TODO: Remove URL hacks when the mobile clients eventually support v2 widgets\n        const widgetUrl = new URL(WidgetUtils.getLocalJitsiWrapperUrl({ auth }));\n        widgetUrl.search = ''; // Causes the URL class use searchParams instead\n        widgetUrl.searchParams.set('confId', confId);\n\n        await WidgetUtils.setRoomWidget(roomId, widgetId, WidgetType.JITSI, widgetUrl.toString(), name, {\n            conferenceId: confId,\n            roomName: oobRoomName ?? MatrixClientPeg.get().getRoom(roomId)?.name,\n            isAudioOnly: type === CallType.Voice,\n            isVideoChannel,\n            domain,\n            auth,\n        });\n    }\n\n    static makeAppConfig(\n        appId: string,\n        app: Partial<IApp>,\n        senderUserId: string,\n        roomId: string | null,\n        eventId: string,\n    ): IApp {\n        if (!senderUserId) {\n            throw new Error(\"Widgets must be created by someone - provide a senderUserId\");\n        }\n        app.creatorUserId = senderUserId;\n\n        app.id = appId;\n        app.roomId = roomId;\n        app.eventId = eventId;\n        app.name = app.name || app.type;\n\n        return app as IApp;\n    }\n\n    static getLocalJitsiWrapperUrl(opts: {forLocalRender?: boolean, auth?: string} = {}) {\n        // NB. we can't just encodeURIComponent all of these because the $ signs need to be there\n        const queryStringParts = [\n            'conferenceDomain=$domain',\n            'conferenceId=$conferenceId',\n            'isAudioOnly=$isAudioOnly',\n            'isVideoChannel=$isVideoChannel',\n            'displayName=$matrix_display_name',\n            'avatarUrl=$matrix_avatar_url',\n            'userId=$matrix_user_id',\n            'roomId=$matrix_room_id',\n            'theme=$theme',\n            'roomName=$roomName',\n            `supportsScreensharing=${PlatformPeg.get().supportsJitsiScreensharing()}`,\n        ];\n        if (opts.auth) {\n            queryStringParts.push(`auth=${opts.auth}`);\n        }\n        const queryString = queryStringParts.join('&');\n\n        let baseUrl = window.location.href;\n        if (window.location.protocol !== \"https:\" && !opts.forLocalRender) {\n            // Use an external wrapper if we're not locally rendering the widget. This is usually\n            // the URL that will end up in the widget event, so we want to make sure it's relatively\n            // safe to send.\n            // We'll end up using a local render URL when we see a Jitsi widget anyways, so this is\n            // really just for backwards compatibility and to appease the spec.\n            baseUrl = \"https://app.element.io/\";\n        }\n        const url = new URL(\"jitsi.html#\" + queryString, baseUrl); // this strips hash fragment from baseUrl\n        return url.href;\n    }\n\n    static getWidgetName(app?: IApp): string {\n        return app?.name?.trim() || _t(\"Unknown App\");\n    }\n\n    static getWidgetDataTitle(app?: IApp): string {\n        return app?.data?.title?.trim() || \"\";\n    }\n\n    static getWidgetUid(app?: IApp): string {\n        return app ? WidgetUtils.calcWidgetUid(app.id, app.roomId) : \"\";\n    }\n\n    static calcWidgetUid(widgetId: string, roomId?: string): string {\n        return roomId ? `room_${roomId}_${widgetId}` : `user_${widgetId}`;\n    }\n\n    static editWidget(room: Room, app: IApp): void {\n        // noinspection JSIgnoredPromiseFromCall\n        IntegrationManagers.sharedInstance().getPrimaryManager().open(room, 'type_' + app.type, app.id);\n    }\n\n    static isManagedByManager(app) {\n        if (WidgetUtils.isScalarUrl(app.url)) {\n            const managers = IntegrationManagers.sharedInstance();\n            if (managers.hasManager()) {\n                // TODO: Pick the right manager for the widget\n                const defaultManager = managers.getPrimaryManager();\n                return WidgetUtils.isScalarUrl(defaultManager.apiUrl);\n            }\n        }\n        return false;\n    }\n}\n"],"mappings":"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"}