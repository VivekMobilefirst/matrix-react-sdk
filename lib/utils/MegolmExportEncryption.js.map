{"version":3,"file":"MegolmExportEncryption.js","names":["subtleCrypto","window","crypto","subtle","webkitSubtle","friendlyError","message","friendlyText","cryptoFailMsg","_t","decryptMegolmKeyFile","data","password","body","unpackMegolmKeyFile","brand","SdkConfig","get","length","version","ciphertextLength","salt","subarray","iv","iterations","ciphertext","hmac","aesKey","hmacKey","deriveKeys","toVerify","isValid","verify","name","e","plaintext","decrypt","counter","TextDecoder","decode","Uint8Array","encryptMegolmKeyFile","options","kdfRounds","kdf_rounds","getRandomValues","encodedData","TextEncoder","encode","encrypt","cipherArray","bodyLength","resultBuffer","idx","set","toSign","sign","hmacArray","packMegolmKeyFile","start","Date","key","importKey","keybits","deriveBits","hash","now","logger","log","getTime","slice","aesProm","catch","hmacProm","Promise","all","HEADER_LINE","TRAILER_LINE","fileStr","lineStart","lineEnd","indexOf","Error","line","trim","dataStart","undefined","dataEnd","decodeBase64","LINE_LENGTH","nLines","Math","ceil","lines","Array","o","i","encodeBase64","join","buffer","uint8Array","latin1String","String","fromCharCode","apply","btoa","base64","atob","charCodeAt"],"sources":["../../src/utils/MegolmExportEncryption.ts"],"sourcesContent":["/*\nCopyright 2017 Vector Creations Ltd\nCopyright 2020 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { logger } from \"matrix-js-sdk/src/logger\";\n\nimport { _t } from '../languageHandler';\nimport SdkConfig from '../SdkConfig';\n\nconst subtleCrypto = window.crypto.subtle || window.crypto.webkitSubtle;\n\n/**\n * Make an Error object which has a friendlyText property which is already\n * translated and suitable for showing to the user.\n *\n * @param {string} message message for the exception\n * @param {string} friendlyText\n * @returns {{message: string, friendlyText: string}}\n */\nfunction friendlyError(\n    message: string, friendlyText: string,\n): { message: string, friendlyText: string } {\n    return { message, friendlyText };\n}\n\nfunction cryptoFailMsg(): string {\n    return _t('Your browser does not support the required cryptography extensions');\n}\n\n/**\n * Decrypt a megolm key file\n *\n * @param {ArrayBuffer} data file to decrypt\n * @param {String} password\n * @return {Promise<String>} promise for decrypted output\n *\n *\n */\nexport async function decryptMegolmKeyFile(data: ArrayBuffer, password: string): Promise<string> {\n    const body = unpackMegolmKeyFile(data);\n    const brand = SdkConfig.get().brand;\n\n    // check we have a version byte\n    if (body.length < 1) {\n        throw friendlyError('Invalid file: too short',\n            _t('Not a valid %(brand)s keyfile', { brand }));\n    }\n\n    const version = body[0];\n    if (version !== 1) {\n        throw friendlyError('Unsupported version',\n            _t('Not a valid %(brand)s keyfile', { brand }));\n    }\n\n    const ciphertextLength = body.length-(1+16+16+4+32);\n    if (ciphertextLength < 0) {\n        throw friendlyError('Invalid file: too short',\n            _t('Not a valid %(brand)s keyfile', { brand }));\n    }\n\n    const salt = body.subarray(1, 1+16);\n    const iv = body.subarray(17, 17+16);\n    const iterations = body[33] << 24 | body[34] << 16 | body[35] << 8 | body[36];\n    const ciphertext = body.subarray(37, 37+ciphertextLength);\n    const hmac = body.subarray(-32);\n\n    const [aesKey, hmacKey] = await deriveKeys(salt, iterations, password);\n    const toVerify = body.subarray(0, -32);\n\n    let isValid;\n    try {\n        isValid = await subtleCrypto.verify(\n            { name: 'HMAC' },\n            hmacKey,\n            hmac,\n            toVerify,\n        );\n    } catch (e) {\n        throw friendlyError('subtleCrypto.verify failed: ' + e, cryptoFailMsg());\n    }\n    if (!isValid) {\n        throw friendlyError('hmac mismatch',\n            _t('Authentication check failed: incorrect password?'));\n    }\n\n    let plaintext;\n    try {\n        plaintext = await subtleCrypto.decrypt(\n            {\n                name: \"AES-CTR\",\n                counter: iv,\n                length: 64,\n            },\n            aesKey,\n            ciphertext,\n        );\n    } catch (e) {\n        throw friendlyError('subtleCrypto.decrypt failed: ' + e, cryptoFailMsg());\n    }\n\n    return new TextDecoder().decode(new Uint8Array(plaintext));\n}\n\n/**\n * Encrypt a megolm key file\n *\n * @param {String} data\n * @param {String} password\n * @param {Object=} options\n * @param {Number=} options.kdf_rounds Number of iterations to perform of the\n *    key-derivation function.\n * @return {Promise<ArrayBuffer>} promise for encrypted output\n */\nexport async function encryptMegolmKeyFile(\n    data: string,\n    password: string,\n    options?: { kdf_rounds?: number }, // eslint-disable-line camelcase\n): Promise<ArrayBuffer> {\n    options = options || {};\n    const kdfRounds = options.kdf_rounds || 500000;\n\n    const salt = new Uint8Array(16);\n    window.crypto.getRandomValues(salt);\n\n    const iv = new Uint8Array(16);\n    window.crypto.getRandomValues(iv);\n\n    // clear bit 63 of the IV to stop us hitting the 64-bit counter boundary\n    // (which would mean we wouldn't be able to decrypt on Android). The loss\n    // of a single bit of iv is a price we have to pay.\n    iv[8] &= 0x7f;\n\n    const [aesKey, hmacKey] = await deriveKeys(salt, kdfRounds, password);\n    const encodedData = new TextEncoder().encode(data);\n\n    let ciphertext;\n    try {\n        ciphertext = await subtleCrypto.encrypt(\n            {\n                name: \"AES-CTR\",\n                counter: iv,\n                length: 64,\n            },\n            aesKey,\n            encodedData,\n        );\n    } catch (e) {\n        throw friendlyError('subtleCrypto.encrypt failed: ' + e, cryptoFailMsg());\n    }\n\n    const cipherArray = new Uint8Array(ciphertext);\n    const bodyLength = (1+salt.length+iv.length+4+cipherArray.length+32);\n    const resultBuffer = new Uint8Array(bodyLength);\n    let idx = 0;\n    resultBuffer[idx++] = 1; // version\n    resultBuffer.set(salt, idx); idx += salt.length;\n    resultBuffer.set(iv, idx); idx += iv.length;\n    resultBuffer[idx++] = kdfRounds >> 24;\n    resultBuffer[idx++] = (kdfRounds >> 16) & 0xff;\n    resultBuffer[idx++] = (kdfRounds >> 8) & 0xff;\n    resultBuffer[idx++] = kdfRounds & 0xff;\n    resultBuffer.set(cipherArray, idx); idx += cipherArray.length;\n\n    const toSign = resultBuffer.subarray(0, idx);\n\n    let hmac;\n    try {\n        hmac = await subtleCrypto.sign(\n            { name: 'HMAC' },\n            hmacKey,\n            toSign,\n        );\n    } catch (e) {\n        throw friendlyError('subtleCrypto.sign failed: ' + e, cryptoFailMsg());\n    }\n\n    const hmacArray = new Uint8Array(hmac);\n    resultBuffer.set(hmacArray, idx);\n    return packMegolmKeyFile(resultBuffer);\n}\n\n/**\n * Derive the AES and HMAC-SHA-256 keys for the file\n *\n * @param {Unit8Array} salt  salt for pbkdf\n * @param {Number} iterations number of pbkdf iterations\n * @param {String} password  password\n * @return {Promise<[CryptoKey, CryptoKey]>} promise for [aes key, hmac key]\n */\nasync function deriveKeys(salt: Uint8Array, iterations: number, password: string): Promise<[CryptoKey, CryptoKey]> {\n    const start = new Date();\n\n    let key;\n    try {\n        key = await subtleCrypto.importKey(\n            'raw',\n            new TextEncoder().encode(password),\n            { name: 'PBKDF2' },\n            false,\n            ['deriveBits'],\n        );\n    } catch (e) {\n        throw friendlyError('subtleCrypto.importKey failed: ' + e, cryptoFailMsg());\n    }\n\n    let keybits;\n    try {\n        keybits = await subtleCrypto.deriveBits(\n            {\n                name: 'PBKDF2',\n                salt: salt,\n                iterations: iterations,\n                hash: 'SHA-512',\n            },\n            key,\n            512,\n        );\n    } catch (e) {\n        throw friendlyError('subtleCrypto.deriveBits failed: ' + e, cryptoFailMsg());\n    }\n\n    const now = new Date();\n    logger.log(\"E2e import/export: deriveKeys took \" + (now.getTime() - start.getTime()) + \"ms\");\n\n    const aesKey = keybits.slice(0, 32);\n    const hmacKey = keybits.slice(32);\n\n    const aesProm = subtleCrypto.importKey(\n        'raw',\n        aesKey,\n        { name: 'AES-CTR' },\n        false,\n        ['encrypt', 'decrypt'],\n    ).catch((e) => {\n        throw friendlyError('subtleCrypto.importKey failed for AES key: ' + e, cryptoFailMsg());\n    });\n\n    const hmacProm = subtleCrypto.importKey(\n        'raw',\n        hmacKey,\n        {\n            name: 'HMAC',\n            hash: { name: 'SHA-256' },\n        },\n        false,\n        ['sign', 'verify'],\n    ).catch((e) => {\n        throw friendlyError('subtleCrypto.importKey failed for HMAC key: ' + e, cryptoFailMsg());\n    });\n\n    return Promise.all([aesProm, hmacProm]);\n}\n\nconst HEADER_LINE = '-----BEGIN MEGOLM SESSION DATA-----';\nconst TRAILER_LINE = '-----END MEGOLM SESSION DATA-----';\n\n/**\n * Unbase64 an ascii-armoured megolm key file\n *\n * Strips the header and trailer lines, and unbase64s the content\n *\n * @param {ArrayBuffer} data  input file\n * @return {Uint8Array} unbase64ed content\n */\nfunction unpackMegolmKeyFile(data: ArrayBuffer): Uint8Array {\n    // parse the file as a great big String. This should be safe, because there\n    // should be no non-ASCII characters, and it means that we can do string\n    // comparisons to find the header and footer, and feed it into window.atob.\n    const fileStr = new TextDecoder().decode(new Uint8Array(data));\n\n    // look for the start line\n    let lineStart = 0;\n    // eslint-disable-next-line no-constant-condition\n    while (1) {\n        const lineEnd = fileStr.indexOf('\\n', lineStart);\n        if (lineEnd < 0) {\n            throw new Error('Header line not found');\n        }\n        const line = fileStr.slice(lineStart, lineEnd).trim();\n\n        // start the next line after the newline\n        lineStart = lineEnd+1;\n\n        if (line === HEADER_LINE) {\n            break;\n        }\n    }\n\n    const dataStart = lineStart;\n\n    // look for the end line\n    // eslint-disable-next-line no-constant-condition\n    while (1) {\n        const lineEnd = fileStr.indexOf('\\n', lineStart);\n        const line = fileStr.slice(lineStart, lineEnd < 0 ? undefined : lineEnd).trim();\n        if (line === TRAILER_LINE) {\n            break;\n        }\n\n        if (lineEnd < 0) {\n            throw new Error('Trailer line not found');\n        }\n\n        // start the next line after the newline\n        lineStart = lineEnd+1;\n    }\n\n    const dataEnd = lineStart;\n    return decodeBase64(fileStr.slice(dataStart, dataEnd));\n}\n\n/**\n * ascii-armour a  megolm key file\n *\n * base64s the content, and adds header and trailer lines\n *\n * @param {Uint8Array} data  raw data\n * @return {ArrayBuffer} formatted file\n */\nfunction packMegolmKeyFile(data: Uint8Array): ArrayBuffer {\n    // we split into lines before base64ing, because encodeBase64 doesn't deal\n    // terribly well with large arrays.\n    const LINE_LENGTH = (72 * 4 / 3);\n    const nLines = Math.ceil(data.length / LINE_LENGTH);\n    const lines = new Array(nLines + 3);\n    lines[0] = HEADER_LINE;\n    let o = 0;\n    let i;\n    for (i = 1; i <= nLines; i++) {\n        lines[i] = encodeBase64(data.subarray(o, o+LINE_LENGTH));\n        o += LINE_LENGTH;\n    }\n    lines[i++] = TRAILER_LINE;\n    lines[i] = '';\n    return (new TextEncoder().encode(lines.join('\\n'))).buffer;\n}\n\n/**\n * Encode a typed array of uint8 as base64.\n * @param {Uint8Array} uint8Array The data to encode.\n * @return {string} The base64.\n */\nfunction encodeBase64(uint8Array: Uint8Array): string {\n    // Misinterpt the Uint8Array as Latin-1.\n    // window.btoa expects a unicode string with codepoints in the range 0-255.\n    const latin1String = String.fromCharCode.apply(null, uint8Array);\n    // Use the builtin base64 encoder.\n    return window.btoa(latin1String);\n}\n\n/**\n * Decode a base64 string to a typed array of uint8.\n * @param {string} base64 The base64 to decode.\n * @return {Uint8Array} The decoded data.\n */\nfunction decodeBase64(base64: string): Uint8Array {\n    // window.atob returns a unicode string with codepoints in the range 0-255.\n    const latin1String = window.atob(base64);\n    // Encode the string as a Uint8Array\n    const uint8Array = new Uint8Array(latin1String.length);\n    for (let i = 0; i < latin1String.length; i++) {\n        uint8Array[i] = latin1String.charCodeAt(i);\n    }\n    return uint8Array;\n}\n"],"mappings":"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"}