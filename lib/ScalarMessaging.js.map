{"version":3,"file":"ScalarMessaging.js","names":["Action","sendResponse","event","res","data","objectClone","response","source","postMessage","origin","sendError","msg","nestedError","logger","error","action","message","_error","inviteUser","roomId","userId","log","client","MatrixClientPeg","get","_t","room","getRoom","member","getMember","includes","membership","success","invite","then","err","setWidget","widgetId","widget_id","widgetType","type","widgetUrl","url","widgetName","name","widgetData","widgetAvatarUrl","avatar_url","userWidget","undefined","Error","Object","WidgetType","fromString","WidgetUtils","setUserWidget","dis","dispatch","catch","e","setRoomWidget","getWidgets","widgetStateEvents","getRoomWidgets","map","ev","userWidgets","getUserWidgetsArray","concat","getRoomEncState","roomIsEncrypted","isRoomEncrypted","setPlumbingState","status","sendStateEvent","setBotOptions","content","setBotPower","level","ignoreIfGreater","Number","isInteger","powerLevels","getStateEvent","currentPl","users","users_default","setPowerLevel","MatrixEvent","getMembershipState","returnStateEvent","getJoinRules","botOptions","getMembershipCount","count","getJoinedMemberCount","canSendEvent","evType","event_type","isState","Boolean","is_state","getMyMembership","me","credentials","canSend","currentState","maySendStateEvent","maySendEvent","eventType","stateKey","stateEvent","getStateEvents","getContent","getOpenIdToken","tokenObject","ex","warn","onMessage","originalEvent","configUrl","openManagerUrl","IntegrationManagers","sharedInstance","getPrimaryManager","uiUrl","URL","eventOriginUrl","api","CloseScalar","room_id","user_id","GetWidgets","SetWidget","RoomViewStore","instance","getRoomId","JoinRulesState","SetPlumbingState","GetMembershipCount","GetRoomEncryptionState","CanSendEvent","MembershipState","BotOptions","SetBotOptions","SetBotPower","GetOpenIdToken","listenerCount","startListening","window","addEventListener","stopListening","removeEventListener"],"sources":["../src/ScalarMessaging.ts"],"sourcesContent":["/*\nCopyright 2016 OpenMarket Ltd\nCopyright 2017 Vector Creations Ltd\nCopyright 2018 New Vector Ltd\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\n// TODO: Generify the name of this and all components within - it's not just for scalar.\n\n/*\nListens for incoming postMessage requests from the integrations UI URL. The following API is exposed:\n{\n    action: \"invite\" | \"membership_state\" | \"bot_options\" | \"set_bot_options\" | etc... ,\n    room_id: $ROOM_ID,\n    user_id: $USER_ID\n    // additional request fields\n}\n\nThe complete request object is returned to the caller with an additional \"response\" key like so:\n{\n    action: \"invite\" | \"membership_state\" | \"bot_options\" | \"set_bot_options\",\n    room_id: $ROOM_ID,\n    user_id: $USER_ID,\n    // additional request fields\n    response: { ... }\n}\n\nThe \"action\" determines the format of the request and response. All actions can return an error response.\nAn error response is a \"response\" object which consists of a sole \"error\" key to indicate an error.\nThey look like:\n{\n    error: {\n        message: \"Unable to invite user into room.\",\n        _error: <Original Error Object>\n    }\n}\nThe \"message\" key should be a human-friendly string.\n\nACTIONS\n=======\nAll actions can return an error response instead of the response outlined below.\n\ninvite\n------\nInvites a user into a room. The request will no-op if the user is already joined OR invited to the room.\n\nRequest:\n - room_id is the room to invite the user into.\n - user_id is the user ID to invite.\n - No additional fields.\nResponse:\n{\n    success: true\n}\nExample:\n{\n    action: \"invite\",\n    room_id: \"!foo:bar\",\n    user_id: \"@invitee:bar\",\n    response: {\n        success: true\n    }\n}\n\nset_bot_options\n---------------\nSet the m.room.bot.options state event for a bot user.\n\nRequest:\n - room_id is the room to send the state event into.\n - user_id is the user ID of the bot who you're setting options for.\n - \"content\" is an object consisting of the content you wish to set.\nResponse:\n{\n    success: true\n}\nExample:\n{\n    action: \"set_bot_options\",\n    room_id: \"!foo:bar\",\n    user_id: \"@bot:bar\",\n    content: {\n        default_option: \"alpha\"\n    },\n    response: {\n        success: true\n    }\n}\n\nget_membership_count\n--------------------\nGet the number of joined users in the room.\n\nRequest:\n - room_id is the room to get the count in.\nResponse:\n78\nExample:\n{\n    action: \"get_membership_count\",\n    room_id: \"!foo:bar\",\n    response: 78\n}\n\ncan_send_event\n--------------\nCheck if the client can send the given event into the given room. If the client\nis unable to do this, an error response is returned instead of 'response: false'.\n\nRequest:\n - room_id is the room to do the check in.\n - event_type is the event type which will be sent.\n - is_state is true if the event to be sent is a state event.\nResponse:\ntrue\nExample:\n{\n    action: \"can_send_event\",\n    is_state: false,\n    event_type: \"m.room.message\",\n    room_id: \"!foo:bar\",\n    response: true\n}\n\nset_widget\n----------\nSet a new widget in the room. Clobbers based on the ID.\n\nRequest:\n - `room_id` (String) is the room to set the widget in.\n - `widget_id` (String) is the ID of the widget to add (or replace if it already exists).\n   It can be an arbitrary UTF8 string and is purely for distinguishing between widgets.\n - `url` (String) is the URL that clients should load in an iframe to run the widget.\n   All widgets must have a valid URL. If the URL is `null` (not `undefined`), the\n   widget will be removed from the room.\n - `type` (String) is the type of widget, which is provided as a hint for matrix clients so they\n   can configure/lay out the widget in different ways. All widgets must have a type.\n - `name` (String) is an optional human-readable string about the widget.\n - `data` (Object) is some optional data about the widget, and can contain arbitrary key/value pairs.\n - `avatar_url` (String) is some optional mxc: URI pointing to the avatar of the widget.\nResponse:\n{\n    success: true\n}\nExample:\n{\n    action: \"set_widget\",\n    room_id: \"!foo:bar\",\n    widget_id: \"abc123\",\n    url: \"http://widget.url\",\n    type: \"example\",\n    response: {\n        success: true\n    }\n}\n\nget_widgets\n-----------\nGet a list of all widgets in the room. The response is an array\nof state events.\n\nRequest:\n - `room_id` (String) is the room to get the widgets in.\nResponse:\n[\n    {\n        // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\n        type: \"im.vector.modular.widgets\",\n        state_key: \"wid1\",\n        content: {\n            type: \"grafana\",\n            url: \"https://grafanaurl\",\n            name: \"dashboard\",\n            data: {key: \"val\"}\n        }\n        room_id: \"!foo:bar\",\n        sender: \"@alice:localhost\"\n    }\n]\nExample:\n{\n    action: \"get_widgets\",\n    room_id: \"!foo:bar\",\n    response: [\n        {\n            // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\n            type: \"im.vector.modular.widgets\",\n            state_key: \"wid1\",\n            content: {\n                type: \"grafana\",\n                url: \"https://grafanaurl\",\n                name: \"dashboard\",\n                data: {key: \"val\"}\n            }\n            room_id: \"!foo:bar\",\n            sender: \"@alice:localhost\"\n        }\n    ]\n}\n\nmembership_state AND bot_options\n--------------------------------\nGet the content of the \"m.room.member\" or \"m.room.bot.options\" state event respectively.\n\nNB: Whilst this API is basically equivalent to getStateEvent, we specifically do not\n    want external entities to be able to query any state event for any room, hence the\n    restrictive API outlined here.\n\nRequest:\n - room_id is the room which has the state event.\n - user_id is the state_key parameter which in both cases is a user ID (the member or the bot).\n - No additional fields.\nResponse:\n - The event content. If there is no state event, the \"response\" key should be null.\nExample:\n{\n    action: \"membership_state\",\n    room_id: \"!foo:bar\",\n    user_id: \"@somemember:bar\",\n    response: {\n        membership: \"join\",\n        displayname: \"Bob\",\n        avatar_url: null\n    }\n}\n\nget_open_id_token\n-----------------\nGet an openID token for the current user session.\nRequest: No parameters\nResponse:\n - The openId token object as described in https://spec.matrix.org/v1.2/client-server-api/#post_matrixclientv3useruseridopenidrequest_token\n*/\n\nimport { MatrixEvent } from 'matrix-js-sdk/src/models/event';\nimport { logger } from \"matrix-js-sdk/src/logger\";\n\nimport { MatrixClientPeg } from './MatrixClientPeg';\nimport dis from './dispatcher/dispatcher';\nimport WidgetUtils from './utils/WidgetUtils';\nimport { RoomViewStore } from './stores/RoomViewStore';\nimport { _t } from './languageHandler';\nimport { IntegrationManagers } from \"./integrations/IntegrationManagers\";\nimport { WidgetType } from \"./widgets/WidgetType\";\nimport { objectClone } from \"./utils/objects\";\n\nenum Action {\n    CloseScalar = \"close_scalar\",\n    GetWidgets = \"get_widgets\",\n    SetWidget = \"set_widget\",\n    JoinRulesState = \"join_rules_state\",\n    SetPlumbingState = \"set_plumbing_state\",\n    GetMembershipCount = \"get_membership_count\",\n    GetRoomEncryptionState = \"get_room_enc_state\",\n    CanSendEvent = \"can_send_event\",\n    MembershipState = \"membership_state\",\n    invite = \"invite\",\n    BotOptions = \"bot_options\",\n    SetBotOptions = \"set_bot_options\",\n    SetBotPower = \"set_bot_power\",\n    GetOpenIdToken = \"get_open_id_token\"\n}\n\nfunction sendResponse(event: MessageEvent<any>, res: any): void {\n    const data = objectClone(event.data);\n    data.response = res;\n    // @ts-ignore\n    event.source.postMessage(data, event.origin);\n}\n\nfunction sendError(event: MessageEvent<any>, msg: string, nestedError?: Error): void {\n    logger.error(\"Action:\" + event.data.action + \" failed with message: \" + msg);\n    const data = objectClone(event.data);\n    data.response = {\n        error: {\n            message: msg,\n        },\n    };\n    if (nestedError) {\n        data.response.error._error = nestedError;\n    }\n    // @ts-ignore\n    event.source.postMessage(data, event.origin);\n}\n\nfunction inviteUser(event: MessageEvent<any>, roomId: string, userId: string): void {\n    logger.log(`Received request to invite ${userId} into room ${roomId}`);\n    const client = MatrixClientPeg.get();\n    if (!client) {\n        sendError(event, _t('You need to be logged in.'));\n        return;\n    }\n    const room = client.getRoom(roomId);\n    if (room) {\n        // if they are already invited or joined we can resolve immediately.\n        const member = room.getMember(userId);\n        if (member && [\"join\", \"invite\"].includes(member.membership)) {\n            sendResponse(event, {\n                success: true,\n            });\n            return;\n        }\n    }\n\n    client.invite(roomId, userId).then(function() {\n        sendResponse(event, {\n            success: true,\n        });\n    }, function(err) {\n        sendError(event, _t('You need to be able to invite users to do that.'), err);\n    });\n}\n\nfunction setWidget(event: MessageEvent<any>, roomId: string): void {\n    const widgetId = event.data.widget_id;\n    let widgetType = event.data.type;\n    const widgetUrl = event.data.url;\n    const widgetName = event.data.name; // optional\n    const widgetData = event.data.data; // optional\n    const widgetAvatarUrl = event.data.avatar_url; // optional\n    const userWidget = event.data.userWidget;\n\n    // both adding/removing widgets need these checks\n    if (!widgetId || widgetUrl === undefined) {\n        sendError(event, _t(\"Unable to create widget.\"), new Error(\"Missing required widget fields.\"));\n        return;\n    }\n\n    if (widgetUrl !== null) { // if url is null it is being deleted, don't need to check name/type/etc\n        // check types of fields\n        if (widgetName !== undefined && typeof widgetName !== 'string') {\n            sendError(event, _t(\"Unable to create widget.\"), new Error(\"Optional field 'name' must be a string.\"));\n            return;\n        }\n        if (widgetData !== undefined && !(widgetData instanceof Object)) {\n            sendError(event, _t(\"Unable to create widget.\"), new Error(\"Optional field 'data' must be an Object.\"));\n            return;\n        }\n        if (widgetAvatarUrl !== undefined && typeof widgetAvatarUrl !== 'string') {\n            sendError(\n                event,\n                _t(\"Unable to create widget.\"),\n                new Error(\"Optional field 'avatar_url' must be a string.\"),\n            );\n            return;\n        }\n        if (typeof widgetType !== 'string') {\n            sendError(event, _t(\"Unable to create widget.\"), new Error(\"Field 'type' must be a string.\"));\n            return;\n        }\n        if (typeof widgetUrl !== 'string') {\n            sendError(event, _t(\"Unable to create widget.\"), new Error(\"Field 'url' must be a string or null.\"));\n            return;\n        }\n    }\n\n    // convert the widget type to a known widget type\n    widgetType = WidgetType.fromString(widgetType);\n\n    if (userWidget) {\n        WidgetUtils.setUserWidget(widgetId, widgetType, widgetUrl, widgetName, widgetData).then(() => {\n            sendResponse(event, {\n                success: true,\n            });\n\n            dis.dispatch({ action: \"user_widget_updated\" });\n        }).catch((e) => {\n            sendError(event, _t('Unable to create widget.'), e);\n        });\n    } else { // Room widget\n        if (!roomId) {\n            sendError(event, _t('Missing roomId.'), null);\n        }\n        WidgetUtils.setRoomWidget(roomId, widgetId, widgetType, widgetUrl, widgetName, widgetData, widgetAvatarUrl)\n            .then(() => {\n                sendResponse(event, {\n                    success: true,\n                });\n            }, (err) => {\n                sendError(event, _t('Failed to send request.'), err);\n            });\n    }\n}\n\nfunction getWidgets(event: MessageEvent<any>, roomId: string): void {\n    const client = MatrixClientPeg.get();\n    if (!client) {\n        sendError(event, _t('You need to be logged in.'));\n        return;\n    }\n    let widgetStateEvents = [];\n\n    if (roomId) {\n        const room = client.getRoom(roomId);\n        if (!room) {\n            sendError(event, _t('This room is not recognised.'));\n            return;\n        }\n        // XXX: This gets the raw event object (I think because we can't\n        // send the MatrixEvent over postMessage?)\n        widgetStateEvents = WidgetUtils.getRoomWidgets(room).map((ev) => ev.event);\n    }\n\n    // Add user widgets (not linked to a specific room)\n    const userWidgets = WidgetUtils.getUserWidgetsArray();\n    widgetStateEvents = widgetStateEvents.concat(userWidgets);\n\n    sendResponse(event, widgetStateEvents);\n}\n\nfunction getRoomEncState(event: MessageEvent<any>, roomId: string): void {\n    const client = MatrixClientPeg.get();\n    if (!client) {\n        sendError(event, _t('You need to be logged in.'));\n        return;\n    }\n    const room = client.getRoom(roomId);\n    if (!room) {\n        sendError(event, _t('This room is not recognised.'));\n        return;\n    }\n    const roomIsEncrypted = MatrixClientPeg.get().isRoomEncrypted(roomId);\n\n    sendResponse(event, roomIsEncrypted);\n}\n\nfunction setPlumbingState(event: MessageEvent<any>, roomId: string, status: string): void {\n    if (typeof status !== 'string') {\n        throw new Error('Plumbing state status should be a string');\n    }\n    logger.log(`Received request to set plumbing state to status \"${status}\" in room ${roomId}`);\n    const client = MatrixClientPeg.get();\n    if (!client) {\n        sendError(event, _t('You need to be logged in.'));\n        return;\n    }\n    client.sendStateEvent(roomId, \"m.room.plumbing\", { status: status }).then(() => {\n        sendResponse(event, {\n            success: true,\n        });\n    }, (err) => {\n        sendError(event, err.message ? err.message : _t('Failed to send request.'), err);\n    });\n}\n\nfunction setBotOptions(event: MessageEvent<any>, roomId: string, userId: string): void {\n    logger.log(`Received request to set options for bot ${userId} in room ${roomId}`);\n    const client = MatrixClientPeg.get();\n    if (!client) {\n        sendError(event, _t('You need to be logged in.'));\n        return;\n    }\n    client.sendStateEvent(roomId, \"m.room.bot.options\", event.data.content, \"_\" + userId).then(() => {\n        sendResponse(event, {\n            success: true,\n        });\n    }, (err) => {\n        sendError(event, err.message ? err.message : _t('Failed to send request.'), err);\n    });\n}\n\nasync function setBotPower(\n    event: MessageEvent<any>, roomId: string, userId: string, level: number, ignoreIfGreater?: boolean,\n): Promise<void> {\n    if (!(Number.isInteger(level) && level >= 0)) {\n        sendError(event, _t('Power level must be positive integer.'));\n        return;\n    }\n\n    logger.log(`Received request to set power level to ${level} for bot ${userId} in room ${roomId}.`);\n    const client = MatrixClientPeg.get();\n    if (!client) {\n        sendError(event, _t('You need to be logged in.'));\n        return;\n    }\n\n    try {\n        const powerLevels = await client.getStateEvent(roomId, \"m.room.power_levels\", \"\");\n\n        // If the PL is equal to or greater than the requested PL, ignore.\n        if (ignoreIfGreater === true) {\n            // As per https://matrix.org/docs/spec/client_server/r0.6.0#m-room-power-levels\n            const currentPl = powerLevels.users?.[userId] ?? powerLevels.users_default ?? 0;\n            if (currentPl >= level) {\n                return sendResponse(event, {\n                    success: true,\n                });\n            }\n        }\n        await client.setPowerLevel(roomId, userId, level, new MatrixEvent(\n            {\n                type: \"m.room.power_levels\",\n                content: powerLevels,\n            },\n        ));\n        return sendResponse(event, {\n            success: true,\n        });\n    } catch (err) {\n        sendError(event, err.message ? err.message : _t('Failed to send request.'), err);\n    }\n}\n\nfunction getMembershipState(event: MessageEvent<any>, roomId: string, userId: string): void {\n    logger.log(`membership_state of ${userId} in room ${roomId} requested.`);\n    returnStateEvent(event, roomId, \"m.room.member\", userId);\n}\n\nfunction getJoinRules(event: MessageEvent<any>, roomId: string): void {\n    logger.log(`join_rules of ${roomId} requested.`);\n    returnStateEvent(event, roomId, \"m.room.join_rules\", \"\");\n}\n\nfunction botOptions(event: MessageEvent<any>, roomId: string, userId: string): void {\n    logger.log(`bot_options of ${userId} in room ${roomId} requested.`);\n    returnStateEvent(event, roomId, \"m.room.bot.options\", \"_\" + userId);\n}\n\nfunction getMembershipCount(event: MessageEvent<any>, roomId: string): void {\n    const client = MatrixClientPeg.get();\n    if (!client) {\n        sendError(event, _t('You need to be logged in.'));\n        return;\n    }\n    const room = client.getRoom(roomId);\n    if (!room) {\n        sendError(event, _t('This room is not recognised.'));\n        return;\n    }\n    const count = room.getJoinedMemberCount();\n    sendResponse(event, count);\n}\n\nfunction canSendEvent(event: MessageEvent<any>, roomId: string): void {\n    const evType = \"\" + event.data.event_type; // force stringify\n    const isState = Boolean(event.data.is_state);\n    const client = MatrixClientPeg.get();\n    if (!client) {\n        sendError(event, _t('You need to be logged in.'));\n        return;\n    }\n    const room = client.getRoom(roomId);\n    if (!room) {\n        sendError(event, _t('This room is not recognised.'));\n        return;\n    }\n    if (room.getMyMembership() !== \"join\") {\n        sendError(event, _t('You are not in this room.'));\n        return;\n    }\n    const me = client.credentials.userId;\n\n    let canSend = false;\n    if (isState) {\n        canSend = room.currentState.maySendStateEvent(evType, me);\n    } else {\n        canSend = room.currentState.maySendEvent(evType, me);\n    }\n\n    if (!canSend) {\n        sendError(event, _t('You do not have permission to do that in this room.'));\n        return;\n    }\n\n    sendResponse(event, true);\n}\n\nfunction returnStateEvent(event: MessageEvent<any>, roomId: string, eventType: string, stateKey: string): void {\n    const client = MatrixClientPeg.get();\n    if (!client) {\n        sendError(event, _t('You need to be logged in.'));\n        return;\n    }\n    const room = client.getRoom(roomId);\n    if (!room) {\n        sendError(event, _t('This room is not recognised.'));\n        return;\n    }\n    const stateEvent = room.currentState.getStateEvents(eventType, stateKey);\n    if (!stateEvent) {\n        sendResponse(event, null);\n        return;\n    }\n    sendResponse(event, stateEvent.getContent());\n}\n\nasync function getOpenIdToken(event: MessageEvent<any>) {\n    try {\n        const tokenObject = MatrixClientPeg.get().getOpenIdToken();\n        sendResponse(event, tokenObject);\n    } catch (ex) {\n        logger.warn(\"Unable to fetch openId token.\", ex);\n        sendError(event, 'Unable to fetch openId token.');\n    }\n}\n\nconst onMessage = function(event: MessageEvent<any>): void {\n    if (!event.origin) { // stupid chrome\n        // @ts-ignore\n        event.origin = event.originalEvent.origin;\n    }\n\n    // Check that the integrations UI URL starts with the origin of the event\n    // This means the URL could contain a path (like /develop) and still be used\n    // to validate event origins, which do not specify paths.\n    // (See https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage)\n    let configUrl;\n    try {\n        if (!openManagerUrl) openManagerUrl = IntegrationManagers.sharedInstance().getPrimaryManager().uiUrl;\n        configUrl = new URL(openManagerUrl);\n    } catch (e) {\n        // No integrations UI URL, ignore silently.\n        return;\n    }\n    let eventOriginUrl;\n    try {\n        eventOriginUrl = new URL(event.origin);\n    } catch (e) {\n        return;\n    }\n    // TODO -- Scalar postMessage API should be namespaced with event.data.api field\n    // Fix following \"if\" statement to respond only to specific API messages.\n    if (\n        configUrl.origin !== eventOriginUrl.origin ||\n        !event.data.action ||\n        event.data.api // Ignore messages with specific API set\n    ) {\n        // don't log this - debugging APIs and browser add-ons like to spam\n        // postMessage which floods the log otherwise\n        return;\n    }\n\n    if (event.data.action === Action.CloseScalar) {\n        dis.dispatch({ action: Action.CloseScalar });\n        sendResponse(event, null);\n        return;\n    }\n\n    const roomId = event.data.room_id;\n    const userId = event.data.user_id;\n\n    if (!roomId) {\n        // These APIs don't require roomId\n        // Get and set user widgets (not associated with a specific room)\n        // If roomId is specified, it must be validated, so room-based widgets agreed\n        // handled further down.\n        if (event.data.action === Action.GetWidgets) {\n            getWidgets(event, null);\n            return;\n        } else if (event.data.action === Action.SetWidget) {\n            setWidget(event, null);\n            return;\n        } else {\n            sendError(event, _t('Missing room_id in request'));\n            return;\n        }\n    }\n\n    if (roomId !== RoomViewStore.instance.getRoomId()) {\n        sendError(event, _t('Room %(roomId)s not visible', { roomId: roomId }));\n        return;\n    }\n\n    // Get and set room-based widgets\n    if (event.data.action === Action.GetWidgets) {\n        getWidgets(event, roomId);\n        return;\n    } else if (event.data.action === Action.SetWidget) {\n        setWidget(event, roomId);\n        return;\n    }\n\n    // These APIs don't require userId\n    if (event.data.action === Action.JoinRulesState) {\n        getJoinRules(event, roomId);\n        return;\n    } else if (event.data.action === Action.SetPlumbingState) {\n        setPlumbingState(event, roomId, event.data.status);\n        return;\n    } else if (event.data.action === Action.GetMembershipCount) {\n        getMembershipCount(event, roomId);\n        return;\n    } else if (event.data.action === Action.GetRoomEncryptionState) {\n        getRoomEncState(event, roomId);\n        return;\n    } else if (event.data.action === Action.CanSendEvent) {\n        canSendEvent(event, roomId);\n        return;\n    }\n\n    if (!userId) {\n        sendError(event, _t('Missing user_id in request'));\n        return;\n    }\n    switch (event.data.action) {\n        case Action.MembershipState:\n            getMembershipState(event, roomId, userId);\n            break;\n        case Action.invite:\n            inviteUser(event, roomId, userId);\n            break;\n        case Action.BotOptions:\n            botOptions(event, roomId, userId);\n            break;\n        case Action.SetBotOptions:\n            setBotOptions(event, roomId, userId);\n            break;\n        case Action.SetBotPower:\n            setBotPower(event, roomId, userId, event.data.level, event.data.ignoreIfGreater);\n            break;\n        case Action.GetOpenIdToken:\n            getOpenIdToken(event);\n            break;\n        default:\n            logger.warn(\"Unhandled postMessage event with action '\" + event.data.action +\"'\");\n            break;\n    }\n};\n\nlet listenerCount = 0;\nlet openManagerUrl: string = null;\n\nexport function startListening(): void {\n    if (listenerCount === 0) {\n        window.addEventListener(\"message\", onMessage, false);\n    }\n    listenerCount += 1;\n}\n\nexport function stopListening(): void {\n    listenerCount -= 1;\n    if (listenerCount === 0) {\n        window.removeEventListener(\"message\", onMessage);\n    }\n    if (listenerCount < 0) {\n        // Make an error so we get a stack trace\n        const e = new Error(\n            \"ScalarMessaging: mismatched startListening / stopListening detected.\" +\n            \" Negative count\",\n        );\n        logger.error(e);\n    }\n}\n"],"mappings":";;;;;;;;;;AAqPA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AA/PA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AA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"}