{"version":3,"file":"WidgetStore.js","names":["WidgetStore","AsyncStoreWithClient","constructor","defaultDispatcher","Map","roomId","widgetId","initRoom","loadRoomWidgets","matrixClient","getRoom","emit","UPDATE_EVENT","room","ev","getType","getRoomId","initIfNeeded","roomMap","get","WidgetEchoStore","on","onWidgetEchoStoreUpdate","instance","internalInstance","has","set","widgets","onReady","ClientEvent","Room","onRoom","RoomStateEvent","Events","onRoomStateEvents","getRooms","forEach","onNotReady","off","widgetMap","reset","onAction","payload","generateApps","getEchoedRoomWidgets","WidgetUtils","getRoomWidgets","map","makeAppConfig","getStateKey","getContent","getSender","getId","roomInfo","Array","from","values","app","delete","getWidgetUid","edited","existingApp","logger","warn","id","push","persistentWidgetId","ActiveWidgetStore","getPersistentWidgetId","getPersistentRoomId","some","w","log","destroyPersistentWidget","getApps","doesRoomHaveConference","currentWidgets","filter","WidgetType","JITSI","matches","type","hasPendingWidgets","roomHasPendingWidgetsOfType","length","isJoinedToConferenceIn","getWidgetPersistence","window","mxWidgetStore"],"sources":["../../src/stores/WidgetStore.ts"],"sourcesContent":["/*\nCopyright 2020 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { Room } from \"matrix-js-sdk/src/models/room\";\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\nimport { IWidget } from \"matrix-widget-api\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\nimport { ClientEvent } from \"matrix-js-sdk/src/client\";\nimport { RoomStateEvent } from \"matrix-js-sdk/src/models/room-state\";\n\nimport { ActionPayload } from \"../dispatcher/payloads\";\nimport { AsyncStoreWithClient } from \"./AsyncStoreWithClient\";\nimport defaultDispatcher from \"../dispatcher/dispatcher\";\nimport WidgetEchoStore from \"../stores/WidgetEchoStore\";\nimport ActiveWidgetStore from \"../stores/ActiveWidgetStore\";\nimport WidgetUtils from \"../utils/WidgetUtils\";\nimport { WidgetType } from \"../widgets/WidgetType\";\nimport { UPDATE_EVENT } from \"./AsyncStore\";\n\ninterface IState {}\n\nexport interface IApp extends IWidget {\n    roomId: string;\n    eventId: string;\n    // eslint-disable-next-line camelcase\n    avatar_url: string; // MSC2765 https://github.com/matrix-org/matrix-doc/pull/2765\n}\n\ninterface IRoomWidgets {\n    widgets: IApp[];\n}\n\n// TODO consolidate WidgetEchoStore into this\n// TODO consolidate ActiveWidgetStore into this\nexport default class WidgetStore extends AsyncStoreWithClient<IState> {\n    private static internalInstance = new WidgetStore();\n\n    private widgetMap = new Map<string, IApp>(); // Key is widget Unique ID (UID)\n    private roomMap = new Map<string, IRoomWidgets>(); // Key is room ID\n\n    private constructor() {\n        super(defaultDispatcher, {});\n\n        WidgetEchoStore.on(\"update\", this.onWidgetEchoStoreUpdate);\n    }\n\n    public static get instance(): WidgetStore {\n        return WidgetStore.internalInstance;\n    }\n\n    private initRoom(roomId: string) {\n        if (!this.roomMap.has(roomId)) {\n            this.roomMap.set(roomId, {\n                widgets: [],\n            });\n        }\n    }\n\n    protected async onReady(): Promise<any> {\n        this.matrixClient.on(ClientEvent.Room, this.onRoom);\n        this.matrixClient.on(RoomStateEvent.Events, this.onRoomStateEvents);\n        this.matrixClient.getRooms().forEach((room: Room) => {\n            this.loadRoomWidgets(room);\n        });\n        this.emit(UPDATE_EVENT, null); // emit for all rooms\n    }\n\n    protected async onNotReady(): Promise<any> {\n        this.matrixClient.off(ClientEvent.Room, this.onRoom);\n        this.matrixClient.off(RoomStateEvent.Events, this.onRoomStateEvents);\n        this.widgetMap = new Map();\n        this.roomMap = new Map();\n        await this.reset({});\n    }\n\n    // We don't need this, but our contract says we do.\n    protected async onAction(payload: ActionPayload) {\n        return;\n    }\n\n    private onWidgetEchoStoreUpdate = (roomId: string, widgetId: string) => {\n        this.initRoom(roomId);\n        this.loadRoomWidgets(this.matrixClient.getRoom(roomId));\n        this.emit(UPDATE_EVENT, roomId);\n    };\n\n    private generateApps(room: Room): IApp[] {\n        return WidgetEchoStore.getEchoedRoomWidgets(room.roomId, WidgetUtils.getRoomWidgets(room)).map((ev) => {\n            return WidgetUtils.makeAppConfig(\n                ev.getStateKey(), ev.getContent(), ev.getSender(), ev.getRoomId(), ev.getId(),\n            );\n        });\n    }\n\n    private loadRoomWidgets(room: Room) {\n        if (!room) return;\n        const roomInfo = this.roomMap.get(room.roomId) || <IRoomWidgets>{};\n        roomInfo.widgets = [];\n\n        // first clean out old widgets from the map which originate from this room\n        // otherwise we are out of sync with the rest of the app with stale widget events during removal\n        Array.from(this.widgetMap.values()).forEach(app => {\n            if (app.roomId !== room.roomId) return; // skip - wrong room\n            this.widgetMap.delete(WidgetUtils.getWidgetUid(app));\n        });\n\n        let edited = false;\n        this.generateApps(room).forEach(app => {\n            // Sanity check for https://github.com/vector-im/element-web/issues/15705\n            const existingApp = this.widgetMap.get(WidgetUtils.getWidgetUid(app));\n            if (existingApp) {\n                logger.warn(\n                    `Possible widget ID conflict for ${app.id} - wants to store in room ${app.roomId} ` +\n                    `but is currently stored as ${existingApp.roomId} - letting the want win`,\n                );\n            }\n\n            this.widgetMap.set(WidgetUtils.getWidgetUid(app), app);\n            roomInfo.widgets.push(app);\n            edited = true;\n        });\n        if (edited && !this.roomMap.has(room.roomId)) {\n            this.roomMap.set(room.roomId, roomInfo);\n        }\n\n        // If a persistent widget is active, check to see if it's just been removed.\n        // If it has, it needs to destroyed otherwise unmounting the node won't kill it\n        const persistentWidgetId = ActiveWidgetStore.instance.getPersistentWidgetId();\n        if (\n            persistentWidgetId &&\n            ActiveWidgetStore.instance.getPersistentRoomId() === room.roomId &&\n            !roomInfo.widgets.some(w => w.id === persistentWidgetId)\n        ) {\n            logger.log(`Persistent widget ${persistentWidgetId} removed from room ${room.roomId}: destroying.`);\n            ActiveWidgetStore.instance.destroyPersistentWidget(persistentWidgetId, room.roomId);\n        }\n\n        this.emit(room.roomId);\n    }\n\n    private onRoom = (room: Room) => {\n        this.initRoom(room.roomId);\n        this.loadRoomWidgets(room);\n        this.emit(UPDATE_EVENT, room.roomId);\n    };\n\n    private onRoomStateEvents = (ev: MatrixEvent) => {\n        if (ev.getType() !== \"im.vector.modular.widgets\") return; // TODO: Support m.widget too\n        const roomId = ev.getRoomId();\n        this.initRoom(roomId);\n        this.loadRoomWidgets(this.matrixClient.getRoom(roomId));\n        this.emit(UPDATE_EVENT, roomId);\n    };\n\n    public getRoom = (roomId: string, initIfNeeded = false) => {\n        if (initIfNeeded) this.initRoom(roomId); // internally handles \"if needed\"\n        return this.roomMap.get(roomId);\n    };\n\n    public getApps(roomId: string): IApp[] {\n        const roomInfo = this.getRoom(roomId);\n        return roomInfo?.widgets || [];\n    }\n\n    public doesRoomHaveConference(room: Room): boolean {\n        const roomInfo = this.getRoom(room.roomId);\n        if (!roomInfo) return false;\n\n        const currentWidgets = roomInfo.widgets.filter(w => WidgetType.JITSI.matches(w.type));\n        const hasPendingWidgets = WidgetEchoStore.roomHasPendingWidgetsOfType(room.roomId, [], WidgetType.JITSI);\n        return currentWidgets.length > 0 || hasPendingWidgets;\n    }\n\n    public isJoinedToConferenceIn(room: Room): boolean {\n        const roomInfo = this.getRoom(room.roomId);\n        if (!roomInfo) return false;\n\n        // A persistent conference widget indicates that we're participating\n        const widgets = roomInfo.widgets.filter(w => WidgetType.JITSI.matches(w.type));\n        return widgets.some(w => ActiveWidgetStore.instance.getWidgetPersistence(w.id, room.roomId));\n    }\n}\n\nwindow.mxWidgetStore = WidgetStore.instance;\n"],"mappings":"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"}