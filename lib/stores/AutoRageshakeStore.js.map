{"version":3,"file":"AutoRageshakeStore.js","names":["RAGESHAKE_INTERVAL","GRACE_PERIOD","AUTO_RS_REQUEST","AutoRageshakeStore","AsyncStoreWithClient","constructor","defaultDispatcher","reportedSessionIds","Set","lastRageshakeTime","initialSyncCompleted","onDecryptionAttempt","bind","onDeviceMessage","onSyncStateChange","instance","internalInstance","onAction","payload","action","Action","ReportKeyBackupNotEnabled","onReportKeyBackupNotEnabled","onReady","SettingsStore","getValue","matrixClient","on","MatrixEventEvent","Decrypted","ClientEvent","ToDeviceEvent","Sync","onNotReady","removeListener","ev","state","wireContent","getWireContent","sessionId","session_id","isDecryptionFailure","has","sleep","newReportedSessionIds","updateState","add","now","Date","getTime","eventInfo","getId","getRoomId","device_id","getSender","sender_key","rageshakeURL","sendBugReport","SdkConfig","get","bug_report_endpoint_url","userText","sendLogs","labels","customApp","uisi_autorageshake_app","customFields","JSON","stringify","messageContent","sendToDevice","user_id","_state","_prevState","data","nextSyncToken","getType","getContent","recipientRageshake","window","mxAutoRageshakeStore"],"sources":["../../src/stores/AutoRageshakeStore.ts"],"sourcesContent":["/*\nCopyright 2022 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { ClientEvent, MatrixEvent, MatrixEventEvent } from \"matrix-js-sdk/src/matrix\";\nimport { sleep } from \"matrix-js-sdk/src/utils\";\nimport { ISyncStateData, SyncState } from \"matrix-js-sdk/src/sync\";\n\nimport SdkConfig from '../SdkConfig';\nimport sendBugReport from '../rageshake/submit-rageshake';\nimport defaultDispatcher from '../dispatcher/dispatcher';\nimport { AsyncStoreWithClient } from './AsyncStoreWithClient';\nimport { ActionPayload } from '../dispatcher/payloads';\nimport SettingsStore from \"../settings/SettingsStore\";\nimport { Action } from \"../dispatcher/actions\";\n\n// Minimum interval of 1 minute between reports\nconst RAGESHAKE_INTERVAL = 60000;\n// Before rageshaking, wait 5 seconds and see if the message has successfully decrypted\nconst GRACE_PERIOD = 5000;\n// Event type for to-device messages requesting sender auto-rageshakes\nconst AUTO_RS_REQUEST = \"im.vector.auto_rs_request\";\n\ninterface IState {\n    reportedSessionIds: Set<string>;\n    lastRageshakeTime: number;\n    initialSyncCompleted: boolean;\n}\n\n/**\n * Watches for decryption errors to auto-report if the relevant lab is\n * enabled, and keeps track of session IDs that have already been\n * reported.\n */\nexport default class AutoRageshakeStore extends AsyncStoreWithClient<IState> {\n    private static internalInstance = new AutoRageshakeStore();\n\n    private constructor() {\n        super(defaultDispatcher, {\n            reportedSessionIds: new Set<string>(),\n            lastRageshakeTime: 0,\n            initialSyncCompleted: false,\n        });\n        this.onDecryptionAttempt = this.onDecryptionAttempt.bind(this);\n        this.onDeviceMessage = this.onDeviceMessage.bind(this);\n        this.onSyncStateChange = this.onSyncStateChange.bind(this);\n    }\n\n    public static get instance(): AutoRageshakeStore {\n        return AutoRageshakeStore.internalInstance;\n    }\n\n    protected async onAction(payload: ActionPayload) {\n        switch (payload.action) {\n            case Action.ReportKeyBackupNotEnabled:\n                this.onReportKeyBackupNotEnabled();\n        }\n    }\n\n    protected async onReady() {\n        if (!SettingsStore.getValue(\"automaticDecryptionErrorReporting\")) return;\n\n        if (this.matrixClient) {\n            this.matrixClient.on(MatrixEventEvent.Decrypted, this.onDecryptionAttempt);\n            this.matrixClient.on(ClientEvent.ToDeviceEvent, this.onDeviceMessage);\n            this.matrixClient.on(ClientEvent.Sync, this.onSyncStateChange);\n        }\n    }\n\n    protected async onNotReady() {\n        if (this.matrixClient) {\n            this.matrixClient.removeListener(ClientEvent.ToDeviceEvent, this.onDeviceMessage);\n            this.matrixClient.removeListener(MatrixEventEvent.Decrypted, this.onDecryptionAttempt);\n            this.matrixClient.removeListener(ClientEvent.Sync, this.onSyncStateChange);\n        }\n    }\n\n    private async onDecryptionAttempt(ev: MatrixEvent): Promise<void> {\n        if (!this.state.initialSyncCompleted) { return; }\n\n        const wireContent = ev.getWireContent();\n        const sessionId = wireContent.session_id;\n        if (ev.isDecryptionFailure() && !this.state.reportedSessionIds.has(sessionId)) {\n            await sleep(GRACE_PERIOD);\n            if (!ev.isDecryptionFailure()) { return; }\n\n            const newReportedSessionIds = new Set(this.state.reportedSessionIds);\n            await this.updateState({ reportedSessionIds: newReportedSessionIds.add(sessionId) });\n\n            const now = new Date().getTime();\n            if (now - this.state.lastRageshakeTime < RAGESHAKE_INTERVAL) { return; }\n\n            await this.updateState({ lastRageshakeTime: now });\n\n            const eventInfo = {\n                \"event_id\": ev.getId(),\n                \"room_id\": ev.getRoomId(),\n                \"session_id\": sessionId,\n                \"device_id\": wireContent.device_id,\n                \"user_id\": ev.getSender(),\n                \"sender_key\": wireContent.sender_key,\n            };\n\n            const rageshakeURL = await sendBugReport(SdkConfig.get().bug_report_endpoint_url, {\n                userText: \"Auto-reporting decryption error (recipient)\",\n                sendLogs: true,\n                labels: [\"Z-UISI\", \"web\", \"uisi-recipient\"],\n                customApp: SdkConfig.get().uisi_autorageshake_app,\n                customFields: { \"auto_uisi\": JSON.stringify(eventInfo) },\n            });\n\n            const messageContent = {\n                ...eventInfo,\n                \"recipient_rageshake\": rageshakeURL,\n            };\n            this.matrixClient.sendToDevice(\n                AUTO_RS_REQUEST,\n                { [messageContent.user_id]: { [messageContent.device_id]: messageContent } },\n            );\n        }\n    }\n\n    private async onSyncStateChange(_state: SyncState, _prevState: SyncState, data: ISyncStateData) {\n        if (!this.state.initialSyncCompleted) {\n            await this.updateState({ initialSyncCompleted: !!data.nextSyncToken });\n        }\n    }\n\n    private async onDeviceMessage(ev: MatrixEvent): Promise<void> {\n        if (ev.getType() !== AUTO_RS_REQUEST) return;\n        const messageContent = ev.getContent();\n        const recipientRageshake = messageContent[\"recipient_rageshake\"] || \"\";\n        const now = new Date().getTime();\n        if (now - this.state.lastRageshakeTime > RAGESHAKE_INTERVAL) {\n            await this.updateState({ lastRageshakeTime: now });\n            await sendBugReport(SdkConfig.get().bug_report_endpoint_url, {\n                userText: `Auto-reporting decryption error (sender)\\nRecipient rageshake: ${recipientRageshake}`,\n                sendLogs: true,\n                labels: [\"Z-UISI\", \"web\", \"uisi-sender\"],\n                customApp: SdkConfig.get().uisi_autorageshake_app,\n                customFields: {\n                    \"recipient_rageshake\": recipientRageshake,\n                    \"auto_uisi\": JSON.stringify(messageContent),\n                },\n            });\n        }\n    }\n\n    private async onReportKeyBackupNotEnabled(): Promise<void> {\n        if (!SettingsStore.getValue(\"automaticKeyBackNotEnabledReporting\")) return;\n\n        await sendBugReport(SdkConfig.get().bug_report_endpoint_url, {\n            userText: `Auto-reporting key backup not enabled`,\n            sendLogs: true,\n            labels: [\"web\", Action.ReportKeyBackupNotEnabled],\n        });\n    }\n}\n\nwindow.mxAutoRageshakeStore = AutoRageshakeStore.instance;\n"],"mappings":"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"}