{"version":3,"file":"GenericEchoChamber.js","names":["implicitlyReverted","PROPERTY_UPDATED","GenericEchoChamber","EventEmitter","constructor","context","lookupFn","Map","setClient","client","oldClient","matrixClient","onClientChanged","getValue","key","cache","has","get","val","cacheVal","txn","set","emit","decacheKey","disownTransaction","delete","markEchoReceived","cancel","setValue","auditName","targetVal","runFn","revertFn","ctxn","beginTransaction","when","TransactionStatus","Pending","Error","run"],"sources":["../../../src/stores/local-echo/GenericEchoChamber.ts"],"sourcesContent":["/*\nCopyright 2020 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\nhttp://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { MatrixClient } from \"matrix-js-sdk/src/client\";\nimport { EventEmitter } from \"events\";\n\nimport { EchoContext } from \"./EchoContext\";\nimport { EchoTransaction, RunFn, TransactionStatus } from \"./EchoTransaction\";\n\nexport async function implicitlyReverted() {\n    // do nothing :D\n}\n\nexport const PROPERTY_UPDATED = \"property_updated\";\n\nexport abstract class GenericEchoChamber<C extends EchoContext, K, V> extends EventEmitter {\n    private cache = new Map<K, {txn: EchoTransaction, val: V}>();\n    protected matrixClient: MatrixClient;\n\n    protected constructor(public readonly context: C, private lookupFn: (key: K) => V) {\n        super();\n    }\n\n    public setClient(client: MatrixClient) {\n        const oldClient = this.matrixClient;\n        this.matrixClient = client;\n        this.onClientChanged(oldClient, client);\n    }\n\n    protected abstract onClientChanged(oldClient: MatrixClient, newClient: MatrixClient);\n\n    /**\n     * Gets a value. If the key is in flight, the cached value will be returned. If\n     * the key is not in flight then the lookupFn provided to this class will be\n     * called instead.\n     * @param key The key to look up.\n     * @returns The value for the key.\n     */\n    public getValue(key: K): V {\n        return this.cache.has(key) ? this.cache.get(key).val : this.lookupFn(key);\n    }\n\n    private cacheVal(key: K, val: V, txn: EchoTransaction) {\n        this.cache.set(key, { txn, val });\n        this.emit(PROPERTY_UPDATED, key);\n    }\n\n    private decacheKey(key: K) {\n        if (this.cache.has(key)) {\n            this.context.disownTransaction(this.cache.get(key).txn);\n            this.cache.delete(key);\n            this.emit(PROPERTY_UPDATED, key);\n        }\n    }\n\n    protected markEchoReceived(key: K) {\n        if (this.cache.has(key)) {\n            const txn = this.cache.get(key).txn;\n            this.context.disownTransaction(txn);\n            txn.cancel();\n        }\n        this.decacheKey(key);\n    }\n\n    public setValue(auditName: string, key: K, targetVal: V, runFn: RunFn, revertFn: RunFn) {\n        // Cancel any pending transactions for the same key\n        if (this.cache.has(key)) {\n            this.cache.get(key).txn.cancel();\n        }\n\n        const ctxn = this.context.beginTransaction(auditName, runFn);\n        this.cacheVal(key, targetVal, ctxn); // set the cache now as it won't be updated by the .when() ladder below.\n\n        ctxn.when(TransactionStatus.Pending, () => this.cacheVal(key, targetVal, ctxn))\n            .when(TransactionStatus.Error, () => revertFn());\n\n        ctxn.run();\n    }\n}\n"],"mappings":";;;;;;;;;;;;AAiBA;;AAGA;;AApBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAQO,eAAeA,kBAAf,GAAoC,CACvC;AACH;;AAEM,MAAMC,gBAAgB,GAAG,kBAAzB;;;AAEA,MAAeC,kBAAf,SAAuEC,oBAAvE,CAAoF;EAI7EC,WAAW,CAAiBC,OAAjB,EAAqCC,QAArC,EAA8D;IAC/E;IAD+E,KAA7CD,OAA6C,GAA7CA,OAA6C;IAAA,KAAzBC,QAAyB,GAAzBA,QAAyB;IAAA,6CAHnE,IAAIC,GAAJ,EAGmE;IAAA;EAElF;;EAEMC,SAAS,CAACC,MAAD,EAAuB;IACnC,MAAMC,SAAS,GAAG,KAAKC,YAAvB;IACA,KAAKA,YAAL,GAAoBF,MAApB;IACA,KAAKG,eAAL,CAAqBF,SAArB,EAAgCD,MAAhC;EACH;;EAID;AACJ;AACA;AACA;AACA;AACA;AACA;EACWI,QAAQ,CAACC,GAAD,EAAY;IACvB,OAAO,KAAKC,KAAL,CAAWC,GAAX,CAAeF,GAAf,IAAsB,KAAKC,KAAL,CAAWE,GAAX,CAAeH,GAAf,EAAoBI,GAA1C,GAAgD,KAAKZ,QAAL,CAAcQ,GAAd,CAAvD;EACH;;EAEOK,QAAQ,CAACL,GAAD,EAASI,GAAT,EAAiBE,GAAjB,EAAuC;IACnD,KAAKL,KAAL,CAAWM,GAAX,CAAeP,GAAf,EAAoB;MAAEM,GAAF;MAAOF;IAAP,CAApB;IACA,KAAKI,IAAL,CAAUrB,gBAAV,EAA4Ba,GAA5B;EACH;;EAEOS,UAAU,CAACT,GAAD,EAAS;IACvB,IAAI,KAAKC,KAAL,CAAWC,GAAX,CAAeF,GAAf,CAAJ,EAAyB;MACrB,KAAKT,OAAL,CAAamB,iBAAb,CAA+B,KAAKT,KAAL,CAAWE,GAAX,CAAeH,GAAf,EAAoBM,GAAnD;MACA,KAAKL,KAAL,CAAWU,MAAX,CAAkBX,GAAlB;MACA,KAAKQ,IAAL,CAAUrB,gBAAV,EAA4Ba,GAA5B;IACH;EACJ;;EAESY,gBAAgB,CAACZ,GAAD,EAAS;IAC/B,IAAI,KAAKC,KAAL,CAAWC,GAAX,CAAeF,GAAf,CAAJ,EAAyB;MACrB,MAAMM,GAAG,GAAG,KAAKL,KAAL,CAAWE,GAAX,CAAeH,GAAf,EAAoBM,GAAhC;MACA,KAAKf,OAAL,CAAamB,iBAAb,CAA+BJ,GAA/B;MACAA,GAAG,CAACO,MAAJ;IACH;;IACD,KAAKJ,UAAL,CAAgBT,GAAhB;EACH;;EAEMc,QAAQ,CAACC,SAAD,EAAoBf,GAApB,EAA4BgB,SAA5B,EAA0CC,KAA1C,EAAwDC,QAAxD,EAAyE;IACpF;IACA,IAAI,KAAKjB,KAAL,CAAWC,GAAX,CAAeF,GAAf,CAAJ,EAAyB;MACrB,KAAKC,KAAL,CAAWE,GAAX,CAAeH,GAAf,EAAoBM,GAApB,CAAwBO,MAAxB;IACH;;IAED,MAAMM,IAAI,GAAG,KAAK5B,OAAL,CAAa6B,gBAAb,CAA8BL,SAA9B,EAAyCE,KAAzC,CAAb;IACA,KAAKZ,QAAL,CAAcL,GAAd,EAAmBgB,SAAnB,EAA8BG,IAA9B,EAPoF,CAO/C;;IAErCA,IAAI,CAACE,IAAL,CAAUC,kCAAA,CAAkBC,OAA5B,EAAqC,MAAM,KAAKlB,QAAL,CAAcL,GAAd,EAAmBgB,SAAnB,EAA8BG,IAA9B,CAA3C,EACKE,IADL,CACUC,kCAAA,CAAkBE,KAD5B,EACmC,MAAMN,QAAQ,EADjD;IAGAC,IAAI,CAACM,GAAL;EACH;;AA9DsF"}