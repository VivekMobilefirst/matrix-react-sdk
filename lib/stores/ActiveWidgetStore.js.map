{"version":3,"file":"ActiveWidgetStore.js","names":["ActiveWidgetStoreEvent","ActiveWidgetStore","EventEmitter","Map","ev","roomId","getType","destroyPersistentWidget","getStateKey","instance","internalInstance","start","MatrixClientPeg","get","on","RoomStateEvent","Events","onRoomStateEvents","stop","removeListener","widgetId","getWidgetPersistence","WidgetMessagingStore","stopMessagingByUid","WidgetUtils","calcWidgetUid","setWidgetPersistence","val","isPersisted","persistentWidgetId","persistentRoomId","emit","Persistence","getPersistentWidgetId","getPersistentRoomId","dockWidget","uid","refs","dockedWidgetsByUid","set","Dock","undockWidget","Undock","isDocked","isLive","window","mxActiveWidgetStore"],"sources":["../../src/stores/ActiveWidgetStore.ts"],"sourcesContent":["/*\nCopyright 2018 New Vector Ltd\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport EventEmitter from 'events';\nimport { MatrixEvent, RoomStateEvent } from \"matrix-js-sdk/src/matrix\";\nimport { RoomState } from \"matrix-js-sdk/src/models/room-state\";\n\nimport { MatrixClientPeg } from '../MatrixClientPeg';\nimport WidgetUtils from \"../utils/WidgetUtils\";\nimport { WidgetMessagingStore } from \"./widgets/WidgetMessagingStore\";\n\nexport enum ActiveWidgetStoreEvent {\n    // Indicates a change in the currently persistent widget\n    Persistence = \"persistence\",\n    // Indicate changes in the currently docked widgets\n    Dock = \"dock\",\n    Undock = \"undock\",\n}\n\n/**\n * Stores information about the widgets active in the app right now:\n *  * What widget is set to remain always-on-screen, if any\n *    Only one widget may be 'always on screen' at any one time.\n *  * Reference counts to keep track of whether a widget is kept docked or alive\n *    by any components\n */\nexport default class ActiveWidgetStore extends EventEmitter {\n    private static internalInstance: ActiveWidgetStore;\n    private persistentWidgetId: string;\n    private persistentRoomId: string;\n    private dockedWidgetsByUid = new Map<string, number>();\n\n    public static get instance(): ActiveWidgetStore {\n        if (!ActiveWidgetStore.internalInstance) {\n            ActiveWidgetStore.internalInstance = new ActiveWidgetStore();\n        }\n        return ActiveWidgetStore.internalInstance;\n    }\n\n    public start(): void {\n        MatrixClientPeg.get().on(RoomStateEvent.Events, this.onRoomStateEvents);\n    }\n\n    public stop(): void {\n        MatrixClientPeg.get()?.removeListener(RoomStateEvent.Events, this.onRoomStateEvents);\n    }\n\n    private onRoomStateEvents = (ev: MatrixEvent, { roomId }: RoomState): void => {\n        // XXX: This listens for state events in order to remove the active widget.\n        // Everything else relies on views listening for events and calling setters\n        // on this class which is terrible. This store should just listen for events\n        // and keep itself up to date.\n        // TODO: Enable support for m.widget event type (https://github.com/vector-im/element-web/issues/13111)\n        if (ev.getType() === \"im.vector.modular.widgets\") {\n            this.destroyPersistentWidget(ev.getStateKey(), roomId);\n        }\n    };\n\n    public destroyPersistentWidget(widgetId: string, roomId: string): void {\n        if (!this.getWidgetPersistence(widgetId, roomId)) return;\n        WidgetMessagingStore.instance.stopMessagingByUid(WidgetUtils.calcWidgetUid(widgetId, roomId));\n        this.setWidgetPersistence(widgetId, roomId, false);\n    }\n\n    public setWidgetPersistence(widgetId: string, roomId: string, val: boolean): void {\n        const isPersisted = this.getWidgetPersistence(widgetId, roomId);\n\n        if (isPersisted && !val) {\n            this.persistentWidgetId = null;\n            this.persistentRoomId = null;\n        } else if (!isPersisted && val) {\n            this.persistentWidgetId = widgetId;\n            this.persistentRoomId = roomId;\n        }\n        this.emit(ActiveWidgetStoreEvent.Persistence);\n    }\n\n    public getWidgetPersistence(widgetId: string, roomId: string): boolean {\n        return this.persistentWidgetId === widgetId && this.persistentRoomId === roomId;\n    }\n\n    public getPersistentWidgetId(): string {\n        return this.persistentWidgetId;\n    }\n\n    public getPersistentRoomId(): string {\n        return this.persistentRoomId;\n    }\n\n    // Registers the given widget as being docked somewhere in the UI (not a PiP),\n    // to allow its lifecycle to be tracked.\n    public dockWidget(widgetId: string, roomId: string): void {\n        const uid = WidgetUtils.calcWidgetUid(widgetId, roomId);\n        const refs = this.dockedWidgetsByUid.get(uid) ?? 0;\n        this.dockedWidgetsByUid.set(uid, refs + 1);\n        if (refs === 0) this.emit(ActiveWidgetStoreEvent.Dock);\n    }\n\n    public undockWidget(widgetId: string, roomId: string): void {\n        const uid = WidgetUtils.calcWidgetUid(widgetId, roomId);\n        const refs = this.dockedWidgetsByUid.get(uid);\n        if (refs) this.dockedWidgetsByUid.set(uid, refs - 1);\n        if (refs === 1) this.emit(ActiveWidgetStoreEvent.Undock);\n    }\n\n    // Determines whether the given widget is docked anywhere in the UI (not a PiP)\n    public isDocked(widgetId: string, roomId: string): boolean {\n        const uid = WidgetUtils.calcWidgetUid(widgetId, roomId);\n        const refs = this.dockedWidgetsByUid.get(uid) ?? 0;\n        return refs > 0;\n    }\n\n    // Determines whether the given widget is being kept alive in the UI, including PiPs\n    public isLive(widgetId: string, roomId: string): boolean {\n        return this.isDocked(widgetId, roomId) || this.getWidgetPersistence(widgetId, roomId);\n    }\n}\n\nwindow.mxActiveWidgetStore = ActiveWidgetStore.instance;\n"],"mappings":"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"}