{"version":3,"file":"SpaceStore.js","names":["ACTIVE_SPACE_LS_KEY","metaSpaceOrder","MetaSpace","Home","Favourites","People","Orphans","MAX_SUGGESTED_ROOMS","getSpaceContextKey","space","partitionSpacesAndRooms","arr","reduce","result","room","isSpaceRoom","push","validOrder","order","length","Array","from","every","c","charCode","charCodeAt","getChildOrder","ts","roomId","NaN","getRoomFn","RoomNotificationStateStore","instance","getRoomState","SpaceStoreClass","AsyncStoreWithClient","constructor","defaultDispatcher","EnhancedMap","Map","roomIdsBySpace","userIdsBySpace","Set","limit","rooms","matrixClient","getRoomHierarchy","viaMap","forEach","children_state","ev","type","EventType","SpaceChild","content","via","getOrCreate","state_key","add","filter","roomInfo","room_type","RoomType","Space","getRoom","room_id","getMyMembership","map","viaServers","get","e","logger","error","includeDescendantSpaces","useCache","allRoomsInHome","getVisibleRooms","r","isMetaSpace","getAggregatedRoomIdsBySpace","childSpacesBySpace","undefined","getAggregatedUserIdsBySpace","flattenSpaceHierarchyWithCache","_aggregatedSpaceCache","rootSpace","unseen","stack","pop","delete","getChildSpaces","has","joinedSpaces","unseenSpaces","subspace","rootSpaces","detachedNodes","sortBy","markTreeChildren","detachedNode","visibleSpaces","invitedSpaces","s","joined","invited","getEffectiveMembership","EffectiveMembership","Join","Invite","findRootSpaces","oldRootSpaces","sortRootSpaces","onRoomsUpdate","arrayHasOrderChange","emit","UPDATE_TOP_LEVEL_SPACES","spacePanelSpaces","enabledMetaSpaces","oldInvitedSpaces","_invitedSpaces","setHasDiff","UPDATE_INVITED_SPACES","parentMap","children","getChildren","child","PosthogAnalytics","setProperty","showInHomeSpace","set","activeSpace","switchSpaceIfNeeded","visibleRooms","rebuildHomeSpace","favourites","tags","DefaultTagID","Favourite","orphans","size","DMRoomMap","shared","getUserIdForRoomId","spaces","dmBadgeSpace","keys","flattenedRoomsForSpace","getSpaceFilteredRoomIds","getNotificationState","setRooms","isRoomInSpace","notificationStateMap","userId","inSpace","isInSpace","getMember","clear","affectedParentSpaceIds","getKnownParents","spaceId","prevRoomsBySpace","prevUsersBySpace","prevChildSpacesBySpace","rebuildParentMap","rebuildMetaSpaces","hiddenChildren","getParents","parent","traverseSpace","parentPath","childSpaces","childRooms","roomIds","userIds","getMembers","m","membership","newPath","childSpace","expandedRoomIds","flatMap","getRoomUpgradeHistory","roomDiff","mapDiff","userDiff","spaceDiff","roomsChanged","changed","k","usersChanged","spacesChanged","changeSet","added","removed","affectedParents","changedId","parentId","notificationStatesToUpdate","includes","updateNotificationStates","RoomViewStore","getRoomId","switchToRelatedSpace","suggestedRooms","find","getCanonicalParent","reverse","setActiveSpace","goToFirstSpace","newMembership","oldMembership","roomMembership","numSuggestedRooms","_suggestedRooms","UPDATE_SUGGESTED_ROOMS","len","rebuildSpaceHierarchy","getType","target","getStateKey","getPrevContent","suggested","getContent","loadSuggestedRooms","SpaceParent","RoomPowerLevels","getDMRoomsForUserId","onMemberUpdate","lastEv","SpaceOrder","spaceOrderLocalEchoMap","lastOrder","notifyIfOrderChanged","Tag","oldTags","newTags","onRoomFavouriteChange","prevEv","Direct","previousRooms","Object","values","flat","currentRooms","diff","setDiff","onRoomDmChange","getAccountData","SettingsStore","monitorSetting","_enabledMetaSpaces","_activeSpace","activeSpaceRoom","_allRoomsInHome","setActiveRoomInSpace","getFirstRoomWithNotifications","dispatch","action","Action","ViewRoom","context_switch","metricsTrigger","lists","RoomListStore","orderedLists","i","TAG_ORDER","t","listRooms","unreadRoom","state","isUnread","contextSwitch","cliSpace","window","localStorage","setItem","getItem","ViewHomePage","UPDATE_SELECTED_SPACE","SpaceStore","loadMembersIfNeeded","fetchSuggestedRooms","addRoomToSpace","sendStateEvent","childEvents","currentState","getStateEvents","getTs","history","getChildRooms","canonicalOnly","getUserId","isArray","canonical","relation","maySendStateEvent","Boolean","parents","includeAncestors","flattenSpaceHierarchy","dmPartner","getSpaceFilteredUserIds","getValue","member","isDm","homeRooms","reset","onNotReady","removeListener","ClientEvent","Room","onRoom","RoomEvent","MyMembership","AccountData","onRoomAccountData","RoomStateEvent","Events","onRoomState","Members","onRoomStateMembers","onAccountData","onReady","on","oldMetaSpaces","sendUserProperties","arrayHasDiff","lastSpaceId","valid","enabled","onAction","payload","isSpace","justCreatedOpts","roomType","room_alias","getCachedRoomIDForAlias","AfterLeaveRoom","SwitchSpace","num","numMetaSpaces","SettingUpdated","settingName","newValue","UPDATE_HOME_BEHAVIOUR","hadPeopleOrHomeEnabled","some","hasPeopleOrHomeEnabled","key","SpaceNotificationState","fn","includeRooms","getSpaceTagOrdering","setRootSpaceOrder","setRoomAccountData","warn","moveRootSpace","fromIndex","toIndex","currentOrders","changes","reorderLexicographically","index","internalInstance","mxSpaceStore"],"sources":["../../../src/stores/spaces/SpaceStore.ts"],"sourcesContent":["/*\nCopyright 2021 - 2022 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { ListIteratee, Many, sortBy } from \"lodash\";\nimport { EventType, RoomType } from \"matrix-js-sdk/src/@types/event\";\nimport { Room, RoomEvent } from \"matrix-js-sdk/src/models/room\";\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\nimport { ClientEvent } from \"matrix-js-sdk/src/client\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\nimport { RoomMember } from \"matrix-js-sdk/src/models/room-member\";\nimport { RoomStateEvent } from \"matrix-js-sdk/src/models/room-state\";\n\nimport { AsyncStoreWithClient } from \"../AsyncStoreWithClient\";\nimport defaultDispatcher from \"../../dispatcher/dispatcher\";\nimport RoomListStore from \"../room-list/RoomListStore\";\nimport SettingsStore from \"../../settings/SettingsStore\";\nimport DMRoomMap from \"../../utils/DMRoomMap\";\nimport { FetchRoomFn } from \"../notifications/ListNotificationState\";\nimport { SpaceNotificationState } from \"../notifications/SpaceNotificationState\";\nimport { RoomNotificationStateStore } from \"../notifications/RoomNotificationStateStore\";\nimport { DefaultTagID } from \"../room-list/models\";\nimport { EnhancedMap, mapDiff } from \"../../utils/maps\";\nimport { setDiff, setHasDiff } from \"../../utils/sets\";\nimport { RoomViewStore } from \"../RoomViewStore\";\nimport { Action } from \"../../dispatcher/actions\";\nimport { arrayHasDiff, arrayHasOrderChange } from \"../../utils/arrays\";\nimport { reorderLexicographically } from \"../../utils/stringOrderField\";\nimport { TAG_ORDER } from \"../../components/views/rooms/RoomList\";\nimport { SettingUpdatedPayload } from \"../../dispatcher/payloads/SettingUpdatedPayload\";\nimport {\n    isMetaSpace,\n    ISuggestedRoom,\n    MetaSpace,\n    SpaceKey,\n    UPDATE_HOME_BEHAVIOUR,\n    UPDATE_INVITED_SPACES,\n    UPDATE_SELECTED_SPACE,\n    UPDATE_SUGGESTED_ROOMS,\n    UPDATE_TOP_LEVEL_SPACES,\n} from \".\";\nimport { getCachedRoomIDForAlias } from \"../../RoomAliasCache\";\nimport { EffectiveMembership, getEffectiveMembership } from \"../../utils/membership\";\nimport {\n    flattenSpaceHierarchyWithCache,\n    SpaceEntityMap,\n    SpaceDescendantMap,\n    flattenSpaceHierarchy,\n} from \"./flattenSpaceHierarchy\";\nimport { PosthogAnalytics } from \"../../PosthogAnalytics\";\nimport { ViewRoomPayload } from \"../../dispatcher/payloads/ViewRoomPayload\";\nimport { ViewHomePagePayload } from \"../../dispatcher/payloads/ViewHomePagePayload\";\nimport { SwitchSpacePayload } from \"../../dispatcher/payloads/SwitchSpacePayload\";\nimport { AfterLeaveRoomPayload } from \"../../dispatcher/payloads/AfterLeaveRoomPayload\";\n\ninterface IState { }\n\nconst ACTIVE_SPACE_LS_KEY = \"mx_active_space\";\n\nconst metaSpaceOrder: MetaSpace[] = [MetaSpace.Home, MetaSpace.Favourites, MetaSpace.People, MetaSpace.Orphans];\n\nconst MAX_SUGGESTED_ROOMS = 20;\n\nconst getSpaceContextKey = (space: SpaceKey) => `mx_space_context_${space}`;\n\nconst partitionSpacesAndRooms = (arr: Room[]): [Room[], Room[]] => { // [spaces, rooms]\n    return arr.reduce((result, room: Room) => {\n        result[room.isSpaceRoom() ? 0 : 1].push(room);\n        return result;\n    }, [[], []]);\n};\n\nconst validOrder = (order: string): string | undefined => {\n    if (typeof order === \"string\" && order.length <= 50 && Array.from(order).every((c: string) => {\n        const charCode = c.charCodeAt(0);\n        return charCode >= 0x20 && charCode <= 0x7E;\n    })) {\n        return order;\n    }\n};\n\n// For sorting space children using a validated `order`, `origin_server_ts`, `room_id`\nexport const getChildOrder = (order: string, ts: number, roomId: string): Array<Many<ListIteratee<unknown>>> => {\n    return [validOrder(order) ?? NaN, ts, roomId]; // NaN has lodash sort it at the end in asc\n};\n\nconst getRoomFn: FetchRoomFn = (room: Room) => {\n    return RoomNotificationStateStore.instance.getRoomState(room);\n};\n\ntype SpaceStoreActions =\n    | SettingUpdatedPayload\n    | ViewRoomPayload\n    | ViewHomePagePayload\n    | SwitchSpacePayload\n    | AfterLeaveRoomPayload;\n\nexport class SpaceStoreClass extends AsyncStoreWithClient<IState> {\n    // The spaces representing the roots of the various tree-like hierarchies\n    private rootSpaces: Room[] = [];\n    // Map from room/space ID to set of spaces which list it as a child\n    private parentMap = new EnhancedMap<string, Set<string>>();\n    // Map from SpaceKey to SpaceNotificationState instance representing that space\n    private notificationStateMap = new Map<SpaceKey, SpaceNotificationState>();\n    // Map from SpaceKey to Set of room IDs that are direct descendants of that space\n    private roomIdsBySpace: SpaceEntityMap = new Map<SpaceKey, Set<string>>(); // won't contain MetaSpace.People\n    // Map from space id to Set of space keys that are direct descendants of that space\n    // meta spaces do not have descendants\n    private childSpacesBySpace: SpaceDescendantMap = new Map<Room[\"roomId\"], Set<Room[\"roomId\"]>>();\n    // Map from space id to Set of user IDs that are direct descendants of that space\n    private userIdsBySpace: SpaceEntityMap = new Map<Room[\"roomId\"], Set<string>>();\n    // cache that stores the aggregated lists of roomIdsBySpace and userIdsBySpace\n    // cleared on changes\n    private _aggregatedSpaceCache = {\n        roomIdsBySpace: new Map<SpaceKey, Set<string>>(),\n        userIdsBySpace: new Map<Room[\"roomId\"], Set<string>>(),\n    };\n    // The space currently selected in the Space Panel\n    private _activeSpace?: SpaceKey = MetaSpace.Home; // set properly by onReady\n    private _suggestedRooms: ISuggestedRoom[] = [];\n    private _invitedSpaces = new Set<Room>();\n    private spaceOrderLocalEchoMap = new Map<string, string>();\n    // The following properties are set by onReady as they live in account_data\n    private _allRoomsInHome = false;\n    private _enabledMetaSpaces: MetaSpace[] = [];\n\n    constructor() {\n        super(defaultDispatcher, {});\n\n        SettingsStore.monitorSetting(\"Spaces.allRoomsInHome\", null);\n        SettingsStore.monitorSetting(\"Spaces.enabledMetaSpaces\", null);\n        SettingsStore.monitorSetting(\"Spaces.showPeopleInSpace\", null);\n    }\n\n    public get invitedSpaces(): Room[] {\n        return Array.from(this._invitedSpaces);\n    }\n\n    public get enabledMetaSpaces(): MetaSpace[] {\n        return this._enabledMetaSpaces;\n    }\n\n    public get spacePanelSpaces(): Room[] {\n        return this.rootSpaces;\n    }\n\n    public get activeSpace(): SpaceKey {\n        return this._activeSpace;\n    }\n\n    public get activeSpaceRoom(): Room | null {\n        if (isMetaSpace(this._activeSpace)) return null;\n        return this.matrixClient?.getRoom(this._activeSpace);\n    }\n\n    public get suggestedRooms(): ISuggestedRoom[] {\n        return this._suggestedRooms;\n    }\n\n    public get allRoomsInHome(): boolean {\n        return this._allRoomsInHome;\n    }\n\n    public setActiveRoomInSpace(space: SpaceKey): void {\n        if (!isMetaSpace(space) && !this.matrixClient?.getRoom(space)?.isSpaceRoom()) return;\n        if (space !== this.activeSpace) this.setActiveSpace(space, false);\n\n        if (space) {\n            const roomId = this.getNotificationState(space).getFirstRoomWithNotifications();\n            defaultDispatcher.dispatch<ViewRoomPayload>({\n                action: Action.ViewRoom,\n                room_id: roomId,\n                context_switch: true,\n                metricsTrigger: \"WebSpacePanelNotificationBadge\",\n            });\n        } else {\n            const lists = RoomListStore.instance.orderedLists;\n            for (let i = 0; i < TAG_ORDER.length; i++) {\n                const t = TAG_ORDER[i];\n                const listRooms = lists[t];\n                const unreadRoom = listRooms.find((r: Room) => {\n                    if (this.showInHomeSpace(r)) {\n                        const state = RoomNotificationStateStore.instance.getRoomState(r);\n                        return state.isUnread;\n                    }\n                });\n                if (unreadRoom) {\n                    defaultDispatcher.dispatch<ViewRoomPayload>({\n                        action: Action.ViewRoom,\n                        room_id: unreadRoom.roomId,\n                        context_switch: true,\n                        metricsTrigger: \"WebSpacePanelNotificationBadge\",\n                    });\n                    break;\n                }\n            }\n        }\n    }\n\n    /**\n     * Sets the active space, updates room list filters,\n     * optionally switches the user's room back to where they were when they last viewed that space.\n     * @param space which space to switch to.\n     * @param contextSwitch whether to switch the user's context,\n     * should not be done when the space switch is done implicitly due to another event like switching room.\n     */\n    public setActiveSpace(space: SpaceKey, contextSwitch = true) {\n        if (!space || !this.matrixClient || space === this.activeSpace) return;\n\n        let cliSpace: Room;\n        if (!isMetaSpace(space)) {\n            cliSpace = this.matrixClient.getRoom(space);\n            if (!cliSpace?.isSpaceRoom()) return;\n        } else if (!this.enabledMetaSpaces.includes(space as MetaSpace)) {\n            return;\n        }\n\n        window.localStorage.setItem(ACTIVE_SPACE_LS_KEY, this._activeSpace = space); // Update & persist selected space\n\n        if (contextSwitch) {\n            // view last selected room from space\n            const roomId = window.localStorage.getItem(getSpaceContextKey(space));\n\n            // if the space being selected is an invite then always view that invite\n            // else if the last viewed room in this space is joined then view that\n            // else view space home or home depending on what is being clicked on\n            if (cliSpace?.getMyMembership() !== \"invite\" &&\n                this.matrixClient.getRoom(roomId)?.getMyMembership() === \"join\" &&\n                this.isRoomInSpace(space, roomId)\n            ) {\n                defaultDispatcher.dispatch<ViewRoomPayload>({\n                    action: Action.ViewRoom,\n                    room_id: roomId,\n                    context_switch: true,\n                    metricsTrigger: \"WebSpaceContextSwitch\",\n                });\n            } else if (cliSpace) {\n                defaultDispatcher.dispatch<ViewRoomPayload>({\n                    action: Action.ViewRoom,\n                    room_id: space,\n                    context_switch: true,\n                    metricsTrigger: \"WebSpaceContextSwitch\",\n                });\n            } else {\n                defaultDispatcher.dispatch<ViewHomePagePayload>({\n                    action: Action.ViewHomePage,\n                    context_switch: true,\n                });\n            }\n        }\n\n        this.emit(UPDATE_SELECTED_SPACE, this.activeSpace);\n        this.emit(UPDATE_SUGGESTED_ROOMS, this._suggestedRooms = []);\n\n        if (cliSpace) {\n            this.loadSuggestedRooms(cliSpace);\n\n            // Load all members for the selected space and its subspaces,\n            // so we can correctly show DMs we have with members of this space.\n            SpaceStore.instance.traverseSpace(space, roomId => {\n                this.matrixClient.getRoom(roomId)?.loadMembersIfNeeded();\n            }, false);\n        }\n    }\n\n    private async loadSuggestedRooms(space: Room): Promise<void> {\n        const suggestedRooms = await this.fetchSuggestedRooms(space);\n        if (this._activeSpace === space.roomId) {\n            this._suggestedRooms = suggestedRooms;\n            this.emit(UPDATE_SUGGESTED_ROOMS, this._suggestedRooms);\n        }\n    }\n\n    public fetchSuggestedRooms = async (space: Room, limit = MAX_SUGGESTED_ROOMS): Promise<ISuggestedRoom[]> => {\n        try {\n            const { rooms } = await this.matrixClient.getRoomHierarchy(space.roomId, limit, 1, true);\n\n            const viaMap = new EnhancedMap<string, Set<string>>();\n            rooms.forEach(room => {\n                room.children_state.forEach(ev => {\n                    if (ev.type === EventType.SpaceChild && ev.content.via?.length) {\n                        ev.content.via.forEach(via => {\n                            viaMap.getOrCreate(ev.state_key, new Set()).add(via);\n                        });\n                    }\n                });\n            });\n\n            return rooms.filter(roomInfo => {\n                return roomInfo.room_type !== RoomType.Space\n                    && this.matrixClient.getRoom(roomInfo.room_id)?.getMyMembership() !== \"join\";\n            }).map(roomInfo => ({\n                ...roomInfo,\n                viaServers: Array.from(viaMap.get(roomInfo.room_id) || []),\n            }));\n        } catch (e) {\n            logger.error(e);\n        }\n        return [];\n    };\n\n    public addRoomToSpace(space: Room, roomId: string, via: string[], suggested = false) {\n        return this.matrixClient.sendStateEvent(space.roomId, EventType.SpaceChild, {\n            via,\n            suggested,\n        }, roomId);\n    }\n\n    public getChildren(spaceId: string): Room[] {\n        const room = this.matrixClient?.getRoom(spaceId);\n        const childEvents = room?.currentState.getStateEvents(EventType.SpaceChild).filter(ev => ev.getContent()?.via);\n        return sortBy(childEvents, ev => {\n            return getChildOrder(ev.getContent().order, ev.getTs(), ev.getStateKey());\n        }).map(ev => {\n            const history = this.matrixClient.getRoomUpgradeHistory(ev.getStateKey(), true);\n            return history[history.length - 1];\n        }).filter(room => {\n            return room?.getMyMembership() === \"join\" || room?.getMyMembership() === \"invite\";\n        }) || [];\n    }\n\n    public getChildRooms(spaceId: string): Room[] {\n        return this.getChildren(spaceId).filter(r => !r.isSpaceRoom());\n    }\n\n    public getChildSpaces(spaceId: string): Room[] {\n        // don't show invited subspaces as they surface at the top level for better visibility\n        return this.getChildren(spaceId).filter(r => r.isSpaceRoom() && r.getMyMembership() === \"join\");\n    }\n\n    public getParents(roomId: string, canonicalOnly = false): Room[] {\n        const userId = this.matrixClient?.getUserId();\n        const room = this.matrixClient?.getRoom(roomId);\n        return room?.currentState.getStateEvents(EventType.SpaceParent)\n            .map(ev => {\n                const content = ev.getContent();\n                if (!Array.isArray(content.via) || (canonicalOnly && !content.canonical)) {\n                    return; // skip\n                }\n\n                // only respect the relationship if the sender has sufficient permissions in the parent to set\n                // child relations, as per MSC1772.\n                // https://github.com/matrix-org/matrix-doc/blob/main/proposals/1772-groups-as-rooms.md#relationship-between-rooms-and-spaces\n                const parent = this.matrixClient.getRoom(ev.getStateKey());\n                const relation = parent?.currentState.getStateEvents(EventType.SpaceChild, roomId);\n                if (!parent?.currentState.maySendStateEvent(EventType.SpaceChild, userId) ||\n                    // also skip this relation if the parent had this child added but then since removed it\n                    (relation && !Array.isArray(relation.getContent().via))\n                ) {\n                    return; // skip\n                }\n\n                return parent;\n            })\n            .filter(Boolean) || [];\n    }\n\n    public getCanonicalParent(roomId: string): Room | null {\n        const parents = this.getParents(roomId, true);\n        return sortBy(parents, r => r.roomId)?.[0] || null;\n    }\n\n    public getKnownParents(roomId: string, includeAncestors?: boolean): Set<string> {\n        if (includeAncestors) {\n            return flattenSpaceHierarchy(this.parentMap, this.parentMap, roomId);\n        }\n        return this.parentMap.get(roomId) || new Set();\n    }\n\n    public isRoomInSpace(space: SpaceKey, roomId: string, includeDescendantSpaces = true): boolean {\n        if (space === MetaSpace.Home && this.allRoomsInHome) {\n            return true;\n        }\n\n        if (this.getSpaceFilteredRoomIds(space, includeDescendantSpaces)?.has(roomId)) {\n            return true;\n        }\n\n        const dmPartner = DMRoomMap.shared().getUserIdForRoomId(roomId);\n        if (!dmPartner) {\n            return false;\n        }\n        // beyond this point we know this is a DM\n\n        if (space === MetaSpace.Home || space === MetaSpace.People) {\n            // these spaces contain all DMs\n            return true;\n        }\n\n        if (!isMetaSpace(space) &&\n            this.getSpaceFilteredUserIds(space, includeDescendantSpaces)?.has(dmPartner) &&\n            SettingsStore.getValue(\"Spaces.showPeopleInSpace\", space)\n        ) {\n            return true;\n        }\n\n        return false;\n    }\n\n    // get all rooms in a space\n    // including descendant spaces\n    public getSpaceFilteredRoomIds = (\n        space: SpaceKey, includeDescendantSpaces = true, useCache = true,\n    ): Set<string> => {\n        if (space === MetaSpace.Home && this.allRoomsInHome) {\n            return new Set(this.matrixClient.getVisibleRooms().map(r => r.roomId));\n        }\n\n        // meta spaces never have descendants\n        // and the aggregate cache is not managed for meta spaces\n        if (!includeDescendantSpaces || isMetaSpace(space)) {\n            return this.roomIdsBySpace.get(space) || new Set();\n        }\n\n        return this.getAggregatedRoomIdsBySpace(this.roomIdsBySpace, this.childSpacesBySpace, space, useCache);\n    };\n\n    public getSpaceFilteredUserIds = (\n        space: SpaceKey, includeDescendantSpaces = true, useCache = true,\n    ): Set<string> => {\n        if (space === MetaSpace.Home && this.allRoomsInHome) {\n            return undefined;\n        }\n        if (isMetaSpace(space)) {\n            return undefined;\n        }\n\n        // meta spaces never have descendants\n        // and the aggregate cache is not managed for meta spaces\n        if (!includeDescendantSpaces || isMetaSpace(space)) {\n            return this.userIdsBySpace.get(space) || new Set();\n        }\n\n        return this.getAggregatedUserIdsBySpace(this.userIdsBySpace, this.childSpacesBySpace, space, useCache);\n    };\n\n    private getAggregatedRoomIdsBySpace = flattenSpaceHierarchyWithCache(this._aggregatedSpaceCache.roomIdsBySpace);\n    private getAggregatedUserIdsBySpace = flattenSpaceHierarchyWithCache(this._aggregatedSpaceCache.userIdsBySpace);\n\n    private markTreeChildren = (rootSpace: Room, unseen: Set<Room>): void => {\n        const stack = [rootSpace];\n        while (stack.length) {\n            const space = stack.pop();\n            unseen.delete(space);\n            this.getChildSpaces(space.roomId).forEach(space => {\n                if (unseen.has(space)) {\n                    stack.push(space);\n                }\n            });\n        }\n    };\n\n    private findRootSpaces = (joinedSpaces: Room[]): Room[] => {\n        // exclude invited spaces from unseenChildren as they will be forcibly shown at the top level of the treeview\n        const unseenSpaces = new Set(joinedSpaces);\n\n        joinedSpaces.forEach(space => {\n            this.getChildSpaces(space.roomId).forEach(subspace => {\n                unseenSpaces.delete(subspace);\n            });\n        });\n\n        // Consider any spaces remaining in unseenSpaces as root,\n        // given they are not children of any known spaces.\n        // The hierarchy from these roots may not yet be exhaustive due to the possibility of full-cycles.\n        const rootSpaces = Array.from(unseenSpaces);\n\n        // Next we need to determine the roots of any remaining full-cycles.\n        // We sort spaces by room ID to force the cycle breaking to be deterministic.\n        const detachedNodes = new Set<Room>(sortBy(joinedSpaces, space => space.roomId));\n\n        // Mark any nodes which are children of our existing root spaces as attached.\n        rootSpaces.forEach(rootSpace => {\n            this.markTreeChildren(rootSpace, detachedNodes);\n        });\n\n        // Handle spaces forming fully cyclical relationships.\n        // In order, assume each remaining detachedNode is a root unless it has already\n        // been claimed as the child of prior detached node.\n        // Work from a copy of the detachedNodes set as it will be mutated as part of this operation.\n        // TODO consider sorting by number of in-refs to favour nodes with fewer parents.\n        Array.from(detachedNodes).forEach(detachedNode => {\n            if (!detachedNodes.has(detachedNode)) return; // already claimed, skip\n            // declare this detached node a new root, find its children, without ever looping back to it\n            rootSpaces.push(detachedNode); // consider this node a new root space\n            this.markTreeChildren(detachedNode, detachedNodes); // declare this node and its children attached\n        });\n\n        return rootSpaces;\n    };\n\n    private rebuildSpaceHierarchy = () => {\n        const visibleSpaces = this.matrixClient.getVisibleRooms().filter(r => r.isSpaceRoom());\n        const [joinedSpaces, invitedSpaces] = visibleSpaces.reduce(([joined, invited], s) => {\n            switch (getEffectiveMembership(s.getMyMembership())) {\n                case EffectiveMembership.Join:\n                    joined.push(s);\n                    break;\n                case EffectiveMembership.Invite:\n                    invited.push(s);\n                    break;\n            }\n            return [joined, invited];\n        }, [[], []] as [Room[], Room[]]);\n\n        const rootSpaces = this.findRootSpaces(joinedSpaces);\n        const oldRootSpaces = this.rootSpaces;\n        this.rootSpaces = this.sortRootSpaces(rootSpaces);\n\n        this.onRoomsUpdate();\n\n        if (arrayHasOrderChange(oldRootSpaces, this.rootSpaces)) {\n            this.emit(UPDATE_TOP_LEVEL_SPACES, this.spacePanelSpaces, this.enabledMetaSpaces);\n        }\n\n        const oldInvitedSpaces = this._invitedSpaces;\n        this._invitedSpaces = new Set(this.sortRootSpaces(invitedSpaces));\n        if (setHasDiff(oldInvitedSpaces, this._invitedSpaces)) {\n            this.emit(UPDATE_INVITED_SPACES, this.invitedSpaces);\n        }\n    };\n\n    private rebuildParentMap = () => {\n        const joinedSpaces = this.matrixClient.getVisibleRooms().filter(r => {\n            return r.isSpaceRoom() && r.getMyMembership() === \"join\";\n        });\n\n        this.parentMap = new EnhancedMap<string, Set<string>>();\n        joinedSpaces.forEach(space => {\n            const children = this.getChildren(space.roomId);\n            children.forEach(child => {\n                this.parentMap.getOrCreate(child.roomId, new Set()).add(space.roomId);\n            });\n        });\n\n        PosthogAnalytics.instance.setProperty(\"numSpaces\", joinedSpaces.length);\n    };\n\n    private rebuildHomeSpace = () => {\n        if (this.allRoomsInHome) {\n            // this is a special-case to not have to maintain a set of all rooms\n            this.roomIdsBySpace.delete(MetaSpace.Home);\n        } else {\n            const rooms = new Set(this.matrixClient.getVisibleRooms().filter(this.showInHomeSpace).map(r => r.roomId));\n            this.roomIdsBySpace.set(MetaSpace.Home, rooms);\n        }\n\n        if (this.activeSpace === MetaSpace.Home) {\n            this.switchSpaceIfNeeded();\n        }\n    };\n\n    private rebuildMetaSpaces = () => {\n        const enabledMetaSpaces = new Set(this.enabledMetaSpaces);\n        const visibleRooms = this.matrixClient.getVisibleRooms();\n\n        if (enabledMetaSpaces.has(MetaSpace.Home)) {\n            this.rebuildHomeSpace();\n        } else {\n            this.roomIdsBySpace.delete(MetaSpace.Home);\n        }\n\n        if (enabledMetaSpaces.has(MetaSpace.Favourites)) {\n            const favourites = visibleRooms.filter(r => r.tags[DefaultTagID.Favourite]);\n            this.roomIdsBySpace.set(MetaSpace.Favourites, new Set(favourites.map(r => r.roomId)));\n        } else {\n            this.roomIdsBySpace.delete(MetaSpace.Favourites);\n        }\n\n        // The People metaspace doesn't need maintaining\n\n        // Populate the orphans space if the Home space is enabled as it is a superset of it.\n        // Home is effectively a super set of People + Orphans with the addition of having all invites too.\n        if (enabledMetaSpaces.has(MetaSpace.Orphans) || enabledMetaSpaces.has(MetaSpace.Home)) {\n            const orphans = visibleRooms.filter(r => {\n                // filter out DMs and rooms with >0 parents\n                return !this.parentMap.get(r.roomId)?.size && !DMRoomMap.shared().getUserIdForRoomId(r.roomId);\n            });\n            this.roomIdsBySpace.set(MetaSpace.Orphans, new Set(orphans.map(r => r.roomId)));\n        }\n\n        if (isMetaSpace(this.activeSpace)) {\n            this.switchSpaceIfNeeded();\n        }\n    };\n\n    private updateNotificationStates = (spaces?: SpaceKey[]) => {\n        const enabledMetaSpaces = new Set(this.enabledMetaSpaces);\n        const visibleRooms = this.matrixClient.getVisibleRooms();\n\n        let dmBadgeSpace: MetaSpace;\n        // only show badges on dms on the most relevant space if such exists\n        if (enabledMetaSpaces.has(MetaSpace.People)) {\n            dmBadgeSpace = MetaSpace.People;\n        } else if (enabledMetaSpaces.has(MetaSpace.Home)) {\n            dmBadgeSpace = MetaSpace.Home;\n        }\n\n        if (!spaces) {\n            spaces = [...this.roomIdsBySpace.keys()];\n            if (dmBadgeSpace === MetaSpace.People) {\n                spaces.push(MetaSpace.People);\n            }\n            if (enabledMetaSpaces.has(MetaSpace.Home) && !this.allRoomsInHome) {\n                spaces.push(MetaSpace.Home);\n            }\n        }\n\n        spaces.forEach((s) => {\n            if (this.allRoomsInHome && s === MetaSpace.Home) return; // we'll be using the global notification state, skip\n\n            const flattenedRoomsForSpace = this.getSpaceFilteredRoomIds(s, true);\n\n            // Update NotificationStates\n            this.getNotificationState(s).setRooms(visibleRooms.filter(room => {\n                if (s === MetaSpace.People) {\n                    return this.isRoomInSpace(MetaSpace.People, room.roomId);\n                }\n\n                if (room.isSpaceRoom() || !flattenedRoomsForSpace.has(room.roomId)) return false;\n\n                if (dmBadgeSpace && DMRoomMap.shared().getUserIdForRoomId(room.roomId)) {\n                    return s === dmBadgeSpace;\n                }\n\n                return true;\n            }));\n        });\n\n        if (dmBadgeSpace !== MetaSpace.People) {\n            this.notificationStateMap.delete(MetaSpace.People);\n        }\n    };\n\n    private showInHomeSpace = (room: Room): boolean => {\n        if (this.allRoomsInHome) return true;\n        if (room.isSpaceRoom()) return false;\n        return !this.parentMap.get(room.roomId)?.size // put all orphaned rooms in the Home Space\n            || !!DMRoomMap.shared().getUserIdForRoomId(room.roomId) || // put all DMs in the Home Space\n            room.getMyMembership() === \"invite\"; // put all invites in the Home Space\n    };\n\n    private static isInSpace(member: RoomMember): boolean {\n        return member.membership === \"join\" || member.membership === \"invite\";\n    }\n\n    // Method for resolving the impact of a single user's membership change in the given Space and its hierarchy\n    private onMemberUpdate = (space: Room, userId: string) => {\n        const inSpace = SpaceStoreClass.isInSpace(space.getMember(userId));\n\n        if (inSpace) {\n            this.userIdsBySpace.get(space.roomId)?.add(userId);\n        } else {\n            this.userIdsBySpace.get(space.roomId)?.delete(userId);\n        }\n\n        // bust cache\n        this._aggregatedSpaceCache.userIdsBySpace.clear();\n\n        const affectedParentSpaceIds = this.getKnownParents(space.roomId, true);\n        this.emit(space.roomId);\n        affectedParentSpaceIds.forEach(spaceId => this.emit(spaceId));\n\n        if (!inSpace) {\n            // switch space if the DM is no longer considered part of the space\n            this.switchSpaceIfNeeded();\n        }\n    };\n\n    private onRoomsUpdate = () => {\n        const visibleRooms = this.matrixClient.getVisibleRooms();\n\n        const prevRoomsBySpace = this.roomIdsBySpace;\n        const prevUsersBySpace = this.userIdsBySpace;\n        const prevChildSpacesBySpace = this.childSpacesBySpace;\n\n        this.roomIdsBySpace = new Map();\n        this.userIdsBySpace = new Map();\n        this.childSpacesBySpace = new Map();\n\n        this.rebuildParentMap();\n        // mutates this.roomIdsBySpace\n        this.rebuildMetaSpaces();\n\n        const hiddenChildren = new EnhancedMap<string, Set<string>>();\n        visibleRooms.forEach(room => {\n            if (room.getMyMembership() !== \"join\") return;\n            this.getParents(room.roomId).forEach(parent => {\n                hiddenChildren.getOrCreate(parent.roomId, new Set()).add(room.roomId);\n            });\n        });\n\n        this.rootSpaces.forEach(s => {\n            // traverse each space tree in DFS to build up the supersets as you go up,\n            // reusing results from like subtrees.\n            const traverseSpace = (spaceId: string, parentPath: Set<string>): [Set<string>, Set<string>] => {\n                if (parentPath.has(spaceId)) return; // prevent cycles\n                // reuse existing results if multiple similar branches exist\n                if (this.roomIdsBySpace.has(spaceId) && this.userIdsBySpace.has(spaceId)) {\n                    return [this.roomIdsBySpace.get(spaceId), this.userIdsBySpace.get(spaceId)];\n                }\n\n                const [childSpaces, childRooms] = partitionSpacesAndRooms(this.getChildren(spaceId));\n\n                this.childSpacesBySpace.set(spaceId, new Set(childSpaces.map(space => space.roomId)));\n\n                const roomIds = new Set(childRooms.map(r => r.roomId));\n\n                const space = this.matrixClient?.getRoom(spaceId);\n                const userIds = new Set(space?.getMembers().filter(m => {\n                    return m.membership === \"join\" || m.membership === \"invite\";\n                }).map(m => m.userId));\n\n                const newPath = new Set(parentPath).add(spaceId);\n\n                childSpaces.forEach(childSpace => {\n                    traverseSpace(childSpace.roomId, newPath);\n                });\n                hiddenChildren.get(spaceId)?.forEach(roomId => {\n                    roomIds.add(roomId);\n                });\n\n                // Expand room IDs to all known versions of the given rooms\n                const expandedRoomIds = new Set(Array.from(roomIds).flatMap(roomId => {\n                    return this.matrixClient.getRoomUpgradeHistory(roomId, true).map(r => r.roomId);\n                }));\n\n                this.roomIdsBySpace.set(spaceId, expandedRoomIds);\n\n                this.userIdsBySpace.set(spaceId, userIds);\n                return [expandedRoomIds, userIds];\n            };\n\n            traverseSpace(s.roomId, new Set());\n        });\n\n        const roomDiff = mapDiff(prevRoomsBySpace, this.roomIdsBySpace);\n        const userDiff = mapDiff(prevUsersBySpace, this.userIdsBySpace);\n        const spaceDiff = mapDiff(prevChildSpacesBySpace, this.childSpacesBySpace);\n        // filter out keys which changed by reference only by checking whether the sets differ\n        const roomsChanged = roomDiff.changed.filter(k => {\n            return setHasDiff(prevRoomsBySpace.get(k), this.roomIdsBySpace.get(k));\n        });\n        const usersChanged = userDiff.changed.filter(k => {\n            return setHasDiff(prevUsersBySpace.get(k), this.userIdsBySpace.get(k));\n        });\n        const spacesChanged = spaceDiff.changed.filter(k => {\n            return setHasDiff(prevChildSpacesBySpace.get(k), this.childSpacesBySpace.get(k));\n        });\n\n        const changeSet = new Set([\n            ...roomDiff.added,\n            ...userDiff.added,\n            ...spaceDiff.added,\n            ...roomDiff.removed,\n            ...userDiff.removed,\n            ...spaceDiff.removed,\n            ...roomsChanged,\n            ...usersChanged,\n            ...spacesChanged,\n        ]);\n\n        const affectedParents = Array.from(changeSet).flatMap(\n            changedId => [...this.getKnownParents(changedId, true)],\n        );\n        affectedParents.forEach(parentId => changeSet.add(parentId));\n        // bust aggregate cache\n        this._aggregatedSpaceCache.roomIdsBySpace.clear();\n        this._aggregatedSpaceCache.userIdsBySpace.clear();\n\n        changeSet.forEach(k => {\n            this.emit(k);\n        });\n\n        if (changeSet.has(this.activeSpace)) {\n            this.switchSpaceIfNeeded();\n        }\n\n        const notificationStatesToUpdate = [...changeSet];\n        if (this.enabledMetaSpaces.includes(MetaSpace.People) &&\n            userDiff.added.length + userDiff.removed.length + usersChanged.length > 0\n        ) {\n            notificationStatesToUpdate.push(MetaSpace.People);\n        }\n        this.updateNotificationStates(notificationStatesToUpdate);\n    };\n\n    private switchSpaceIfNeeded = (roomId = RoomViewStore.instance.getRoomId()) => {\n        if (!this.isRoomInSpace(this.activeSpace, roomId) && !this.matrixClient.getRoom(roomId)?.isSpaceRoom()) {\n            this.switchToRelatedSpace(roomId);\n        }\n    };\n\n    private switchToRelatedSpace = (roomId: string) => {\n        if (this.suggestedRooms.find(r => r.room_id === roomId)) return;\n\n        // try to find the canonical parent first\n        let parent: SpaceKey = this.getCanonicalParent(roomId)?.roomId;\n\n        // otherwise, try to find a root space which contains this room\n        if (!parent) {\n            parent = this.rootSpaces.find(s => this.isRoomInSpace(s.roomId, roomId))?.roomId;\n        }\n\n        // otherwise, try to find a metaspace which contains this room\n        if (!parent) {\n            // search meta spaces in reverse as Home is the first and least specific one\n            parent = [...this.enabledMetaSpaces].reverse().find(s => this.isRoomInSpace(s, roomId));\n        }\n\n        // don't trigger a context switch when we are switching a space to match the chosen room\n        if (parent) {\n            this.setActiveSpace(parent, false);\n        } else {\n            this.goToFirstSpace();\n        }\n    };\n\n    private onRoom = (room: Room, newMembership?: string, oldMembership?: string) => {\n        const roomMembership = room.getMyMembership();\n        if (!roomMembership) {\n            // room is still being baked in the js-sdk, we'll process it at Room.myMembership instead\n            return;\n        }\n        const membership = newMembership || roomMembership;\n\n        if (!room.isSpaceRoom()) {\n            this.onRoomsUpdate();\n\n            if (membership === \"join\") {\n                // the user just joined a room, remove it from the suggested list if it was there\n                const numSuggestedRooms = this._suggestedRooms.length;\n                this._suggestedRooms = this._suggestedRooms.filter(r => r.room_id !== room.roomId);\n                if (numSuggestedRooms !== this._suggestedRooms.length) {\n                    this.emit(UPDATE_SUGGESTED_ROOMS, this._suggestedRooms);\n                }\n\n                // if the room currently being viewed was just joined then switch to its related space\n                if (newMembership === \"join\" && room.roomId === RoomViewStore.instance.getRoomId()) {\n                    this.switchSpaceIfNeeded(room.roomId);\n                }\n            }\n            return;\n        }\n\n        // Space\n        if (membership === \"invite\") {\n            const len = this._invitedSpaces.size;\n            this._invitedSpaces.add(room);\n            if (len !== this._invitedSpaces.size) {\n                this.emit(UPDATE_INVITED_SPACES, this.invitedSpaces);\n            }\n        } else if (oldMembership === \"invite\" && membership !== \"join\") {\n            if (this._invitedSpaces.delete(room)) {\n                this.emit(UPDATE_INVITED_SPACES, this.invitedSpaces);\n            }\n        } else {\n            this.rebuildSpaceHierarchy();\n            // fire off updates to all parent listeners\n            this.parentMap.get(room.roomId)?.forEach((parentId) => {\n                this.emit(parentId);\n            });\n            this.emit(room.roomId);\n        }\n\n        if (membership === \"join\" && room.roomId === RoomViewStore.instance.getRoomId()) {\n            // if the user was looking at the space and then joined: select that space\n            this.setActiveSpace(room.roomId, false);\n        } else if (membership === \"leave\" && room.roomId === this.activeSpace) {\n            // user's active space has gone away, go back to home\n            this.goToFirstSpace(true);\n        }\n    };\n\n    private notifyIfOrderChanged(): void {\n        const rootSpaces = this.sortRootSpaces(this.rootSpaces);\n        if (arrayHasOrderChange(this.rootSpaces, rootSpaces)) {\n            this.rootSpaces = rootSpaces;\n            this.emit(UPDATE_TOP_LEVEL_SPACES, this.spacePanelSpaces, this.enabledMetaSpaces);\n        }\n    }\n\n    private onRoomState = (ev: MatrixEvent) => {\n        const room = this.matrixClient.getRoom(ev.getRoomId());\n\n        if (!room) return;\n\n        switch (ev.getType()) {\n            case EventType.SpaceChild: {\n                const target = this.matrixClient.getRoom(ev.getStateKey());\n\n                if (room.isSpaceRoom()) {\n                    if (target?.isSpaceRoom()) {\n                        this.rebuildSpaceHierarchy();\n                        this.emit(target.roomId);\n                    } else {\n                        this.onRoomsUpdate();\n                    }\n                    this.emit(room.roomId);\n                }\n\n                if (room.roomId === this.activeSpace && // current space\n                    target?.getMyMembership() !== \"join\" && // target not joined\n                    ev.getPrevContent().suggested !== ev.getContent().suggested // suggested flag changed\n                ) {\n                    this.loadSuggestedRooms(room);\n                }\n\n                break;\n            }\n\n            case EventType.SpaceParent:\n                // TODO rebuild the space parent and not the room - check permissions?\n                // TODO confirm this after implementing parenting behaviour\n                if (room.isSpaceRoom()) {\n                    this.rebuildSpaceHierarchy();\n                } else {\n                    this.onRoomsUpdate();\n                }\n                this.emit(room.roomId);\n                break;\n\n            case EventType.RoomPowerLevels:\n                if (room.isSpaceRoom()) {\n                    this.onRoomsUpdate();\n                }\n                break;\n        }\n    };\n\n    // listening for m.room.member events in onRoomState above doesn't work as the Member object isn't updated by then\n    private onRoomStateMembers = (ev: MatrixEvent) => {\n        const room = this.matrixClient.getRoom(ev.getRoomId());\n\n        const userId = ev.getStateKey();\n        if (room?.isSpaceRoom() && // only consider space rooms\n            DMRoomMap.shared().getDMRoomsForUserId(userId).length > 0 && // only consider members we have a DM with\n            ev.getPrevContent().membership !== ev.getContent().membership // only consider when membership changes\n        ) {\n            this.onMemberUpdate(room, userId);\n        }\n    };\n\n    private onRoomAccountData = (ev: MatrixEvent, room: Room, lastEv?: MatrixEvent) => {\n        if (room.isSpaceRoom() && ev.getType() === EventType.SpaceOrder) {\n            this.spaceOrderLocalEchoMap.delete(room.roomId); // clear any local echo\n            const order = ev.getContent()?.order;\n            const lastOrder = lastEv?.getContent()?.order;\n            if (order !== lastOrder) {\n                this.notifyIfOrderChanged();\n            }\n        } else if (ev.getType() === EventType.Tag) {\n            // If the room was in favourites and now isn't or the opposite then update its position in the trees\n            const oldTags = lastEv?.getContent()?.tags || {};\n            const newTags = ev.getContent()?.tags || {};\n            if (!!oldTags[DefaultTagID.Favourite] !== !!newTags[DefaultTagID.Favourite]) {\n                this.onRoomFavouriteChange(room);\n            }\n        }\n    };\n\n    private onRoomFavouriteChange(room: Room) {\n        if (this.enabledMetaSpaces.includes(MetaSpace.Favourites)) {\n            if (room.tags[DefaultTagID.Favourite]) {\n                this.roomIdsBySpace.get(MetaSpace.Favourites).add(room.roomId);\n            } else {\n                this.roomIdsBySpace.get(MetaSpace.Favourites).delete(room.roomId);\n            }\n            this.emit(MetaSpace.Favourites);\n        }\n    }\n\n    private onRoomDmChange(room: Room, isDm: boolean): void {\n        const enabledMetaSpaces = new Set(this.enabledMetaSpaces);\n\n        if (!this.allRoomsInHome && enabledMetaSpaces.has(MetaSpace.Home)) {\n            const homeRooms = this.roomIdsBySpace.get(MetaSpace.Home);\n            if (this.showInHomeSpace(room)) {\n                homeRooms?.add(room.roomId);\n            } else if (!this.roomIdsBySpace.get(MetaSpace.Orphans).has(room.roomId)) {\n                this.roomIdsBySpace.get(MetaSpace.Home)?.delete(room.roomId);\n            }\n\n            this.emit(MetaSpace.Home);\n        }\n\n        if (enabledMetaSpaces.has(MetaSpace.People)) {\n            this.emit(MetaSpace.People);\n        }\n\n        if (enabledMetaSpaces.has(MetaSpace.Orphans) || enabledMetaSpaces.has(MetaSpace.Home)) {\n            if (isDm && this.roomIdsBySpace.get(MetaSpace.Orphans).delete(room.roomId)) {\n                this.emit(MetaSpace.Orphans);\n                this.emit(MetaSpace.Home);\n            }\n        }\n    }\n\n    private onAccountData = (ev: MatrixEvent, prevEv?: MatrixEvent) => {\n        if (ev.getType() === EventType.Direct) {\n            const previousRooms = new Set(Object.values(prevEv?.getContent<Record<string, string[]>>() ?? {}).flat());\n            const currentRooms = new Set(Object.values(ev.getContent<Record<string, string[]>>()).flat());\n\n            const diff = setDiff(previousRooms, currentRooms);\n            [...diff.added, ...diff.removed].forEach(roomId => {\n                const room = this.matrixClient?.getRoom(roomId);\n                if (room) {\n                    this.onRoomDmChange(room, currentRooms.has(roomId));\n                }\n            });\n\n            if (diff.removed.length > 0) {\n                this.switchSpaceIfNeeded();\n            }\n        }\n    };\n\n    protected async reset() {\n        this.rootSpaces = [];\n        this.parentMap = new EnhancedMap();\n        this.notificationStateMap = new Map();\n        this.roomIdsBySpace = new Map();\n        this.userIdsBySpace = new Map();\n        this._aggregatedSpaceCache.roomIdsBySpace.clear();\n        this._aggregatedSpaceCache.userIdsBySpace.clear();\n        this._activeSpace = MetaSpace.Home; // set properly by onReady\n        this._suggestedRooms = [];\n        this._invitedSpaces = new Set();\n        this._enabledMetaSpaces = [];\n    }\n\n    protected async onNotReady() {\n        if (this.matrixClient) {\n            this.matrixClient.removeListener(ClientEvent.Room, this.onRoom);\n            this.matrixClient.removeListener(RoomEvent.MyMembership, this.onRoom);\n            this.matrixClient.removeListener(RoomEvent.AccountData, this.onRoomAccountData);\n            this.matrixClient.removeListener(RoomStateEvent.Events, this.onRoomState);\n            this.matrixClient.removeListener(RoomStateEvent.Members, this.onRoomStateMembers);\n            this.matrixClient.removeListener(ClientEvent.AccountData, this.onAccountData);\n        }\n        await this.reset();\n    }\n\n    protected async onReady() {\n        this.matrixClient.on(ClientEvent.Room, this.onRoom);\n        this.matrixClient.on(RoomEvent.MyMembership, this.onRoom);\n        this.matrixClient.on(RoomEvent.AccountData, this.onRoomAccountData);\n        this.matrixClient.on(RoomStateEvent.Events, this.onRoomState);\n        this.matrixClient.on(RoomStateEvent.Members, this.onRoomStateMembers);\n        this.matrixClient.on(ClientEvent.AccountData, this.onAccountData);\n\n        const oldMetaSpaces = this._enabledMetaSpaces;\n        const enabledMetaSpaces = SettingsStore.getValue(\"Spaces.enabledMetaSpaces\");\n        this._enabledMetaSpaces = metaSpaceOrder.filter(k => enabledMetaSpaces[k]);\n\n        this._allRoomsInHome = SettingsStore.getValue(\"Spaces.allRoomsInHome\");\n        this.sendUserProperties();\n\n        this.rebuildSpaceHierarchy(); // trigger an initial update\n        // rebuildSpaceHierarchy will only send an update if the spaces have changed.\n        // If only the meta spaces have changed, we need to send an update ourselves.\n        if (arrayHasDiff(oldMetaSpaces, this._enabledMetaSpaces)) {\n            this.emit(UPDATE_TOP_LEVEL_SPACES, this.spacePanelSpaces, this.enabledMetaSpaces);\n        }\n\n        // restore selected state from last session if any and still valid\n        const lastSpaceId = window.localStorage.getItem(ACTIVE_SPACE_LS_KEY);\n        const valid = (lastSpaceId && !isMetaSpace(lastSpaceId))\n            ? this.matrixClient.getRoom(lastSpaceId)\n            : enabledMetaSpaces[lastSpaceId];\n        if (valid) {\n            // don't context switch here as it may break permalinks\n            this.setActiveSpace(lastSpaceId, false);\n        } else {\n            this.switchSpaceIfNeeded();\n        }\n    }\n\n    private sendUserProperties() {\n        const enabled = new Set(this.enabledMetaSpaces);\n        PosthogAnalytics.instance.setProperty(\"WebMetaSpaceHomeEnabled\", enabled.has(MetaSpace.Home));\n        PosthogAnalytics.instance.setProperty(\"WebMetaSpaceHomeAllRooms\", this.allRoomsInHome);\n        PosthogAnalytics.instance.setProperty(\"WebMetaSpacePeopleEnabled\", enabled.has(MetaSpace.People));\n        PosthogAnalytics.instance.setProperty(\"WebMetaSpaceFavouritesEnabled\", enabled.has(MetaSpace.Favourites));\n        PosthogAnalytics.instance.setProperty(\"WebMetaSpaceOrphansEnabled\", enabled.has(MetaSpace.Orphans));\n    }\n\n    private goToFirstSpace(contextSwitch = false) {\n        this.setActiveSpace(this.enabledMetaSpaces[0] ?? this.spacePanelSpaces[0]?.roomId, contextSwitch);\n    }\n\n    protected async onAction(payload: SpaceStoreActions) {\n        if (!this.matrixClient) return;\n\n        switch (payload.action) {\n            case Action.ViewRoom: {\n                // Don't auto-switch rooms when reacting to a context-switch or for new rooms being created\n                // as this is not helpful and can create loops of rooms/space switching\n                const isSpace = payload.justCreatedOpts?.roomType === RoomType.Space;\n                if (payload.context_switch || (payload.justCreatedOpts && !isSpace)) break;\n                let roomId = payload.room_id;\n\n                if (payload.room_alias && !roomId) {\n                    roomId = getCachedRoomIDForAlias(payload.room_alias);\n                }\n\n                if (!roomId) return; // we'll get re-fired with the room ID shortly\n\n                const room = this.matrixClient.getRoom(roomId);\n                if (room?.isSpaceRoom()) {\n                    // Don't context switch when navigating to the space room\n                    // as it will cause you to end up in the wrong room\n                    this.setActiveSpace(room.roomId, false);\n                } else {\n                    this.switchSpaceIfNeeded(roomId);\n                }\n\n                // Persist last viewed room from a space\n                // we don't await setActiveSpace above as we only care about this.activeSpace being up to date\n                // synchronously for the below code - everything else can and should be async.\n                window.localStorage.setItem(getSpaceContextKey(this.activeSpace), payload.room_id);\n                break;\n            }\n\n            case Action.ViewHomePage:\n                if (!payload.context_switch && this.enabledMetaSpaces.includes(MetaSpace.Home)) {\n                    this.setActiveSpace(MetaSpace.Home, false);\n                    window.localStorage.setItem(getSpaceContextKey(this.activeSpace), \"\");\n                }\n                break;\n\n            case Action.AfterLeaveRoom:\n                if (!isMetaSpace(this._activeSpace) && payload.room_id === this._activeSpace) {\n                    // User has left the current space, go to first space\n                    this.goToFirstSpace(true);\n                }\n                break;\n\n            case Action.SwitchSpace: {\n                // Metaspaces start at 1, Spaces follow\n                if (payload.num < 1 || payload.num > 9) break;\n                const numMetaSpaces = this.enabledMetaSpaces.length;\n                if (payload.num <= numMetaSpaces) {\n                    this.setActiveSpace(this.enabledMetaSpaces[payload.num - 1]);\n                } else if (this.spacePanelSpaces.length > payload.num - numMetaSpaces - 1) {\n                    this.setActiveSpace(this.spacePanelSpaces[payload.num - numMetaSpaces - 1].roomId);\n                }\n                break;\n            }\n\n            case Action.SettingUpdated: {\n                switch (payload.settingName) {\n                    case \"Spaces.allRoomsInHome\": {\n                        const newValue = SettingsStore.getValue(\"Spaces.allRoomsInHome\");\n                        if (this.allRoomsInHome !== newValue) {\n                            this._allRoomsInHome = newValue;\n                            this.emit(UPDATE_HOME_BEHAVIOUR, this.allRoomsInHome);\n                            if (this.enabledMetaSpaces.includes(MetaSpace.Home)) {\n                                this.rebuildHomeSpace();\n                            }\n                            this.sendUserProperties();\n                        }\n                        break;\n                    }\n\n                    case \"Spaces.enabledMetaSpaces\": {\n                        const newValue = SettingsStore.getValue(\"Spaces.enabledMetaSpaces\");\n                        const enabledMetaSpaces = metaSpaceOrder.filter(k => newValue[k]);\n                        if (arrayHasDiff(this._enabledMetaSpaces, enabledMetaSpaces)) {\n                            const hadPeopleOrHomeEnabled = this.enabledMetaSpaces.some(s => {\n                                return s === MetaSpace.Home || s === MetaSpace.People;\n                            });\n                            this._enabledMetaSpaces = enabledMetaSpaces;\n                            const hasPeopleOrHomeEnabled = this.enabledMetaSpaces.some(s => {\n                                return s === MetaSpace.Home || s === MetaSpace.People;\n                            });\n\n                            // if a metaspace currently being viewed was removed, go to another one\n                            if (isMetaSpace(this.activeSpace) && !newValue[this.activeSpace]) {\n                                this.switchSpaceIfNeeded();\n                            }\n                            this.rebuildMetaSpaces();\n\n                            if (hadPeopleOrHomeEnabled !== hasPeopleOrHomeEnabled) {\n                                // in this case we have to rebuild everything as DM badges will move to/from real spaces\n                                this.updateNotificationStates();\n                            } else {\n                                this.updateNotificationStates(enabledMetaSpaces);\n                            }\n\n                            this.emit(UPDATE_TOP_LEVEL_SPACES, this.spacePanelSpaces, this.enabledMetaSpaces);\n                            this.sendUserProperties();\n                        }\n                        break;\n                    }\n\n                    case \"Spaces.showPeopleInSpace\":\n                        // getSpaceFilteredUserIds will return the appropriate value\n                        this.emit(payload.roomId);\n                        if (!this.enabledMetaSpaces.some(s => s === MetaSpace.Home || s === MetaSpace.People)) {\n                            this.updateNotificationStates([payload.roomId]);\n                        }\n                        break;\n                }\n            }\n        }\n    }\n\n    public getNotificationState(key: SpaceKey): SpaceNotificationState {\n        if (this.notificationStateMap.has(key)) {\n            return this.notificationStateMap.get(key);\n        }\n\n        const state = new SpaceNotificationState(getRoomFn);\n        this.notificationStateMap.set(key, state);\n        return state;\n    }\n\n    // traverse space tree with DFS calling fn on each space including the given root one,\n    // if includeRooms is true then fn will be called on each leaf room, if it is present in multiple sub-spaces\n    // then fn will be called with it multiple times.\n    public traverseSpace(\n        spaceId: string,\n        fn: (roomId: string) => void,\n        includeRooms = false,\n        parentPath?: Set<string>,\n    ) {\n        if (parentPath && parentPath.has(spaceId)) return; // prevent cycles\n\n        fn(spaceId);\n\n        const newPath = new Set(parentPath).add(spaceId);\n        const [childSpaces, childRooms] = partitionSpacesAndRooms(this.getChildren(spaceId));\n\n        if (includeRooms) {\n            childRooms.forEach(r => fn(r.roomId));\n        }\n        childSpaces.forEach(s => this.traverseSpace(s.roomId, fn, includeRooms, newPath));\n    }\n\n    private getSpaceTagOrdering = (space: Room): string | undefined => {\n        if (this.spaceOrderLocalEchoMap.has(space.roomId)) return this.spaceOrderLocalEchoMap.get(space.roomId);\n        return validOrder(space.getAccountData(EventType.SpaceOrder)?.getContent()?.order);\n    };\n\n    private sortRootSpaces(spaces: Room[]): Room[] {\n        return sortBy(spaces, [this.getSpaceTagOrdering, \"roomId\"]);\n    }\n\n    private async setRootSpaceOrder(space: Room, order: string): Promise<void> {\n        this.spaceOrderLocalEchoMap.set(space.roomId, order);\n        try {\n            await this.matrixClient.setRoomAccountData(space.roomId, EventType.SpaceOrder, { order });\n        } catch (e) {\n            logger.warn(\"Failed to set root space order\", e);\n            if (this.spaceOrderLocalEchoMap.get(space.roomId) === order) {\n                this.spaceOrderLocalEchoMap.delete(space.roomId);\n            }\n        }\n    }\n\n    public moveRootSpace(fromIndex: number, toIndex: number): void {\n        const currentOrders = this.rootSpaces.map(this.getSpaceTagOrdering);\n        const changes = reorderLexicographically(currentOrders, fromIndex, toIndex);\n\n        changes.forEach(({ index, order }) => {\n            this.setRootSpaceOrder(this.rootSpaces[index], order);\n        });\n\n        this.notifyIfOrderChanged();\n    }\n}\n\nexport default class SpaceStore {\n    private static internalInstance = new SpaceStoreClass();\n\n    public static get instance(): SpaceStoreClass {\n        return SpaceStore.internalInstance;\n    }\n}\n\nwindow.mxSpaceStore = SpaceStore.instance;\n"],"mappings":"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"}