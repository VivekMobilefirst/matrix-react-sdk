{"version":3,"file":"VideoChannelStore.js","names":["VideoChannelEvent","TIMEOUT_MS","waitForEvent","emitter","event","pred","listener","wait","Promise","resolve","on","timedOut","timeout","off","Error","VideoChannelStore","AsyncStoreWithClient","instance","_instance","constructor","defaultDispatcher","roomId","audioDevice","videoDevice","activeChannel","disconnect","jitsi","getVideoChannel","jitsiUid","WidgetUtils","getWidgetUid","messagingStore","WidgetMessagingStore","messaging","getMessagingForUid","WidgetMessagingStoreEvent","StoreMessaging","uid","widgetApi","e","dontStopMessaging","reject","cleanup","done","StopMessaging","Connect","Disconnect","isWidgetReady","race","WidgetReady","ElementWidgetActions","CallParticipants","onParticipants","MuteAudio","onMuteAudio","UnmuteAudio","onUnmuteAudio","MuteVideo","onMuteVideo","UnmuteVideo","onUnmuteVideo","once","HangupCall","onHangup","emit","StartConnect","waitForJoin","JoinCall","ev","preventDefault","ack","transport","send","label","ready","ForceHangupCall","connected","ActiveWidgetStore","ActiveWidgetStoreEvent","Dock","onDock","Undock","onUndock","room","RoomEvent","MyMembership","onMyMembership","window","addEventListener","setDisconnected","addOurDevice","resendDevicesTimer","setInterval","logger","log","STUCK_DEVICE_TIMEOUT_MS","waitForDisconnect","removeEventListener","clearInterval","participants","removeOurDevice","reply","detail","data","Participants","audioMuted","videoMuted","membership","TileLayout","SpotlightLayout","onAction","payload","SettingsStore","getValue","value","setValue","SettingLevel","DEVICE","matrixClient","getRoom","_connected","_participants"],"sources":["../../src/stores/VideoChannelStore.ts"],"sourcesContent":["/*\nCopyright 2022 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport EventEmitter from \"events\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\nimport { Room, RoomEvent } from \"matrix-js-sdk/src/models/room\";\nimport { ClientWidgetApi, IWidgetApiRequest } from \"matrix-widget-api\";\n\nimport SettingsStore from \"../settings/SettingsStore\";\nimport { SettingLevel } from \"../settings/SettingLevel\";\nimport defaultDispatcher from \"../dispatcher/dispatcher\";\nimport { ActionPayload } from \"../dispatcher/payloads\";\nimport { ElementWidgetActions } from \"./widgets/ElementWidgetActions\";\nimport { WidgetMessagingStore, WidgetMessagingStoreEvent } from \"./widgets/WidgetMessagingStore\";\nimport ActiveWidgetStore, { ActiveWidgetStoreEvent } from \"./ActiveWidgetStore\";\nimport { STUCK_DEVICE_TIMEOUT_MS, getVideoChannel, addOurDevice, removeOurDevice } from \"../utils/VideoChannelUtils\";\nimport { timeout } from \"../utils/promise\";\nimport WidgetUtils from \"../utils/WidgetUtils\";\nimport { AsyncStoreWithClient } from \"./AsyncStoreWithClient\";\n\nexport enum VideoChannelEvent {\n    StartConnect = \"start_connect\",\n    Connect = \"connect\",\n    Disconnect = \"disconnect\",\n    Participants = \"participants\",\n}\n\nexport interface IJitsiParticipant {\n    avatarURL: string;\n    displayName: string;\n    formattedDisplayName: string;\n    participantId: string;\n}\n\nconst TIMEOUT_MS = 16000;\n\n// Wait until an event is emitted satisfying the given predicate\nconst waitForEvent = async (emitter: EventEmitter, event: string, pred: (...args) => boolean = () => true) => {\n    let listener;\n    const wait = new Promise<void>(resolve => {\n        listener = (...args) => { if (pred(...args)) resolve(); };\n        emitter.on(event, listener);\n    });\n\n    const timedOut = await timeout(wait, false, TIMEOUT_MS) === false;\n    emitter.off(event, listener);\n    if (timedOut) throw new Error(\"Timed out\");\n};\n\n/*\n * Holds information about the currently active video channel.\n */\nexport default class VideoChannelStore extends AsyncStoreWithClient<null> {\n    private static _instance: VideoChannelStore;\n\n    public static get instance(): VideoChannelStore {\n        if (!VideoChannelStore._instance) {\n            VideoChannelStore._instance = new VideoChannelStore();\n        }\n        return VideoChannelStore._instance;\n    }\n\n    private constructor() {\n        super(defaultDispatcher);\n    }\n\n    protected async onAction(payload: ActionPayload): Promise<void> {\n        // nothing to do\n    }\n\n    private activeChannel: ClientWidgetApi;\n    private resendDevicesTimer: number;\n\n    // This is persisted to settings so we can detect unclean disconnects\n    public get roomId(): string | null { return SettingsStore.getValue(\"videoChannelRoomId\"); }\n    private set roomId(value: string | null) {\n        SettingsStore.setValue(\"videoChannelRoomId\", null, SettingLevel.DEVICE, value);\n    }\n\n    private get room(): Room { return this.matrixClient.getRoom(this.roomId); }\n\n    private _connected = false;\n    public get connected(): boolean { return this._connected; }\n    private set connected(value: boolean) { this._connected = value; }\n\n    private _participants: IJitsiParticipant[] = [];\n    public get participants(): IJitsiParticipant[] { return this._participants; }\n    private set participants(value: IJitsiParticipant[]) { this._participants = value; }\n\n    public get audioMuted(): boolean { return SettingsStore.getValue(\"audioInputMuted\"); }\n    public set audioMuted(value: boolean) {\n        SettingsStore.setValue(\"audioInputMuted\", null, SettingLevel.DEVICE, value);\n    }\n\n    public get videoMuted(): boolean { return SettingsStore.getValue(\"videoInputMuted\"); }\n    public set videoMuted(value: boolean) {\n        SettingsStore.setValue(\"videoInputMuted\", null, SettingLevel.DEVICE, value);\n    }\n\n    public connect = async (\n        roomId: string,\n        audioDevice: MediaDeviceInfo | null,\n        videoDevice: MediaDeviceInfo | null,\n    ) => {\n        if (this.activeChannel) await this.disconnect();\n\n        const jitsi = getVideoChannel(roomId);\n        if (!jitsi) throw new Error(`No video channel in room ${roomId}`);\n\n        const jitsiUid = WidgetUtils.getWidgetUid(jitsi);\n        const messagingStore = WidgetMessagingStore.instance;\n\n        let messaging = messagingStore.getMessagingForUid(jitsiUid);\n        if (!messaging) {\n            // The widget might still be initializing, so wait for it\n            try {\n                await waitForEvent(\n                    messagingStore,\n                    WidgetMessagingStoreEvent.StoreMessaging,\n                    (uid: string, widgetApi: ClientWidgetApi) => {\n                        if (uid === jitsiUid) {\n                            messaging = widgetApi;\n                            return true;\n                        }\n                        return false;\n                    },\n                );\n            } catch (e) {\n                throw new Error(`Failed to bind video channel in room ${roomId}: ${e}`);\n            }\n        }\n\n        // Now that we got the messaging, we need a way to ensure that it doesn't get stopped\n        const dontStopMessaging = new Promise<void>((resolve, reject) => {\n            const listener = (uid: string) => {\n                if (uid === jitsiUid) {\n                    cleanup();\n                    reject(new Error(\"Messaging stopped\"));\n                }\n            };\n            const done = () => {\n                cleanup();\n                resolve();\n            };\n            const cleanup = () => {\n                messagingStore.off(WidgetMessagingStoreEvent.StopMessaging, listener);\n                this.off(VideoChannelEvent.Connect, done);\n                this.off(VideoChannelEvent.Disconnect, done);\n            };\n\n            messagingStore.on(WidgetMessagingStoreEvent.StopMessaging, listener);\n            this.on(VideoChannelEvent.Connect, done);\n            this.on(VideoChannelEvent.Disconnect, done);\n        });\n\n        if (!messagingStore.isWidgetReady(jitsiUid)) {\n            // Wait for the widget to be ready to receive our join event\n            try {\n                await Promise.race([\n                    waitForEvent(\n                        messagingStore,\n                        WidgetMessagingStoreEvent.WidgetReady,\n                        (uid: string) => uid === jitsiUid,\n                    ),\n                    dontStopMessaging,\n                ]);\n            } catch (e) {\n                throw new Error(`Video channel in room ${roomId} never became ready: ${e}`);\n            }\n        }\n\n        // Participant data and mute state will come down the event pipeline quickly, so prepare in advance\n        this.activeChannel = messaging;\n        this.roomId = roomId;\n        messaging.on(`action:${ElementWidgetActions.CallParticipants}`, this.onParticipants);\n        messaging.on(`action:${ElementWidgetActions.MuteAudio}`, this.onMuteAudio);\n        messaging.on(`action:${ElementWidgetActions.UnmuteAudio}`, this.onUnmuteAudio);\n        messaging.on(`action:${ElementWidgetActions.MuteVideo}`, this.onMuteVideo);\n        messaging.on(`action:${ElementWidgetActions.UnmuteVideo}`, this.onUnmuteVideo);\n        // Empirically, it's possible for Jitsi Meet to crash instantly at startup,\n        // sending a hangup event that races with the rest of this method, so we also\n        // need to add the hangup listener now rather than later\n        messaging.once(`action:${ElementWidgetActions.HangupCall}`, this.onHangup);\n\n        this.emit(VideoChannelEvent.StartConnect, roomId);\n\n        // Actually perform the join\n        const waitForJoin = waitForEvent(\n            messaging,\n            `action:${ElementWidgetActions.JoinCall}`,\n            (ev: CustomEvent<IWidgetApiRequest>) => {\n                ev.preventDefault();\n                this.ack(ev);\n                return true;\n            },\n        );\n        messaging.transport.send(ElementWidgetActions.JoinCall, {\n            audioDevice: audioDevice?.label ?? null,\n            videoDevice: videoDevice?.label ?? null,\n        });\n        try {\n            await Promise.race([waitForJoin, dontStopMessaging]);\n        } catch (e) {\n            // If it timed out, clean up our advance preparations\n            this.activeChannel = null;\n            this.roomId = null;\n\n            messaging.off(`action:${ElementWidgetActions.CallParticipants}`, this.onParticipants);\n            messaging.off(`action:${ElementWidgetActions.MuteAudio}`, this.onMuteAudio);\n            messaging.off(`action:${ElementWidgetActions.UnmuteAudio}`, this.onUnmuteAudio);\n            messaging.off(`action:${ElementWidgetActions.MuteVideo}`, this.onMuteVideo);\n            messaging.off(`action:${ElementWidgetActions.UnmuteVideo}`, this.onUnmuteVideo);\n            messaging.off(`action:${ElementWidgetActions.HangupCall}`, this.onHangup);\n\n            if (messaging.transport.ready) {\n                // The messaging still exists, which means Jitsi might still be going in the background\n                messaging.transport.send(ElementWidgetActions.ForceHangupCall, {});\n            }\n\n            this.emit(VideoChannelEvent.Disconnect, roomId);\n\n            throw new Error(`Failed to join call in room ${roomId}: ${e}`);\n        }\n\n        this.connected = true;\n        ActiveWidgetStore.instance.on(ActiveWidgetStoreEvent.Dock, this.onDock);\n        ActiveWidgetStore.instance.on(ActiveWidgetStoreEvent.Undock, this.onUndock);\n        this.room.on(RoomEvent.MyMembership, this.onMyMembership);\n        window.addEventListener(\"beforeunload\", this.setDisconnected);\n\n        this.emit(VideoChannelEvent.Connect, roomId);\n\n        // Tell others that we're connected, by adding our device to room state\n        await addOurDevice(this.room);\n        // Re-add this device every so often so our video member event doesn't become stale\n        this.resendDevicesTimer = setInterval(async () => {\n            logger.log(`Resending video member event for ${this.roomId}`);\n            await addOurDevice(this.room);\n        }, (STUCK_DEVICE_TIMEOUT_MS * 3) / 4);\n    };\n\n    public disconnect = async () => {\n        if (!this.activeChannel) throw new Error(\"Not connected to any video channel\");\n\n        const waitForDisconnect = waitForEvent(this, VideoChannelEvent.Disconnect);\n        this.activeChannel.transport.send(ElementWidgetActions.HangupCall, {});\n        try {\n            await waitForDisconnect; // onHangup cleans up for us\n        } catch (e) {\n            throw new Error(`Failed to hangup call in room ${this.roomId}: ${e}`);\n        }\n    };\n\n    public setDisconnected = async () => {\n        const roomId = this.roomId;\n        const room = this.room;\n\n        this.activeChannel.off(`action:${ElementWidgetActions.CallParticipants}`, this.onParticipants);\n        this.activeChannel.off(`action:${ElementWidgetActions.MuteAudio}`, this.onMuteAudio);\n        this.activeChannel.off(`action:${ElementWidgetActions.UnmuteAudio}`, this.onUnmuteAudio);\n        this.activeChannel.off(`action:${ElementWidgetActions.MuteVideo}`, this.onMuteVideo);\n        this.activeChannel.off(`action:${ElementWidgetActions.UnmuteVideo}`, this.onUnmuteVideo);\n        this.activeChannel.off(`action:${ElementWidgetActions.HangupCall}`, this.onHangup);\n        ActiveWidgetStore.instance.off(ActiveWidgetStoreEvent.Dock, this.onDock);\n        ActiveWidgetStore.instance.off(ActiveWidgetStoreEvent.Undock, this.onUndock);\n        room.off(RoomEvent.MyMembership, this.onMyMembership);\n        window.removeEventListener(\"beforeunload\", this.setDisconnected);\n        clearInterval(this.resendDevicesTimer);\n\n        this.activeChannel = null;\n        this.roomId = null;\n        this.connected = false;\n        this.participants = [];\n\n        this.emit(VideoChannelEvent.Disconnect, roomId);\n\n        // Tell others that we're disconnected, by removing our device from room state\n        await removeOurDevice(room);\n    };\n\n    private ack = (ev: CustomEvent<IWidgetApiRequest>, messaging = this.activeChannel) => {\n        // Even if we don't have a reply to a given widget action, we still need\n        // to give the widget API something to acknowledge receipt\n        messaging.transport.reply(ev.detail, {});\n    };\n\n    private onHangup = async (ev: CustomEvent<IWidgetApiRequest>) => {\n        ev.preventDefault();\n        const messaging = this.activeChannel;\n        // In case this hangup is caused by Jitsi Meet crashing at startup,\n        // wait for the connection event in order to avoid racing\n        if (!this.connected) await waitForEvent(this, VideoChannelEvent.Connect);\n        await this.setDisconnected();\n        this.ack(ev, messaging);\n    };\n\n    private onParticipants = (ev: CustomEvent<IWidgetApiRequest>) => {\n        ev.preventDefault();\n        this.participants = ev.detail.data.participants as IJitsiParticipant[];\n        this.emit(VideoChannelEvent.Participants, this.roomId, ev.detail.data.participants);\n        this.ack(ev);\n    };\n\n    private onMuteAudio = (ev: CustomEvent<IWidgetApiRequest>) => {\n        ev.preventDefault();\n        this.audioMuted = true;\n        this.ack(ev);\n    };\n\n    private onUnmuteAudio = (ev: CustomEvent<IWidgetApiRequest>) => {\n        ev.preventDefault();\n        this.audioMuted = false;\n        this.ack(ev);\n    };\n\n    private onMuteVideo = (ev: CustomEvent<IWidgetApiRequest>) => {\n        ev.preventDefault();\n        this.videoMuted = true;\n        this.ack(ev);\n    };\n\n    private onUnmuteVideo = (ev: CustomEvent<IWidgetApiRequest>) => {\n        ev.preventDefault();\n        this.videoMuted = false;\n        this.ack(ev);\n    };\n\n    private onMyMembership = (room: Room, membership: string) => {\n        if (membership !== \"join\") this.setDisconnected();\n    };\n\n    private onDock = async () => {\n        // The widget is no longer a PiP, so let's restore the default layout\n        await this.activeChannel.transport.send(ElementWidgetActions.TileLayout, {});\n    };\n\n    private onUndock = async () => {\n        // The widget has become a PiP, so let's switch Jitsi to spotlight mode\n        // to only show the active speaker and economize on space\n        await this.activeChannel.transport.send(ElementWidgetActions.SpotlightLayout, {});\n    };\n}\n"],"mappings":"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"}