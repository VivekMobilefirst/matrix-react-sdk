{"version":3,"file":"submit-rageshake.js","names":["collectBugReport","opts","gzipLogs","progressCallback","_t","version","PlatformPeg","get","getAppVersion","err","userAgent","window","navigator","installedPWA","String","matchMedia","matches","e","touchInput","client","MatrixClientPeg","logger","log","body","FormData","append","userText","customApp","customFields","key","credentials","userId","deviceId","isCryptoEnabled","keys","getDeviceEd25519Key","getDeviceCurve25519Key","push","join","getCrossSigningId","crossSigning","crypto","crossSigningInfo","secretStorage","isCrossSigningReady","doesServerSupportUnstableFeature","getId","isStoredInSecretStorage","pkCache","getCrossSigningCacheCallbacks","getCrossSigningKeyCache","isSecretStorageReady","hasKey","isKeyBackupKeyStored","sessionBackupKeyFromCache","getSessionBackupPrivateKey","Uint8Array","labels","label","enabledLabs","SettingsStore","getFeatureSettingNames","filter","f","getValue","length","storage","persisted","document","hasStorageAccess","estimate","quota","usage","usageDetails","Object","forEach","k","Modernizr","missingFeatures","localStorage","getItem","sendLogs","logs","rageshake","getLogsForReport","entry","buf","TextEncoder","encode","lines","pako","gzip","Blob","id","sendBugReport","bugReportEndpoint","Error","submitReport","downloadBugReport","metadata","tape","Tar","i","value","entries","Promise","resolve","reader","FileReader","addEventListener","ev","TextDecoder","decode","target","result","readAsArrayBuffer","dl","createElement","href","btoa","uint8ToString","out","download","appendChild","click","removeChild","fromCharCode","submitFeedback","endpoint","comment","canContact","extraData","getHumanReadableName","getUserId","JSON","stringify","SdkConfig","bug_report_endpoint_url","reject","req","XMLHttpRequest","open","responseType","timeout","onreadystatechange","readyState","LOADING","DONE","status","response","report_url","send"],"sources":["../../src/rageshake/submit-rageshake.ts"],"sourcesContent":["/*\nCopyright 2017 OpenMarket Ltd\nCopyright 2018 New Vector Ltd\nCopyright 2019 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport pako from 'pako';\nimport Tar from \"tar-js\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\n\nimport { MatrixClientPeg } from '../MatrixClientPeg';\nimport PlatformPeg from '../PlatformPeg';\nimport { _t } from '../languageHandler';\nimport * as rageshake from './rageshake';\nimport SettingsStore from \"../settings/SettingsStore\";\nimport SdkConfig from \"../SdkConfig\";\n\ninterface IOpts {\n    labels?: string[];\n    userText?: string;\n    sendLogs?: boolean;\n    progressCallback?: (s: string) => void;\n    customApp?: string;\n    customFields?: Record<string, string>;\n}\n\nasync function collectBugReport(opts: IOpts = {}, gzipLogs = true) {\n    const progressCallback = opts.progressCallback || (() => {});\n\n    progressCallback(_t(\"Collecting app version information\"));\n    let version = \"UNKNOWN\";\n    try {\n        version = await PlatformPeg.get().getAppVersion();\n    } catch (err) {} // PlatformPeg already logs this.\n\n    let userAgent = \"UNKNOWN\";\n    if (window.navigator && window.navigator.userAgent) {\n        userAgent = window.navigator.userAgent;\n    }\n\n    let installedPWA = \"UNKNOWN\";\n    try {\n        // Known to work at least for desktop Chrome\n        installedPWA = String(window.matchMedia('(display-mode: standalone)').matches);\n    } catch (e) {}\n\n    let touchInput = \"UNKNOWN\";\n    try {\n        // MDN claims broad support across browsers\n        touchInput = String(window.matchMedia('(pointer: coarse)').matches);\n    } catch (e) { }\n\n    const client = MatrixClientPeg.get();\n\n    logger.log(\"Sending bug report.\");\n\n    const body = new FormData();\n    body.append('text', opts.userText || \"User did not supply any additional text.\");\n    body.append('app', opts.customApp || 'element-web');\n    body.append('version', version);\n    body.append('user_agent', userAgent);\n    body.append('installed_pwa', installedPWA);\n    body.append('touch_input', touchInput);\n\n    if (opts.customFields) {\n        for (const key in opts.customFields) {\n            body.append(key, opts.customFields[key]);\n        }\n    }\n\n    if (client) {\n        body.append('user_id', client.credentials.userId);\n        body.append('device_id', client.deviceId);\n\n        if (client.isCryptoEnabled()) {\n            const keys = [`ed25519:${client.getDeviceEd25519Key()}`];\n            if (client.getDeviceCurve25519Key) {\n                keys.push(`curve25519:${client.getDeviceCurve25519Key()}`);\n            }\n            body.append('device_keys', keys.join(', '));\n            body.append('cross_signing_key', client.getCrossSigningId());\n\n            // add cross-signing status information\n            const crossSigning = client.crypto.crossSigningInfo;\n            const secretStorage = client.crypto.secretStorage;\n\n            body.append(\"cross_signing_ready\", String(await client.isCrossSigningReady()));\n            body.append(\"cross_signing_supported_by_hs\",\n                String(await client.doesServerSupportUnstableFeature(\"org.matrix.e2e_cross_signing\")));\n            body.append(\"cross_signing_key\", crossSigning.getId());\n            body.append(\"cross_signing_privkey_in_secret_storage\",\n                String(!!(await crossSigning.isStoredInSecretStorage(secretStorage))));\n\n            const pkCache = client.getCrossSigningCacheCallbacks();\n            body.append(\"cross_signing_master_privkey_cached\",\n                String(!!(pkCache && (await pkCache.getCrossSigningKeyCache(\"master\")))));\n            body.append(\"cross_signing_self_signing_privkey_cached\",\n                String(!!(pkCache && (await pkCache.getCrossSigningKeyCache(\"self_signing\")))));\n            body.append(\"cross_signing_user_signing_privkey_cached\",\n                String(!!(pkCache && (await pkCache.getCrossSigningKeyCache(\"user_signing\")))));\n\n            body.append(\"secret_storage_ready\", String(await client.isSecretStorageReady()));\n            body.append(\"secret_storage_key_in_account\", String(!!(await secretStorage.hasKey())));\n\n            body.append(\"session_backup_key_in_secret_storage\", String(!!(await client.isKeyBackupKeyStored())));\n            const sessionBackupKeyFromCache = await client.crypto.getSessionBackupPrivateKey();\n            body.append(\"session_backup_key_cached\", String(!!sessionBackupKeyFromCache));\n            body.append(\"session_backup_key_well_formed\", String(sessionBackupKeyFromCache instanceof Uint8Array));\n        }\n    }\n\n    if (opts.labels) {\n        for (const label of opts.labels) {\n            body.append('label', label);\n        }\n    }\n\n    // add labs options\n    const enabledLabs = SettingsStore.getFeatureSettingNames().filter(f => SettingsStore.getValue(f));\n    if (enabledLabs.length) {\n        body.append('enabled_labs', enabledLabs.join(', '));\n    }\n    // if low bandwidth mode is enabled, say so over rageshake, it causes many issues\n    if (SettingsStore.getValue(\"lowBandwidth\")) {\n        body.append(\"lowBandwidth\", \"enabled\");\n    }\n\n    // add storage persistence/quota information\n    if (navigator.storage && navigator.storage.persisted) {\n        try {\n            body.append(\"storageManager_persisted\", String(await navigator.storage.persisted()));\n        } catch (e) {}\n    } else if (document.hasStorageAccess) { // Safari\n        try {\n            body.append(\"storageManager_persisted\", String(await document.hasStorageAccess()));\n        } catch (e) {}\n    }\n    if (navigator.storage && navigator.storage.estimate) {\n        try {\n            const estimate = await navigator.storage.estimate();\n            body.append(\"storageManager_quota\", String(estimate.quota));\n            body.append(\"storageManager_usage\", String(estimate.usage));\n            if (estimate.usageDetails) {\n                Object.keys(estimate.usageDetails).forEach(k => {\n                    body.append(`storageManager_usage_${k}`, String(estimate.usageDetails[k]));\n                });\n            }\n        } catch (e) {}\n    }\n\n    if (window.Modernizr) {\n        const missingFeatures = Object.keys(window.Modernizr).filter(key => window.Modernizr[key] === false);\n        if (missingFeatures.length > 0) {\n            body.append(\"modernizr_missing_features\", missingFeatures.join(\", \"));\n        }\n    }\n\n    body.append(\"mx_local_settings\", localStorage.getItem('mx_local_settings'));\n\n    if (opts.sendLogs) {\n        progressCallback(_t(\"Collecting logs\"));\n        const logs = await rageshake.getLogsForReport();\n        for (const entry of logs) {\n            // encode as UTF-8\n            let buf = new TextEncoder().encode(entry.lines);\n\n            // compress\n            if (gzipLogs) {\n                buf = pako.gzip(buf);\n            }\n\n            body.append('compressed-log', new Blob([buf]), entry.id);\n        }\n    }\n\n    return body;\n}\n\n/**\n * Send a bug report.\n *\n * @param {string} bugReportEndpoint HTTP url to send the report to\n *\n * @param {object} opts optional dictionary of options\n *\n * @param {string} opts.userText Any additional user input.\n *\n * @param {boolean} opts.sendLogs True to send logs\n *\n * @param {function(string)} opts.progressCallback Callback to call with progress updates\n *\n * @return {Promise<string>} URL returned by the rageshake server\n */\nexport default async function sendBugReport(bugReportEndpoint: string, opts: IOpts = {}): Promise<string> {\n    if (!bugReportEndpoint) {\n        throw new Error(\"No bug report endpoint has been set.\");\n    }\n\n    const progressCallback = opts.progressCallback || (() => {});\n    const body = await collectBugReport(opts);\n\n    progressCallback(_t(\"Uploading logs\"));\n    return submitReport(bugReportEndpoint, body, progressCallback);\n}\n\n/**\n * Downloads the files from a bug report. This is the same as sendBugReport,\n * but instead causes the browser to download the files locally.\n *\n * @param {object} opts optional dictionary of options\n *\n * @param {string} opts.userText Any additional user input.\n *\n * @param {boolean} opts.sendLogs True to send logs\n *\n * @param {function(string)} opts.progressCallback Callback to call with progress updates\n *\n * @return {Promise} Resolved when the bug report is downloaded (or started).\n */\nexport async function downloadBugReport(opts: IOpts = {}) {\n    const progressCallback = opts.progressCallback || (() => {});\n    const body = await collectBugReport(opts, false);\n\n    progressCallback(_t(\"Downloading logs\"));\n    let metadata = \"\";\n    const tape = new Tar();\n    let i = 0;\n    for (const [key, value] of body.entries()) {\n        if (key === 'compressed-log') {\n            await new Promise<void>((resolve => {\n                const reader = new FileReader();\n                reader.addEventListener('loadend', ev => {\n                    tape.append(`log-${i++}.log`, new TextDecoder().decode(ev.target.result as ArrayBuffer));\n                    resolve();\n                });\n                reader.readAsArrayBuffer(value as Blob);\n            }));\n        } else {\n            metadata += `${key} = ${value}\\n`;\n        }\n    }\n    tape.append('issue.txt', metadata);\n\n    // We have to create a new anchor to download if we want a filename. Otherwise we could\n    // just use window.open.\n    const dl = document.createElement('a');\n    dl.href = `data:application/octet-stream;base64,${btoa(uint8ToString(tape.out))}`;\n    dl.download = 'rageshake.tar';\n    document.body.appendChild(dl);\n    dl.click();\n    document.body.removeChild(dl);\n}\n\n// Source: https://github.com/beatgammit/tar-js/blob/master/examples/main.js\nfunction uint8ToString(buf: Buffer) {\n    let out = '';\n    for (let i = 0; i < buf.length; i += 1) {\n        out += String.fromCharCode(buf[i]);\n    }\n    return out;\n}\n\nexport async function submitFeedback(\n    endpoint: string,\n    label: string,\n    comment: string,\n    canContact = false,\n    extraData: Record<string, string> = {},\n) {\n    let version = \"UNKNOWN\";\n    try {\n        version = await PlatformPeg.get().getAppVersion();\n    } catch (err) {} // PlatformPeg already logs this.\n\n    const body = new FormData();\n    body.append(\"label\", label);\n    body.append(\"text\", comment);\n    body.append(\"can_contact\", canContact ? \"yes\" : \"no\");\n\n    body.append(\"app\", \"element-web\");\n    body.append(\"version\", version);\n    body.append(\"platform\", PlatformPeg.get().getHumanReadableName());\n    body.append(\"user_id\", MatrixClientPeg.get()?.getUserId());\n\n    for (const k in extraData) {\n        body.append(k, JSON.stringify(extraData[k]));\n    }\n\n    await submitReport(SdkConfig.get().bug_report_endpoint_url, body, () => {});\n}\n\nfunction submitReport(endpoint: string, body: FormData, progressCallback: (str: string) => void): Promise<string> {\n    return new Promise<string>((resolve, reject) => {\n        const req = new XMLHttpRequest();\n        req.open(\"POST\", endpoint);\n        req.responseType = \"json\";\n        req.timeout = 5 * 60 * 1000;\n        req.onreadystatechange = function() {\n            if (req.readyState === XMLHttpRequest.LOADING) {\n                progressCallback(_t(\"Waiting for response from server\"));\n            } else if (req.readyState === XMLHttpRequest.DONE) {\n                // on done\n                if (req.status < 200 || req.status >= 400) {\n                    reject(new Error(`HTTP ${req.status}`));\n                    return;\n                }\n                resolve(req.response.report_url || \"\");\n            }\n        };\n        req.send(body);\n    });\n}\n"],"mappings":"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"}