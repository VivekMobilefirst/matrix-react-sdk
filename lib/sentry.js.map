{"version":3,"file":"sentry.js","names":["getStorageContext","result","navigator","storage","persisted","String","e","document","hasStorageAccess","estimate","quota","usage","usageDetails","Object","keys","forEach","k","push","join","getUserContext","client","credentials","userId","getEnabledLabs","SettingsStore","getValue","enabledLabs","getFeatureSettingNames","filter","f","length","getCryptoContext","isCryptoEnabled","getDeviceEd25519Key","getDeviceCurve25519Key","crossSigning","crypto","crossSigningInfo","secretStorage","pkCache","getCrossSigningCacheCallbacks","sessionBackupKeyFromCache","getSessionBackupPrivateKey","isCrossSigningReady","doesServerSupportUnstableFeature","getId","isStoredInSecretStorage","getCrossSigningKeyCache","isSecretStorageReady","hasKey","isKeyBackupKeyStored","Uint8Array","getDeviceContext","deviceId","localStorage","getItem","window","Modernizr","missingFeatures","key","getContexts","MatrixClientPeg","get","sendSentryReport","userText","issueUrl","error","sentryConfig","SdkConfig","getObject","captureContext","Sentry","captureException","captureMessage","setSentryUser","mxid","sentry","setUser","username","initSentry","integrations","Integrations","InboundFilters","FunctionToString","Breadcrumbs","UserAgent","Dedupe","GlobalHandlers","onerror","onunhandledrejection","TryCatch","init","dsn","release","process","env","VERSION","environment","defaultIntegrations","autoSessionTracking","tracesSampleRate","mxSendSentryReport"],"sources":["../src/sentry.ts"],"sourcesContent":["/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport * as Sentry from \"@sentry/browser\";\nimport { MatrixClient } from \"matrix-js-sdk/src/client\";\n\nimport SdkConfig from \"./SdkConfig\";\nimport { MatrixClientPeg } from \"./MatrixClientPeg\";\nimport SettingsStore from \"./settings/SettingsStore\";\nimport { IConfigOptions } from \"./IConfigOptions\";\n\n/* eslint-disable camelcase */\n\ntype StorageContext = {\n    storageManager_persisted?: string;\n    storageManager_quota?: string;\n    storageManager_usage?: string;\n    storageManager_usageDetails?: string;\n};\n\ntype UserContext = {\n    username: string;\n    enabled_labs: string;\n    low_bandwidth: string;\n};\n\ntype CryptoContext = {\n    device_keys?: string;\n    cross_signing_ready?: string;\n    cross_signing_supported_by_hs?: string;\n    cross_signing_key?: string;\n    cross_signing_privkey_in_secret_storage?: string;\n    cross_signing_master_privkey_cached?: string;\n    cross_signing_user_signing_privkey_cached?: string;\n    secret_storage_ready?: string;\n    secret_storage_key_in_account?: string;\n    session_backup_key_in_secret_storage?: string;\n    session_backup_key_cached?: string;\n    session_backup_key_well_formed?: string;\n};\n\ntype DeviceContext = {\n    device_id: string;\n    mx_local_settings: string;\n    modernizr_missing_features?: string;\n};\n\ntype Contexts = {\n    user: UserContext;\n    crypto: CryptoContext;\n    device: DeviceContext;\n    storage: StorageContext;\n};\n\n/* eslint-enable camelcase */\n\nasync function getStorageContext(): Promise<StorageContext> {\n    const result = {};\n\n    // add storage persistence/quota information\n    if (navigator.storage && navigator.storage.persisted) {\n        try {\n            result[\"storageManager_persisted\"] = String(await navigator.storage.persisted());\n        } catch (e) {}\n    } else if (document.hasStorageAccess) { // Safari\n        try {\n            result[\"storageManager_persisted\"] = String(await document.hasStorageAccess());\n        } catch (e) {}\n    }\n    if (navigator.storage && navigator.storage.estimate) {\n        try {\n            const estimate = await navigator.storage.estimate();\n            result[\"storageManager_quota\"] = String(estimate.quota);\n            result[\"storageManager_usage\"] = String(estimate.usage);\n            if (estimate.usageDetails) {\n                const usageDetails = [];\n                Object.keys(estimate.usageDetails).forEach(k => {\n                    usageDetails.push(`${k}: ${String(estimate.usageDetails[k])}`);\n                });\n                result[`storageManager_usage`] = usageDetails.join(\", \");\n            }\n        } catch (e) {}\n    }\n\n    return result;\n}\n\nfunction getUserContext(client: MatrixClient): UserContext {\n    return {\n        \"username\": client.credentials.userId,\n        \"enabled_labs\": getEnabledLabs(),\n        \"low_bandwidth\": SettingsStore.getValue(\"lowBandwidth\") ? \"enabled\" : \"disabled\",\n    };\n}\n\nfunction getEnabledLabs(): string {\n    const enabledLabs = SettingsStore.getFeatureSettingNames().filter(f => SettingsStore.getValue(f));\n    if (enabledLabs.length) {\n        return enabledLabs.join(\", \");\n    }\n    return \"\";\n}\n\nasync function getCryptoContext(client: MatrixClient): Promise<CryptoContext> {\n    if (!client.isCryptoEnabled()) {\n        return {};\n    }\n    const keys = [`ed25519:${client.getDeviceEd25519Key()}`];\n    if (client.getDeviceCurve25519Key) {\n        keys.push(`curve25519:${client.getDeviceCurve25519Key()}`);\n    }\n    const crossSigning = client.crypto.crossSigningInfo;\n    const secretStorage = client.crypto.secretStorage;\n    const pkCache = client.getCrossSigningCacheCallbacks();\n    const sessionBackupKeyFromCache = await client.crypto.getSessionBackupPrivateKey();\n\n    return {\n        \"device_keys\": keys.join(', '),\n        \"cross_signing_ready\": String(await client.isCrossSigningReady()),\n        \"cross_signing_supported_by_hs\":\n            String(await client.doesServerSupportUnstableFeature(\"org.matrix.e2e_cross_signing\")),\n        \"cross_signing_key\": crossSigning.getId(),\n        \"cross_signing_privkey_in_secret_storage\": String(\n            !!(await crossSigning.isStoredInSecretStorage(secretStorage))),\n        \"cross_signing_master_privkey_cached\": String(\n            !!(pkCache && (await pkCache.getCrossSigningKeyCache(\"master\")))),\n        \"cross_signing_user_signing_privkey_cached\": String(\n            !!(pkCache && (await pkCache.getCrossSigningKeyCache(\"user_signing\")))),\n        \"secret_storage_ready\": String(await client.isSecretStorageReady()),\n        \"secret_storage_key_in_account\": String(!!(await secretStorage.hasKey())),\n        \"session_backup_key_in_secret_storage\": String(!!(await client.isKeyBackupKeyStored())),\n        \"session_backup_key_cached\": String(!!sessionBackupKeyFromCache),\n        \"session_backup_key_well_formed\": String(sessionBackupKeyFromCache instanceof Uint8Array),\n    };\n}\n\nfunction getDeviceContext(client: MatrixClient): DeviceContext {\n    const result = {\n        \"device_id\": client?.deviceId,\n        \"mx_local_settings\": localStorage.getItem('mx_local_settings'),\n    };\n\n    if (window.Modernizr) {\n        const missingFeatures = Object.keys(window.Modernizr).filter(key => window.Modernizr[key] === false);\n        if (missingFeatures.length > 0) {\n            result[\"modernizr_missing_features\"] = missingFeatures.join(\", \");\n        }\n    }\n\n    return result;\n}\n\nasync function getContexts(): Promise<Contexts> {\n    const client = MatrixClientPeg.get();\n    return {\n        \"user\": getUserContext(client),\n        \"crypto\": await getCryptoContext(client),\n        \"device\": getDeviceContext(client),\n        \"storage\": await getStorageContext(),\n    };\n}\n\nexport async function sendSentryReport(userText: string, issueUrl: string, error: Error): Promise<void> {\n    const sentryConfig = SdkConfig.getObject(\"sentry\");\n    if (!sentryConfig) return;\n\n    const captureContext = {\n        \"contexts\": await getContexts(),\n        \"extra\": {\n            \"user_text\": userText,\n            \"issue_url\": issueUrl,\n        },\n    };\n\n    // If there's no error and no issueUrl, the report will just produce non-grouped noise in Sentry, so don't\n    // upload it\n    if (error) {\n        Sentry.captureException(error, captureContext);\n    } else if (issueUrl) {\n        Sentry.captureMessage(`Issue: ${issueUrl}`, captureContext);\n    }\n}\n\nexport function setSentryUser(mxid: string): void {\n    if (!SdkConfig.get().sentry || !SettingsStore.getValue(\"automaticErrorReporting\")) return;\n    Sentry.setUser({ username: mxid });\n}\n\nexport async function initSentry(sentryConfig: IConfigOptions[\"sentry\"]): Promise<void> {\n    if (!sentryConfig) return;\n    // Only enable Integrations.GlobalHandlers, which hooks uncaught exceptions, if automaticErrorReporting is true\n    const integrations = [\n        new Sentry.Integrations.InboundFilters(),\n        new Sentry.Integrations.FunctionToString(),\n        new Sentry.Integrations.Breadcrumbs(),\n        new Sentry.Integrations.UserAgent(),\n        new Sentry.Integrations.Dedupe(),\n    ];\n\n    if (SettingsStore.getValue(\"automaticErrorReporting\")) {\n        integrations.push(new Sentry.Integrations.GlobalHandlers(\n            { onerror: false, onunhandledrejection: true }));\n        integrations.push(new Sentry.Integrations.TryCatch());\n    }\n\n    Sentry.init({\n        dsn: sentryConfig.dsn,\n        release: process.env.VERSION,\n        environment: sentryConfig.environment,\n        defaultIntegrations: false,\n        autoSessionTracking: false,\n        integrations,\n        // Set to 1.0 which is reasonable if we're only submitting Rageshakes; will need to be set < 1.0\n        // if we collect more frequently.\n        tracesSampleRate: 1.0,\n    });\n}\n\nwindow.mxSendSentryReport = sendSentryReport;\n"],"mappings":"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"}