{"version":3,"file":"DecryptionFailureTracker.js","names":["DecryptionFailure","constructor","failedEventId","errorCode","ts","Date","now","DecryptionFailureTracker","fn","errorCodeMapFn","Map","Set","Error","instance","internalInstance","eventDecrypted","e","err","getWireContent","algorithm","addDecryptionFailure","getId","code","removeDecryptionFailuresForEvent","addVisibleEvent","eventId","trackedEvents","has","visibleEvents","add","failures","visibleFailures","set","get","failure","delete","start","checkInterval","setInterval","checkFailures","CHECK_INTERVAL_MS","trackInterval","trackFailures","TRACK_INTERVAL_MS","stop","clearInterval","failureCounts","nowTs","failuresGivenGrace","failuresNotReady","GRACE_PERIOD_MS","aggregateFailures","Object","keys","trackedErrorCode","total","rawError","i","PosthogAnalytics","trackEvent","eventName","domain","name","context","undefined"],"sources":["../src/DecryptionFailureTracker.ts"],"sourcesContent":["/*\nCopyright 2018 - 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { DecryptionError } from \"matrix-js-sdk/src/crypto/algorithms\";\nimport { MatrixEvent } from \"matrix-js-sdk/src/models/event\";\nimport { Error as ErrorEvent } from \"@matrix-org/analytics-events/types/typescript/Error\";\n\nimport { PosthogAnalytics } from './PosthogAnalytics';\n\nexport class DecryptionFailure {\n    public readonly ts: number;\n\n    constructor(public readonly failedEventId: string, public readonly errorCode: string) {\n        this.ts = Date.now();\n    }\n}\n\ntype ErrorCode = \"OlmKeysNotSentError\" | \"OlmIndexError\" | \"UnknownError\" | \"OlmUnspecifiedError\";\n\ntype TrackingFn = (count: number, trackedErrCode: ErrorCode, rawError: string) => void;\n\nexport type ErrCodeMapFn = (errcode: string) => ErrorCode;\n\nexport class DecryptionFailureTracker {\n    private static internalInstance = new DecryptionFailureTracker((total, errorCode, rawError) => {\n        for (let i = 0; i < total; i++) {\n            PosthogAnalytics.instance.trackEvent<ErrorEvent>({\n                eventName: \"Error\",\n                domain: \"E2EE\",\n                name: errorCode,\n                context: `mxc_crypto_error_type_${rawError}`,\n            });\n        }\n    }, (errorCode) => {\n        // Map JS-SDK error codes to tracker codes for aggregation\n        switch (errorCode) {\n            case 'MEGOLM_UNKNOWN_INBOUND_SESSION_ID':\n                return 'OlmKeysNotSentError';\n            case 'OLM_UNKNOWN_MESSAGE_INDEX':\n                return 'OlmIndexError';\n            case undefined:\n                return 'OlmUnspecifiedError';\n            default:\n                return 'UnknownError';\n        }\n    });\n\n    // Map of event IDs to DecryptionFailure items.\n    public failures: Map<string, DecryptionFailure> = new Map();\n\n    // Set of event IDs that have been visible to the user.\n    public visibleEvents: Set<string> = new Set();\n\n    // Map of visible event IDs to `DecryptionFailure`s. Every\n    // `CHECK_INTERVAL_MS`, this map is checked for failures that\n    // happened > `GRACE_PERIOD_MS` ago. Those that did are\n    // accumulated in `failureCounts`.\n    public visibleFailures: Map<string, DecryptionFailure> = new Map();\n\n    // A histogram of the number of failures that will be tracked at the next tracking\n    // interval, split by failure error code.\n    public failureCounts: Record<string, number> = {\n        // [errorCode]: 42\n    };\n\n    // Event IDs of failures that were tracked previously\n    public trackedEvents: Set<string> = new Set();\n\n    // Set to an interval ID when `start` is called\n    public checkInterval: number = null;\n    public trackInterval: number = null;\n\n    // Spread the load on `Analytics` by tracking at a low frequency, `TRACK_INTERVAL_MS`.\n    static TRACK_INTERVAL_MS = 60000;\n\n    // Call `checkFailures` every `CHECK_INTERVAL_MS`.\n    static CHECK_INTERVAL_MS = 5000;\n\n    // Give events a chance to be decrypted by waiting `GRACE_PERIOD_MS` before counting\n    // the failure in `failureCounts`.\n    static GRACE_PERIOD_MS = 4000;\n\n    /**\n     * Create a new DecryptionFailureTracker.\n     *\n     * Call `eventDecrypted(event, err)` on this instance when an event is decrypted.\n     *\n     * Call `start()` to start the tracker, and `stop()` to stop tracking.\n     *\n     * @param {function} fn The tracking function, which will be called when failures\n     * are tracked. The function should have a signature `(count, trackedErrorCode) => {...}`,\n     * where `count` is the number of failures and `errorCode` matches the `.code` of\n     * provided DecryptionError errors (by default, unless `errorCodeMapFn` is specified.\n     * @param {function?} errorCodeMapFn The function used to map error codes to the\n     * trackedErrorCode. If not provided, the `.code` of errors will be used.\n     */\n    private constructor(private readonly fn: TrackingFn, private readonly errorCodeMapFn: ErrCodeMapFn) {\n        if (!fn || typeof fn !== 'function') {\n            throw new Error('DecryptionFailureTracker requires tracking function');\n        }\n\n        if (typeof errorCodeMapFn !== 'function') {\n            throw new Error('DecryptionFailureTracker second constructor argument should be a function');\n        }\n    }\n\n    public static get instance(): DecryptionFailureTracker {\n        return DecryptionFailureTracker.internalInstance;\n    }\n\n    // loadTrackedEvents() {\n    //     this.trackedEvents = new Set(JSON.parse(localStorage.getItem('mx-decryption-failure-event-ids')) || []);\n    // }\n\n    // saveTrackedEvents() {\n    //     localStorage.setItem('mx-decryption-failure-event-ids', JSON.stringify([...this.trackedEvents]));\n    // }\n\n    public eventDecrypted(e: MatrixEvent, err: DecryptionError): void {\n        // for now we only track megolm decrytion failures\n        if (e.getWireContent().algorithm != \"m.megolm.v1.aes-sha2\") {\n            return;\n        }\n        if (err) {\n            this.addDecryptionFailure(new DecryptionFailure(e.getId(), err.code));\n        } else {\n            // Could be an event in the failures, remove it\n            this.removeDecryptionFailuresForEvent(e);\n        }\n    }\n\n    public addVisibleEvent(e: MatrixEvent): void {\n        const eventId = e.getId();\n\n        if (this.trackedEvents.has(eventId)) { return; }\n\n        this.visibleEvents.add(eventId);\n        if (this.failures.has(eventId) && !this.visibleFailures.has(eventId)) {\n            this.visibleFailures.set(eventId, this.failures.get(eventId));\n        }\n    }\n\n    public addDecryptionFailure(failure: DecryptionFailure): void {\n        const eventId = failure.failedEventId;\n\n        if (this.trackedEvents.has(eventId)) { return; }\n\n        this.failures.set(eventId, failure);\n        if (this.visibleEvents.has(eventId) && !this.visibleFailures.has(eventId)) {\n            this.visibleFailures.set(eventId, failure);\n        }\n    }\n\n    public removeDecryptionFailuresForEvent(e: MatrixEvent): void {\n        const eventId = e.getId();\n        this.failures.delete(eventId);\n        this.visibleFailures.delete(eventId);\n    }\n\n    /**\n     * Start checking for and tracking failures.\n     */\n    public start(): void {\n        this.checkInterval = setInterval(\n            () => this.checkFailures(Date.now()),\n            DecryptionFailureTracker.CHECK_INTERVAL_MS,\n        );\n\n        this.trackInterval = setInterval(\n            () => this.trackFailures(),\n            DecryptionFailureTracker.TRACK_INTERVAL_MS,\n        );\n    }\n\n    /**\n     * Clear state and stop checking for and tracking failures.\n     */\n    public stop(): void {\n        clearInterval(this.checkInterval);\n        clearInterval(this.trackInterval);\n\n        this.failures = new Map();\n        this.visibleEvents = new Set();\n        this.visibleFailures = new Map();\n        this.failureCounts = {};\n    }\n\n    /**\n     * Mark failures that occurred before nowTs - GRACE_PERIOD_MS as failures that should be\n     * tracked. Only mark one failure per event ID.\n     * @param {number} nowTs the timestamp that represents the time now.\n     */\n    public checkFailures(nowTs: number): void {\n        const failuresGivenGrace: Set<DecryptionFailure> = new Set();\n        const failuresNotReady: Map<string, DecryptionFailure> = new Map();\n        for (const [eventId, failure] of this.visibleFailures) {\n            if (nowTs > failure.ts + DecryptionFailureTracker.GRACE_PERIOD_MS) {\n                failuresGivenGrace.add(failure);\n                this.trackedEvents.add(eventId);\n            } else {\n                failuresNotReady.set(eventId, failure);\n            }\n        }\n        this.visibleFailures = failuresNotReady;\n\n        // Commented out for now for expediency, we need to consider unbound nature of storing\n        // this in localStorage\n        // this.saveTrackedEvents();\n\n        this.aggregateFailures(failuresGivenGrace);\n    }\n\n    private aggregateFailures(failures: Set<DecryptionFailure>): void {\n        for (const failure of failures) {\n            const errorCode = failure.errorCode;\n            this.failureCounts[errorCode] = (this.failureCounts[errorCode] || 0) + 1;\n        }\n    }\n\n    /**\n     * If there are failures that should be tracked, call the given trackDecryptionFailure\n     * function with the number of failures that should be tracked.\n     */\n    public trackFailures(): void {\n        for (const errorCode of Object.keys(this.failureCounts)) {\n            if (this.failureCounts[errorCode] > 0) {\n                const trackedErrorCode = this.errorCodeMapFn(errorCode);\n\n                this.fn(this.failureCounts[errorCode], trackedErrorCode, errorCode);\n                this.failureCounts[errorCode] = 0;\n            }\n        }\n    }\n}\n"],"mappings":"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"}