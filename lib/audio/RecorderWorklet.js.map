{"version":3,"file":"RecorderWorklet.js","names":["TARGET_AMPLITUDE_FREQUENCY","roundTimeToTargetFreq","seconds","Math","round","Number","EPSILON","nextTimeForTargetFreq","roundedSeconds","MxVoiceWorklet","AudioWorkletProcessor","process","inputs","outputs","parameters","currentSecond","currentTime","nextAmplitudeSecond","monoChan","minVal","min","maxVal","max","amplitude","percentageOf","port","postMessage","ev","PayloadEvent","AmplitudeMark","forIndex","amplitudeIndex","Timekeep","timeSeconds","registerProcessor","WORKLET_NAME"],"sources":["../../src/audio/RecorderWorklet.ts"],"sourcesContent":["/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { IAmplitudePayload, ITimingPayload, PayloadEvent, WORKLET_NAME } from \"./consts\";\nimport { percentageOf } from \"../utils/numbers\";\n\n// from AudioWorkletGlobalScope: https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletGlobalScope\ndeclare const currentTime: number;\n// declare const currentFrame: number;\n// declare const sampleRate: number;\n\n// We rate limit here to avoid overloading downstream consumers with amplitude information.\n// The two major consumers are the voice message waveform thumbnail (resampled down to an\n// appropriate length) and the live waveform shown to the user. Effectively, this controls\n// the refresh rate of that live waveform and the number of samples the thumbnail has to\n// work with.\nconst TARGET_AMPLITUDE_FREQUENCY = 16; // Hz\n\nfunction roundTimeToTargetFreq(seconds: number): number {\n    // Epsilon helps avoid floating point rounding issues (1 + 1 = 1.999999, etc)\n    return Math.round((seconds + Number.EPSILON) * TARGET_AMPLITUDE_FREQUENCY) / TARGET_AMPLITUDE_FREQUENCY;\n}\n\nfunction nextTimeForTargetFreq(roundedSeconds: number): number {\n    // The extra round is just to make sure we cut off any floating point issues\n    return roundTimeToTargetFreq(roundedSeconds + (1 / TARGET_AMPLITUDE_FREQUENCY));\n}\n\nclass MxVoiceWorklet extends AudioWorkletProcessor {\n    private nextAmplitudeSecond = 0;\n    private amplitudeIndex = 0;\n\n    process(inputs, outputs, parameters) {\n        const currentSecond = roundTimeToTargetFreq(currentTime);\n        // We special case the first ping because there's a fairly good chance that we'll miss the zeroth\n        // update. Firefox for instance takes 0.06 seconds (roughly) to call this function for the first\n        // time. Edge and Chrome occasionally lag behind too, but for the most part are on time.\n        //\n        // When this doesn't work properly we end up producing a waveform of nulls and no live preview\n        // of the recorded message.\n        if (currentSecond === this.nextAmplitudeSecond || this.nextAmplitudeSecond === 0) {\n            // We're expecting exactly one mono input source, so just grab the very first frame of\n            // samples for the analysis.\n            const monoChan = inputs[0][0];\n\n            // The amplitude of the frame's samples is effectively the loudness of the frame. This\n            // translates into a bar which can be rendered as part of the whole recording clip's\n            // waveform.\n            //\n            // We translate the amplitude down to 0-1 for sanity's sake.\n            const minVal = Math.min(...monoChan);\n            const maxVal = Math.max(...monoChan);\n            const amplitude = percentageOf(maxVal, -1, 1) - percentageOf(minVal, -1, 1);\n\n            this.port.postMessage(<IAmplitudePayload>{\n                ev: PayloadEvent.AmplitudeMark,\n                amplitude: amplitude,\n                forIndex: this.amplitudeIndex++,\n            });\n            this.nextAmplitudeSecond = nextTimeForTargetFreq(currentSecond);\n        }\n\n        // We mostly use this worklet to fire regular clock updates through to components\n        this.port.postMessage(<ITimingPayload>{ ev: PayloadEvent.Timekeep, timeSeconds: currentTime });\n\n        // We're supposed to return false when we're \"done\" with the audio clip, but seeing as\n        // we are acting as a passive processor we are never truly \"done\". The browser will clean\n        // us up when it is done with us.\n        return true;\n    }\n}\n\nregisterProcessor(WORKLET_NAME, MxVoiceWorklet);\n\nexport default null; // to appease module loaders (we never use the export)\n"],"mappings":";;;;;;;;;;;AAgBA;;AACA;;AAjBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAOA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA,MAAMA,0BAA0B,GAAG,EAAnC,C,CAAuC;;AAEvC,SAASC,qBAAT,CAA+BC,OAA/B,EAAwD;EACpD;EACA,OAAOC,IAAI,CAACC,KAAL,CAAW,CAACF,OAAO,GAAGG,MAAM,CAACC,OAAlB,IAA6BN,0BAAxC,IAAsEA,0BAA7E;AACH;;AAED,SAASO,qBAAT,CAA+BC,cAA/B,EAA+D;EAC3D;EACA,OAAOP,qBAAqB,CAACO,cAAc,GAAI,IAAIR,0BAAvB,CAA5B;AACH;;AAED,MAAMS,cAAN,SAA6BC,qBAA7B,CAAmD;EAAA;IAAA;IAAA,2DACjB,CADiB;IAAA,sDAEtB,CAFsB;EAAA;;EAI/CC,OAAO,CAACC,MAAD,EAASC,OAAT,EAAkBC,UAAlB,EAA8B;IACjC,MAAMC,aAAa,GAAGd,qBAAqB,CAACe,WAAD,CAA3C,CADiC,CAEjC;IACA;IACA;IACA;IACA;IACA;;IACA,IAAID,aAAa,KAAK,KAAKE,mBAAvB,IAA8C,KAAKA,mBAAL,KAA6B,CAA/E,EAAkF;MAC9E;MACA;MACA,MAAMC,QAAQ,GAAGN,MAAM,CAAC,CAAD,CAAN,CAAU,CAAV,CAAjB,CAH8E,CAK9E;MACA;MACA;MACA;MACA;;MACA,MAAMO,MAAM,GAAGhB,IAAI,CAACiB,GAAL,CAAS,GAAGF,QAAZ,CAAf;MACA,MAAMG,MAAM,GAAGlB,IAAI,CAACmB,GAAL,CAAS,GAAGJ,QAAZ,CAAf;MACA,MAAMK,SAAS,GAAG,IAAAC,qBAAA,EAAaH,MAAb,EAAqB,CAAC,CAAtB,EAAyB,CAAzB,IAA8B,IAAAG,qBAAA,EAAaL,MAAb,EAAqB,CAAC,CAAtB,EAAyB,CAAzB,CAAhD;MAEA,KAAKM,IAAL,CAAUC,WAAV,CAAyC;QACrCC,EAAE,EAAEC,oBAAA,CAAaC,aADoB;QAErCN,SAAS,EAAEA,SAF0B;QAGrCO,QAAQ,EAAE,KAAKC,cAAL;MAH2B,CAAzC;MAKA,KAAKd,mBAAL,GAA2BV,qBAAqB,CAACQ,aAAD,CAAhD;IACH,CA5BgC,CA8BjC;;;IACA,KAAKU,IAAL,CAAUC,WAAV,CAAsC;MAAEC,EAAE,EAAEC,oBAAA,CAAaI,QAAnB;MAA6BC,WAAW,EAAEjB;IAA1C,CAAtC,EA/BiC,CAiCjC;IACA;IACA;;IACA,OAAO,IAAP;EACH;;AAzC8C;;AA4CnDkB,iBAAiB,CAACC,oBAAD,EAAe1B,cAAf,CAAjB;eAEe,I,EAAM"}