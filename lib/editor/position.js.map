{"version":3,"file":"position.js","names":["DocumentPosition","constructor","index","offset","compare","otherPos","iteratePartsBetween","other","model","callback","startPos","endPos","parts","firstPart","text","length","i","part","lastPart","forwardsWhile","predicate","backwardsWhile","asOffset","DocumentOffset","atEnd","isAtEnd","lastPartIdx","isAtStart"],"sources":["../../src/editor/position.ts"],"sourcesContent":["/*\nCopyright 2019 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport DocumentOffset from \"./offset\";\nimport EditorModel from \"./model\";\nimport { Part } from \"./parts\";\n\nexport interface IPosition {\n    index: number;\n    offset: number;\n}\n\ntype Callback = (part: Part, startIdx: number, endIdx: number) => void;\nexport type Predicate = (index: number, offset: number, part: Part) => boolean;\n\nexport default class DocumentPosition implements IPosition {\n    constructor(public readonly index: number, public readonly offset: number) {\n    }\n\n    public compare(otherPos: DocumentPosition): number {\n        if (this.index === otherPos.index) {\n            return this.offset - otherPos.offset;\n        } else {\n            return this.index - otherPos.index;\n        }\n    }\n\n    public iteratePartsBetween(other: DocumentPosition, model: EditorModel, callback: Callback): void {\n        if (this.index === -1 || other.index === -1) {\n            return;\n        }\n        const [startPos, endPos] = this.compare(other) < 0 ? [this, other] : [other, this];\n        if (startPos.index === endPos.index) {\n            callback(model.parts[this.index], startPos.offset, endPos.offset);\n        } else {\n            const firstPart = model.parts[startPos.index];\n            callback(firstPart, startPos.offset, firstPart.text.length);\n            for (let i = startPos.index + 1; i < endPos.index; ++i) {\n                const part = model.parts[i];\n                callback(part, 0, part.text.length);\n            }\n            const lastPart = model.parts[endPos.index];\n            callback(lastPart, 0, endPos.offset);\n        }\n    }\n\n    public forwardsWhile(model: EditorModel, predicate: Predicate): DocumentPosition {\n        if (this.index === -1) {\n            return this;\n        }\n\n        let { index, offset } = this;\n        const { parts } = model;\n        while (index < parts.length) {\n            const part = parts[index];\n            while (offset < part.text.length) {\n                if (!predicate(index, offset, part)) {\n                    return new DocumentPosition(index, offset);\n                }\n                offset += 1;\n            }\n            // end reached\n            if (index === (parts.length - 1)) {\n                return new DocumentPosition(index, offset);\n            } else {\n                index += 1;\n                offset = 0;\n            }\n        }\n    }\n\n    public backwardsWhile(model: EditorModel, predicate: Predicate): DocumentPosition {\n        if (this.index === -1) {\n            return this;\n        }\n\n        let { index, offset } = this;\n        const parts = model.parts;\n        while (index >= 0) {\n            const part = parts[index];\n            while (offset > 0) {\n                if (!predicate(index, offset - 1, part)) {\n                    return new DocumentPosition(index, offset);\n                }\n                offset -= 1;\n            }\n            // start reached\n            if (index === 0) {\n                return new DocumentPosition(index, offset);\n            } else {\n                index -= 1;\n                offset = parts[index].text.length;\n            }\n        }\n    }\n\n    public asOffset(model: EditorModel): DocumentOffset {\n        if (this.index === -1) {\n            return new DocumentOffset(0, true);\n        }\n        let offset = 0;\n        for (let i = 0; i < this.index; ++i) {\n            offset += model.parts[i].text.length;\n        }\n        offset += this.offset;\n        const lastPart = model.parts[this.index];\n        const atEnd = !lastPart || offset >= lastPart.text.length; // if no last part, we're at the end\n        return new DocumentOffset(offset, atEnd);\n    }\n\n    public isAtEnd(model: EditorModel): boolean {\n        if (model.parts.length === 0) {\n            return true;\n        }\n        const lastPartIdx = model.parts.length - 1;\n        const lastPart = model.parts[lastPartIdx];\n        return this.index === lastPartIdx && this.offset === lastPart.text.length;\n    }\n\n    public isAtStart(): boolean {\n        return this.index === 0 && this.offset === 0;\n    }\n}\n"],"mappings":"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"}