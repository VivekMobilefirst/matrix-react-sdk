{"version":3,"file":"Notifier.js","names":["MAX_PENDING_ENCRYPTED","msgTypeHandlers","MsgType","KeyVerificationRequest","event","name","sender","_t","M_LOCATION","TextForEvent","textForLocationEvent","altName","Notifier","notifsByRoom","pendingEncryptedEventIds","notificationMessageForEvent","ev","hasOwnProperty","getContent","msgtype","textForEvent","_displayPopupNotification","room","plaf","PlatformPeg","get","supportsNotifications","maySendNotifications","msg","title","body","getType","isBodyEnabled","avatarUrl","SettingsStore","getValue","Avatar","avatarUrlForMember","notif","displayNotification","getRoomId","undefined","push","getSoundForRoom","roomId","content","url","logger","warn","startsWith","mediaFromMxc","srcHttp","type","size","_playAudioNotification","sound","log","selector","document","querySelector","audioElement","error","Audio","appendChild","play","ex","start","boundOnEvent","onEvent","bind","boundOnSyncStateChange","onSyncStateChange","boundOnRoomReceipt","onRoomReceipt","boundOnEventDecrypted","onEventDecrypted","MatrixClientPeg","on","ClientEvent","Event","RoomEvent","Receipt","MatrixEventEvent","Decrypted","Sync","toolbarHidden","isSyncing","stop","removeListener","supportsDesktopNotifications","setEnabled","enable","callback","isLevelSupported","SettingLevel","DEVICE","setValue","isEnabled","requestNotificationPermission","then","result","brand","SdkConfig","description","Modal","createDialog","ErrorDialog","PosthogAnalytics","instance","trackEvent","eventName","permission","granted","dis","dispatch","action","value","setPromptHidden","isPossible","isAudioEnabled","hidden","persistent","hideNotificationsToast","global","localStorage","setItem","String","shouldShowPrompt","client","isGuest","isPushNotifyDisabled","_isPromptHidden","getItem","state","getSender","credentials","userId","decryptEventIfNeeded","isBeingDecrypted","isDecryptionFailure","getId","length","shift","_evaluateEvent","idx","indexOf","splice","getUnreadNotificationCount","clearNotification","CallHandler","getSupportsVirtualRooms","nativeRoomId","VoipUserMapper","sharedInstance","nativeRoomForVirtualRoom","getRoom","actions","getPushActionsForEvent","notify","RoomViewStore","UserActivity","userActiveRecently","hasDialogs","tweaks","loudNotification","window","mxNotifier"],"sources":["../src/Notifier.ts"],"sourcesContent":["/*\nCopyright 2015, 2016 OpenMarket Ltd\nCopyright 2017 Vector Creations Ltd\nCopyright 2017 New Vector Ltd\nCopyright 2020 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { MatrixEvent, MatrixEventEvent } from \"matrix-js-sdk/src/models/event\";\nimport { Room, RoomEvent } from \"matrix-js-sdk/src/models/room\";\nimport { ClientEvent } from \"matrix-js-sdk/src/client\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\nimport { MsgType } from \"matrix-js-sdk/src/@types/event\";\nimport { M_LOCATION } from \"matrix-js-sdk/src/@types/location\";\nimport {\n    PermissionChanged as PermissionChangedEvent,\n} from \"@matrix-org/analytics-events/types/typescript/PermissionChanged\";\n\nimport { MatrixClientPeg } from './MatrixClientPeg';\nimport { PosthogAnalytics } from \"./PosthogAnalytics\";\nimport SdkConfig from './SdkConfig';\nimport PlatformPeg from './PlatformPeg';\nimport * as TextForEvent from './TextForEvent';\nimport * as Avatar from './Avatar';\nimport dis from './dispatcher/dispatcher';\nimport { _t } from './languageHandler';\nimport Modal from './Modal';\nimport SettingsStore from \"./settings/SettingsStore\";\nimport { hideToast as hideNotificationsToast } from \"./toasts/DesktopNotificationsToast\";\nimport { SettingLevel } from \"./settings/SettingLevel\";\nimport { isPushNotifyDisabled } from \"./settings/controllers/NotificationControllers\";\nimport { RoomViewStore } from \"./stores/RoomViewStore\";\nimport UserActivity from \"./UserActivity\";\nimport { mediaFromMxc } from \"./customisations/Media\";\nimport ErrorDialog from \"./components/views/dialogs/ErrorDialog\";\nimport CallHandler from \"./CallHandler\";\nimport VoipUserMapper from \"./VoipUserMapper\";\n\n/*\n * Dispatches:\n * {\n *   action: \"notifier_enabled\",\n *   value: boolean\n * }\n */\n\nconst MAX_PENDING_ENCRYPTED = 20;\n\n/*\nOverride both the content body and the TextForEvent handler for specific msgtypes, in notifications.\nThis is useful when the content body contains fallback text that would explain that the client can't handle a particular\ntype of tile.\n*/\nconst msgTypeHandlers = {\n    [MsgType.KeyVerificationRequest]: (event: MatrixEvent) => {\n        const name = (event.sender || {}).name;\n        return _t(\"%(name)s is requesting verification\", { name });\n    },\n    [M_LOCATION.name]: (event: MatrixEvent) => {\n        return TextForEvent.textForLocationEvent(event)();\n    },\n    [M_LOCATION.altName]: (event: MatrixEvent) => {\n        return TextForEvent.textForLocationEvent(event)();\n    },\n};\n\nexport const Notifier = {\n    notifsByRoom: {},\n\n    // A list of event IDs that we've received but need to wait until\n    // they're decrypted until we decide whether to notify for them\n    // or not\n    pendingEncryptedEventIds: [],\n\n    notificationMessageForEvent: function(ev: MatrixEvent): string {\n        if (msgTypeHandlers.hasOwnProperty(ev.getContent().msgtype)) {\n            return msgTypeHandlers[ev.getContent().msgtype](ev);\n        }\n        return TextForEvent.textForEvent(ev);\n    },\n\n    _displayPopupNotification: function(ev: MatrixEvent, room: Room) {\n        const plaf = PlatformPeg.get();\n        if (!plaf) {\n            return;\n        }\n        if (!plaf.supportsNotifications() || !plaf.maySendNotifications()) {\n            return;\n        }\n\n        let msg = this.notificationMessageForEvent(ev);\n        if (!msg) return;\n\n        let title;\n        if (!ev.sender || room.name === ev.sender.name) {\n            title = room.name;\n            // notificationMessageForEvent includes sender,\n            // but we already have the sender here\n            if (ev.getContent().body && !msgTypeHandlers.hasOwnProperty(ev.getContent().msgtype)) {\n                msg = ev.getContent().body;\n            }\n        } else if (ev.getType() === 'm.room.member') {\n            // context is all in the message here, we don't need\n            // to display sender info\n            title = room.name;\n        } else if (ev.sender) {\n            title = ev.sender.name + \" (\" + room.name + \")\";\n            // notificationMessageForEvent includes sender,\n            // but we've just out sender in the title\n            if (ev.getContent().body && !msgTypeHandlers.hasOwnProperty(ev.getContent().msgtype)) {\n                msg = ev.getContent().body;\n            }\n        }\n\n        if (!this.isBodyEnabled()) {\n            msg = '';\n        }\n\n        let avatarUrl = null;\n        if (ev.sender && !SettingsStore.getValue(\"lowBandwidth\")) {\n            avatarUrl = Avatar.avatarUrlForMember(ev.sender, 40, 40, 'crop');\n        }\n\n        const notif = plaf.displayNotification(title, msg, avatarUrl, room, ev);\n\n        // if displayNotification returns non-null,  the platform supports\n        // clearing notifications later, so keep track of this.\n        if (notif) {\n            if (this.notifsByRoom[ev.getRoomId()] === undefined) this.notifsByRoom[ev.getRoomId()] = [];\n            this.notifsByRoom[ev.getRoomId()].push(notif);\n        }\n    },\n\n    getSoundForRoom: function(roomId: string) {\n        // We do no caching here because the SDK caches setting\n        // and the browser will cache the sound.\n        const content = SettingsStore.getValue(\"notificationSound\", roomId);\n        if (!content) {\n            return null;\n        }\n\n        if (!content.url) {\n            logger.warn(`${roomId} has custom notification sound event, but no url key`);\n            return null;\n        }\n\n        if (!content.url.startsWith(\"mxc://\")) {\n            logger.warn(`${roomId} has custom notification sound event, but url is not a mxc url`);\n            return null;\n        }\n\n        // Ideally in here we could use MSC1310 to detect the type of file, and reject it.\n\n        return {\n            url: mediaFromMxc(content.url).srcHttp,\n            name: content.name,\n            type: content.type,\n            size: content.size,\n        };\n    },\n\n    _playAudioNotification: async function(ev: MatrixEvent, room: Room) {\n        const sound = this.getSoundForRoom(room.roomId);\n        logger.log(`Got sound ${sound && sound.name || \"default\"} for ${room.roomId}`);\n\n        try {\n            const selector =\n                document.querySelector<HTMLAudioElement>(sound ? `audio[src='${sound.url}']` : \"#messageAudio\");\n            let audioElement = selector;\n            if (!selector) {\n                if (!sound) {\n                    logger.error(\"No audio element or sound to play for notification\");\n                    return;\n                }\n                audioElement = new Audio(sound.url);\n                if (sound.type) {\n                    audioElement.type = sound.type;\n                }\n                document.body.appendChild(audioElement);\n            }\n            await audioElement.play();\n        } catch (ex) {\n            logger.warn(\"Caught error when trying to fetch room notification sound:\", ex);\n        }\n    },\n\n    start: function() {\n        // do not re-bind in the case of repeated call\n        this.boundOnEvent = this.boundOnEvent || this.onEvent.bind(this);\n        this.boundOnSyncStateChange = this.boundOnSyncStateChange || this.onSyncStateChange.bind(this);\n        this.boundOnRoomReceipt = this.boundOnRoomReceipt || this.onRoomReceipt.bind(this);\n        this.boundOnEventDecrypted = this.boundOnEventDecrypted || this.onEventDecrypted.bind(this);\n\n        MatrixClientPeg.get().on(ClientEvent.Event, this.boundOnEvent);\n        MatrixClientPeg.get().on(RoomEvent.Receipt, this.boundOnRoomReceipt);\n        MatrixClientPeg.get().on(MatrixEventEvent.Decrypted, this.boundOnEventDecrypted);\n        MatrixClientPeg.get().on(ClientEvent.Sync, this.boundOnSyncStateChange);\n        this.toolbarHidden = false;\n        this.isSyncing = false;\n    },\n\n    stop: function() {\n        if (MatrixClientPeg.get()) {\n            MatrixClientPeg.get().removeListener(ClientEvent.Event, this.boundOnEvent);\n            MatrixClientPeg.get().removeListener(RoomEvent.Receipt, this.boundOnRoomReceipt);\n            MatrixClientPeg.get().removeListener(MatrixEventEvent.Decrypted, this.boundOnEventDecrypted);\n            MatrixClientPeg.get().removeListener(ClientEvent.Sync, this.boundOnSyncStateChange);\n        }\n        this.isSyncing = false;\n    },\n\n    supportsDesktopNotifications: function() {\n        const plaf = PlatformPeg.get();\n        return plaf && plaf.supportsNotifications();\n    },\n\n    setEnabled: function(enable: boolean, callback?: () => void) {\n        const plaf = PlatformPeg.get();\n        if (!plaf) return;\n\n        // Dev note: We don't set the \"notificationsEnabled\" setting to true here because it is a\n        // calculated value. It is determined based upon whether or not the master rule is enabled\n        // and other flags. Setting it here would cause a circular reference.\n\n        // make sure that we persist the current setting audio_enabled setting\n        // before changing anything\n        if (SettingsStore.isLevelSupported(SettingLevel.DEVICE)) {\n            SettingsStore.setValue(\"audioNotificationsEnabled\", null, SettingLevel.DEVICE, this.isEnabled());\n        }\n\n        if (enable) {\n            // Attempt to get permission from user\n            plaf.requestNotificationPermission().then((result) => {\n                if (result !== 'granted') {\n                    // The permission request was dismissed or denied\n                    // TODO: Support alternative branding in messaging\n                    const brand = SdkConfig.get().brand;\n                    const description = result === 'denied'\n                        ? _t('%(brand)s does not have permission to send you notifications - ' +\n                            'please check your browser settings', { brand })\n                        : _t('%(brand)s was not given permission to send notifications - please try again', { brand });\n                    Modal.createDialog(ErrorDialog, {\n                        title: _t('Unable to enable Notifications'),\n                        description,\n                    });\n                    return;\n                }\n\n                if (callback) callback();\n\n                PosthogAnalytics.instance.trackEvent<PermissionChangedEvent>({\n                    eventName: \"PermissionChanged\",\n                    permission: \"Notification\",\n                    granted: true,\n                });\n                dis.dispatch({\n                    action: \"notifier_enabled\",\n                    value: true,\n                });\n            });\n        } else {\n            PosthogAnalytics.instance.trackEvent<PermissionChangedEvent>({\n                eventName: \"PermissionChanged\",\n                permission: \"Notification\",\n                granted: false,\n            });\n            dis.dispatch({\n                action: \"notifier_enabled\",\n                value: false,\n            });\n        }\n        // set the notifications_hidden flag, as the user has knowingly interacted\n        // with the setting we shouldn't nag them any further\n        this.setPromptHidden(true);\n    },\n\n    isEnabled: function() {\n        return this.isPossible() && SettingsStore.getValue(\"notificationsEnabled\");\n    },\n\n    isPossible: function() {\n        const plaf = PlatformPeg.get();\n        if (!plaf) return false;\n        if (!plaf.supportsNotifications()) return false;\n        if (!plaf.maySendNotifications()) return false;\n\n        return true; // possible, but not necessarily enabled\n    },\n\n    isBodyEnabled: function() {\n        return this.isEnabled() && SettingsStore.getValue(\"notificationBodyEnabled\");\n    },\n\n    isAudioEnabled: function() {\n        // We don't route Audio via the HTML Notifications API so it is possible regardless of other things\n        return SettingsStore.getValue(\"audioNotificationsEnabled\");\n    },\n\n    setPromptHidden: function(hidden: boolean, persistent = true) {\n        this.toolbarHidden = hidden;\n\n        hideNotificationsToast();\n\n        // update the info to localStorage for persistent settings\n        if (persistent && global.localStorage) {\n            global.localStorage.setItem(\"notifications_hidden\", String(hidden));\n        }\n    },\n\n    shouldShowPrompt: function() {\n        const client = MatrixClientPeg.get();\n        if (!client) {\n            return false;\n        }\n        const isGuest = client.isGuest();\n        return !isGuest && this.supportsDesktopNotifications() && !isPushNotifyDisabled() &&\n            !this.isEnabled() && !this._isPromptHidden();\n    },\n\n    _isPromptHidden: function() {\n        // Check localStorage for any such meta data\n        if (global.localStorage) {\n            return global.localStorage.getItem(\"notifications_hidden\") === \"true\";\n        }\n\n        return this.toolbarHidden;\n    },\n\n    onSyncStateChange: function(state: string) {\n        if (state === \"SYNCING\") {\n            this.isSyncing = true;\n        } else if (state === \"STOPPED\" || state === \"ERROR\") {\n            this.isSyncing = false;\n        }\n    },\n\n    onEvent: function(ev: MatrixEvent) {\n        if (!this.isSyncing) return; // don't alert for any messages initially\n        if (ev.getSender() === MatrixClientPeg.get().credentials.userId) return;\n\n        MatrixClientPeg.get().decryptEventIfNeeded(ev);\n\n        // If it's an encrypted event and the type is still 'm.room.encrypted',\n        // it hasn't yet been decrypted, so wait until it is.\n        if (ev.isBeingDecrypted() || ev.isDecryptionFailure()) {\n            this.pendingEncryptedEventIds.push(ev.getId());\n            // don't let the list fill up indefinitely\n            while (this.pendingEncryptedEventIds.length > MAX_PENDING_ENCRYPTED) {\n                this.pendingEncryptedEventIds.shift();\n            }\n            return;\n        }\n\n        this._evaluateEvent(ev);\n    },\n\n    onEventDecrypted: function(ev: MatrixEvent) {\n        // 'decrypted' means the decryption process has finished: it may have failed,\n        // in which case it might decrypt soon if the keys arrive\n        if (ev.isDecryptionFailure()) return;\n\n        const idx = this.pendingEncryptedEventIds.indexOf(ev.getId());\n        if (idx === -1) return;\n\n        this.pendingEncryptedEventIds.splice(idx, 1);\n        this._evaluateEvent(ev);\n    },\n\n    onRoomReceipt: function(ev: MatrixEvent, room: Room) {\n        if (room.getUnreadNotificationCount() === 0) {\n            // ideally we would clear each notification when it was read,\n            // but we have no way, given a read receipt, to know whether\n            // the receipt comes before or after an event, so we can't\n            // do this. Instead, clear all notifications for a room once\n            // there are no notifs left in that room., which is not quite\n            // as good but it's something.\n            const plaf = PlatformPeg.get();\n            if (!plaf) return;\n            if (this.notifsByRoom[room.roomId] === undefined) return;\n            for (const notif of this.notifsByRoom[room.roomId]) {\n                plaf.clearNotification(notif);\n            }\n            delete this.notifsByRoom[room.roomId];\n        }\n    },\n\n    _evaluateEvent: function(ev: MatrixEvent) {\n        let roomId = ev.getRoomId();\n        if (CallHandler.instance.getSupportsVirtualRooms()) {\n            // Attempt to translate a virtual room to a native one\n            const nativeRoomId = VoipUserMapper.sharedInstance().nativeRoomForVirtualRoom(roomId);\n            if (nativeRoomId) {\n                roomId = nativeRoomId;\n            }\n        }\n        const room = MatrixClientPeg.get().getRoom(roomId);\n\n        const actions = MatrixClientPeg.get().getPushActionsForEvent(ev);\n        if (actions?.notify) {\n            if (RoomViewStore.instance.getRoomId() === room.roomId &&\n                UserActivity.sharedInstance().userActiveRecently() &&\n                !Modal.hasDialogs()\n            ) {\n                // don't bother notifying as user was recently active in this room\n                return;\n            }\n\n            if (this.isEnabled()) {\n                this._displayPopupNotification(ev, room);\n            }\n            if (actions.tweaks.sound && this.isAudioEnabled()) {\n                PlatformPeg.get().loudNotification(ev, room);\n                this._playAudioNotification(ev, room);\n            }\n        }\n    },\n};\n\nif (!window.mxNotifier) {\n    window.mxNotifier = Notifier;\n}\n\nexport default window.mxNotifier;\n"],"mappings":"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"}