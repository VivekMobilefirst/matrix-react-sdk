{"version":3,"file":"ContentMessages.js","names":["PHYS_HIDPI","UploadCanceledError","Error","loadImageElement","imageFile","img","document","createElement","objectUrl","URL","createObjectURL","imgPromise","Promise","resolve","reject","onload","revokeObjectURL","onerror","e","src","parsePromise","type","headers","readFileAsArrayBuffer","then","arrayBuffer","buffer","Uint8Array","chunks","extractPngChunks","chunk","name","data","byteLength","length","every","val","i","hidpi","all","width","height","IMAGE_SIZE_THRESHOLD_THUMBNAIL","IMAGE_THUMBNAIL_MIN_REDUCTION_SIZE","IMAGE_THUMBNAIL_MIN_REDUCTION_PERCENT","ALWAYS_INCLUDE_THUMBNAIL","infoForImageFile","matrixClient","roomId","thumbnailType","imageElement","result","createThumbnail","imageInfo","info","includes","sizeDifference","size","thumbnail_info","uploadResult","uploadFile","thumbnail","url","file","loadVideoElement","videoFile","video","preload","playsInline","muted","reader","FileReader","ev","onloadeddata","pause","dataUrl","target","startsWith","replace","load","play","readAsDataURL","infoForVideoFile","videoInfo","videoWidth","videoHeight","thumbnail_url","thumbnail_file","readAsArrayBuffer","progressHandler","canceled","isRoomEncrypted","uploadPromise","prom","encrypt","encryptAttachment","encryptResult","blob","Blob","uploadContent","includeFilename","abort","cancelUpload","basePromise","promise1","ContentMessages","sendStickerContentToRoom","threadId","text","doMaybeLocalRoomAction","actualRoomId","sendStickerMessage","catch","logger","warn","getUploadLimit","mediaConfig","undefined","sendContentListToRoom","files","relation","context","TimelineRenderingType","Room","isGuest","dis","dispatch","action","replyToEvent","RoomViewStore","instance","getQuotingEvent","modal","Modal","createDialog","Spinner","ensureMediaConfigFetched","close","tooBigFiles","okFiles","isFileSizeAcceptable","push","finished","UploadFailureDialog","badFiles","totalFiles","contentMessages","shouldContinue","uploadAll","promBefore","loopPromiseBefore","UploadConfirmDialog","currentIndex","shouldUploadAll","sendContentToRoom","event","Action","FocusSendMessageComposer","getCurrentUploads","inprogress","filter","upload","noRelation","matchingRelation","rel_type","event_id","promise","find","item","UploadCanceled","content","body","msgtype","MsgType","File","attachRelation","addReplyToMessageContent","includeLegacyFallback","SettingsStore","getValue","decorateStartSendingTime","mimetype","indexOf","Image","Object","assign","error","Audio","Video","fileName","total","loaded","UploadStarted","onProgress","UploadProgress","THREAD_RELATION_TYPE","sendMessage","resp","sendRoundTripMetric","err","desc","_t","httpStatus","ErrorDialog","title","description","finally","splice","UploadFailed","UploadFinished","log","getMediaConfig","config","sharedInstance","window","mxContentMessages"],"sources":["../src/ContentMessages.ts"],"sourcesContent":["/*\nCopyright 2015, 2016 OpenMarket Ltd\nCopyright 2019 New Vector Ltd\nCopyright 2020 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { MatrixClient } from \"matrix-js-sdk/src/client\";\nimport { IUploadOpts } from \"matrix-js-sdk/src/@types/requests\";\nimport { MsgType } from \"matrix-js-sdk/src/@types/event\";\nimport encrypt from \"matrix-encrypt-attachment\";\nimport extractPngChunks from \"png-chunks-extract\";\nimport { IAbortablePromise, IImageInfo } from \"matrix-js-sdk/src/@types/partials\";\nimport { logger } from \"matrix-js-sdk/src/logger\";\nimport { IEventRelation, ISendEventResponse, MatrixError, MatrixEvent } from \"matrix-js-sdk/src/matrix\";\nimport { THREAD_RELATION_TYPE } from \"matrix-js-sdk/src/models/thread\";\n\nimport { IEncryptedFile, IMediaEventInfo } from \"./customisations/models/IMediaEventContent\";\nimport dis from './dispatcher/dispatcher';\nimport { _t } from './languageHandler';\nimport Modal from './Modal';\nimport Spinner from \"./components/views/elements/Spinner\";\nimport { Action } from \"./dispatcher/actions\";\nimport {\n    UploadCanceledPayload,\n    UploadErrorPayload,\n    UploadFinishedPayload,\n    UploadProgressPayload,\n    UploadStartedPayload,\n} from \"./dispatcher/payloads/UploadPayload\";\nimport { IUpload } from \"./models/IUpload\";\nimport SettingsStore from \"./settings/SettingsStore\";\nimport { decorateStartSendingTime, sendRoundTripMetric } from \"./sendTimePerformanceMetrics\";\nimport { TimelineRenderingType } from \"./contexts/RoomContext\";\nimport { RoomViewStore } from \"./stores/RoomViewStore\";\nimport { addReplyToMessageContent } from \"./utils/Reply\";\nimport ErrorDialog from \"./components/views/dialogs/ErrorDialog\";\nimport UploadFailureDialog from \"./components/views/dialogs/UploadFailureDialog\";\nimport UploadConfirmDialog from \"./components/views/dialogs/UploadConfirmDialog\";\nimport { createThumbnail } from \"./utils/image-media\";\nimport { attachRelation } from \"./components/views/rooms/SendMessageComposer\";\nimport { doMaybeLocalRoomAction } from \"./utils/local-room\";\n\n// scraped out of a macOS hidpi (5660ppm) screenshot png\n//                  5669 px (x-axis)      , 5669 px (y-axis)      , per metre\nconst PHYS_HIDPI = [0x00, 0x00, 0x16, 0x25, 0x00, 0x00, 0x16, 0x25, 0x01];\n\nexport class UploadCanceledError extends Error {}\n\ninterface IMediaConfig {\n    \"m.upload.size\"?: number;\n}\n\ninterface IContent {\n    body: string;\n    msgtype: string;\n    info: IMediaEventInfo;\n    file?: string;\n    url?: string;\n}\n\n/**\n * Load a file into a newly created image element.\n *\n * @param {File} imageFile The file to load in an image element.\n * @return {Promise} A promise that resolves with the html image element.\n */\nasync function loadImageElement(imageFile: File) {\n    // Load the file into an html element\n    const img = document.createElement(\"img\");\n    const objectUrl = URL.createObjectURL(imageFile);\n    const imgPromise = new Promise((resolve, reject) => {\n        img.onload = function() {\n            URL.revokeObjectURL(objectUrl);\n            resolve(img);\n        };\n        img.onerror = function(e) {\n            reject(e);\n        };\n    });\n    img.src = objectUrl;\n\n    // check for hi-dpi PNGs and fudge display resolution as needed.\n    // this is mainly needed for macOS screencaps\n    let parsePromise;\n    if (imageFile.type === \"image/png\") {\n        // in practice macOS happens to order the chunks so they fall in\n        // the first 0x1000 bytes (thanks to a massive ICC header).\n        // Thus we could slice the file down to only sniff the first 0x1000\n        // bytes (but this makes extractPngChunks choke on the corrupt file)\n        const headers = imageFile; //.slice(0, 0x1000);\n        parsePromise = readFileAsArrayBuffer(headers).then(arrayBuffer => {\n            const buffer = new Uint8Array(arrayBuffer);\n            const chunks = extractPngChunks(buffer);\n            for (const chunk of chunks) {\n                if (chunk.name === 'pHYs') {\n                    if (chunk.data.byteLength !== PHYS_HIDPI.length) return;\n                    return chunk.data.every((val, i) => val === PHYS_HIDPI[i]);\n                }\n            }\n            return false;\n        });\n    }\n\n    const [hidpi] = await Promise.all([parsePromise, imgPromise]);\n    const width = hidpi ? (img.width >> 1) : img.width;\n    const height = hidpi ? (img.height >> 1) : img.height;\n    return { width, height, img };\n}\n\n// Minimum size for image files before we generate a thumbnail for them.\nconst IMAGE_SIZE_THRESHOLD_THUMBNAIL = 1 << 15; // 32KB\n// Minimum size improvement for image thumbnails, if both are not met then don't bother uploading thumbnail.\nconst IMAGE_THUMBNAIL_MIN_REDUCTION_SIZE = 1 << 16; // 1MB\nconst IMAGE_THUMBNAIL_MIN_REDUCTION_PERCENT = 0.1; // 10%\n// We don't apply these thresholds to video thumbnails as a poster image is always useful\n// and videos tend to be much larger.\n\n// Image mime types for which to always include a thumbnail for even if it is larger than the input for wider support.\nconst ALWAYS_INCLUDE_THUMBNAIL = [\"image/avif\", \"image/webp\"];\n\n/**\n * Read the metadata for an image file and create and upload a thumbnail of the image.\n *\n * @param {MatrixClient} matrixClient A matrixClient to upload the thumbnail with.\n * @param {String} roomId The ID of the room the image will be uploaded in.\n * @param {File} imageFile The image to read and thumbnail.\n * @return {Promise} A promise that resolves with the attachment info.\n */\nasync function infoForImageFile(\n    matrixClient: MatrixClient,\n    roomId: string,\n    imageFile: File,\n): Promise<Partial<IMediaEventInfo>> {\n    let thumbnailType = \"image/png\";\n    if (imageFile.type === \"image/jpeg\") {\n        thumbnailType = \"image/jpeg\";\n    }\n\n    const imageElement = await loadImageElement(imageFile);\n\n    const result = await createThumbnail(imageElement.img, imageElement.width, imageElement.height, thumbnailType);\n    const imageInfo = result.info;\n\n    // For lesser supported image types, always include the thumbnail even if it is larger\n    if (!ALWAYS_INCLUDE_THUMBNAIL.includes(imageFile.type)) {\n        // we do all sizing checks here because we still rely on thumbnail generation for making a blurhash from.\n        const sizeDifference = imageFile.size - imageInfo.thumbnail_info.size;\n        if (\n            // image is small enough already\n            imageFile.size <= IMAGE_SIZE_THRESHOLD_THUMBNAIL ||\n            // thumbnail is not sufficiently smaller than original\n            (sizeDifference <= IMAGE_THUMBNAIL_MIN_REDUCTION_SIZE &&\n                sizeDifference <= (imageFile.size * IMAGE_THUMBNAIL_MIN_REDUCTION_PERCENT))\n        ) {\n            delete imageInfo[\"thumbnail_info\"];\n            return imageInfo;\n        }\n    }\n\n    const uploadResult = await uploadFile(matrixClient, roomId, result.thumbnail);\n\n    imageInfo[\"thumbnail_url\"] = uploadResult.url;\n    imageInfo[\"thumbnail_file\"] = uploadResult.file;\n    return imageInfo;\n}\n\n/**\n * Load a file into a newly created video element and pull some strings\n * in an attempt to guarantee the first frame will be showing.\n *\n * @param {File} videoFile The file to load in an video element.\n * @return {Promise} A promise that resolves with the video image element.\n */\nfunction loadVideoElement(videoFile: File): Promise<HTMLVideoElement> {\n    return new Promise((resolve, reject) => {\n        // Load the file into an html element\n        const video = document.createElement(\"video\");\n        video.preload = \"metadata\";\n        video.playsInline = true;\n        video.muted = true;\n\n        const reader = new FileReader();\n\n        reader.onload = function(ev) {\n            // Wait until we have enough data to thumbnail the first frame.\n            video.onloadeddata = async function() {\n                resolve(video);\n                video.pause();\n            };\n            video.onerror = function(e) {\n                reject(e);\n            };\n\n            let dataUrl = ev.target.result as string;\n            // Chrome chokes on quicktime but likes mp4, and `file.type` is\n            // read only, so do this horrible hack to unbreak quicktime\n            if (dataUrl.startsWith(\"data:video/quicktime;\")) {\n                dataUrl = dataUrl.replace(\"data:video/quicktime;\", \"data:video/mp4;\");\n            }\n\n            video.src = dataUrl;\n            video.load();\n            video.play();\n        };\n        reader.onerror = function(e) {\n            reject(e);\n        };\n        reader.readAsDataURL(videoFile);\n    });\n}\n\n/**\n * Read the metadata for a video file and create and upload a thumbnail of the video.\n *\n * @param {MatrixClient} matrixClient A matrixClient to upload the thumbnail with.\n * @param {String} roomId The ID of the room the video will be uploaded to.\n * @param {File} videoFile The video to read and thumbnail.\n * @return {Promise} A promise that resolves with the attachment info.\n */\nfunction infoForVideoFile(\n    matrixClient: MatrixClient,\n    roomId: string,\n    videoFile: File,\n): Promise<Partial<IMediaEventInfo>> {\n    const thumbnailType = \"image/jpeg\";\n\n    let videoInfo: Partial<IMediaEventInfo>;\n    return loadVideoElement(videoFile).then((video) => {\n        return createThumbnail(video, video.videoWidth, video.videoHeight, thumbnailType);\n    }).then((result) => {\n        videoInfo = result.info;\n        return uploadFile(matrixClient, roomId, result.thumbnail);\n    }).then((result) => {\n        videoInfo.thumbnail_url = result.url;\n        videoInfo.thumbnail_file = result.file;\n        return videoInfo;\n    });\n}\n\n/**\n * Read the file as an ArrayBuffer.\n * @param {File} file The file to read\n * @return {Promise} A promise that resolves with an ArrayBuffer when the file\n *   is read.\n */\nfunction readFileAsArrayBuffer(file: File | Blob): Promise<ArrayBuffer> {\n    return new Promise((resolve, reject) => {\n        const reader = new FileReader();\n        reader.onload = function(e) {\n            resolve(e.target.result as ArrayBuffer);\n        };\n        reader.onerror = function(e) {\n            reject(e);\n        };\n        reader.readAsArrayBuffer(file);\n    });\n}\n\n/**\n * Upload the file to the content repository.\n * If the room is encrypted then encrypt the file before uploading.\n *\n * @param {MatrixClient} matrixClient The matrix client to upload the file with.\n * @param {String} roomId The ID of the room being uploaded to.\n * @param {File} file The file to upload.\n * @param {Function?} progressHandler optional callback to be called when a chunk of\n *    data is uploaded.\n * @return {Promise} A promise that resolves with an object.\n *  If the file is unencrypted then the object will have a \"url\" key.\n *  If the file is encrypted then the object will have a \"file\" key.\n */\nexport function uploadFile(\n    matrixClient: MatrixClient,\n    roomId: string,\n    file: File | Blob,\n    progressHandler?: IUploadOpts[\"progressHandler\"],\n): IAbortablePromise<{ url?: string, file?: IEncryptedFile }> {\n    let canceled = false;\n    if (matrixClient.isRoomEncrypted(roomId)) {\n        // If the room is encrypted then encrypt the file before uploading it.\n        // First read the file into memory.\n        let uploadPromise: IAbortablePromise<string>;\n        const prom = readFileAsArrayBuffer(file).then(function(data) {\n            if (canceled) throw new UploadCanceledError();\n            // Then encrypt the file.\n            return encrypt.encryptAttachment(data);\n        }).then(function(encryptResult) {\n            if (canceled) throw new UploadCanceledError();\n\n            // Pass the encrypted data as a Blob to the uploader.\n            const blob = new Blob([encryptResult.data]);\n            uploadPromise = matrixClient.uploadContent(blob, {\n                progressHandler,\n                includeFilename: false,\n            });\n\n            return uploadPromise.then(url => {\n                if (canceled) throw new UploadCanceledError();\n\n                // If the attachment is encrypted then bundle the URL along\n                // with the information needed to decrypt the attachment and\n                // add it under a file key.\n                return {\n                    file: {\n                        ...encryptResult.info,\n                        url,\n                    },\n                };\n            });\n        }) as IAbortablePromise<{ file: IEncryptedFile }>;\n        prom.abort = () => {\n            canceled = true;\n            if (uploadPromise) matrixClient.cancelUpload(uploadPromise);\n        };\n        return prom;\n    } else {\n        const basePromise = matrixClient.uploadContent(file, { progressHandler });\n        const promise1 = basePromise.then(function(url) {\n            if (canceled) throw new UploadCanceledError();\n            // If the attachment isn't encrypted then include the URL directly.\n            return { url };\n        }) as IAbortablePromise<{ url: string }>;\n        promise1.abort = () => {\n            canceled = true;\n            matrixClient.cancelUpload(basePromise);\n        };\n        return promise1;\n    }\n}\n\nexport default class ContentMessages {\n    private inprogress: IUpload[] = [];\n    private mediaConfig: IMediaConfig = null;\n\n    public sendStickerContentToRoom(\n        url: string,\n        roomId: string,\n        threadId: string | null,\n        info: IImageInfo,\n        text: string,\n        matrixClient: MatrixClient,\n    ): Promise<ISendEventResponse> {\n        return doMaybeLocalRoomAction(\n            roomId,\n            (actualRoomId: string) => matrixClient.sendStickerMessage(actualRoomId, threadId, url, info, text),\n            matrixClient,\n        ).catch((e) => {\n            logger.warn(`Failed to send content with URL ${url} to room ${roomId}`, e);\n            throw e;\n        });\n    }\n\n    public getUploadLimit(): number | null {\n        if (this.mediaConfig !== null && this.mediaConfig[\"m.upload.size\"] !== undefined) {\n            return this.mediaConfig[\"m.upload.size\"];\n        } else {\n            return null;\n        }\n    }\n\n    public async sendContentListToRoom(\n        files: File[],\n        roomId: string,\n        relation: IEventRelation | undefined,\n        matrixClient: MatrixClient,\n        context = TimelineRenderingType.Room,\n    ): Promise<void> {\n        if (matrixClient.isGuest()) {\n            dis.dispatch({ action: 'require_registration' });\n            return;\n        }\n\n        const replyToEvent = RoomViewStore.instance.getQuotingEvent();\n        if (!this.mediaConfig) { // hot-path optimization to not flash a spinner if we don't need to\n            const modal = Modal.createDialog(Spinner, null, 'mx_Dialog_spinner');\n            await this.ensureMediaConfigFetched(matrixClient);\n            modal.close();\n        }\n\n        const tooBigFiles = [];\n        const okFiles = [];\n\n        for (const file of files) {\n            if (this.isFileSizeAcceptable(file)) {\n                okFiles.push(file);\n            } else {\n                tooBigFiles.push(file);\n            }\n        }\n\n        if (tooBigFiles.length > 0) {\n            const { finished } = Modal.createDialog<[boolean]>(UploadFailureDialog, {\n                badFiles: tooBigFiles,\n                totalFiles: files.length,\n                contentMessages: this,\n            });\n            const [shouldContinue] = await finished;\n            if (!shouldContinue) return;\n        }\n\n        let uploadAll = false;\n        // Promise to complete before sending next file into room, used for synchronisation of file-sending\n        // to match the order the files were specified in\n        let promBefore: Promise<any> = Promise.resolve();\n        for (let i = 0; i < okFiles.length; ++i) {\n            const file = okFiles[i];\n            const loopPromiseBefore = promBefore;\n\n            if (!uploadAll) {\n                const { finished } = Modal.createDialog<[boolean, boolean]>(UploadConfirmDialog, {\n                    file,\n                    currentIndex: i,\n                    totalFiles: okFiles.length,\n                });\n                const [shouldContinue, shouldUploadAll] = await finished;\n                if (!shouldContinue) break;\n                if (shouldUploadAll) {\n                    uploadAll = true;\n                }\n            }\n\n            promBefore = doMaybeLocalRoomAction(\n                roomId,\n                (actualRoomId) => this.sendContentToRoom(\n                    file,\n                    actualRoomId,\n                    relation,\n                    matrixClient,\n                    replyToEvent,\n                    loopPromiseBefore,\n                ),\n            );\n        }\n\n        if (replyToEvent) {\n            // Clear event being replied to\n            dis.dispatch({\n                action: \"reply_to_event\",\n                event: null,\n                context,\n            });\n        }\n\n        // Focus the correct composer\n        dis.dispatch({\n            action: Action.FocusSendMessageComposer,\n            context,\n        });\n    }\n\n    public getCurrentUploads(relation?: IEventRelation): IUpload[] {\n        return this.inprogress.filter(upload => {\n            const noRelation = !relation && !upload.relation;\n            const matchingRelation = relation && upload.relation\n                && relation.rel_type === upload.relation.rel_type\n                && relation.event_id === upload.relation.event_id;\n\n            return (noRelation || matchingRelation) && !upload.canceled;\n        });\n    }\n\n    public cancelUpload(promise: IAbortablePromise<any>, matrixClient: MatrixClient): void {\n        const upload = this.inprogress.find(item => item.promise === promise);\n        if (upload) {\n            upload.canceled = true;\n            matrixClient.cancelUpload(upload.promise);\n            dis.dispatch<UploadCanceledPayload>({ action: Action.UploadCanceled, upload });\n        }\n    }\n\n    private sendContentToRoom(\n        file: File,\n        roomId: string,\n        relation: IEventRelation | undefined,\n        matrixClient: MatrixClient,\n        replyToEvent: MatrixEvent | undefined,\n        promBefore: Promise<any>,\n    ) {\n        const content: Omit<IContent, \"info\"> & { info: Partial<IMediaEventInfo> } = {\n            body: file.name || 'Attachment',\n            info: {\n                size: file.size,\n            },\n            msgtype: MsgType.File, // set more specifically later\n        };\n\n        attachRelation(content, relation);\n        if (replyToEvent) {\n            addReplyToMessageContent(content, replyToEvent, {\n                includeLegacyFallback: false,\n            });\n        }\n\n        if (SettingsStore.getValue(\"Performance.addSendMessageTimingMetadata\")) {\n            decorateStartSendingTime(content);\n        }\n\n        // if we have a mime type for the file, add it to the message metadata\n        if (file.type) {\n            content.info.mimetype = file.type;\n        }\n\n        const prom = new Promise<void>((resolve) => {\n            if (file.type.indexOf('image/') === 0) {\n                content.msgtype = MsgType.Image;\n                infoForImageFile(matrixClient, roomId, file).then((imageInfo) => {\n                    Object.assign(content.info, imageInfo);\n                    resolve();\n                }, (e) => {\n                    // Failed to thumbnail, fall back to uploading an m.file\n                    logger.error(e);\n                    content.msgtype = MsgType.File;\n                    resolve();\n                });\n            } else if (file.type.indexOf('audio/') === 0) {\n                content.msgtype = MsgType.Audio;\n                resolve();\n            } else if (file.type.indexOf('video/') === 0) {\n                content.msgtype = MsgType.Video;\n                infoForVideoFile(matrixClient, roomId, file).then((videoInfo) => {\n                    Object.assign(content.info, videoInfo);\n                    resolve();\n                }, (e) => {\n                    // Failed to thumbnail, fall back to uploading an m.file\n                    logger.error(e);\n                    content.msgtype = MsgType.File;\n                    resolve();\n                });\n            } else {\n                content.msgtype = MsgType.File;\n                resolve();\n            }\n        }) as IAbortablePromise<void>;\n\n        // create temporary abort handler for before the actual upload gets passed off to js-sdk\n        prom.abort = () => {\n            upload.canceled = true;\n        };\n\n        const upload: IUpload = {\n            fileName: file.name || 'Attachment',\n            roomId,\n            relation,\n            total: file.size,\n            loaded: 0,\n            promise: prom,\n        };\n        this.inprogress.push(upload);\n        dis.dispatch<UploadStartedPayload>({ action: Action.UploadStarted, upload });\n\n        function onProgress(ev) {\n            upload.total = ev.total;\n            upload.loaded = ev.loaded;\n            dis.dispatch<UploadProgressPayload>({ action: Action.UploadProgress, upload });\n        }\n\n        let error: MatrixError;\n        return prom.then(() => {\n            if (upload.canceled) throw new UploadCanceledError();\n            // XXX: upload.promise must be the promise that\n            // is returned by uploadFile as it has an abort()\n            // method hacked onto it.\n            upload.promise = uploadFile(matrixClient, roomId, file, onProgress);\n            return upload.promise.then(function(result) {\n                content.file = result.file;\n                content.url = result.url;\n            });\n        }).then(() => {\n            // Await previous message being sent into the room\n            return promBefore;\n        }).then(function() {\n            if (upload.canceled) throw new UploadCanceledError();\n            const threadId = relation?.rel_type === THREAD_RELATION_TYPE.name\n                ? relation.event_id\n                : null;\n            const prom = matrixClient.sendMessage(roomId, threadId, content);\n            if (SettingsStore.getValue(\"Performance.addSendMessageTimingMetadata\")) {\n                prom.then(resp => {\n                    sendRoundTripMetric(matrixClient, roomId, resp.event_id);\n                });\n            }\n            return prom;\n        }, function(err: MatrixError) {\n            error = err;\n            if (!upload.canceled) {\n                let desc = _t(\"The file '%(fileName)s' failed to upload.\", { fileName: upload.fileName });\n                if (err.httpStatus === 413) {\n                    desc = _t(\n                        \"The file '%(fileName)s' exceeds this homeserver's size limit for uploads\",\n                        { fileName: upload.fileName },\n                    );\n                }\n                Modal.createDialog(ErrorDialog, {\n                    title: _t('Upload Failed'),\n                    description: desc,\n                });\n            }\n        }).finally(() => {\n            for (let i = 0; i < this.inprogress.length; ++i) {\n                if (this.inprogress[i].promise === upload.promise) {\n                    this.inprogress.splice(i, 1);\n                    break;\n                }\n            }\n            if (error) {\n                // 413: File was too big or upset the server in some way:\n                // clear the media size limit so we fetch it again next time\n                // we try to upload\n                if (error?.httpStatus === 413) {\n                    this.mediaConfig = null;\n                }\n                dis.dispatch<UploadErrorPayload>({ action: Action.UploadFailed, upload, error });\n            } else {\n                dis.dispatch<UploadFinishedPayload>({ action: Action.UploadFinished, upload });\n                dis.dispatch({ action: 'message_sent' });\n            }\n        });\n    }\n\n    private isFileSizeAcceptable(file: File) {\n        if (this.mediaConfig !== null &&\n            this.mediaConfig[\"m.upload.size\"] !== undefined &&\n            file.size > this.mediaConfig[\"m.upload.size\"]) {\n            return false;\n        }\n        return true;\n    }\n\n    private ensureMediaConfigFetched(matrixClient: MatrixClient): Promise<void> {\n        if (this.mediaConfig !== null) return;\n\n        logger.log(\"[Media Config] Fetching\");\n        return matrixClient.getMediaConfig().then((config) => {\n            logger.log(\"[Media Config] Fetched config:\", config);\n            return config;\n        }).catch(() => {\n            // Media repo can't or won't report limits, so provide an empty object (no limits).\n            logger.log(\"[Media Config] Could not fetch config, so not limiting uploads.\");\n            return {};\n        }).then((config) => {\n            this.mediaConfig = config;\n        });\n    }\n\n    static sharedInstance() {\n        if (window.mxContentMessages === undefined) {\n            window.mxContentMessages = new ContentMessages();\n        }\n        return window.mxContentMessages;\n    }\n}\n"],"mappings":"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"}