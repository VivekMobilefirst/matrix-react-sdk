{"version":3,"file":"VoipUserMapper.js","names":["VoipUserMapper","Map","sharedInstance","window","mxVoipUserMapper","undefined","userToVirtualUser","userId","results","CallHandler","instance","sipVirtualLookup","length","fields","lookup_success","userid","getVirtualUserForRoom","roomId","DMRoomMap","shared","getUserIdForRoomId","virtualUser","getOrCreateVirtualRoomForRoom","virtualRoomId","ensureVirtualRoomExists","MatrixClientPeg","get","setRoomAccountData","VIRTUAL_ROOM_EVENT_TYPE","native_room","virtualToNativeRoomIdCache","set","getVirtualRoomForRoom","findDMForUser","nativeRoomForVirtualRoom","cachedNativeRoomId","logger","log","virtualRoom","getRoom","virtualRoomEvent","getAccountData","getContent","nativeRoomID","nativeRoom","getMyMembership","isVirtualRoom","room","has","roomCreateEvent","currentState","getStateEvents","EventType","RoomCreate","getSender","getUserId","claimedNativeRoomId","Boolean","onNewInvitedRoom","invitedRoom","getSupportsVirtualRooms","inviterId","getDMInviter","result","sipNativeLookup","is_virtual","nativeUser","joinRoom"],"sources":["../src/VoipUserMapper.ts"],"sourcesContent":["/*\nCopyright 2021 The Matrix.org Foundation C.I.C.\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n*/\n\nimport { Room } from 'matrix-js-sdk/src/models/room';\nimport { logger } from \"matrix-js-sdk/src/logger\";\nimport { EventType } from 'matrix-js-sdk/src/@types/event';\n\nimport { ensureVirtualRoomExists } from './createRoom';\nimport { MatrixClientPeg } from \"./MatrixClientPeg\";\nimport DMRoomMap from \"./utils/DMRoomMap\";\nimport CallHandler from './CallHandler';\nimport { VIRTUAL_ROOM_EVENT_TYPE } from \"./call-types\";\nimport { findDMForUser } from './utils/dm/findDMForUser';\n\n// Functions for mapping virtual users & rooms. Currently the only lookup\n// is sip virtual: there could be others in the future.\n\nexport default class VoipUserMapper {\n    // We store mappings of virtual -> native room IDs here until the local echo for the\n    // account data arrives.\n    private virtualToNativeRoomIdCache = new Map<string, string>();\n\n    public static sharedInstance(): VoipUserMapper {\n        if (window.mxVoipUserMapper === undefined) window.mxVoipUserMapper = new VoipUserMapper();\n        return window.mxVoipUserMapper;\n    }\n\n    private async userToVirtualUser(userId: string): Promise<string> {\n        const results = await CallHandler.instance.sipVirtualLookup(userId);\n        if (results.length === 0 || !results[0].fields.lookup_success) return null;\n        return results[0].userid;\n    }\n\n    private async getVirtualUserForRoom(roomId: string): Promise<string | null> {\n        const userId = DMRoomMap.shared().getUserIdForRoomId(roomId);\n        if (!userId) return null;\n\n        const virtualUser = await this.userToVirtualUser(userId);\n        if (!virtualUser) return null;\n\n        return virtualUser;\n    }\n\n    public async getOrCreateVirtualRoomForRoom(roomId: string): Promise<string | null> {\n        const virtualUser = await this.getVirtualUserForRoom(roomId);\n        if (!virtualUser) return null;\n\n        const virtualRoomId = await ensureVirtualRoomExists(MatrixClientPeg.get(), virtualUser, roomId);\n        MatrixClientPeg.get().setRoomAccountData(virtualRoomId, VIRTUAL_ROOM_EVENT_TYPE, {\n            native_room: roomId,\n        });\n\n        this.virtualToNativeRoomIdCache.set(virtualRoomId, roomId);\n\n        return virtualRoomId;\n    }\n\n    /**\n     * Gets the ID of the virtual room for a room, or null if the room has no\n     * virtual room\n     */\n    public async getVirtualRoomForRoom(roomId: string): Promise<Room | null> {\n        const virtualUser = await this.getVirtualUserForRoom(roomId);\n        if (!virtualUser) return null;\n\n        return findDMForUser(MatrixClientPeg.get(), virtualUser);\n    }\n\n    public nativeRoomForVirtualRoom(roomId: string): string {\n        const cachedNativeRoomId = this.virtualToNativeRoomIdCache.get(roomId);\n        if (cachedNativeRoomId) {\n            logger.log(\n                \"Returning native room ID \" + cachedNativeRoomId + \" for virtual room ID \" + roomId + \" from cache\",\n            );\n            return cachedNativeRoomId;\n        }\n\n        const virtualRoom = MatrixClientPeg.get().getRoom(roomId);\n        if (!virtualRoom) return null;\n        const virtualRoomEvent = virtualRoom.getAccountData(VIRTUAL_ROOM_EVENT_TYPE);\n        if (!virtualRoomEvent || !virtualRoomEvent.getContent()) return null;\n        const nativeRoomID = virtualRoomEvent.getContent()['native_room'];\n        const nativeRoom = MatrixClientPeg.get().getRoom(nativeRoomID);\n        if (!nativeRoom || nativeRoom.getMyMembership() !== 'join') return null;\n\n        return nativeRoomID;\n    }\n\n    public isVirtualRoom(room: Room): boolean {\n        if (this.nativeRoomForVirtualRoom(room.roomId)) return true;\n\n        if (this.virtualToNativeRoomIdCache.has(room.roomId)) return true;\n\n        // also look in the create event for the claimed native room ID, which is the only\n        // way we can recognise a virtual room we've created when it first arrives down\n        // our stream. We don't trust this in general though, as it could be faked by an\n        // inviter: our main source of truth is the DM state.\n        const roomCreateEvent = room.currentState.getStateEvents(EventType.RoomCreate, \"\");\n        if (!roomCreateEvent || !roomCreateEvent.getContent()) return false;\n        // we only look at this for rooms we created (so inviters can't just cause rooms\n        // to be invisible)\n        if (roomCreateEvent.getSender() !== MatrixClientPeg.get().getUserId()) return false;\n        const claimedNativeRoomId = roomCreateEvent.getContent()[VIRTUAL_ROOM_EVENT_TYPE];\n        return Boolean(claimedNativeRoomId);\n    }\n\n    public async onNewInvitedRoom(invitedRoom: Room): Promise<void> {\n        if (!CallHandler.instance.getSupportsVirtualRooms()) return;\n\n        const inviterId = invitedRoom.getDMInviter();\n        logger.log(`Checking virtual-ness of room ID ${invitedRoom.roomId}, invited by ${inviterId}`);\n        const result = await CallHandler.instance.sipNativeLookup(inviterId);\n        if (result.length === 0) {\n            return;\n        }\n\n        if (result[0].fields.is_virtual) {\n            const nativeUser = result[0].userid;\n            const nativeRoom = findDMForUser(MatrixClientPeg.get(), nativeUser);\n            if (nativeRoom) {\n                // It's a virtual room with a matching native room, so set the room account data. This\n                // will make sure we know where how to map calls and also allow us know not to display\n                // it in the future.\n                MatrixClientPeg.get().setRoomAccountData(invitedRoom.roomId, VIRTUAL_ROOM_EVENT_TYPE, {\n                    native_room: nativeRoom.roomId,\n                });\n                // also auto-join the virtual room if we have a matching native room\n                // (possibly we should only join if we've also joined the native room, then we'd also have\n                // to make sure we joined virtual rooms on joining a native one)\n                MatrixClientPeg.get().joinRoom(invitedRoom.roomId);\n            }\n\n            // also put this room in the virtual room ID cache so isVirtualRoom return the right answer\n            // in however long it takes for the echo of setAccountData to come down the sync\n            this.virtualToNativeRoomIdCache.set(invitedRoom.roomId, nativeRoom.roomId);\n        }\n    }\n}\n"],"mappings":"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"}